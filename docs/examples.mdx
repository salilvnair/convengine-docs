---
title: Examples
sidebar_position: 3
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import { Conversation, User, Assistant, CodeBlockToggle, Highlight, DbTable, FileRef, MethodRef } from "@site/src/components/convengine";

# Examples (Deep E2E)

## FAQ Example

<Conversation title="FAQ: First turn">
  <User>Can I move my connection within Zapper?</User>
  <Assistant>Yes. Internal transfer is supported. Use Connections -> Move Service.</Assistant>
</Conversation>

<Tabs groupId="faq-example">
  <TabItem value="flow" label="Step-by-step Flow" default>

1. Control goes to <MethodRef>ConversationController.message</MethodRef> in <FileRef>api/controller/ConversationController.java</FileRef>.

<CodeBlockToggle
  title="Controller: message(...)"
  language="java"
  packagePath="com.github.salilvnair.convengine.api.controller"
  filePath="src/main/java/com/github/salilvnair/convengine/api/controller/ConversationController.java"
>
{`@PostMapping("/message")
public ConversationResponse message(@RequestBody ConversationRequest request) {
  UUID conversationId = request.getConversationId() != null
      ? request.getConversationId() : UUID.randomUUID();

  Map<String, Object> inputParams = new LinkedHashMap<>();
  if (request.getInputParams() != null) {
    inputParams.putAll(request.getInputParams());
  }

  EngineContext engineContext = EngineContext.builder()
      .conversationId(conversationId.toString())
      .userText(request.getMessage())
      .inputParams(inputParams)
      .build();

  EngineResult result = engine.process(engineContext);
  // maps TextPayload/JsonPayload into API response
}`}
</CodeBlockToggle>

2. <MethodRef>EngineContext</MethodRef> is built and <MethodRef>engine.process</MethodRef> is called in <FileRef>engine/provider/DefaultConversationalEngine.java</FileRef>.

<CodeBlockToggle
  title="Engine: process(...)"
  language="java"
  filePath="src/main/java/com/github/salilvnair/convengine/engine/provider/DefaultConversationalEngine.java"
>
{`@Override
public EngineResult process(EngineContext engineContext) {
  EngineSession session = sessionFactory.open(engineContext);
  session.setConversationHistory(historyProvider.lastTurns(session.getConversationId(), 10));
  EnginePipeline pipeline = pipelineFactory.create();
  return pipeline.execute(session);
}`}
</CodeBlockToggle>

3. New <MethodRef>EngineSession</MethodRef> is created and pipeline executes via <MethodRef>EnginePipeline.execute</MethodRef> in <FileRef>engine/pipeline/EnginePipeline.java</FileRef>.

<CodeBlockToggle
  title="Pipeline execute loop"
  language="java"
  filePath="src/main/java/com/github/salilvnair/convengine/engine/pipeline/EnginePipeline.java"
>
{`public EngineResult execute(EngineSession session) {
  for (EngineStep step : steps) {
    StepResult r = step.execute(session);
    if (r instanceof StepResult.Stop(EngineResult result)) {
      return result;
    }
  }
  if (session.getFinalResult() == null) {
    throw new ConversationEngineException(ConversationEngineErrorCode.PIPELINE_NO_FINAL_RESULT);
  }
  return session.getFinalResult();
}`}
</CodeBlockToggle>

4. DAG order is precomputed in <MethodRef>EnginePipelineFactory.init/orderByDag</MethodRef> from <FileRef>engine/factory/EnginePipelineFactory.java</FileRef>.

<CodeBlockToggle
  title="Pipeline factory DAG ordering"
  language="java"
  filePath="src/main/java/com/github/salilvnair/convengine/engine/factory/EnginePipelineFactory.java"
>
{`@PostConstruct
public void init() {
  List<EngineStep> ordered = orderByDag(discoveredSteps);
  this.pipeline = new EnginePipeline(wrapWithTiming(ordered));
}

// Applies @MustRunAfter, @MustRunBefore, @RequiresConversationPersisted
private List<EngineStep> orderByDag(List<EngineStep> steps) {
  // build edges, enforce one @TerminalStep, topological sort
}`}
</CodeBlockToggle>

5. Step loop invokes each <MethodRef>execute(session)</MethodRef>. If <MethodRef>Stop</MethodRef>, response returns immediately; else it continues.

<details className="ce-trace-details">
  <summary>Open full step traversal with snippets</summary>

<CodeBlockToggle title="LoadOrCreateConversationStep.execute" language="java" filePath="engine/steps/LoadOrCreateConversationStep.java">
{`public StepResult execute(EngineSession session) {
  // Loads existing ce_conversation row or creates default.
  // Syncs intent/state/context into session.
  return new StepResult.Continue();
}`}
</CodeBlockToggle>

<CodeBlockToggle title="ResetConversationStep.execute" language="java" filePath="engine/steps/ResetConversationStep.java">
{`public StepResult execute(EngineSession session) {
  // Checks reset flags/commands and clears state/context when required.
  return new StepResult.Continue();
}`}
</CodeBlockToggle>

<CodeBlockToggle title="AuditUserInputStep.execute" language="java" filePath="engine/steps/AuditUserInputStep.java">
{`public StepResult execute(EngineSession session) {
  // Persists USER_INPUT stage to ce_audit.
  return new StepResult.Continue();
}`}
</CodeBlockToggle>

<CodeBlockToggle title="IntentResolutionStep.execute" language="java" filePath="engine/steps/IntentResolutionStep.java">
{`public StepResult execute(EngineSession session) {
  // resolveWithTrace(session), apply lock checks,
  // set intent/state and audit source.
  return new StepResult.Continue();
}`}
</CodeBlockToggle>

<CodeBlockToggle title="SchemaExtractionStep.execute" language="java" filePath="engine/steps/SchemaExtractionStep.java">
{`public StepResult execute(EngineSession session) {
  // If schema configured: render SCHEMA_JSON prompt,
  // llm.generateJson(...), merge context_json,
  // compute missing fields + intent lock.
  return new StepResult.Continue();
}`}
</CodeBlockToggle>

<CodeBlockToggle title="RulesStep.execute" language="java" filePath="engine/steps/RulesStep.java">
{`public StepResult execute(EngineSession session) {
  // Multi-pass ce_rule evaluation with action resolvers.
  // SET_STATE / SET_INTENT / SET_JSON / SET_TASK etc.
  return new StepResult.Continue();
}`}
</CodeBlockToggle>

<CodeBlockToggle title="ResponseResolutionStep.execute" language="java" filePath="engine/steps/ResponseResolutionStep.java">
{`public StepResult execute(EngineSession session) {
  // resolve ce_response candidate,
  // apply EXACT or DERIVED resolver,
  // run ResponseTransformer,
  // audit ASSISTANT_OUTPUT.
  return new StepResult.Continue();
}`}
</CodeBlockToggle>

<CodeBlockToggle title="PersistConversationStep.execute" language="java" filePath="engine/steps/PersistConversationStep.java">
{`public StepResult execute(EngineSession session) {
  // Persists final intent/state/context to ce_conversation.
  return new StepResult.Continue();
}`}
</CodeBlockToggle>

  </details>

  </TabItem>

  <TabItem value="tables" label="Tables + Prompts">

<DbTable
  title="FAQ table touchpoints"
  columns={["Table", "Read/Write", "Expectation"]}
  rows={[
    ["ce_intent", "R", "FAQ intent exists and enabled=true"],
    ["ce_intent_classifier", "R", "FAQ phrase patterns are configured"],
    ["ce_response", "R", "EXACT response row for FAQ + state"],
    ["ce_prompt_template", "Optional", "Only needed when response_type=DERIVED"],
    ["ce_audit", "W", "USER_INPUT, INTENT_*, ASSISTANT_OUTPUT, ENGINE_RETURN"],
    ["ce_conversation", "R/W", "Conversation state and context persistence"],
  ]}
/>

<CodeBlockToggle title="FAQ exact response row" language="sql" packagePath="ce_response" filePath="response_type=EXACT">
{`INSERT INTO ce_response
(intent_code, state_code, response_type, output_format, exact_text, enabled, priority)
VALUES
('FAQ', 'ANY', 'EXACT', 'TEXT',
 'Yes. Internal transfer is supported. Use Connections -> Move Service.', true, 1);`}
</CodeBlockToggle>

  </TabItem>

  <TabItem value="audit" label="Audit Sequence">
<CodeBlockToggle title="Expected stage order" language="text" filePath="ce_audit.stage">
{`STEP_ENTER(LoadOrCreateConversationStep)
STEP_EXIT(LoadOrCreateConversationStep)
USER_INPUT
INTENT_RESOLVE_START
INTENT_RESOLVED_BY_CLASSIFIER or INTENT_RESOLVED_BY_AGENT
RULE_MATCHED / RULE_NO_MATCH
ASSISTANT_OUTPUT
ENGINE_RETURN`}
</CodeBlockToggle>
  </TabItem>
</Tabs>

<Highlight type="info" title="Intervene points">
Use <MethodRef>EngineStepHook.beforeStep/afterStep</MethodRef> around <MethodRef>IntentResolutionStep</MethodRef> or <MethodRef>RulesStep</MethodRef> to debug or inject hints in runtime.
</Highlight>

## DISCONNECT_ELECTRICITY Example

<Conversation title="Turn 1">
  <User>I need to disconnect electricity for account 10004567.</User>
  <Assistant>Please share final service date and disconnection reason.</Assistant>
</Conversation>

Engine asks follow-up because schema is incomplete (<MethodRef>finalDate</MethodRef>, <MethodRef>reason</MethodRef> missing).

<Conversation title="Turn 2">
  <User>Final date is 2026-03-31 and reason is moving out.</User>
  <Assistant>Your request is submitted. Ticket DR-22991 is created.</Assistant>
</Conversation>

<Tabs groupId="disconnect-example">
  <TabItem value="flow" label="Flow" default>

<ul>
  <li><code>SchemaExtractionStep.execute</code> picks schema from <FileRef>ce_output_schema</FileRef>.</li>
  <li>Prompt is resolved from <FileRef>ce_prompt_template</FileRef> (<code>response_type=SCHEMA_JSON</code>).</li>
  <li><code>llm.generateJson(...)</code> extracts fields and merges into <code>context_json</code>.</li>
  <li><code>session.lockIntent("SCHEMA_INCOMPLETE")</code> protects intent until required fields are complete.</li>
  <li><code>RulesStep.execute</code> can move state to submission-ready.</li>
  <li><code>ResponseResolutionStep.execute</code> returns clarification or success response.</li>
</ul>

  </TabItem>
  <TabItem value="tables" label="Tables">
<DbTable
  title="Disconnect table touchpoints"
  columns={["Table", "Expected data"]}
  rows={[
    ["ce_output_schema", "required: accountId, finalDate, reason"],
    ["ce_prompt_template", "SCHEMA_JSON extraction template"],
    ["ce_rule", "state transitions for missing-fields and submit"],
    ["ce_response", "clarification + submission confirmation"],
    ["ce_audit", "SCHEMA_EXTRACTION_*, SCHEMA_STATUS"],
  ]}
/>
  </TabItem>
</Tabs>

## LOG_ANALYSIS Example

<Conversation title="Turn 1">
  <User>Analyze timeout logs for order flow.</User>
  <Assistant>Please share correlation id or request id.</Assistant>
</Conversation>

After identifier is collected, tool-assisted path can run.

<Conversation title="Turn 2">
  <User>Correlation id is 8fe6d9c9-2f7a.</User>
  <Assistant>Root cause: DB pool saturation from 11:02 to 11:07 UTC.</Assistant>
</Conversation>

<Tabs groupId="log-example">
  <TabItem value="flow" label="Flow" default>
<ul>
  <li><code>SchemaExtractionStep</code> extracts <code>correlationId</code>.</li>
  <li><code>McpToolStep.execute</code> plans tool call from MCP config.</li>
  <li>Tool result is merged under <code>context_json.mcp</code>.</li>
  <li><code>ResponseResolutionStep</code> generates final RCA output.</li>
</ul>
  </TabItem>
  <TabItem value="tables" label="Tables">
<DbTable
  title="Log analysis table touchpoints"
  columns={["Table", "Role"]}
  rows={[
    ["ce_mcp_tool", "Tool registry for planner"],
    ["ce_mcp_db_tool", "DB-backed tool metadata"],
    ["ce_config", "MCP planner prompt keys"],
    ["ce_prompt_template", "derived response template"],
    ["ce_audit", "MCP_PLAN_*, MCP_TOOL_*, MCP_FINAL_ANSWER"],
  ]}
/>
  </TabItem>
</Tabs>

## REQUEST_TRACKER Example

<Conversation title="Single turn tracker">
  <User>Track request REQ-778102.</User>
  <Assistant>Request REQ-778102 is IN_REVIEW and assigned to Queue-3.</Assistant>
</Conversation>

<Tabs groupId="tracker-example">
  <TabItem value="flow" label="Flow" default>
<ul>
  <li><code>IntentResolutionStep.execute</code> resolves <code>REQUEST_TRACKER</code>.</li>
  <li><code>SchemaExtractionStep.execute</code> extracts request id.</li>
  <li><code>RulesStep.execute</code> sets tracking-ready state.</li>
  <li><code>ResponseResolutionStep.resolveResponse</code> selects mapping and emits output.</li>
</ul>
  </TabItem>
  <TabItem value="tables" label="Tables">
<DbTable
  title="Request tracker table touchpoints"
  columns={["Table", "Expected row"]}
  rows={[
    ["ce_output_schema", "requestId extraction schema"],
    ["ce_rule", "state transition to TRACK_READY"],
    ["ce_response", "status message mapping"],
    ["ce_audit", "intent + state + output trace"],
  ]}
/>
  </TabItem>
</Tabs>

<Highlight type="success" title="Fast debug routine">
For every example run: call <FileRef>/audit/{'{conversationId}'}</FileRef> for stage timeline, then <FileRef>/audit/{'{conversationId}'}/trace</FileRef> for step spans and source references.
</Highlight>
