"use strict";(globalThis.webpackChunkconvengine_docs=globalThis.webpackChunkconvengine_docs||[]).push([[3628],{1420(e,s,n){n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>d,default:()=>u,frontMatter:()=>a,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"deep-dive/verbose-and-conversation-runtime","title":"Verbose and Conversation Runtime","description":"This page documents two runtime tables that are often tuned together:","source":"@site/docs/v2/deep-dive/verbose-and-conversation-runtime.mdx","sourceDirName":"deep-dive","slug":"/deep-dive/verbose-and-conversation-runtime","permalink":"/docs/v2/deep-dive/verbose-and-conversation-runtime","draft":false,"unlisted":false,"editUrl":"https://github.com/salilvnair/convengine-docs/tree/main/docs/v2/deep-dive/verbose-and-conversation-runtime.mdx","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"title":"Verbose and Conversation Runtime","sidebar_position":5},"sidebar":"docSidebar","previous":{"title":"Thymeleaf and SpEL","permalink":"/docs/v2/deep-dive/thymeleaf-spel"},"next":{"title":"Developer Guide","permalink":"/docs/v2/deep-dive/developer-guide"}}');var r=n(4848),i=n(8453),o=n(7555);const a={title:"Verbose and Conversation Runtime",sidebar_position:5},d="Verbose and Conversation Runtime",c={},l=[{value:"<code>ce_conversation</code> runtime contract",id:"ce_conversation-runtime-contract",level:2},{value:"<code>ce_verbose</code> runtime contract",id:"ce_verbose-runtime-contract",level:2},{value:"Resolver behavior (from Java implementation)",id:"resolver-behavior-from-java-implementation",level:3},{value:"Determinants currently emitted by runtime",id:"determinants-currently-emitted-by-runtime",level:2},{value:"Consumer-side verbose emission",id:"consumer-side-verbose-emission",level:2},{value:"Stream envelope contract (<code>AUDIT</code> + <code>VERBOSE</code>)",id:"stream-envelope-contract-audit--verbose",level:2}];function h(e){const s={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsx)(s.h1,{id:"verbose-and-conversation-runtime",children:"Verbose and Conversation Runtime"})}),"\n",(0,r.jsx)(s.p,{children:"This page documents two runtime tables that are often tuned together:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"ce_conversation"})," (conversation state persistence)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"ce_verbose"})," (runtime progress/error messaging)"]}),"\n"]}),"\n",(0,r.jsxs)(s.h2,{id:"ce_conversation-runtime-contract",children:[(0,r.jsx)(s.code,{children:"ce_conversation"})," runtime contract"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"ce_conversation"})," is the turn-to-turn state source used by ",(0,r.jsx)(s.code,{children:"EngineSessionFactory"})," and ",(0,r.jsx)(s.code,{children:"LoadOrCreateConversationStep"}),"."]}),"\n",(0,r.jsx)(o.p,{title:"ce_conversation fields used at runtime",columns:["Column","How engine uses it","Write path"],rows:[["conversation_id","Primary key for session bootstrap and resume","Created once in bootstrap/create step"],["intent_code","Restored into session intent at turn start","Updated through pipeline + persist"],["state_code","Restored into session state at turn start","Updated through pipeline + persist"],["context_json","Restored into `session.contextJson`","Mutated by steps, saved in persist"],["input_params_json","Restored into session input params baseline","Sanitized and saved in persist"],["last_user_text","Tracks most recent user text for diagnostics","Set in `LoadOrCreateConversationStep`"],["last_assistant_json","Stores last assistant payload","Set during response/persist flow"],["status","Conversation status marker (normally `RUNNING`)","Set in bootstrap/persist"],["created_at/updated_at","Turn recency and lifecycle timestamps","Created in bootstrap, updated each turn"]]}),"\n",(0,r.jsx)(o.f4,{type:"tip",title:"Bootstrap behavior",children:(0,r.jsxs)(s.p,{children:["If a conversation row does not exist, ",(0,r.jsx)(s.code,{children:"EngineSessionFactory"})," creates a minimal row with ",(0,r.jsx)(s.code,{children:"context_json={}"}),", ",(0,r.jsx)(s.code,{children:"input_params_json={}"}),", and status ",(0,r.jsx)(s.code,{children:"RUNNING"}),", then syncs session from it."]})}),"\n",(0,r.jsxs)(s.h2,{id:"ce_verbose-runtime-contract",children:[(0,r.jsx)(s.code,{children:"ce_verbose"})," runtime contract"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"ce_verbose"})," is resolved by ",(0,r.jsx)(s.code,{children:"DbVerboseMessageResolver"})," using the current runtime context from session and metadata."]}),"\n",(0,r.jsx)(o.p,{title:"ce_verbose matching inputs",columns:["Column","Meaning","Example"],rows:[["intent_code/state_code","Primary runtime scope","Exact value or `ANY`"],["determinant","Event emitted by runtime code","`STEP_ENTER`, `RULE_MATCH`, `MCP_TOOL_CALL`"],["step_match + step_value","Step matcher (`EXACT|REGEX|JSON_PATH`)","`RulesStep`, `.*Step$`, `$.stepInfo.error`"],["rule_id/tool_code","Optional strict narrowing","Specific rule or MCP tool"],["message/error_message","Text returned for info/error paths","Progress and failure variants"],["priority","Lower value wins after specificity scoring","10, 20, 100"],["enabled","Row eligibility switch","true/false"]]}),"\n",(0,r.jsx)(s.h3,{id:"resolver-behavior-from-java-implementation",children:"Resolver behavior (from Java implementation)"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["Load eligible rows from static cache (",(0,r.jsx)(s.code,{children:"ce_verbose"}),") by intent/state."]}),"\n",(0,r.jsx)(s.li,{children:"Filter by determinant, step match, rule/tool constraints."}),"\n",(0,r.jsxs)(s.li,{children:["Score candidates by specificity (",(0,r.jsx)(s.code,{children:"intent"}),", ",(0,r.jsx)(s.code,{children:"state"}),", ",(0,r.jsx)(s.code,{children:"determinant"}),", step match type, ",(0,r.jsx)(s.code,{children:"rule_id"}),", ",(0,r.jsx)(s.code,{children:"tool_code"}),") and priority."]}),"\n",(0,r.jsxs)(s.li,{children:["Render ",(0,r.jsx)(s.code,{children:"message"})," / ",(0,r.jsx)(s.code,{children:"error_message"})," through the shared Thymeleaf text renderer using current session/runtime variables."]}),"\n",(0,r.jsxs)(s.li,{children:["Build ",(0,r.jsx)(s.code,{children:"VerboseStreamPayload"})," with ",(0,r.jsx)(s.code,{children:"level=INFO|ERROR"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["If no row matches and the event is error path, fallback publishes:\n",(0,r.jsx)(s.code,{children:"Something went wrong while processing <step>."})]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"determinants-currently-emitted-by-runtime",children:"Determinants currently emitted by runtime"}),"\n",(0,r.jsxs)(s.p,{children:["These emitted determinant values are the same values you should use in ",(0,r.jsx)(s.code,{children:"ce_verbose.determinant"}),"."]}),"\n",(0,r.jsx)(o.p,{title:"Common emitted determinants",columns:["Source","Determinants"],rows:[["Step hook","STEP_ENTER, STEP_EXIT, STEP_ERROR"],["Intent resolver","AGENT_INTENT_START, AGENT_INTENT_ACCEPTED, AGENT_INTENT_REJECTED, AGENT_INTENT_COLLISION, AGENT_INTENT_NEEDS_CLARIFICATION, INTENT_AGENT_LLM_INPUT, INTENT_AGENT_LLM_OUTPUT, INTENT_AGENT_LLM_ERROR"],["Dialogue act","DIALOGUE_ACT_LLM_INPUT, DIALOGUE_ACT_LLM_OUTPUT, DIALOGUE_ACT_LLM_ERROR"],["Rules","RULE_MATCH, RULE_APPLIED, RULE_NO_MATCH"],["Schema","SCHEMA_EXTRACTION_START, SCHEMA_EXTRACTION_LLM_INPUT, SCHEMA_EXTRACTION_LLM_OUTPUT, SCHEMA_EXTRACTION_LLM_ERROR, SCHEMA_STATUS"],["MCP/tool","MCP_PLAN_LLM_INPUT, MCP_PLAN_LLM_OUTPUT, MCP_PLAN_LLM_ERROR, MCP_TOOL_CALL, MCP_TOOL_RESULT, MCP_TOOL_ERROR, MCP_FINAL_ANSWER, TOOL_ORCHESTRATION_REQUEST, TOOL_ORCHESTRATION_RESULT, TOOL_ORCHESTRATION_ERROR"],["Resolver factories","RULE_ACTION_RESOLVER_SELECTED/NOT_FOUND, RESPONSE_TYPE_RESOLVER_SELECTED/NOT_FOUND, OUTPUT_FORMAT_RESOLVER_SELECTED/NOT_FOUND"],["Response step","RESOLVE_RESPONSE, RESOLVE_RESPONSE_SELECTED, RESOLVE_RESPONSE_LLM_INPUT, RESOLVE_RESPONSE_LLM_OUTPUT, RESOLVE_RESPONSE_LLM_ERROR"],["Intent step","INTENT_RESOLVED"]]}),"\n",(0,r.jsx)(s.h2,{id:"consumer-side-verbose-emission",children:"Consumer-side verbose emission"}),"\n",(0,r.jsxs)(s.p,{children:["Consumer hooks, container transformers, response transformers, and other Spring beans can emit UI verbose messages through ",(0,r.jsx)(s.code,{children:"ConvEngineVerboseAdapter"}),"."]}),"\n",(0,r.jsx)(o.vl,{title:"Consumer verbose adapter usage",language:"java",children:'@Component\n@RequiredArgsConstructor\npublic class LoanResponseTransformer implements ResponseTransformerHandler {\n\nprivate final ConvEngineVerboseAdapter verboseAdapter;\n\n@Override\npublic OutputPayload transform(OutputPayload responsePayload, EngineSession session, Map<String, Object> inputParams) {\n  verboseAdapter.publish(session, this, "POST_TRANSFORM_START");\n  verboseAdapter.publishText(\n      session,\n      this,\n      "POST_TRANSFORM_NOTE",\n      "Preparing final response for [[${intent}]] in state [[${state}]]."\n  );\n  return responsePayload;\n}\n}'}),"\n",(0,r.jsxs)(s.p,{children:["For ",(0,r.jsx)(s.code,{children:'publish(session, this, "POST_TRANSFORM_START")'}),", ",(0,r.jsx)(s.code,{children:"ce_verbose"})," resolution uses:"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"step_value = LoanResponseTransformer"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"determinant = POST_TRANSFORM_START"})}),"\n",(0,r.jsxs)(s.li,{children:["current ",(0,r.jsx)(s.code,{children:"intent_code"})," and ",(0,r.jsx)(s.code,{children:"state_code"})]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"Adapter behavior:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:'publish(session, this, "...")'})," uses ",(0,r.jsx)(s.code,{children:"this.getClass().getSimpleName()"})," as ",(0,r.jsx)(s.code,{children:"step_value"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"publish(session, ..., metadata)"})," and ",(0,r.jsx)(s.code,{children:"publishError(...)"})," flow through the same DB-backed ",(0,r.jsx)(s.code,{children:"ce_verbose"})," resolver with extra metadata"]}),"\n",(0,r.jsxs)(s.li,{children:["if no ",(0,r.jsx)(s.code,{children:"ce_verbose"})," row matches, no custom verbose message is emitted from the DB path"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"publishText(...)"})," bypasses DB lookup and sends the provided text directly, still rendered through Thymeleaf against session + metadata"]}),"\n"]}),"\n",(0,r.jsxs)(s.h2,{id:"stream-envelope-contract-audit--verbose",children:["Stream envelope contract (",(0,r.jsx)(s.code,{children:"AUDIT"})," + ",(0,r.jsx)(s.code,{children:"VERBOSE"}),")"]}),"\n",(0,r.jsxs)(s.p,{children:["Both SSE and STOMP publish ",(0,r.jsx)(s.code,{children:"AuditStreamEventResponse"})," with:"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"eventType"}),": ",(0,r.jsx)(s.code,{children:"AUDIT"})," or ",(0,r.jsx)(s.code,{children:"VERBOSE"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"verbose"}),": populated for verbose events"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"payload.verbose"}),": verbose payload mirror for clients that read payload map"]}),"\n"]}),"\n",(0,r.jsx)(o.vl,{title:"Verbose rollout SQL (standalone assets)",language:"text",children:"src/main/resources/sql/verbose_ddl.sql\nsrc/main/resources/sql/verbose_seed.sql"}),"\n",(0,r.jsx)(o.f4,{type:"warning",title:"Startup safety",children:(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"ce_verbose"})," is validated at startup. Invalid ",(0,r.jsx)(s.code,{children:"step_match"})," or blank ",(0,r.jsx)(s.code,{children:"step_value"})," / ",(0,r.jsx)(s.code,{children:"determinant"})," rows can fail startup integrity checks."]})})]})}function u(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}}}]);