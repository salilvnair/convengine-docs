"use strict";(globalThis.webpackChunkconvengine_docs=globalThis.webpackChunkconvengine_docs||[]).push([[569],{6277(e,n,s){s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"deep-dive/thymeleaf-spel","title":"Thymeleaf and SpEL","description":"ConvEngine 2.0.9 routes prompt rendering and verbose text rendering through the shared ThymeleafTemplateRenderer.","source":"@site/docs/v2/deep-dive/thymeleaf-spel.mdx","sourceDirName":"deep-dive","slug":"/deep-dive/thymeleaf-spel","permalink":"/docs/v2/deep-dive/thymeleaf-spel","draft":false,"unlisted":false,"editUrl":"https://github.com/salilvnair/convengine-docs/tree/main/docs/v2/deep-dive/thymeleaf-spel.mdx","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"title":"Thymeleaf and SpEL","sidebar_position":6},"sidebar":"docSidebar","previous":{"title":"Data Model","permalink":"/docs/v2/deep-dive/data-model"},"next":{"title":"Verbose and Conversation Runtime","permalink":"/docs/v2/deep-dive/verbose-and-conversation-runtime"}}');var i=s(4848),t=s(8453),l=s(7555);const a={title:"Thymeleaf and SpEL",sidebar_position:6},o="Thymeleaf and SpEL in Prompts and Verbose Messages",d={},c=[{value:"Where it is used",id:"where-it-is-used",level:2},{value:"Available runtime variables",id:"available-runtime-variables",level:2},{value:"What Spring Expression Language (SpEL) means here",id:"what-spring-expression-language-spel-means-here",level:2},{value:"Common SpEL patterns",id:"common-spel-patterns",level:2},{value:"Recommended syntax",id:"recommended-syntax",level:2},{value:"Prompt examples",id:"prompt-examples",level:2},{value:"Conditional/default examples",id:"conditionaldefault-examples",level:2},{value:"SpEL examples for confirmation-first flows",id:"spel-examples-for-confirmation-first-flows",level:2},{value:"Verbose message examples",id:"verbose-message-examples",level:2},{value:"Direct adapter example",id:"direct-adapter-example",level:2},{value:"What happens when variables are missing",id:"what-happens-when-variables-are-missing",level:2},{value:"Best practices",id:"best-practices",level:2}];function p(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"thymeleaf-and-spel-in-prompts-and-verbose-messages",children:"Thymeleaf and SpEL in Prompts and Verbose Messages"})}),"\n",(0,i.jsxs)(n.p,{children:["ConvEngine ",(0,i.jsx)(n.code,{children:"2.0.9"})," routes prompt rendering and verbose text rendering through the shared ",(0,i.jsx)(n.code,{children:"ThymeleafTemplateRenderer"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"This applies to:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"ce_prompt_template.system_prompt"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"ce_prompt_template.user_prompt"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"ce_verbose.message"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"ce_verbose.error_message"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"It means you can use Thymeleaf text expressions backed by Spring Expression Language (SpEL) against live session/runtime data."}),"\n",(0,i.jsx)(n.h2,{id:"where-it-is-used",children:"Where it is used"}),"\n",(0,i.jsx)(l.p,{title:"Rendering surfaces",columns:["Surface","Rendered by","Typical use"],rows:[["ce_prompt_template.system_prompt","PromptTemplateRenderer -> ThymeleafTemplateRenderer","LLM behavior instructions"],["ce_prompt_template.user_prompt","PromptTemplateRenderer -> ThymeleafTemplateRenderer","Current request/context assembly"],["ce_verbose.message","DbVerboseMessageResolver -> ThymeleafTemplateRenderer","Progress text shown to UI"],["ce_verbose.error_message","DbVerboseMessageResolver -> ThymeleafTemplateRenderer","Error text shown to UI"],["ConvEngineVerboseAdapter.publishText(...)","VerboseMessagePublisher -> ThymeleafTemplateRenderer","Direct consumer-emitted UI verbose text"]]}),"\n",(0,i.jsx)(n.h2,{id:"available-runtime-variables",children:"Available runtime variables"}),"\n",(0,i.jsx)(n.p,{children:"Common variables available during rendering:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"user_input"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"resolved_user_input"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"standalone_query"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"intent"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"state"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"context"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"inputParams"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"schema"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"session"})}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"resolved_user_input"})," is the preferred current-turn input when query rewrite / standalone query is present."]}),"\n",(0,i.jsx)(n.h2,{id:"what-spring-expression-language-spel-means-here",children:"What Spring Expression Language (SpEL) means here"}),"\n",(0,i.jsxs)(n.p,{children:["Thymeleaf is the text templating layer. SpEL is the expression language inside the ",(0,i.jsx)(n.code,{children:"${...}"})," part."]}),"\n",(0,i.jsx)(n.p,{children:"In other words:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"[[${intent}]]"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"[[...]]"})," is Thymeleaf text rendering"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"${intent}"})," is a SpEL expression"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"ConvEngine uses this so templates can read values, branch on conditions, and apply simple defaults without writing Java."}),"\n",(0,i.jsx)(n.h2,{id:"common-spel-patterns",children:"Common SpEL patterns"}),"\n",(0,i.jsx)(l.p,{title:"SpEL patterns you can use",columns:["Pattern","Example","What it does"],rows:[["Property access","[[${context.customerId}]]","Reads a nested value from runtime context."],["Boolean check","[[${inputParams.awaiting_confirmation == true}]]","Evaluates a true/false condition."],["Ternary","[[${state == 'CONFIRMATION' ? 'Please confirm.' : 'Continuing.'}]]","Chooses one of two strings based on a condition."],["Null/default fallback","[[${context.customerId != null ? context.customerId : 'UNKNOWN_CUSTOMER'}]]","Supplies a fallback value when the real value is absent."],["Logical operators","[[${context.mcp != null && context.mcp.finalAnswer != null ? context.mcp.finalAnswer : 'Pending'}]]","Combines multiple checks before rendering."]]}),"\n",(0,i.jsx)(n.p,{children:"Supported practical operators you will use most:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["equality: ",(0,i.jsx)(n.code,{children:"=="}),", ",(0,i.jsx)(n.code,{children:"!="})]}),"\n",(0,i.jsxs)(n.li,{children:["logical: ",(0,i.jsx)(n.code,{children:"&&"}),", ",(0,i.jsx)(n.code,{children:"||"}),", ",(0,i.jsx)(n.code,{children:"!"})]}),"\n",(0,i.jsxs)(n.li,{children:["comparisons: ",(0,i.jsx)(n.code,{children:">"}),", ",(0,i.jsx)(n.code,{children:"<"}),", ",(0,i.jsx)(n.code,{children:">="}),", ",(0,i.jsx)(n.code,{children:"<="})]}),"\n",(0,i.jsxs)(n.li,{children:["ternary: ",(0,i.jsx)(n.code,{children:"condition ? a : b"})]}),"\n"]}),"\n",(0,i.jsx)(l.f4,{type:"info",title:"Recommended scope for SpEL",children:(0,i.jsxs)(n.p,{children:["Use SpEL for lightweight reads, conditionals, and defaults. Keep business routing in ",(0,i.jsx)(n.code,{children:"ce_rule"})," and pipeline steps, not in large prompt expressions."]})}),"\n",(0,i.jsx)(n.h2,{id:"recommended-syntax",children:"Recommended syntax"}),"\n",(0,i.jsx)(n.p,{children:"Use Thymeleaf text expressions for new templates:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"[[${intent}]]"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"[[${state}]]"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"[[${context.customerId}]]"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"[[${inputParams.confirmation_key}]]"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Legacy placeholders still work:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"{{user_input}}"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"{{context}}"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"But Thymeleaf expressions are the native path now."}),"\n",(0,i.jsx)(l.f4,{type:"tip",title:"Practical rule",children:(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.code,{children:"[[...]]"})," for rendered text output. Use ",(0,i.jsx)(n.code,{children:"${...}"})," inside conditions and default expressions."]})}),"\n",(0,i.jsx)(n.h2,{id:"prompt-examples",children:"Prompt examples"}),"\n",(0,i.jsx)(l.vl,{title:"ce_prompt_template.user_prompt example",language:"text",children:"User input:\n[[${resolved_user_input}]]\n\nCurrent intent/state:\n- intent: [[${intent}]]\n- state: [[${state}]]\n\nLoan draft:\n- customerId: [[${context.customerId}]]\n- requestedAmount: [[${context.requestedAmount}]]\n- tenureMonths: [[${context.tenureMonths}]]\n\nIf awaiting confirmation is true, ask for confirmation only.\nAwaiting confirmation: [[${inputParams.awaiting_confirmation}]]"}),"\n",(0,i.jsx)(n.h2,{id:"conditionaldefault-examples",children:"Conditional/default examples"}),"\n",(0,i.jsx)(n.p,{children:"You can use SpEL-backed Thymeleaf expressions for simple branching and fallbacks:"}),"\n",(0,i.jsx)(l.vl,{title:"Conditional and fallback examples",language:"text",children:"[[${context.customerId != null ? context.customerId : 'UNKNOWN_CUSTOMER'}]]\n[[${inputParams.correction_applied == true ? 'Updated value captured.' : 'No correction applied.'}]]\n[[${context.mcp != null && context.mcp.finalAnswer != null ? context.mcp.finalAnswer : 'Processing is still in progress.'}]]"}),"\n",(0,i.jsx)(n.h2,{id:"spel-examples-for-confirmation-first-flows",children:"SpEL examples for confirmation-first flows"}),"\n",(0,i.jsxs)(n.p,{children:["These are the kinds of checks that pair well with ",(0,i.jsx)(n.code,{children:"SET_INPUT_PARAM"}),", ",(0,i.jsx)(n.code,{children:"DialogueActStep"}),", and ",(0,i.jsx)(n.code,{children:"CorrectionStep"}),":"]}),"\n",(0,i.jsx)(l.vl,{title:"Confirmation-focused SpEL examples",language:"text",children:"[[${inputParams.awaiting_confirmation == true ? 'Awaiting user confirmation.' : 'No confirmation gate active.'}]]\n[[${inputParams.routing_decision == 'PROCEED_CONFIRMED' ? 'User confirmed. Start processing.' : 'Still waiting for confirmation.'}]]\n[[${inputParams.correction_applied == true ? 'Updated ' + inputParams.correction_target_field + '.' : 'No correction applied.'}]]"}),"\n",(0,i.jsx)(n.h2,{id:"verbose-message-examples",children:"Verbose message examples"}),"\n",(0,i.jsx)(l.vl,{title:"ce_verbose.message example",language:"sql",children:"INSERT INTO ce_verbose\n(intent_code, state_code, step_match, step_value, determinant, message, error_message, priority, enabled)\nVALUES\n('LOAN_APPLICATION', 'CONFIRMATION', 'EXACT', 'CorrectionStep', 'CORRECTION_PATCH_APPLIED',\n 'Updated [[${correction_target_field}]]. Please confirm customer [[${context.customerId}]] again.',\n 'Could not apply the requested correction for [[${context.customerId}]].',\n 10, true);"}),"\n",(0,i.jsx)(n.h2,{id:"direct-adapter-example",children:"Direct adapter example"}),"\n",(0,i.jsx)(l.vl,{title:"ConvEngineVerboseAdapter with Thymeleaf text",language:"java",children:'@Component\n@RequiredArgsConstructor\npublic class LoanHook implements EngineStepHook {\n\nprivate final ConvEngineVerboseAdapter verboseAdapter;\n\n@Override\npublic void beforeStep(EngineStep.Name stepName, EngineSession session) {\n  verboseAdapter.publishText(\n      session,\n      this,\n      "PRECHECK_STARTED",\n      "Starting review for [[${context.customerId}]] in state [[${state}]]."\n  );\n}\n}'}),"\n",(0,i.jsx)(n.h2,{id:"what-happens-when-variables-are-missing",children:"What happens when variables are missing"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Legacy ",(0,i.jsx)(n.code,{children:"{{...}}"})," placeholders are validated."]}),"\n",(0,i.jsx)(n.li,{children:"If a required legacy variable cannot be resolved, prompt rendering can fail with unresolved prompt metadata."}),"\n",(0,i.jsx)(n.li,{children:"For Thymeleaf expressions, prefer explicit fallbacks when a value may be absent."}),"\n"]}),"\n",(0,i.jsx)(l.f4,{type:"warning",title:"Avoid brittle templates",children:(0,i.jsx)(n.p,{children:"Do not assume every nested node exists. For optional values, use fallback expressions instead of hard-failing on deep property chains."})}),"\n",(0,i.jsx)(n.h2,{id:"best-practices",children:"Best practices"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Use ",(0,i.jsx)(n.code,{children:"resolved_user_input"})," instead of ",(0,i.jsx)(n.code,{children:"user_input"})," when current-turn rewrites matter."]}),"\n",(0,i.jsxs)(n.li,{children:["Keep business control in ",(0,i.jsx)(n.code,{children:"ce_rule"}),"; use templates for wording, not state transitions."]}),"\n",(0,i.jsxs)(n.li,{children:["Use ",(0,i.jsx)(n.code,{children:"ce_verbose"})," / ",(0,i.jsx)(n.code,{children:"ConvEngineVerboseAdapter"})," for UI progress text, not to mutate runtime state."]}),"\n",(0,i.jsx)(n.li,{children:"Prefer compact expressions; large branching logic belongs in rules or Java, not prompt text."}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(p,{...e})}):p(e)}}}]);