"use strict";(globalThis.webpackChunkconvengine_docs=globalThis.webpackChunkconvengine_docs||[]).push([[8087],{1470(e,n,t){t.d(n,{A:()=>O});var s=t(6540),o=t(4164),r=t(7559),i=t(3104),a=t(6347),c=t(205),l=t(7485),d=t(1682),u=t(679);function p(e){return s.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,s.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function h(e){const{values:n,children:t}=e;return(0,s.useMemo)(()=>{const e=n??function(e){return p(e).map(({props:{value:e,label:n,attributes:t,default:s}})=>({value:e,label:n,attributes:t,default:s}))}(t);return function(e){const n=(0,d.XI)(e,(e,n)=>e.value===n.value);if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[n,t])}function _({value:e,tabValues:n}){return n.some(n=>n.value===e)}function m({queryString:e=!1,groupId:n}){const t=(0,a.W6)(),o=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,l.aZ)(o),(0,s.useCallback)(e=>{if(!o)return;const n=new URLSearchParams(t.location.search);n.set(o,e),t.replace({...t.location,search:n.toString()})},[o,t])]}function T(e){const{defaultValue:n,queryString:t=!1,groupId:o}=e,r=h(e),[i,a]=(0,s.useState)(()=>function({defaultValue:e,tabValues:n}){if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!_({value:e,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const t=n.find(e=>e.default)??n[0];if(!t)throw new Error("Unexpected error: 0 tabValues");return t.value}({defaultValue:n,tabValues:r})),[l,d]=m({queryString:t,groupId:o}),[p,T]=function({groupId:e}){const n=function(e){return e?`docusaurus.tab.${e}`:null}(e),[t,o]=(0,u.Dv)(n);return[t,(0,s.useCallback)(e=>{n&&o.set(e)},[n,o])]}({groupId:o}),I=(()=>{const e=l??p;return _({value:e,tabValues:r})?e:null})();(0,c.A)(()=>{I&&a(I)},[I]);return{selectedValue:i,selectValue:(0,s.useCallback)(e=>{if(!_({value:e,tabValues:r}))throw new Error(`Can't select invalid tab value=${e}`);a(e),d(e),T(e)},[d,T,r]),tabValues:r}}var I=t(2303);const A="tabList__CuJ",E="tabItem_LNqP";var N=t(4848);function P({className:e,block:n,selectedValue:t,selectValue:s,tabValues:r}){const a=[],{blockElementScrollPositionUntilNextRender:c}=(0,i.a_)(),l=e=>{const n=e.currentTarget,o=a.indexOf(n),i=r[o].value;i!==t&&(c(n),s(i))},d=e=>{let n=null;switch(e.key){case"Enter":l(e);break;case"ArrowRight":{const t=a.indexOf(e.currentTarget)+1;n=a[t]??a[0];break}case"ArrowLeft":{const t=a.indexOf(e.currentTarget)-1;n=a[t]??a[a.length-1];break}}n?.focus()};return(0,N.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,o.A)("tabs",{"tabs--block":n},e),children:r.map(({value:e,label:n,attributes:s})=>(0,N.jsx)("li",{role:"tab",tabIndex:t===e?0:-1,"aria-selected":t===e,ref:e=>{a.push(e)},onKeyDown:d,onClick:l,...s,className:(0,o.A)("tabs__item",E,s?.className,{"tabs__item--active":t===e}),children:n??e},e))})}function x({lazy:e,children:n,selectedValue:t}){const r=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){const e=r.find(e=>e.props.value===t);return e?(0,s.cloneElement)(e,{className:(0,o.A)("margin-top--md",e.props.className)}):null}return(0,N.jsx)("div",{className:"margin-top--md",children:r.map((e,n)=>(0,s.cloneElement)(e,{key:n,hidden:e.props.value!==t}))})}function C(e){const n=T(e);return(0,N.jsxs)("div",{className:(0,o.A)(r.G.tabs.container,"tabs-container",A),children:[(0,N.jsx)(P,{...n,...e}),(0,N.jsx)(x,{...n,...e})]})}function O(e){const n=(0,I.A)();return(0,N.jsx)(C,{...e,children:p(e.children)},String(n))}},7461(e,n,t){t.r(n),t.d(n,{assets:()=>u,contentTitle:()=>d,default:()=>I,frontMatter:()=>l,loanExtendedDetails:()=>_,loanExtendedEdges:()=>h,loanExtendedNodes:()=>p,metadata:()=>s,toc:()=>m});const s=JSON.parse('{"id":"consumer/mcp/example3","title":"MCP Example 3 - Loan Application Extended","description":"This is the confirmation-first version of the loan flow built around the newer runtime behavior:","source":"@site/docs/v2/consumer/mcp/example3.mdx","sourceDirName":"consumer/mcp","slug":"/consumer/mcp/example3","permalink":"/docs/v2/consumer/mcp/example3","draft":false,"unlisted":false,"editUrl":"https://github.com/salilvnair/convengine-docs/tree/main/docs/v2/consumer/mcp/example3.mdx","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"title":"MCP Example 3 - Loan Application Extended","sidebar_position":5},"sidebar":"docSidebar","previous":{"title":"MCP Example 2 - Loan Application","permalink":"/docs/v2/consumer/mcp/example2"},"next":{"title":"REST API","permalink":"/docs/v2/api/rest-api"}}');var o=t(4848),r=t(8453),i=t(1470),a=t(9365),c=t(7555);const l={title:"MCP Example 3 - Loan Application Extended",sidebar_position:5},d="MCP Example 3 - Loan Application Extended",u={},p=[{id:"g",data:{label:"GREETING"}},{id:"i",data:{label:"IDLE -> ELIGIBILITY_GATE"}},{id:"s",data:{label:"SchemaExtractionStep"}},{id:"ps",data:{label:"POST_SCHEMA_EXTRACTION"}},{id:"c",data:{label:"CONFIRMATION"}},{id:"fix",data:{label:"CorrectionStep (EDIT)"}},{id:"ok",data:{label:"CorrectionStep (AFFIRM)"}},{id:"pm",data:{label:"PRE_AGENT_MCP"}},{id:"p",data:{label:"PROCESS_APPLICATION"}},{id:"t1",data:{label:"loan.credit.rating.check"}},{id:"t2",data:{label:"loan.credit.fraud.check"}},{id:"t3",data:{label:"loan.debt.credit.summary"}},{id:"t4",data:{label:"loan.application.submit"}},{id:"post",data:{label:"POST_AGENT_MCP"}},{id:"done",data:{label:"COMPLETED"}}],h=[{id:"e1",source:"g",target:"i"},{id:"e2",source:"i",target:"s"},{id:"e3",source:"s",target:"ps"},{id:"e4",source:"ps",target:"c"},{id:"e5",source:"c",target:"fix"},{id:"e6",source:"fix",target:"c"},{id:"e7",source:"c",target:"ok"},{id:"e8",source:"ok",target:"pm"},{id:"e9",source:"pm",target:"p"},{id:"e10",source:"p",target:"t1"},{id:"e11",source:"t1",target:"t2"},{id:"e12",source:"t2",target:"t3"},{id:"e13",source:"t3",target:"t4"},{id:"e14",source:"t4",target:"post"},{id:"e15",source:"post",target:"done"}],_={g:{title:"Greeting turn",stage:"REQUEST",summary:"User says hi. Normal greeting flow stays outside the loan path.",session:["intent=GREETING","state=IDLE"],tables:["ce_intent_classifier (R)","ce_response (R)","ce_audit (W)"]},i:{title:"Loan intake bootstrap",stage:"POST_AGENT_INTENT",summary:"Loan intent starts in IDLE, then rules move the flow into ELIGIBILITY_GATE.",session:["intent=LOAN_APPLICATION","state=ELIGIBILITY_GATE"],tables:["ce_intent_classifier (R)","ce_rule (POST_AGENT_INTENT)","ce_audit (W)"]},s:{title:"Schema extraction",stage:"SCHEMA_EXTRACTION",summary:"Collects customerId, requestedAmount, and tenureMonths using the ELIGIBILITY_GATE schema + prompt template.",session:["context.customerId","context.requestedAmount","context.tenureMonths","schemaComplete"],tables:["ce_output_schema (R)","ce_prompt_template (SCHEMA_JSON)","ce_audit (W)"]},ps:{title:"Schema complete transition",stage:"POST_SCHEMA_EXTRACTION",summary:"When schemaComplete=true, the engine moves ELIGIBILITY_GATE -> CONFIRMATION and the active prompt template becomes the confirmation contract.",session:["state=CONFIRMATION","interaction_mode=CONFIRM"],tables:["ce_rule (POST_SCHEMA_EXTRACTION)","ce_audit (W)"]},c:{title:"Confirmation response",stage:"RESOLVE_RESPONSE",summary:"The confirmation prompt shows only the collected values and asks the user to proceed or correct them.",session:["state=CONFIRMATION"],tables:["ce_response (R)","ce_prompt_template (TEXT)","ce_audit (W)"]},fix:{title:"In-place correction",stage:"CORRECTION",summary:"CorrectionStep patches only the changed field, keeps CONFIRMATION, and avoids full schema re-extraction.",session:["correction_applied=true","correction_target_field=requestedAmount"],tables:["ce_audit (W)","ce_verbose (optional R)"]},ok:{title:"Confirmation accepted",stage:"CORRECTION",summary:"AFFIRM in confirmation sets routing_decision=PROCEED_CONFIRMED.",session:["routing_decision=PROCEED_CONFIRMED"],tables:["ce_audit (W)","ce_verbose (optional R)"]},pm:{title:"Pre-MCP gate",stage:"PRE_AGENT_MCP",summary:"Rule checks routing_decision and moves CONFIRMATION -> PROCESS_APPLICATION just before MCP starts.",session:["state=PROCESS_APPLICATION"],tables:["ce_rule (PRE_AGENT_MCP)","ce_audit (W)"]},p:{title:"Processing state",stage:"MCP_PLAN",summary:"Planner and tools are scoped to PROCESS_APPLICATION only, so no APIs run before user confirmation.",session:["state=PROCESS_APPLICATION","context.mcp.lifecycle active"],tables:["ce_mcp_planner (R)","ce_mcp_tool (R)","ce_audit (W)"]},t1:{title:"Credit rating",stage:"MCP_TOOL_CALL",summary:"Tool 1 checks credit rating.",session:["context.mcp.observations[0]=credit rating"],tables:["ce_audit (W)","ce_verbose (optional R)"]},t2:{title:"Fraud check",stage:"MCP_TOOL_CALL",summary:"Tool 2 runs only when rating passes the threshold.",session:["context.mcp.observations[1]=fraud result"],tables:["ce_audit (W)"]},t3:{title:"Debt summary",stage:"MCP_TOOL_CALL",summary:"Tool 3 evaluates dti and availableCredit.",session:["context.mcp.observations[2]=debt profile"],tables:["ce_audit (W)"]},t4:{title:"Application submit",stage:"MCP_TOOL_CALL",summary:"Tool 4 submits the loan application when all prior checks pass.",session:["context.mcp.observations[3]=submit result"],tables:["ce_audit (W)","ce_verbose (optional R)"]},post:{title:"Final MCP transition",stage:"POST_AGENT_MCP",summary:"When context.mcp.finalAnswer exists, rules move PROCESS_APPLICATION -> COMPLETED.",session:["state=COMPLETED","context.mcp.finalAnswer set"],tables:["ce_rule (POST_AGENT_MCP)","ce_audit (W)"]},done:{title:"Completed response",stage:"ASSISTANT_OUTPUT",summary:"The completed response uses context.mcp.finalAnswer as the primary answer and validates against MCP observations.",session:["final payload returned"],tables:["ce_response (R)","ce_prompt_template (TEXT)","ce_conversation (W)","ce_audit (W)"]}},m=[{value:"Flow summary",id:"flow-summary",level:2},{value:"Why this flow is the recommended pattern",id:"why-this-flow-is-the-recommended-pattern",level:2},{value:"Post-schema, pre-MCP control points",id:"post-schema-pre-mcp-control-points",level:2},{value:"How confirmation turns should work",id:"how-confirmation-turns-should-work",level:2},{value:"How to apply rules on \u201cyes\u201d, \u201cgo ahead\u201d, and similar replies",id:"how-to-apply-rules-on-yes-go-ahead-and-similar-replies",level:2},{value:"How retry should work after MCP failure",id:"how-retry-should-work-after-mcp-failure",level:2},{value:"How to avoid another schema extraction call",id:"how-to-avoid-another-schema-extraction-call",level:2},{value:"How partial edits should work",id:"how-partial-edits-should-work",level:2},{value:"Recommended step-level strategy",id:"recommended-step-level-strategy",level:2}];function T(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",ul:"ul",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"mcp-example-3---loan-application-extended",children:"MCP Example 3 - Loan Application Extended"})}),"\n",(0,o.jsx)(n.p,{children:"This is the confirmation-first version of the loan flow built around the newer runtime behavior:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"CorrectionStep"})," handles confirmation affirmations and in-place edits"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"POST_DIALOGUE_ACT"})," can override guarded dialogue-act output before interaction policy runs"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"POST_SCHEMA_EXTRACTION"})," moves the flow into confirmation once required data is complete"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"PRE_AGENT_MCP"})," delays MCP until the user explicitly confirms"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"SET_INPUT_PARAM"})," can mark confirmation runtime flags without extra Java code"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"SET_DIALOGUE_ACT"})," can safely promote an LLM candidate act (for example ",(0,o.jsx)(n.code,{children:"EDIT"}),") back into the final ",(0,o.jsx)(n.code,{children:"dialogue_act"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"ConvEngineVerboseAdapter"})," / ",(0,o.jsx)(n.code,{children:"ce_verbose"})," can emit custom progress messages for the confirm-and-process path"]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"This is the recommended state machine for the extended loan workflow:"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"IDLE -> ELIGIBILITY_GATE -> CONFIRMATION -> PROCESS_APPLICATION -> COMPLETED"})}),"\n",(0,o.jsx)(c.f4,{type:"warning",title:"Current demo seed gap",children:(0,o.jsxs)(n.p,{children:["The current ",(0,o.jsx)(n.code,{children:"convengine-demo"})," ",(0,o.jsx)(n.code,{children:"mcp_planner_seed.sql"})," still scopes the loan planner and tools to ",(0,o.jsx)(n.code,{children:"ELIGIBILITY_GATE"})," and closes directly to ",(0,o.jsx)(n.code,{children:"COMPLETED"}),". It does not yet model ",(0,o.jsx)(n.code,{children:"CONFIRMATION"})," and ",(0,o.jsx)(n.code,{children:"PROCESS_APPLICATION"}),". This example shows the missing shape to add."]})}),"\n",(0,o.jsx)(n.h2,{id:"flow-summary",children:"Flow summary"}),"\n",(0,o.jsx)(c.p,{title:"State flow",columns:["State","Purpose","What happens here"],rows:[["IDLE","Loan intake entry","Intent is recognized; rule moves into ELIGIBILITY_GATE."],["ELIGIBILITY_GATE","Required field collection","Schema extraction collects customerId, requestedAmount, tenureMonths."],["CONFIRMATION","User review","Show exact collected values; allow AFFIRM or EDIT."],["PROCESS_APPLICATION","MCP execution","Planner runs credit -> fraud -> debt -> submit in sequence."],["COMPLETED","Final answer","Derived response uses context.mcp.finalAnswer as the primary summary."]]}),"\n",(0,o.jsxs)(i.A,{groupId:"mcp-example-3",children:[(0,o.jsx)(a.A,{value:"chat",label:"Chat + Trace",default:!0,children:(0,o.jsxs)(c.cW,{children:[(0,o.jsx)(c._b,{role:"user",name:"Turn 1 - User",message:"Hi",info:["Greeting classifier matches.","Loan flow has not started yet."]}),(0,o.jsx)(c._b,{role:"assistant",name:"Turn 1 - Assistant",intent:"GREETING",state:"IDLE",message:"Hi, how can I help you today?",json:{intent:"GREETING",state:"IDLE"},tables:["ce_intent_classifier (R)","ce_response (R)","ce_audit (W)"],info:["Normal greeting response."]}),(0,o.jsx)(c._b,{role:"user",name:"Turn 2 - User",message:"I need a loan for my customer",info:["Loan classifier matches LOAN_APPLICATION.","POST_AGENT_INTENT rules move the flow into ELIGIBILITY_GATE."]}),(0,o.jsx)(c._b,{role:"assistant",name:"Turn 2 - Assistant",intent:"LOAN_APPLICATION",state:"ELIGIBILITY_GATE",message:"Please provide customerId, requestedAmount, and tenureMonths.",json:{intent:"LOAN_APPLICATION",state:"ELIGIBILITY_GATE",missing_fields:["customerId","requestedAmount","tenureMonths"]},tables:["ce_rule (POST_AGENT_INTENT)","ce_output_schema (R)","ce_response (R)","ce_prompt_template (R)","ce_audit (W)"],info:["Schema is incomplete, so the engine asks only for missing required fields."]}),(0,o.jsx)(c._b,{role:"user",name:"Turn 3 - User",message:"customer id 1234, 35000, 24 months",info:["Schema extraction fills all three required fields.","POST_SCHEMA_EXTRACTION can now move the flow into CONFIRMATION."]}),(0,o.jsx)(c._b,{role:"assistant",name:"Turn 3 - Assistant",intent:"LOAN_APPLICATION",state:"CONFIRMATION",message:"Please confirm: customerId 1234, requestedAmount 35000, tenureMonths 24. Proceed?",json:{state:"CONFIRMATION",interaction_mode:"CONFIRM",interaction_contract:{allows:["affirm","edit","reset"],expects:[]}},tables:["ce_output_schema (R)","ce_rule (POST_SCHEMA_EXTRACTION)","ce_response (R)","ce_prompt_template (R)","ce_audit (W)"],info:["Schema is complete.","No MCP tools run yet because the flow stops at confirmation first."]}),(0,o.jsx)(c._b,{role:"user",name:"Turn 4 - User",message:"Ohh wait, I missed one zero. Change amount to 350000.",info:["DialogueActStep should resolve EDIT.","CorrectionStep patches only requestedAmount in place."]}),(0,o.jsx)(c._b,{role:"assistant",name:"Turn 4 - Assistant",intent:"LOAN_APPLICATION",state:"CONFIRMATION",message:"Updated. Please confirm: customerId 1234, requestedAmount 350000, tenureMonths 24. Proceed?",json:{state:"CONFIRMATION",correction_applied:!0,correction_target_field:"requestedAmount"},tables:["ce_response (R)","ce_prompt_template (R)","ce_audit (W)","ce_verbose (optional R)"],info:["Only the amount changes.","The engine stays in CONFIRMATION and skips full schema re-extraction."]}),(0,o.jsx)(c._b,{role:"user",name:"Turn 5 - User",message:"Looks good, go ahead.",info:["DialogueActStep resolves AFFIRM.","CorrectionStep sets routing_decision=PROCEED_CONFIRMED."]}),(0,o.jsx)(c._b,{role:"assistant",name:"Turn 5 - Internal MCP Loop",intent:"LOAN_APPLICATION",state:"PROCESS_APPLICATION",message:"Confirmation accepted. Starting loan processing. PRE_AGENT_MCP moves to PROCESS_APPLICATION. Planner executes credit -> fraud -> debt -> submit.",json:{state:"PROCESS_APPLICATION",routing_decision:"PROCEED_CONFIRMED",mcp:{observations:[{toolCode:"loan.credit.rating.check",json:'{"creditRating":782}'},{toolCode:"loan.credit.fraud.check",json:'{"flagged":false}'},{toolCode:"loan.debt.credit.summary",json:'{"dti":0.31,"availableCredit":220000}'},{toolCode:"loan.application.submit",json:'{"applicationId":"APP-90817","status":"SUBMITTED"}'}]}},tables:["ce_rule (PRE_AGENT_MCP)","ce_mcp_planner (R)","ce_mcp_tool (R)","ce_audit (W)","ce_verbose (optional R)"],info:["Tools are now scoped to PROCESS_APPLICATION.","This is the missing step in the current demo seed."]}),(0,o.jsx)(c._b,{role:"assistant",name:"Turn 5 - Final",intent:"LOAN_APPLICATION",state:"COMPLETED",message:"Loan application submitted successfully for customer 1234. Requested amount: 350000, tenure: 24 months. Credit rating passed, fraud check clear, debt profile acceptable. Application ID: APP-90817.",json:{state:"COMPLETED",mcp:{finalAnswer:"Loan application submitted successfully for customer 1234. Requested amount: 350000, tenure: 24 months. Application ID: APP-90817.",lifecycle:{phase:"POST_AGENT_MCP",status:"ANSWER",outcome:"ANSWERED",finished:!0}}},tables:["ce_rule (POST_AGENT_MCP)","ce_response (R)","ce_prompt_template (R)","ce_conversation (W)","ce_audit (W)"],info:["POST_AGENT_MCP closes the flow only after context.mcp.finalAnswer exists.","COMPLETED response derives from final MCP context."]})]})}),(0,o.jsx)(a.A,{value:"flow",label:"Step Graph",children:(0,o.jsx)(c.il,{title:"Extended loan confirmation-first flow",subtitle:"IDLE -> ELIGIBILITY_GATE -> CONFIRMATION -> PROCESS_APPLICATION -> COMPLETED",nodes:p,edges:h,detailsById:_,defaultSelectedId:"s"})}),(0,o.jsxs)(a.A,{value:"tables",label:"Component Tables",children:[(0,o.jsx)(c.p,{title:"Table usage by phase",columns:["Phase","Reads","Writes","Why it matters"],rows:[["Intent bootstrap","ce_intent_classifier, ce_rule","ce_audit","Classifier starts in IDLE; rules move into ELIGIBILITY_GATE."],["Schema collection","ce_output_schema, ce_prompt_template, ce_response","ce_audit","Collect and ask only for missing fields."],["Schema complete gate","ce_rule","ce_audit","POST_SCHEMA_EXTRACTION moves to CONFIRMATION and can set runtime flags."],["Confirmation response","ce_response, ce_prompt_template","ce_audit","Shows exact collected values before any MCP call."],["Correction path","session/context, optional ce_verbose","ce_audit","Patch only the changed field and stay in CONFIRMATION."],["Pre-MCP gate","ce_rule","ce_audit","PRE_AGENT_MCP checks routing_decision and unlocks PROCESS_APPLICATION."],["Planner + tools","ce_mcp_planner, ce_mcp_tool","ce_audit","Run the credit/fraud/debt/submit chain only after confirmation."],["Post-MCP close","ce_rule","ce_audit","POST_AGENT_MCP moves PROCESS_APPLICATION -> COMPLETED."],["Final response","ce_response, ce_prompt_template","ce_conversation, ce_audit","Return the final derived summary from context.mcp.finalAnswer."]]}),(0,o.jsx)(c.p,{title:"What is missing from the current demo seed",columns:["Current seed","Missing piece","Needed for this example"],rows:[["Classifier starts LOAN_APPLICATION in ELIGIBILITY_GATE","No clean IDLE intake entry","Classifier starts in IDLE, then POST_AGENT_INTENT advances."],["Planner scoped to ELIGIBILITY_GATE","Runs too early","Planner row should be scoped to PROCESS_APPLICATION."],["Tools scoped to ELIGIBILITY_GATE","APIs can run before confirmation","Tool rows should be scoped to PROCESS_APPLICATION."],["POST_AGENT_MCP closes ELIGIBILITY_GATE -> COMPLETED","No confirmation checkpoint","Add CONFIRMATION and PROCESS_APPLICATION phases in between."],["No confirmation prompt row","No explicit user review step","Add CONFIRMATION TEXT prompt + response."],["No PRE_AGENT_MCP confirmation rule","No confirm-before-run gate","Route only after routing_decision=PROCEED_CONFIRMED."]]})]}),(0,o.jsx)(a.A,{value:"sql",label:"Complete SQL",children:(0,o.jsx)(c.vl,{title:"Extended loan flow DDL/DML",language:"sql",defaultOpen:!1,children:"-- ------------------------------------------------------------\n-- Intents\n-- ------------------------------------------------------------\n\nINSERT INTO ce_intent\n(intent_code, description, priority, enabled, created_at, display_name, llm_hint)\nVALUES\n('LOAN_APPLICATION', 'Loan application eligibility and submission workflow', 30, true, CURRENT_TIMESTAMP, 'Loan Application', 'Handle loan checks and submission using MCP APIs in strict sequence.');\n\nINSERT INTO ce_intent\n(intent_code, description, priority, enabled, created_at, display_name, llm_hint)\nVALUES\n('GREETING', 'When user greets you', 15, true, CURRENT_TIMESTAMP, 'GREETING', 'Reply with firm greetings');\n\nINSERT INTO ce_intent\n(intent_code, description, priority, enabled, created_at, display_name, llm_hint)\nVALUES\n('UNKNOWN', 'Fallback intent', 999, true, CURRENT_TIMESTAMP, 'Unknown', 'Fallback when no intent matches');\n\n-- ------------------------------------------------------------\n-- Intent classifier\n-- ------------------------------------------------------------\n\nINSERT INTO ce_intent_classifier\n(classifier_id, intent_code, state_code, rule_type, pattern, priority, enabled, description)\nVALUES\n(108, 'LOAN_APPLICATION', 'IDLE', 'REGEX',\n'(?i)\\b(loan|apply loan|personal loan|home loan|loan application)\\b',\n30, true, 'Loan application classifier -> start in IDLE');\n\n-- ------------------------------------------------------------\n-- Output schema (collect required fields in ELIGIBILITY_GATE)\n-- ------------------------------------------------------------\n\nINSERT INTO ce_output_schema\n(schema_id, intent_code, state_code, json_schema, description, enabled, priority)\nVALUES\n(\n109,\n'LOAN_APPLICATION',\n'ELIGIBILITY_GATE',\n'{\n  \"type\":\"object\",\n  \"required\":[\"customerId\",\"requestedAmount\",\"tenureMonths\"],\n  \"properties\":{\n    \"customerId\":{\"type\":\"string\",\"maxLength\":64,\"minLength\":1},\n    \"requestedAmount\":{\"type\":\"number\",\"minimum\":1000,\"maximum\":50000000},\n    \"tenureMonths\":{\"type\":\"integer\",\"minimum\":6,\"maximum\":480}\n  },\n  \"additionalProperties\":false\n}'::jsonb,\n'Loan application required fields before confirmation',\ntrue,\n1\n);\n\n-- ------------------------------------------------------------\n-- Prompt templates\n-- ------------------------------------------------------------\n\n-- Schema extraction prompt\nINSERT INTO ce_prompt_template\n(template_id, intent_code, state_code, response_type, system_prompt, user_prompt, temperature, interaction_mode, interaction_contract, enabled, created_at)\nVALUES\n(\n124,\n'LOAN_APPLICATION',\n'ELIGIBILITY_GATE',\n'SCHEMA_JSON',\n'You are a strict structured extractor for loan application fields.',\n'User input:\n{{resolved_user_input}}\n\nContext JSON:\n{{context}}\n\nExtract only:\n- customerId\n- requestedAmount\n- tenureMonths\n\nReturn actual values only if explicitly present in input/context.\nReturn null for missing values.\nReturn valid JSON only.',\n0.00,\n'COLLECT',\n'{\"allows\":[\"reset\"],\"expects\":[\"structured_input\"]}',\ntrue,\nCURRENT_TIMESTAMP\n);\n\n-- IDLE intake prompt\nINSERT INTO ce_prompt_template\n(template_id, intent_code, state_code, response_type, system_prompt, user_prompt, temperature, interaction_mode, interaction_contract, enabled, created_at)\nVALUES\n(\n122,\n'LOAN_APPLICATION',\n'IDLE',\n'TEXT',\n'You are a strict loan intake assistant.',\n'Ask the user for the required fields needed to start the loan application: customerId, requestedAmount, and tenureMonths.',\n0.00,\n'IDLE',\n'{\"allows\":[\"reset\"],\"expects\":[]}',\ntrue,\nCURRENT_TIMESTAMP\n);\n\n-- Intake / missing-fields response\nINSERT INTO ce_prompt_template\n(template_id, intent_code, state_code, response_type, system_prompt, user_prompt, temperature, interaction_mode, interaction_contract, enabled, created_at)\nVALUES\n(\n123,\n'LOAN_APPLICATION',\n'ELIGIBILITY_GATE',\n'TEXT',\n'You are a strict loan intake assistant.',\n'Context JSON:\n{{context}}\n\nIf {{missing_fields}} is not empty, ask only for the missing required fields.\nDo not confirm yet unless all required fields are present.',\n0.00,\n'COLLECT',\n'{\"allows\":[\"reset\"],\"expects\":[\"structured_input\"]}',\ntrue,\nCURRENT_TIMESTAMP\n);\n\n-- Confirmation response\nINSERT INTO ce_prompt_template\n(template_id, intent_code, state_code, response_type, system_prompt, user_prompt, temperature, interaction_mode, interaction_contract, enabled, created_at)\nVALUES\n(\n125,\n'LOAN_APPLICATION',\n'CONFIRMATION',\n'TEXT',\n'You are a strict confirmation assistant.',\n'Context JSON:\n{{context}}\n\nAsk the user to confirm exactly these values:\n\n- customerId: [[$'||'{context.customerId}]]\n- requestedAmount: [[$'||'{context.requestedAmount}]]\n- tenureMonths: [[$'||'{context.tenureMonths}]]\n\nIf correction_applied is true, mention that the value was updated.\nAsk: Proceed?',\n0.00,\n'CONFIRM',\n'{\"allows\":[\"affirm\",\"edit\",\"reset\"],\"expects\":[]}',\ntrue,\nCURRENT_TIMESTAMP\n);\n\n-- Processing / retry-enabled prompt (recommended so retry is contract-driven in PROCESS_APPLICATION)\nINSERT INTO ce_prompt_template\n(template_id, intent_code, state_code, response_type, system_prompt, user_prompt, temperature, interaction_mode, interaction_contract, enabled, created_at)\nVALUES\n(\n127,\n'LOAN_APPLICATION',\n'PROCESS_APPLICATION',\n'TEXT',\n'You are a strict loan workflow processor.',\n'Context JSON:\n{{context}}\n\nIf context.mcp.finalAnswer exists, return it directly.\nIf the latest MCP lifecycle shows an error, tell the user they can retry.\nOtherwise keep the reply concise and indicate processing is in progress.',\n0.00,\n'PROCESSING',\n'{\"allows\":[\"retry\",\"reset\"],\"expects\":[]}',\ntrue,\nCURRENT_TIMESTAMP\n);\n\n-- Final response\nINSERT INTO ce_prompt_template\n(template_id, intent_code, state_code, response_type, system_prompt, user_prompt, temperature, interaction_mode, interaction_contract, enabled, created_at)\nVALUES\n(\n126,\n'LOAN_APPLICATION',\n'COMPLETED',\n'TEXT',\n'You are a strict loan workflow summarizer.',\n'Context JSON:\n{{context}}\n\nUse context.mcp.finalAnswer as primary final answer.\nUse context.mcp.observations only to validate details.',\n0.00,\n'FINAL',\n'{\"allows\":[\"reset\"],\"expects\":[]}',\ntrue,\nCURRENT_TIMESTAMP\n);\n\n-- ------------------------------------------------------------\n-- Responses\n-- ------------------------------------------------------------\n\nINSERT INTO ce_response\n(response_id, intent_code, state_code, output_format, response_type, exact_text, derivation_hint, json_schema, priority, enabled, description, created_at)\nVALUES\n(\n223,\n'LOAN_APPLICATION',\n'IDLE',\n'TEXT',\n'DERIVED',\nNULL,\n'Ask the user for any missing required fields needed to start loan processing.',\nNULL,\n10,\ntrue,\n'Loan intake response',\nCURRENT_TIMESTAMP\n);\n\nINSERT INTO ce_response\n(response_id, intent_code, state_code, output_format, response_type, exact_text, derivation_hint, json_schema, priority, enabled, description, created_at)\nVALUES\n(\n224,\n'LOAN_APPLICATION',\n'ELIGIBILITY_GATE',\n'TEXT',\n'DERIVED',\nNULL,\n'If missing_fields is not empty, ask only for those fields.',\nNULL,\n20,\ntrue,\n'Loan missing-fields response',\nCURRENT_TIMESTAMP\n);\n\nINSERT INTO ce_response\n(response_id, intent_code, state_code, output_format, response_type, exact_text, derivation_hint, json_schema, priority, enabled, description, created_at)\nVALUES\n(\n225,\n'LOAN_APPLICATION',\n'CONFIRMATION',\n'TEXT',\n'DERIVED',\nNULL,\n'Display collected values and ask for confirmation. If correction_applied=true, mention the update first.',\nNULL,\n10,\ntrue,\n'Loan confirmation response',\nCURRENT_TIMESTAMP\n);\n\nINSERT INTO ce_response\n(response_id, intent_code, state_code, output_format, response_type, exact_text, derivation_hint, json_schema, priority, enabled, description, created_at)\nVALUES\n(\n226,\n'LOAN_APPLICATION',\n'COMPLETED',\n'TEXT',\n'DERIVED',\nNULL,\n'Use context.mcp.finalAnswer as primary answer. Include applicationId when present.',\nNULL,\n10,\ntrue,\n'Loan completed response',\nCURRENT_TIMESTAMP\n);\n\n-- Optional exact response while processing if you expose it\nINSERT INTO ce_response\n(response_id, intent_code, state_code, output_format, response_type, exact_text, derivation_hint, json_schema, priority, enabled, description, created_at)\nVALUES\n(\n227,\n'LOAN_APPLICATION',\n'PROCESS_APPLICATION',\n'TEXT',\n'EXACT',\n'Processing your loan application now.',\nNULL,\nNULL,\n50,\ntrue,\n'Optional processing placeholder',\nCURRENT_TIMESTAMP\n);\n\n-- ------------------------------------------------------------\n-- Rules\n-- ------------------------------------------------------------\n\n-- Move loan flow from UNKNOWN -> IDLE after intent\nINSERT INTO ce_rule\n(rule_id, phase, intent_code, state_code, rule_type, match_pattern, \"action\", action_value, priority, enabled, description, created_at)\nVALUES\n(\n128,\n'POST_AGENT_INTENT',\n'LOAN_APPLICATION',\n'UNKNOWN',\n'REGEX',\n'.*',\n'SET_STATE',\n'IDLE',\n10,\ntrue,\n'Move loan flow to IDLE when classifier returns UNKNOWN state',\nCURRENT_TIMESTAMP\n);\n\n-- Move IDLE -> ELIGIBILITY_GATE after intent\nINSERT INTO ce_rule\n(rule_id, phase, intent_code, state_code, rule_type, match_pattern, \"action\", action_value, priority, enabled, description, created_at)\nVALUES\n(\n129,\n'POST_AGENT_INTENT',\n'LOAN_APPLICATION',\n'IDLE',\n'REGEX',\n'.*',\n'SET_STATE',\n'ELIGIBILITY_GATE',\n20,\ntrue,\n'Move loan flow into ELIGIBILITY_GATE',\nCURRENT_TIMESTAMP\n);\n\n-- Once schema is complete, move to confirmation\nINSERT INTO ce_rule\n(rule_id, phase, intent_code, state_code, rule_type, match_pattern, \"action\", action_value, priority, enabled, description, created_at)\nVALUES\n(\n130,\n'POST_SCHEMA_EXTRACTION',\n'LOAN_APPLICATION',\n'ELIGIBILITY_GATE',\n'JSON_PATH',\n'$[?(@.schemaComplete == true)]',\n'SET_STATE',\n'CONFIRMATION',\n10,\ntrue,\n'Move to CONFIRMATION when schema is complete',\nCURRENT_TIMESTAMP\n);\n\n-- Safety net: if DialogueActStep guarded an LLM EDIT back to NEW_REQUEST, restore EDIT before policy runs\nINSERT INTO ce_rule\n(rule_id, phase, intent_code, state_code, rule_type, match_pattern, \"action\", action_value, priority, enabled, description, created_at)\nVALUES\n(\n135,\n'POST_DIALOGUE_ACT',\n'LOAN_APPLICATION',\n'ANY',\n'JSON_PATH',\n'$[?(@.inputParams.dialogue_act == ''NEW_REQUEST'' && @.inputParams.dialogue_act_source == ''REGEX_GUARD'' && @.inputParams.dialogue_act_llm_candidate == ''EDIT'')]',\n'SET_DIALOGUE_ACT',\n'{\"dialogueAct\":\"EDIT\",\"source\":\"POST_DIALOGUE_ACT_RULE\"}',\n5,\ntrue,\n'Promote guarded LLM EDIT back to EDIT before interaction policy',\nCURRENT_TIMESTAMP\n);\n\n-- If confirmation accepted, move to processing before MCP starts\nINSERT INTO ce_rule\n(rule_id, phase, intent_code, state_code, rule_type, match_pattern, \"action\", action_value, priority, enabled, description, created_at)\nVALUES\n(\n131,\n'PRE_AGENT_MCP',\n'LOAN_APPLICATION',\n'CONFIRMATION',\n'JSON_PATH',\n'$[?(@.inputParams.routing_decision == ''PROCEED_CONFIRMED'')]',\n'SET_STATE',\n'PROCESS_APPLICATION',\n10,\ntrue,\n'Move CONFIRMATION -> PROCESS_APPLICATION when user confirms',\nCURRENT_TIMESTAMP\n);\n\n-- Optional: if correction patch applied, keep explicit confirmation state\nINSERT INTO ce_rule\n(rule_id, phase, intent_code, state_code, rule_type, match_pattern, \"action\", action_value, priority, enabled, description, created_at)\nVALUES\n(\n132,\n'PRE_RESPONSE_RESOLUTION',\n'LOAN_APPLICATION',\n'CONFIRMATION',\n'JSON_PATH',\n'$[?(@.inputParams.correction_applied == true)]',\n'SET_STATE',\n'CONFIRMATION',\n50,\ntrue,\n'Stay in confirmation after correction patch',\nCURRENT_TIMESTAMP\n);\n\n-- When MCP final answer exists, finish the flow\nINSERT INTO ce_rule\n(rule_id, phase, intent_code, state_code, rule_type, match_pattern, \"action\", action_value, priority, enabled, description, created_at)\nVALUES\n(\n133,\n'POST_AGENT_MCP',\n'LOAN_APPLICATION',\n'PROCESS_APPLICATION',\n'JSON_PATH',\n'$[?(@.context.mcp.lifecycle.finished == true && @.context.mcp.lifecycle.error == false && @.context.mcp.finalAnswer != null && @.context.mcp.finalAnswer != '''')]',\n'SET_STATE',\n'COMPLETED',\n10,\ntrue,\n'Move PROCESS_APPLICATION -> COMPLETED only when MCP finishes successfully with final answer',\nCURRENT_TIMESTAMP\n);\n\n-- Example runtime flags using SET_INPUT_PARAM (optional)\nINSERT INTO ce_rule\n(rule_id, phase, intent_code, state_code, rule_type, match_pattern, \"action\", action_value, priority, enabled, description, created_at)\nVALUES\n(\n134,\n'POST_SCHEMA_EXTRACTION',\n'LOAN_APPLICATION',\n'ELIGIBILITY_GATE',\n'JSON_PATH',\n'$[?(@.schemaComplete == true)]',\n'SET_INPUT_PARAM',\n'{\"awaiting_confirmation\":true,\"confirmation_key\":\"LOAN_APPLICATION_CONFIRM\"}',\n11,\ntrue,\n'Legacy optional runtime flags when schema becomes complete (prompt-template interaction metadata is now preferred)',\nCURRENT_TIMESTAMP\n);\n\n-- ------------------------------------------------------------\n-- MCP planner\n-- ------------------------------------------------------------\n\nINSERT INTO ce_mcp_planner\n(planner_id, intent_code, state_code, system_prompt, user_prompt, enabled, created_at)\nVALUES\n(\n6202,\n'LOAN_APPLICATION',\n'PROCESS_APPLICATION',\n'You are an MCP planning agent for a loan application workflow.\nYou MUST follow tool order:\n1) loan.credit.rating.check\n2) If creditRating <= 750 => ANSWER reject\n3) Else loan.credit.fraud.check\n4) If flagged=true => ANSWER reject\n5) Else loan.debt.credit.summary\n6) If dti > 0.65 or availableCredit < requestedAmount*0.15 => ANSWER reject/manual-review\n7) Else loan.application.submit\n8) ANSWER with applicationId.\nReturn JSON only.',\n'User input:\n{{resolved_user_input}}\n\nContext JSON:\n{{context}}\n\nAvailable MCP tools:\n{{mcp_tools}}\n\nExisting MCP observations:\n{{mcp_observations}}\n\nReturn strict JSON:\n{\n\"action\":\"CALL_TOOL\" | \"ANSWER\",\n\"tool_code\":\"<tool_code_or_null>\",\n\"args\":{},\n\"answer\":\"<text_or_null>\"\n}',\ntrue,\nCURRENT_TIMESTAMP\n);\n\n-- ------------------------------------------------------------\n-- MCP tools (only visible in PROCESS_APPLICATION)\n-- ------------------------------------------------------------\n\nINSERT INTO ce_mcp_tool\n(tool_id, tool_code, tool_group, intent_code, state_code, enabled, description, created_at)\nVALUES\n(10201, 'loan.credit.rating.check', 'HTTP_API', 'LOAN_APPLICATION', 'PROCESS_APPLICATION', true, 'Step 1: credit rating check', CURRENT_TIMESTAMP),\n(10202, 'loan.credit.fraud.check', 'HTTP_API', 'LOAN_APPLICATION', 'PROCESS_APPLICATION', true, 'Step 2: fraud check', CURRENT_TIMESTAMP),\n(10203, 'loan.debt.credit.summary', 'HTTP_API', 'LOAN_APPLICATION', 'PROCESS_APPLICATION', true, 'Step 3: debt and credit summary', CURRENT_TIMESTAMP),\n(10204, 'loan.application.submit', 'HTTP_API', 'LOAN_APPLICATION', 'PROCESS_APPLICATION', true, 'Step 4: submit application', CURRENT_TIMESTAMP);\n\n-- ------------------------------------------------------------\n-- Optional ce_verbose rows for the new flow\n-- ------------------------------------------------------------\n\nINSERT INTO ce_verbose\n(verbose_id, intent_code, state_code, step_match, step_value, determinant, rule_id, tool_code, message, error_message, priority, enabled, created_at)\nVALUES\n(\n201,\n'LOAN_APPLICATION',\n'CONFIRMATION',\n'EXACT',\n'CorrectionStep',\n'CONFIRM_ACCEPT',\nNULL,\nNULL,\n'Confirmation accepted. Starting loan processing.',\n'Could not continue after confirmation.',\n10,\ntrue,\nCURRENT_TIMESTAMP\n),\n(\n202,\n'LOAN_APPLICATION',\n'CONFIRMATION',\n'EXACT',\n'CorrectionStep',\n'CORRECTION_PATCH_APPLIED',\nNULL,\nNULL,\n'Updated [[$'||'{correction_target_field}]]. Please confirm again.',\n'Could not apply the requested correction.',\n10,\ntrue,\nCURRENT_TIMESTAMP\n),\n(\n203,\n'LOAN_APPLICATION',\n'PROCESS_APPLICATION',\n'EXACT',\n'McpToolStep',\n'MCP_TOOL_CALL',\nNULL,\n'loan.application.submit',\n'Submitting loan application now.',\n'Loan submission failed.',\n10,\ntrue,\nCURRENT_TIMESTAMP\n);"})}),(0,o.jsxs)(a.A,{value:"conversation",label:"Expected Conversation",children:[(0,o.jsx)(c.p,{title:"Expected next conversation",columns:["Turn","User / System","Expected behavior"],rows:[["1","User: Hi","Intent GREETING, state IDLE, normal greeting response."],["2","User: I need a loan for my customer","Intent LOAN_APPLICATION, POST_AGENT_INTENT moves to ELIGIBILITY_GATE, ask for missing fields."],["3","User: customer id 1234, 35000, 24 months","Schema extraction fills all required fields, POST_SCHEMA_EXTRACTION moves to CONFIRMATION."],["4","Assistant","Please confirm: customerId 1234, requestedAmount 35000, tenureMonths 24. Proceed?"],["5","User: Ohh wait, I missed one zero. Change amount to 350000.","DialogueAct=EDIT, CorrectionStep patches requestedAmount only, stays in CONFIRMATION."],["6","Assistant","Updated. Please confirm: customerId 1234, requestedAmount 350000, tenureMonths 24. Proceed?"],["7","User: Looks good, go ahead.","DialogueAct=AFFIRM, routing_decision=PROCEED_CONFIRMED, PRE_AGENT_MCP moves to PROCESS_APPLICATION."],["8","System internal","Planner runs credit -> fraud -> debt -> submit in order."],["9","Assistant final","POST_AGENT_MCP moves to COMPLETED and returns the final loan summary."]]}),(0,o.jsxs)(c.f4,{type:"tip",title:"Natural-language correction note",children:[(0,o.jsx)(n.p,{children:"For the exact phrase \u201cI missed one zero, it is 350000\u201d, the cleanest path is:"}),(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"DialogueActStep"})," keeps the LLM candidate as ",(0,o.jsx)(n.code,{children:"dialogue_act_llm_candidate=EDIT"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"POST_DIALOGUE_ACT"})," can use ",(0,o.jsx)(n.code,{children:"SET_DIALOGUE_ACT"})," to restore ",(0,o.jsx)(n.code,{children:"EDIT"})," if the guarded final result stayed ",(0,o.jsx)(n.code,{children:"NEW_REQUEST"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"CorrectionStep"})," patches the field in place"]}),"\n"]}),(0,o.jsx)(n.p,{children:"Explicit forms like \u201cchange amount to 350000\u201d are still the most reliable with the current deterministic patch path."})]})]})]}),"\n",(0,o.jsx)(n.h2,{id:"why-this-flow-is-the-recommended-pattern",children:"Why this flow is the recommended pattern"}),"\n",(0,o.jsx)(n.p,{children:"This example exists to solve two common problems cleanly:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"\u201cI need rules after schema extraction, but before MCP starts.\u201d"}),"\n",(0,o.jsx)(n.li,{children:"\u201cI asked for confirmation, the user said yes, and I do not want to run schema extraction again.\u201d"}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"The correct answer is not \u201cstuff more prompt context into every turn.\u201d The correct answer is to treat the turn type as a routing decision."}),"\n",(0,o.jsx)(n.h2,{id:"post-schema-pre-mcp-control-points",children:"Post-schema, pre-MCP control points"}),"\n",(0,o.jsx)(n.p,{children:"Use both phases, but for different reasons:"}),"\n",(0,o.jsx)(c.p,{title:"Why both rule phases exist",columns:["Phase","When it runs","Use it for"],rows:[["POST_SCHEMA_EXTRACTION","Immediately after schema merge and schemaComplete recompute","Move to CONFIRMATION, set confirmation flags, seed lightweight runtime variables."],["PRE_AGENT_MCP","At the start of MCP execution, just before planner/tool logic","Final gate for starting MCP, changing state, or skipping MCP entirely."]]}),"\n",(0,o.jsx)(n.p,{children:"In this loan flow:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"POST_SCHEMA_EXTRACTION"})," sees ",(0,o.jsx)(n.code,{children:"schemaComplete=true"})]}),"\n",(0,o.jsxs)(n.li,{children:["it sets ",(0,o.jsx)(n.code,{children:"state=CONFIRMATION"})]}),"\n",(0,o.jsxs)(n.li,{children:["the active ",(0,o.jsx)(n.code,{children:"ce_prompt_template"})," for ",(0,o.jsx)(n.code,{children:"CONFIRMATION"})," should use ",(0,o.jsx)(n.code,{children:"interaction_mode=CONFIRM"})]}),"\n",(0,o.jsxs)(n.li,{children:["optional ",(0,o.jsx)(n.code,{children:"interaction_contract"})," can allow ",(0,o.jsx)(n.code,{children:"affirm"}),", ",(0,o.jsx)(n.code,{children:"edit"}),", and ",(0,o.jsx)(n.code,{children:"reset"})]}),"\n",(0,o.jsxs)(n.li,{children:["optional ",(0,o.jsx)(n.code,{children:"POST_DIALOGUE_ACT"})," rule with ",(0,o.jsx)(n.code,{children:"SET_DIALOGUE_ACT"})," restores guarded LLM ",(0,o.jsx)(n.code,{children:"EDIT"})," before interaction policy runs"]}),"\n",(0,o.jsx)(n.li,{children:"user replies"}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"CorrectionStep"})," interprets the reply from prompt-template interaction metadata"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"PRE_AGENT_MCP"})," decides whether MCP should start"]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"That is the clean way to run rules after schema extraction but before MCP."}),"\n",(0,o.jsx)(n.h2,{id:"how-confirmation-turns-should-work",children:"How confirmation turns should work"}),"\n",(0,o.jsx)(n.p,{children:"When the engine asks:"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"Please confirm: customerId 1234, requestedAmount 350000, tenureMonths 24. Proceed?"})}),"\n",(0,o.jsx)(n.p,{children:"the next user turn should not be treated like a fresh extraction request."}),"\n",(0,o.jsx)(n.p,{children:"Use this shape instead:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"DialogueActStep"})," normalizes ",(0,o.jsx)(n.code,{children:"yes"}),", ",(0,o.jsx)(n.code,{children:"go ahead"}),", ",(0,o.jsx)(n.code,{children:"please do it"}),", ",(0,o.jsx)(n.code,{children:"looks good"})," into ",(0,o.jsx)(n.code,{children:"AFFIRM"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"CorrectionStep"})," checks the active prompt template (",(0,o.jsx)(n.code,{children:"interaction_mode=CONFIRM"}),") plus dialogue act"]}),"\n",(0,o.jsxs)(n.li,{children:["if the active template allows affirm and dialogue act is ",(0,o.jsx)(n.code,{children:"AFFIRM"}),", it sets a routing flag such as ",(0,o.jsx)(n.code,{children:"routing_decision=PROCEED_CONFIRMED"})]}),"\n",(0,o.jsx)(n.li,{children:"downstream steps skip expensive or unnecessary work"}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["This is why ",(0,o.jsx)(n.code,{children:"DialogueActStep"})," is crucial: rules should match on the normalized signal, not raw free-form text."]}),"\n",(0,o.jsx)(n.h2,{id:"how-to-apply-rules-on-yes-go-ahead-and-similar-replies",children:"How to apply rules on \u201cyes\u201d, \u201cgo ahead\u201d, and similar replies"}),"\n",(0,o.jsxs)(n.p,{children:["Do not write ",(0,o.jsx)(n.code,{children:"ce_rule"})," against raw strings like:"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"yes"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"go ahead"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"confirm"})}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"That is fragile and ambiguous."}),"\n",(0,o.jsx)(n.p,{children:"Use a scoped runtime pattern:"}),"\n",(0,o.jsx)(c.p,{title:"Confirmation interaction pattern",columns:["Variable","Who sets it","Why it exists"],rows:[["interaction_mode","ce_prompt_template","Marks that this turn is a confirmation checkpoint."],["interaction_contract","ce_prompt_template","Declares allowed capabilities such as affirm/edit/reset."],["routing_decision","CorrectionStep","Normalizes the next branch, for example PROCEED_CONFIRMED."],["skip_schema_extraction","CorrectionStep or later rule","Prevents another schema extraction call for confirm-accept turns."],["correction_applied","CorrectionStep","Lets confirmation response explain that a value was updated."]]}),"\n",(0,o.jsx)(n.p,{children:"Then your rules can check:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["current ",(0,o.jsx)(n.code,{children:"state"})]}),"\n",(0,o.jsxs)(n.li,{children:["active prompt-template ",(0,o.jsx)(n.code,{children:"interaction_mode"})]}),"\n",(0,o.jsxs)(n.li,{children:["active prompt-template ",(0,o.jsx)(n.code,{children:"interaction_contract"})]}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"dialogue_act"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"inputParams.routing_decision"})}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"That is much safer than parsing raw \u201cyes\u201d in SQL."}),"\n",(0,o.jsx)(n.h2,{id:"how-retry-should-work-after-mcp-failure",children:"How retry should work after MCP failure"}),"\n",(0,o.jsxs)(n.p,{children:["If an MCP call fails in ",(0,o.jsx)(n.code,{children:"PROCESS_APPLICATION"}),", the flow should stay in ",(0,o.jsx)(n.code,{children:"PROCESS_APPLICATION"}),", not jump to ",(0,o.jsx)(n.code,{children:"COMPLETED"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"Use this shape:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"POST_AGENT_MCP"})," completion rule matches only when ",(0,o.jsx)(n.code,{children:"context.mcp.lifecycle.finished == true"})," and ",(0,o.jsx)(n.code,{children:"context.mcp.lifecycle.error == false"})]}),"\n",(0,o.jsxs)(n.li,{children:["the ",(0,o.jsx)(n.code,{children:"PROCESS_APPLICATION"})," prompt template uses ",(0,o.jsx)(n.code,{children:"interaction_mode=PROCESSING"})]}),"\n",(0,o.jsxs)(n.li,{children:["the ",(0,o.jsx)(n.code,{children:"PROCESS_APPLICATION"})," ",(0,o.jsx)(n.code,{children:"interaction_contract"})," includes ",(0,o.jsx)(n.code,{children:"retry"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"CorrectionStep"})," detects retry phrases like ",(0,o.jsx)(n.code,{children:"retry"}),", ",(0,o.jsx)(n.code,{children:"try again"}),", and ",(0,o.jsx)(n.code,{children:"again"})]}),"\n",(0,o.jsxs)(n.li,{children:["it sets ",(0,o.jsx)(n.code,{children:"routing_decision=RETRY_IN_PLACE"}),", ",(0,o.jsx)(n.code,{children:"skip_intent_resolution=true"}),", and ",(0,o.jsx)(n.code,{children:"skip_schema_extraction=true"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"McpToolStep"})," then runs again in the same state and re-calls the API"]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"That gives you deterministic retry behavior without depending on state-name parsing or arbitrary runtime flags."}),"\n",(0,o.jsx)(n.h2,{id:"how-to-avoid-another-schema-extraction-call",children:"How to avoid another schema extraction call"}),"\n",(0,o.jsx)(n.p,{children:"This is the key optimization."}),"\n",(0,o.jsx)(n.p,{children:"When the user has already supplied:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"customerId"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"requestedAmount"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"tenureMonths"})}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["and the engine is already in ",(0,o.jsx)(n.code,{children:"CONFIRMATION"}),", a reply like:"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"Looks good, go ahead."})}),"\n",(0,o.jsx)(n.p,{children:"should not trigger a full schema extraction again."}),"\n",(0,o.jsx)(n.p,{children:"Recommended behavior:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"DialogueActStep"})," returns ",(0,o.jsx)(n.code,{children:"AFFIRM"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"CorrectionStep"})," sees an active confirmation prompt (",(0,o.jsx)(n.code,{children:"interaction_mode=CONFIRM"}),")"]}),"\n",(0,o.jsxs)(n.li,{children:["it sets ",(0,o.jsx)(n.code,{children:"routing_decision=PROCEED_CONFIRMED"})]}),"\n",(0,o.jsxs)(n.li,{children:["it also sets ",(0,o.jsx)(n.code,{children:"skip_schema_extraction=true"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"SchemaExtractionStep"})," is skipped"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"PRE_AGENT_MCP"})," sees ",(0,o.jsx)(n.code,{children:"routing_decision=PROCEED_CONFIRMED"})," and moves to ",(0,o.jsx)(n.code,{children:"PROCESS_APPLICATION"})]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"That avoids:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"one more LLM call"}),"\n",(0,o.jsx)(n.li,{children:"redundant re-parsing of already-collected data"}),"\n",(0,o.jsx)(n.li,{children:"accidental mutation of existing schema values"}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"how-partial-edits-should-work",children:"How partial edits should work"}),"\n",(0,o.jsx)(n.p,{children:"When the user says:"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"Ohh wait, I missed one zero. Change amount to 350000."})}),"\n",(0,o.jsx)(n.p,{children:"the engine should not perform a full schema extraction from scratch."}),"\n",(0,o.jsxs)(n.p,{children:["Recommended ",(0,o.jsx)(n.code,{children:"CorrectionStep"})," behavior:"]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["detect ",(0,o.jsx)(n.code,{children:"dialogue_act=EDIT"})]}),"\n",(0,o.jsxs)(n.li,{children:["inspect existing schema in ",(0,o.jsx)(n.code,{children:"context"})]}),"\n",(0,o.jsxs)(n.li,{children:["patch only the changed field (",(0,o.jsx)(n.code,{children:"requestedAmount"}),")"]}),"\n",(0,o.jsxs)(n.li,{children:["keep untouched fields (",(0,o.jsx)(n.code,{children:"customerId"}),", ",(0,o.jsx)(n.code,{children:"tenureMonths"}),")"]}),"\n",(0,o.jsx)(n.li,{children:"recompute schema completeness"}),"\n",(0,o.jsxs)(n.li,{children:["stay in ",(0,o.jsx)(n.code,{children:"CONFIRMATION"})]}),"\n",(0,o.jsxs)(n.li,{children:["set:","\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"correction_applied=true"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"correction_target_field=requestedAmount"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"skip_schema_extraction=true"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"Then the assistant re-renders the confirmation view with only the changed value updated."}),"\n",(0,o.jsx)(n.p,{children:"That is exactly why this example uses:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"CONFIRMATION"})," as a dedicated state"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"CorrectionStep"})," before rework"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"SET_INPUT_PARAM"})," for lightweight runtime flags"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"SET_DIALOGUE_ACT"})," for safe post-classification dialogue-act overrides"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"PRE_AGENT_MCP"})," as the final start gate"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"recommended-step-level-strategy",children:"Recommended step-level strategy"}),"\n",(0,o.jsx)(n.p,{children:"For confirmation-first business flows, the best pipeline behavior is:"}),"\n",(0,o.jsx)(c.p,{title:"Recommended routing behavior",columns:["Situation","What should happen","What should be skipped"],rows:[["Schema just became complete","POST_SCHEMA_EXTRACTION moves to CONFIRMATION","No MCP yet"],["User AFFIRM in CONFIRMATION","CorrectionStep sets routing_decision and PRE_AGENT_MCP starts MCP","Skip schema extraction; usually skip intent re-resolution"],["User EDIT in CONFIRMATION","CorrectionStep patches the field and re-confirms","Skip full schema extraction when patch is deterministic"],["User reply is ambiguous","Fall back to clarification or a small patch path","Do not blindly rerun the full flow"]]}),"\n",(0,o.jsx)(c.f4,{type:"tip",title:"The design principle",children:(0,o.jsxs)(n.p,{children:["Keep control in structured runtime state (",(0,o.jsx)(n.code,{children:"inputParams"}),", ",(0,o.jsx)(n.code,{children:"context"}),", ",(0,o.jsx)(n.code,{children:"dialogue_act"}),", ",(0,o.jsx)(n.code,{children:"routing_decision"}),") and keep prompts focused on wording. Use rules and steps for routing, not prompt text for control flow."]})})]})}function I(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(T,{...e})}):T(e)}},9365(e,n,t){t.d(n,{A:()=>i});t(6540);var s=t(4164);const o="tabItem_Ymn6";var r=t(4848);function i({children:e,hidden:n,className:t}){return(0,r.jsx)("div",{role:"tabpanel",className:(0,s.A)(o,t),hidden:n,children:e})}}}]);