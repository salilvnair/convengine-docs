"use strict";(globalThis.webpackChunkconvengine_docs=globalThis.webpackChunkconvengine_docs||[]).push([[9993],{3650(e,n,s){s.r(n),s.d(n,{assets:()=>t,contentTitle:()=>o,default:()=>x,frontMatter:()=>l,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"deep-dive/rules-responses","title":"Rules & Responses","description":"Rule phases","source":"@site/docs/v2/deep-dive/rules-responses.mdx","sourceDirName":"deep-dive","slug":"/deep-dive/rules-responses","permalink":"/docs/v2/deep-dive/rules-responses","draft":false,"unlisted":false,"editUrl":"https://github.com/salilvnair/convengine-docs/tree/main/docs/v2/deep-dive/rules-responses.mdx","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"title":"Rules & Responses","sidebar_position":6},"sidebar":"docSidebar","previous":{"title":"Intent & Schema","permalink":"/docs/v2/deep-dive/intent-and-schema"},"next":{"title":"MCP and Audit","permalink":"/docs/v2/deep-dive/mcp-audit"}}');var r=s(4848),c=s(8453),d=s(7555);const l={title:"Rules & Responses",sidebar_position:6},o="Rules and Response Resolution",t={},a=[{value:"Rule phases",id:"rule-phases",level:2},{value:"Why <code>POST_SCHEMA_EXTRACTION</code> and <code>PRE_AGENT_MCP</code> both matter",id:"why-post_schema_extraction-and-pre_agent_mcp-both-matter",level:2},{value:"Rule matching behavior",id:"rule-matching-behavior",level:2},{value:"Response resolution behavior",id:"response-resolution-behavior",level:2},{value:"<code>SET_INPUT_PARAM</code> patterns",id:"set_input_param-patterns",level:2},{value:"Operational guidance",id:"operational-guidance",level:2}];function h(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",ul:"ul",...(0,c.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"rules-and-response-resolution",children:"Rules and Response Resolution"})}),"\n",(0,r.jsx)(n.h2,{id:"rule-phases",children:"Rule phases"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"ce_rule.phase"})," supports:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"POST_DIALOGUE_ACT"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"PRE_RESPONSE_RESOLUTION"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"POST_AGENT_INTENT"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"POST_SCHEMA_EXTRACTION"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"PRE_AGENT_MCP"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"POST_AGENT_MCP"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"POST_TOOL_EXECUTION"})}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"RulesStep"})," writes phase/source/origin metadata into input params and audit payload for every pass."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"ce_rule.action"})," supports:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"SET_INTENT"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"SET_STATE"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"SET_DIALOGUE_ACT"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"SET_JSON"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"GET_CONTEXT"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"GET_SCHEMA_JSON"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"GET_SESSION"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"SET_TASK"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"SET_INPUT_PARAM"})}),"\n"]}),"\n",(0,r.jsxs)(n.h2,{id:"why-post_schema_extraction-and-pre_agent_mcp-both-matter",children:["Why ",(0,r.jsx)(n.code,{children:"POST_SCHEMA_EXTRACTION"})," and ",(0,r.jsx)(n.code,{children:"PRE_AGENT_MCP"})," both matter"]}),"\n",(0,r.jsx)(n.p,{children:"Use the two phases for different boundaries:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"POST_SCHEMA_EXTRACTION"}),": immediate shaping right after schema merge and schema-completeness recompute"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"PRE_AGENT_MCP"}),": last deterministic gate before planner/tool execution starts"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Typical confirmation-first flow:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"POST_SCHEMA_EXTRACTION"})," sees ",(0,r.jsx)(n.code,{children:"schemaComplete=true"})]}),"\n",(0,r.jsxs)(n.li,{children:["rule sets ",(0,r.jsx)(n.code,{children:"state=CONFIRMATION"})]}),"\n",(0,r.jsxs)(n.li,{children:["optional ",(0,r.jsx)(n.code,{children:"SET_INPUT_PARAM"})," writes ",(0,r.jsx)(n.code,{children:"awaiting_confirmation=true"})," and ",(0,r.jsx)(n.code,{children:"confirmation_key=..."})]}),"\n",(0,r.jsxs)(n.li,{children:["user responds with ",(0,r.jsx)(n.code,{children:"AFFIRM"})," / ",(0,r.jsx)(n.code,{children:"EDIT"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"POST_DIALOGUE_ACT"})," can use ",(0,r.jsx)(n.code,{children:"SET_DIALOGUE_ACT"})," if the final guarded act should be overridden before policy routing"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"CorrectionStep"})," sets runtime flags such as ",(0,r.jsx)(n.code,{children:"routing_decision"})," or ",(0,r.jsx)(n.code,{children:"correction_applied"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"PRE_AGENT_MCP"})," checks those flags and decides whether MCP should start"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"rule-matching-behavior",children:"Rule matching behavior"}),"\n",(0,r.jsx)(n.p,{children:"For each pass:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"fetch by phase + session state"}),"\n",(0,r.jsxs)(n.li,{children:["check intent (",(0,r.jsx)(n.code,{children:"ANY"}),"/blank/null supported)"]}),"\n",(0,r.jsxs)(n.li,{children:["check state (",(0,r.jsx)(n.code,{children:"ANY"}),"/blank/null supported)"]}),"\n",(0,r.jsxs)(n.li,{children:["evaluate type resolver (",(0,r.jsx)(n.code,{children:"EXACT"}),", ",(0,r.jsx)(n.code,{children:"REGEX"}),", ",(0,r.jsx)(n.code,{children:"JSON_PATH"}),")"]}),"\n",(0,r.jsx)(n.li,{children:"execute action resolver"}),"\n",(0,r.jsx)(n.li,{children:"rerun pass if intent/state changed (max pass cap)"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Audit emitted for both outcomes:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"RULE_MATCH (AgentIntentResolver)"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"RULE_NO_MATCH (AgentIntentResolver)"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"RULE_MATCH (RulesStep)"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"RULE_NO_MATCH (RulesStep)"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"RULE_MATCH (McpToolStep)"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"RULE_NO_MATCH (McpToolStep)"})}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"RULE_APPLIED (...)"})," is additionally emitted when action execution mutates/executes the matched rule."]}),"\n",(0,r.jsx)(n.h2,{id:"response-resolution-behavior",children:"Response resolution behavior"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"ResponseResolutionStep"}),":"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"selects response template by intent/state/priority"}),"\n",(0,r.jsx)(n.li,{children:"resolves output format"}),"\n",(0,r.jsxs)(n.li,{children:["emits ",(0,r.jsx)(n.code,{children:"RESOLVE_RESPONSE*"})," audit stages"]}),"\n",(0,r.jsxs)(n.li,{children:["writes final payload (",(0,r.jsx)(n.code,{children:"EXACT"})," or ",(0,r.jsx)(n.code,{children:"DERIVED"}),")"]}),"\n"]}),"\n",(0,r.jsxs)(n.h2,{id:"set_input_param-patterns",children:[(0,r.jsx)(n.code,{children:"SET_INPUT_PARAM"})," patterns"]}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.code,{children:"SET_INPUT_PARAM"})," when you need lightweight runtime variables persisted in ",(0,r.jsx)(n.code,{children:"inputParams"})," instead of writing custom Java."]}),"\n",(0,r.jsx)(d.p,{title:"Common runtime-flag patterns",columns:["Scenario","Example action_value","Why it helps"],rows:[["Confirmation required",'{"awaiting_confirmation":true,"confirmation_key":"LOAN_APPLICATION_CONFIRM"}',"Marks the next turn as a confirmation-bound reply."],["Skip re-extraction",'{"skip_schema_extraction":true}',"Avoids another schema LLM call on confirm-accept or deterministic patch."],["Route after AFFIRM",'{"routing_decision":"PROCEED_CONFIRMED"}',"Lets PRE_AGENT_MCP or PRE_RESPONSE_RESOLUTION rules branch without parsing raw user text."],["Patch feedback",'{"correction_applied":true}',"Allows confirmation responses to mention that a value was updated."]]}),"\n",(0,r.jsx)(d.f4,{type:"tip",title:"Best practice for yes/no turns",children:(0,r.jsxs)(n.p,{children:["Do not write ",(0,r.jsx)(n.code,{children:"ce_rule"})," against raw \u201cyes\u201d, \u201cgo ahead\u201d, or \u201cconfirm\u201d text. Use ",(0,r.jsx)(n.code,{children:"DialogueActStep"})," (",(0,r.jsx)(n.code,{children:"AFFIRM"})," / ",(0,r.jsx)(n.code,{children:"NEGATE"}),") plus a scoped runtime flag such as ",(0,r.jsx)(n.code,{children:"awaiting_confirmation"})," or ",(0,r.jsx)(n.code,{children:"confirmation_key"}),"."]})}),"\n",(0,r.jsx)(n.h2,{id:"operational-guidance",children:"Operational guidance"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Keep fallback state responses (",(0,r.jsx)(n.code,{children:"ANY"}),"/",(0,r.jsx)(n.code,{children:"UNKNOWN"}),") for safety paths."]}),"\n",(0,r.jsx)(n.li,{children:"Keep at least one response for each terminal state."}),"\n",(0,r.jsxs)(n.li,{children:["Use phase-scoped rules instead of overloading one monolithic ",(0,r.jsx)(n.code,{children:"PRE_RESPONSE_RESOLUTION"})," pass."]}),"\n",(0,r.jsxs)(n.li,{children:["Use ",(0,r.jsx)(n.code,{children:"SET_INPUT_PARAM"})," when you need deterministic runtime flags without hardcoding more Java branching."]}),"\n",(0,r.jsxs)(n.li,{children:["For confirmation flows, combine ",(0,r.jsx)(n.code,{children:"DialogueActStep"})," + ",(0,r.jsx)(n.code,{children:"CorrectionStep"})," + ",(0,r.jsx)(n.code,{children:"SET_INPUT_PARAM"})," rather than rerunning full schema extraction on every turn."]}),"\n",(0,r.jsxs)(n.li,{children:["When guarded dialogue-act output needs a DB-driven override, use ",(0,r.jsx)(n.code,{children:"POST_DIALOGUE_ACT"})," + ",(0,r.jsx)(n.code,{children:"SET_DIALOGUE_ACT"})," instead of hardcoding workflow state names in Java."]}),"\n"]})]})}function x(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}}}]);