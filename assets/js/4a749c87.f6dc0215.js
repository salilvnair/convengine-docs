"use strict";(globalThis.webpackChunkconvengine_docs=globalThis.webpackChunkconvengine_docs||[]).push([[720],{1470(e,n,c){c.d(n,{A:()=>A});var r=c(6540),s=c(4164),l=c(7559),o=c(3104),t=c(6347),i=c(205),d=c(7485),a=c(1682),u=c(679);function h(e){return r.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function p(e){const{values:n,children:c}=e;return(0,r.useMemo)(()=>{const e=n??function(e){return h(e).map(({props:{value:e,label:n,attributes:c,default:r}})=>({value:e,label:n,attributes:c,default:r}))}(c);return function(e){const n=(0,a.XI)(e,(e,n)=>e.value===n.value);if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[n,c])}function x({value:e,tabValues:n}){return n.some(n=>n.value===e)}function j({queryString:e=!1,groupId:n}){const c=(0,t.W6)(),s=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,d.aZ)(s),(0,r.useCallback)(e=>{if(!s)return;const n=new URLSearchParams(c.location.search);n.set(s,e),c.replace({...c.location,search:n.toString()})},[s,c])]}function m(e){const{defaultValue:n,queryString:c=!1,groupId:s}=e,l=p(e),[o,t]=(0,r.useState)(()=>function({defaultValue:e,tabValues:n}){if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!x({value:e,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const c=n.find(e=>e.default)??n[0];if(!c)throw new Error("Unexpected error: 0 tabValues");return c.value}({defaultValue:n,tabValues:l})),[d,a]=j({queryString:c,groupId:s}),[h,m]=function({groupId:e}){const n=function(e){return e?`docusaurus.tab.${e}`:null}(e),[c,s]=(0,u.Dv)(n);return[c,(0,r.useCallback)(e=>{n&&s.set(e)},[n,s])]}({groupId:s}),_=(()=>{const e=d??h;return x({value:e,tabValues:l})?e:null})();(0,i.A)(()=>{_&&t(_)},[_]);return{selectedValue:o,selectValue:(0,r.useCallback)(e=>{if(!x({value:e,tabValues:l}))throw new Error(`Can't select invalid tab value=${e}`);t(e),a(e),m(e)},[a,m,l]),tabValues:l}}var _=c(2303);const v="tabList__CuJ",f="tabItem_LNqP";var T=c(4848);function b({className:e,block:n,selectedValue:c,selectValue:r,tabValues:l}){const t=[],{blockElementScrollPositionUntilNextRender:i}=(0,o.a_)(),d=e=>{const n=e.currentTarget,s=t.indexOf(n),o=l[s].value;o!==c&&(i(n),r(o))},a=e=>{let n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const c=t.indexOf(e.currentTarget)+1;n=t[c]??t[0];break}case"ArrowLeft":{const c=t.indexOf(e.currentTarget)-1;n=t[c]??t[t.length-1];break}}n?.focus()};return(0,T.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,s.A)("tabs",{"tabs--block":n},e),children:l.map(({value:e,label:n,attributes:r})=>(0,T.jsx)("li",{role:"tab",tabIndex:c===e?0:-1,"aria-selected":c===e,ref:e=>{t.push(e)},onKeyDown:a,onClick:d,...r,className:(0,s.A)("tabs__item",f,r?.className,{"tabs__item--active":c===e}),children:n??e},e))})}function g({lazy:e,children:n,selectedValue:c}){const l=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){const e=l.find(e=>e.props.value===c);return e?(0,r.cloneElement)(e,{className:(0,s.A)("margin-top--md",e.props.className)}):null}return(0,T.jsx)("div",{className:"margin-top--md",children:l.map((e,n)=>(0,r.cloneElement)(e,{key:n,hidden:e.props.value!==c}))})}function E(e){const n=m(e);return(0,T.jsxs)("div",{className:(0,s.A)(l.G.tabs.container,"tabs-container",v),children:[(0,T.jsx)(b,{...n,...e}),(0,T.jsx)(g,{...n,...e})]})}function A(e){const n=(0,_.A)();return(0,T.jsx)(E,{...e,children:h(e.children)},String(n))}},6852(e,n,c){c.r(n),c.d(n,{assets:()=>u,contentTitle:()=>a,default:()=>x,frontMatter:()=>d,metadata:()=>r,toc:()=>h});const r=JSON.parse('{"id":"consumer/mcp/advanced","title":"MCP Advanced Guide","description":"This page documents the production MCP model in ConvEngine 2.0.7, including planner guardrails, post-phase rules, and MCP context metadata used by cerule JSONPATH.","source":"@site/docs/v2/consumer/mcp/advanced.mdx","sourceDirName":"consumer/mcp","slug":"/consumer/mcp/advanced","permalink":"/docs/v2/consumer/mcp/advanced","draft":false,"unlisted":false,"editUrl":"https://github.com/salilvnair/convengine-docs/tree/main/docs/v2/consumer/mcp/advanced.mdx","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"title":"MCP Advanced Guide","sidebar_position":2},"sidebar":"docSidebar","previous":{"title":"MCP Basics","permalink":"/docs/v2/consumer/mcp/basics"},"next":{"title":"MCP HTTP Tool","permalink":"/docs/v2/consumer/mcp/http-tool"}}');var s=c(4848),l=c(8453),o=c(1470),t=c(9365),i=c(7555);const d={title:"MCP Advanced Guide",sidebar_position:2},a="MCP Advanced Guide (v2.0.7)",u={},h=[{value:"Read order",id:"read-order",level:2},{value:"Phase names (current)",id:"phase-names-current",level:2},{value:"Tool execution paths",id:"tool-execution-paths",level:2},{value:"Planner MCP path (<code>McpToolStep</code>)",id:"planner-mcp-path-mcptoolstep",level:3},{value:"Direct tool path (<code>ToolOrchestrationStep</code>)",id:"direct-tool-path-toolorchestrationstep",level:3},{value:"Guardrail blocked answer semantics",id:"guardrail-blocked-answer-semantics",level:2},{value:"MCP metadata model for rules",id:"mcp-metadata-model-for-rules",level:2},{value:"JSON_PATH patterns you can use in <code>ce_rule.match_pattern</code>",id:"json_path-patterns-you-can-use-in-ce_rulematch_pattern",level:2},{value:"Direct tool example (<code>POST_TOOL_EXECUTION</code>)",id:"direct-tool-example-post_tool_execution",level:2},{value:"<code>ce_mcp_tool</code> and <code>ce_mcp_planner</code> scoping rules",id:"ce_mcp_tool-and-ce_mcp_planner-scoping-rules",level:2},{value:"Planner prompt source (<code>ce_mcp_planner</code>)",id:"planner-prompt-source-ce_mcp_planner",level:2},{value:"SQL snippets",id:"sql-snippets",level:2}];function p(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"mcp-advanced-guide-v207",children:"MCP Advanced Guide (v2.0.7)"})}),"\n",(0,s.jsxs)(n.p,{children:["This page documents the production MCP model in ConvEngine ",(0,s.jsx)(n.code,{children:"2.0.7"}),", including planner guardrails, post-phase rules, and MCP context metadata used by ",(0,s.jsx)(n.code,{children:"ce_rule"})," JSON_PATH."]}),"\n",(0,s.jsx)(n.h2,{id:"read-order",children:"Read order"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/docs/v2/consumer/mcp/basics",children:"MCP Basics"})}),"\n",(0,s.jsx)(n.li,{children:"MCP Advanced Guide (this page)"}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/docs/v2/consumer/mcp/http-tool",children:"MCP HTTP Tool"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/docs/v2/consumer/mcp/deep-dive",children:"MCP Deep Dive"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/docs/v2/consumer/mcp/example1",children:"MCP Example 1"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/docs/v2/consumer/mcp/example2",children:"MCP Example 2"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"phase-names-current",children:"Phase names (current)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"PRE_RESPONSE_RESOLUTION"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"POST_AGENT_INTENT"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"POST_AGENT_MCP"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"POST_TOOL_EXECUTION"})}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Compatibility note: legacy values (",(0,s.jsx)(n.code,{children:"PIPELINE_RULES"}),", ",(0,s.jsx)(n.code,{children:"AGENT_POST_INTENT"}),", ",(0,s.jsx)(n.code,{children:"AGENT_POST_MCP"}),", ",(0,s.jsx)(n.code,{children:"TOOL_POST_EXECUTION"}),") are normalized at runtime."]}),"\n",(0,s.jsx)(n.h2,{id:"tool-execution-paths",children:"Tool execution paths"}),"\n",(0,s.jsxs)(n.h3,{id:"planner-mcp-path-mcptoolstep",children:["Planner MCP path (",(0,s.jsx)(n.code,{children:"McpToolStep"}),")"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Planner returns ",(0,s.jsx)(n.code,{children:"CALL_TOOL"})," or ",(0,s.jsx)(n.code,{children:"ANSWER"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Tool results are appended to ",(0,s.jsx)(n.code,{children:"context.mcp.observations"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["For ",(0,s.jsx)(n.code,{children:"ANSWER"}),", final text is written to ",(0,s.jsx)(n.code,{children:"context.mcp.finalAnswer"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Rules run in phase ",(0,s.jsx)(n.code,{children:"POST_AGENT_MCP"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"Response resolution runs after rule transitions."}),"\n"]}),"\n",(0,s.jsxs)(n.h3,{id:"direct-tool-path-toolorchestrationstep",children:["Direct tool path (",(0,s.jsx)(n.code,{children:"ToolOrchestrationStep"}),")"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Request contains ",(0,s.jsx)(n.code,{children:"tool_request"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"Exactly one tool executes."}),"\n",(0,s.jsxs)(n.li,{children:["Result stored in ",(0,s.jsx)(n.code,{children:"inputParams.tool_result"})," and ",(0,s.jsx)(n.code,{children:"context.mcp.toolExecution"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Rules run in phase ",(0,s.jsx)(n.code,{children:"POST_TOOL_EXECUTION"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"Response resolution runs with updated state/context."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"guardrail-blocked-answer-semantics",children:"Guardrail blocked answer semantics"}),"\n",(0,s.jsxs)(n.p,{children:["When ",(0,s.jsx)(n.code,{children:"MCP_STATUS=GUARDRAIL_BLOCKED_NEXT_TOOL"}),":"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"McpToolStep"})," writes fallback text (",(0,s.jsx)(n.code,{children:"McpConstants.FALLBACK_GUARDRAIL_BLOCKED"}),") to ",(0,s.jsx)(n.code,{children:"context.mcp.finalAnswer"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Rules in ",(0,s.jsx)(n.code,{children:"POST_AGENT_MCP"})," still execute."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ce_response"})," remains the final response authority (commonly ",(0,s.jsx)(n.code,{children:"DERIVED"})," using ",(0,s.jsx)(n.code,{children:"context.mcp.finalAnswer"}),")."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"mcp-metadata-model-for-rules",children:"MCP metadata model for rules"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"context.mcp.lifecycle"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"phase"}),", ",(0,s.jsx)(n.code,{children:"status"}),", ",(0,s.jsx)(n.code,{children:"outcome"}),", ",(0,s.jsx)(n.code,{children:"finished"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"blocked"}),", ",(0,s.jsx)(n.code,{children:"error"}),", ",(0,s.jsx)(n.code,{children:"errorMessage"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"lastAction"}),", ",(0,s.jsx)(n.code,{children:"lastToolCode"}),", ",(0,s.jsx)(n.code,{children:"lastToolGroup"}),", ",(0,s.jsx)(n.code,{children:"lastToolArgs"})]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"toolExecuted"})}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"context.mcp.toolExecution"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"phase"}),", ",(0,s.jsx)(n.code,{children:"status"}),", ",(0,s.jsx)(n.code,{children:"outcome"}),", ",(0,s.jsx)(n.code,{children:"finished"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"error"}),", ",(0,s.jsx)(n.code,{children:"scopeMismatch"}),", ",(0,s.jsx)(n.code,{children:"toolExecuted"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"toolCode"}),", ",(0,s.jsx)(n.code,{children:"toolGroup"}),", ",(0,s.jsx)(n.code,{children:"meta"}),", ",(0,s.jsx)(n.code,{children:"result"}),", ",(0,s.jsx)(n.code,{children:"errorMessage"})]}),"\n"]}),"\n",(0,s.jsxs)(n.h2,{id:"json_path-patterns-you-can-use-in-ce_rulematch_pattern",children:["JSON_PATH patterns you can use in ",(0,s.jsx)(n.code,{children:"ce_rule.match_pattern"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"$[?(@.context.mcp.lifecycle.finished == true && @.context.mcp.lifecycle.outcome == 'BLOCKED')]\n$[?(@.context.mcp.lifecycle.error == true)]\n$[?(@.context.mcp.toolExecution.phase == 'POST_TOOL_EXECUTION' && @.context.mcp.toolExecution.status == 'SUCCESS')]\n$[?(@.context.mcp.toolExecution.scopeMismatch == true)]\n"})}),"\n",(0,s.jsxs)(n.h2,{id:"direct-tool-example-post_tool_execution",children:["Direct tool example (",(0,s.jsx)(n.code,{children:"POST_TOOL_EXECUTION"}),")"]}),"\n",(0,s.jsxs)(n.p,{children:["User asks: ",(0,s.jsx)(n.code,{children:"Check order ORD-7017 status."})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "tool_request": {\n    "tool_code": "mock.order.status",\n    "tool_group": "HTTP_API",\n    "args": { "orderId": "ORD-7017" }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Execution:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ToolOrchestrationStep"})," executes one tool."]}),"\n",(0,s.jsxs)(n.li,{children:["Writes ",(0,s.jsx)(n.code,{children:"tool_result"})," + ",(0,s.jsx)(n.code,{children:"tool_status=SUCCESS"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Writes ",(0,s.jsx)(n.code,{children:"context.mcp.toolExecution.*"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Executes ",(0,s.jsx)(n.code,{children:"POST_TOOL_EXECUTION"})," rules."]}),"\n",(0,s.jsxs)(n.li,{children:["Example: rule sets state to ",(0,s.jsx)(n.code,{children:"ORDER_SUBMITTED_DIAGNOSIS"})," when tool status is submitted."]}),"\n"]}),"\n",(0,s.jsxs)(n.h2,{id:"ce_mcp_tool-and-ce_mcp_planner-scoping-rules",children:[(0,s.jsx)(n.code,{children:"ce_mcp_tool"})," and ",(0,s.jsx)(n.code,{children:"ce_mcp_planner"})," scoping rules"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"intent_code"})," and ",(0,s.jsx)(n.code,{children:"state_code"})," are mandatory (no null/blank scope)."]}),"\n",(0,s.jsx)(n.p,{children:"Allowed values:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"intent_code"}),": defined ",(0,s.jsx)(n.code,{children:"ce_intent.intent_code"})," or ",(0,s.jsx)(n.code,{children:"ANY"})," or ",(0,s.jsx)(n.code,{children:"UNKNOWN"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"state_code"}),": values present in ",(0,s.jsx)(n.code,{children:"ce_rule.state_code"})," or ",(0,s.jsx)(n.code,{children:"ANY"})," or ",(0,s.jsx)(n.code,{children:"UNKNOWN"})]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Invalid scope rows are blocked at startup by static scope validation."}),"\n",(0,s.jsxs)(n.h2,{id:"planner-prompt-source-ce_mcp_planner",children:["Planner prompt source (",(0,s.jsx)(n.code,{children:"ce_mcp_planner"}),")"]}),"\n",(0,s.jsx)(n.p,{children:"Planner prompt selection:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["exact ",(0,s.jsx)(n.code,{children:"intent_code + state_code"})]}),"\n",(0,s.jsxs)(n.li,{children:["exact ",(0,s.jsx)(n.code,{children:"intent_code + ANY"})]}),"\n",(0,s.jsxs)(n.li,{children:["global ",(0,s.jsx)(n.code,{children:"ANY + ANY"})]}),"\n",(0,s.jsxs)(n.li,{children:["legacy fallback (",(0,s.jsx)(n.code,{children:"ce_config"})," ",(0,s.jsx)(n.code,{children:"McpPlanner"})," keys) if planner rows are unavailable"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"sql-snippets",children:"SQL snippets"}),"\n",(0,s.jsxs)(o.A,{groupId:"mcp-advanced-sql",children:[(0,s.jsx)(t.A,{value:"planner",label:"Planner Rows",default:!0,children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"INSERT INTO ce_mcp_planner (planner_id, intent_code, state_code, system_prompt, user_prompt, enabled)\nVALUES\n(1001, 'ANY', 'ANY', '...', '...', true),\n(1002, 'LOAN_APPLICATION', 'ELIGIBILITY_GATE', '...', '...', true);\n"})})}),(0,s.jsx)(t.A,{value:"tool",label:"Tool Rows",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"INSERT INTO ce_mcp_tool (tool_id, tool_code, tool_group, intent_code, state_code, enabled, description)\nVALUES\n(9001, 'db.knowledge.graph', 'DB', 'ANY', 'ANY', true, 'DB knowledge graph'),\n(9002, 'order.status.api', 'HTTP_API', 'ANY', 'ANY', true, 'Order status API');\n"})})})]}),"\n",(0,s.jsx)(i.f4,{type:"info",title:"Recommended response pattern",children:(0,s.jsxs)(n.p,{children:["For MCP chains, keep final user text in ",(0,s.jsx)(n.code,{children:"ce_response"}),"/",(0,s.jsx)(n.code,{children:"ce_prompt_template"})," and treat ",(0,s.jsx)(n.code,{children:"context.mcp.finalAnswer"})," as a derived source, not the final transport payload."]})})]})}function x(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}},9365(e,n,c){c.d(n,{A:()=>o});c(6540);var r=c(4164);const s="tabItem_Ymn6";var l=c(4848);function o({children:e,hidden:n,className:c}){return(0,l.jsx)("div",{role:"tabpanel",className:(0,r.A)(s,c),hidden:n,children:e})}}}]);