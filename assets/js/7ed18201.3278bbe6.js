"use strict";(globalThis.webpackChunkconvengine_docs=globalThis.webpackChunkconvengine_docs||[]).push([[3509],{1470(e,n,s){s.d(n,{A:()=>y});var t=s(6540),r=s(4164),o=s(7559),l=s(3104),i=s(6347),a=s(205),c=s(7485),d=s(1682),u=s(679);function p(e){return t.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,t.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function m(e){const{values:n,children:s}=e;return(0,t.useMemo)(()=>{const e=n??function(e){return p(e).map(({props:{value:e,label:n,attributes:s,default:t}})=>({value:e,label:n,attributes:s,default:t}))}(s);return function(e){const n=(0,d.XI)(e,(e,n)=>e.value===n.value);if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[n,s])}function h({value:e,tabValues:n}){return n.some(n=>n.value===e)}function x({queryString:e=!1,groupId:n}){const s=(0,i.W6)(),r=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,c.aZ)(r),(0,t.useCallback)(e=>{if(!r)return;const n=new URLSearchParams(s.location.search);n.set(r,e),s.replace({...s.location,search:n.toString()})},[r,s])]}function j(e){const{defaultValue:n,queryString:s=!1,groupId:r}=e,o=m(e),[l,i]=(0,t.useState)(()=>function({defaultValue:e,tabValues:n}){if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!h({value:e,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const s=n.find(e=>e.default)??n[0];if(!s)throw new Error("Unexpected error: 0 tabValues");return s.value}({defaultValue:n,tabValues:o})),[c,d]=x({queryString:s,groupId:r}),[p,j]=function({groupId:e}){const n=function(e){return e?`docusaurus.tab.${e}`:null}(e),[s,r]=(0,u.Dv)(n);return[s,(0,t.useCallback)(e=>{n&&r.set(e)},[n,r])]}({groupId:r}),_=(()=>{const e=c??p;return h({value:e,tabValues:o})?e:null})();(0,a.A)(()=>{_&&i(_)},[_]);return{selectedValue:l,selectValue:(0,t.useCallback)(e=>{if(!h({value:e,tabValues:o}))throw new Error(`Can't select invalid tab value=${e}`);i(e),d(e),j(e)},[d,j,o]),tabValues:o}}var _=s(2303);const v="tabList__CuJ",b="tabItem_LNqP";var T=s(4848);function g({className:e,block:n,selectedValue:s,selectValue:t,tabValues:o}){const i=[],{blockElementScrollPositionUntilNextRender:a}=(0,l.a_)(),c=e=>{const n=e.currentTarget,r=i.indexOf(n),l=o[r].value;l!==s&&(a(n),t(l))},d=e=>{let n=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const s=i.indexOf(e.currentTarget)+1;n=i[s]??i[0];break}case"ArrowLeft":{const s=i.indexOf(e.currentTarget)-1;n=i[s]??i[i.length-1];break}}n?.focus()};return(0,T.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.A)("tabs",{"tabs--block":n},e),children:o.map(({value:e,label:n,attributes:t})=>(0,T.jsx)("li",{role:"tab",tabIndex:s===e?0:-1,"aria-selected":s===e,ref:e=>{i.push(e)},onKeyDown:d,onClick:c,...t,className:(0,r.A)("tabs__item",b,t?.className,{"tabs__item--active":s===e}),children:n??e},e))})}function f({lazy:e,children:n,selectedValue:s}){const o=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){const e=o.find(e=>e.props.value===s);return e?(0,t.cloneElement)(e,{className:(0,r.A)("margin-top--md",e.props.className)}):null}return(0,T.jsx)("div",{className:"margin-top--md",children:o.map((e,n)=>(0,t.cloneElement)(e,{key:n,hidden:e.props.value!==s}))})}function E(e){const n=j(e);return(0,T.jsxs)("div",{className:(0,r.A)(o.G.tabs.container,"tabs-container",v),children:[(0,T.jsx)(g,{...n,...e}),(0,T.jsx)(f,{...n,...e})]})}function y(e){const n=(0,_.A)();return(0,T.jsx)(E,{...e,children:p(e.children)},String(n))}},3744(e,n,s){s.r(n),s.d(n,{assets:()=>u,contentTitle:()=>d,default:()=>_,frontMatter:()=>c,liveExampleDetails:()=>h,liveExampleEdges:()=>m,liveExampleNodes:()=>p,metadata:()=>t,toc:()=>x});const t=JSON.parse('{"id":"consumer/mcp/example1","title":"MCP Example 1 (Mockey + Demo)","description":"This guide shows a complete local test of ConvEngine 2.0.7 advanced MCP HTTP tools using convengine-demo and mockey.","source":"@site/docs/v2/consumer/mcp/example1.mdx","sourceDirName":"consumer/mcp","slug":"/consumer/mcp/example1","permalink":"/docs/v2/consumer/mcp/example1","draft":false,"unlisted":false,"editUrl":"https://github.com/salilvnair/convengine-docs/tree/main/docs/v2/consumer/mcp/example1.mdx","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"MCP Example 1 (Mockey + Demo)","sidebar_position":3},"sidebar":"docSidebar","previous":{"title":"MCP Deep Dive","permalink":"/docs/v2/consumer/mcp/deep-dive"},"next":{"title":"MCP Example 2 - Loan Application","permalink":"/docs/v2/consumer/mcp/example2"}}');var r=s(4848),o=s(8453),l=s(1470),i=s(9365),a=s(7555);const c={title:"MCP Example 1 (Mockey + Demo)",sidebar_position:3},d="MCP Example 1 (ConvEngine Demo + Mockey)",u={},p=[{id:"u1",data:{label:"User Input"}},{id:"i1",data:{label:"Intent + State Resolution"}},{id:"m1",data:{label:"McpToolStep: plan #1"}},{id:"t1",data:{label:"Tool call: mock.order.status"}},{id:"m2",data:{label:"McpToolStep: plan #2"}},{id:"t2",data:{label:"Tool call: mock.order.async.trace"}},{id:"m3",data:{label:"McpToolStep: ANSWER"}},{id:"r2",data:{label:"Rule: ANALYZE -> COMPLETED (POST_AGENT_MCP)"}},{id:"r1",data:{label:"ResponseResolutionStep"}},{id:"out",data:{label:"Assistant Output"}}],m=[{id:"e1",source:"u1",target:"i1"},{id:"e2",source:"i1",target:"m1"},{id:"e3",source:"m1",target:"t1"},{id:"e4",source:"t1",target:"m2"},{id:"e5",source:"m2",target:"t2"},{id:"e6",source:"t2",target:"m3"},{id:"e7",source:"m3",target:"r2"},{id:"e8",source:"r2",target:"r1"},{id:"e9",source:"r1",target:"out"}],h={u1:{title:"User Input",stage:"REQUEST",summary:"User asks order status/callback question.",session:["userText captured"],tables:["ce_audit (W)"]},i1:{title:"Intent + State Resolution",stage:"INTENT",summary:"Classifier and rules set runtime intent/state for tool eligibility.",session:["intent/state resolved"],tables:["ce_intent (R)","ce_intent_classifier (R)","ce_rule (R)","ce_audit (W)"]},m1:{title:"McpToolStep plan #1",stage:"MCP_PLAN_LLM_OUTPUT",summary:"Planner selects first tool based on prompt and available tools.",session:["mcp_action=CALL_TOOL","mcp_tool_code=mock.order.status"],tables:["ce_mcp_tool (R)","ce_mcp_planner (R)","ce_audit (W)"]},t1:{title:"Tool call: mock.order.status",stage:"MCP_TOOL_RESULT",summary:"HTTP tool executes via HttpApiToolInvoker and returns mapped payload.",session:["mcp.observations[0] written"],tables:["ce_audit (W)"]},m2:{title:"McpToolStep plan #2",stage:"MCP_PLAN_LLM_OUTPUT",summary:"Planner sees first observation and requests async trace tool.",session:["mcp_tool_code=mock.order.async.trace"],tables:["ce_mcp_tool (R)","ce_mcp_planner (R)","ce_audit (W)"]},t2:{title:"Tool call: mock.order.async.trace",stage:"MCP_TOOL_RESULT",summary:"Second observation appended to context.mcp.observations.",session:["mcp.observations[1] written"],tables:["ce_audit (W)"]},m3:{title:"McpToolStep ANSWER",stage:"MCP_FINAL_ANSWER",summary:"Planner returns final answer and it is stored in context.mcp.finalAnswer.",session:["mcp_final_answer set","mcp_status=ANSWER"],tables:["ce_audit (W)"]},r2:{title:"Post-MCP transition",stage:"POST_AGENT_MCP",summary:"If context.mcp.finalAnswer exists, rule moves ORDER_DIAGNOSTICS from ANALYZE to COMPLETED.",session:["state=COMPLETED"],tables:["ce_rule (R)","ce_audit (W)"]},r1:{title:"ResponseResolutionStep",stage:"RESOLVE_RESPONSE",summary:"Resolves ce_response + ce_prompt_template for ORDER_DIAGNOSTICS+COMPLETED using MCP-enriched context.",session:["payload generated"],tables:["ce_response (R)","ce_prompt_template (R)","ce_audit (W)"]},out:{title:"Assistant Output",stage:"ASSISTANT_OUTPUT",summary:"Resolved output is returned and persisted.",session:["finalResult returned"],tables:["ce_conversation (W)","ce_conversation_history (W async)","ce_audit (W)"]}},x=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"What is already wired in demo",id:"what-is-already-wired-in-demo",level:2},{value:"Step 1: Start mockey",id:"step-1-start-mockey",level:2},{value:"Step 2: Quick endpoint smoke tests",id:"step-2-quick-endpoint-smoke-tests",level:2},{value:"Step 3: Start convengine-demo",id:"step-3-start-convengine-demo",level:2},{value:"Step 4: Seed MCP tools and planner prompts (SQL panel)",id:"step-4-seed-mcp-tools-and-planner-prompts-sql-panel",level:2},{value:"Step 5: Run as chat-style walkthrough",id:"step-5-run-as-chat-style-walkthrough",level:2},{value:"Step 6: Validate advanced HTTP behavior",id:"step-6-validate-advanced-http-behavior",level:2},{value:"Step 7: Verify MCP audit stages",id:"step-7-verify-mcp-audit-stages",level:2},{value:"MCP Output to Final Response (Deep Dive)",id:"mcp-output-to-final-response-deep-dive",level:2},{value:"Turn-by-Turn E2E (Tab View)",id:"turn-by-turn-e2e-tab-view",level:2},{value:"Example 1: Explicit prompt wiring (recommended)",id:"example-1-explicit-prompt-wiring-recommended",level:2},{value:"ReactFlow View",id:"reactflow-view",level:2},{value:"Optional planner-driven test",id:"optional-planner-driven-test",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Related pages",id:"related-pages",level:2}];function j(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"mcp-example-1-convengine-demo--mockey",children:"MCP Example 1 (ConvEngine Demo + Mockey)"})}),"\n",(0,r.jsxs)(n.p,{children:["This guide shows a complete local test of ConvEngine ",(0,r.jsx)(n.code,{children:"2.0.7"})," advanced MCP HTTP tools using ",(0,r.jsx)(n.code,{children:"convengine-demo"})," and ",(0,r.jsx)(n.a,{href:"https://github.com/salilvnair/mockey",children:"mockey"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"It covers:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["starting mock APIs in ",(0,r.jsx)(n.a,{href:"https://github.com/salilvnair/mockey",children:"mockey"})]}),"\n",(0,r.jsxs)(n.li,{children:["wiring demo MCP tools to ",(0,r.jsx)(n.a,{href:"https://github.com/salilvnair/mockey",children:"mockey"})," endpoints"]}),"\n",(0,r.jsxs)(n.li,{children:["seeding ",(0,r.jsx)(n.code,{children:"ce_mcp_tool"})," and planner prompts"]}),"\n",(0,r.jsx)(n.li,{children:"testing via SQL panel + chat requests"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/salilvnair/mockey",children:"mockey"})," repo available locally"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"convengine-demo"})," repo available locally"]}),"\n",(0,r.jsxs)(n.li,{children:["Postgres running for ",(0,r.jsx)(n.code,{children:"convengine-demo"})]}),"\n",(0,r.jsxs)(n.li,{children:["ConvEngine dependency ",(0,r.jsx)(n.code,{children:"2.0.7"})]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"what-is-already-wired-in-demo",children:"What is already wired in demo"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"convengine-demo"})," now includes four ",(0,r.jsx)(n.code,{children:"HttpApiRequestingToolHandler"})," mappings:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"mock.order.submit"})," -> ",(0,r.jsx)(n.code,{children:"POST /api/mock/order/submit"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"mock.order.status"})," -> ",(0,r.jsx)(n.code,{children:"GET /api/mock/order/status"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"mock.order.async.trace"})," -> ",(0,r.jsx)(n.code,{children:"GET /api/mock/order/async/trace"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"mock.customer.profile"})," -> ",(0,r.jsx)(n.code,{children:"GET /api/mock/customer/profile"})]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Base URL is configured by:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"convengine:\n  demo:\n    mockey:\n      base-url: http://localhost:31333\n      api-key: demo-live-key\n"})}),"\n",(0,r.jsxs)(n.h2,{id:"step-1-start-mockey",children:["Step 1: Start ",(0,r.jsx)(n.a,{href:"https://github.com/salilvnair/mockey",children:"mockey"})]}),"\n",(0,r.jsxs)(n.p,{children:["From ",(0,r.jsx)(n.a,{href:"https://github.com/salilvnair/mockey",children:"mockey"})," root:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"npm install\nnpm start\n"})}),"\n",(0,r.jsx)(n.p,{children:"Expected log:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-text",children:"listening to 31333\n"})}),"\n",(0,r.jsx)(n.h2,{id:"step-2-quick-endpoint-smoke-tests",children:"Step 2: Quick endpoint smoke tests"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'curl -s "http://localhost:31333/api/mock/order/status?orderId=ORD-7017"\ncurl -s "http://localhost:31333/api/mock/order/async/trace?orderId=ORD-7017"\ncurl -s "http://localhost:31333/api/mock/customer/profile?customerId=CUST-1001"\ncurl -s -X POST "http://localhost:31333/api/mock/order/submit" -H "Content-Type: application/json" -d \'{"orderId":"ORD-7017","customerId":"CUST-1001","submittedByRole":"ADMIN"}\'\n'})}),"\n",(0,r.jsx)(n.h2,{id:"step-3-start-convengine-demo",children:"Step 3: Start convengine-demo"}),"\n",(0,r.jsxs)(n.p,{children:["From ",(0,r.jsx)(n.code,{children:"convengine-demo"})," root:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"./mvnw spring-boot:run\n"})}),"\n",(0,r.jsx)(n.h2,{id:"step-4-seed-mcp-tools-and-planner-prompts-sql-panel",children:"Step 4: Seed MCP tools and planner prompts (SQL panel)"}),"\n",(0,r.jsxs)(n.p,{children:["Run ",(0,r.jsx)(n.code,{children:"convengine-demo/src/main/resources/sql/seed.sql"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"That seed includes the live MCP tools and ORDER_DIAGNOSTICS response/rule wiring (ANALYZE -> COMPLETED via POST_AGENT_MCP when context.mcp.finalAnswer exists):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"INSERT INTO ce_mcp_tool (tool_id, tool_code, tool_group, intent_code, state_code, enabled, description)\nVALUES\n(3, 'mock.order.submit', 'HTTP_API', 'ORDER_DIAGNOSTICS', 'ANALYZE', true, 'Submit order through mockey live API'),\n(4, 'mock.order.status', 'HTTP_API', 'ORDER_DIAGNOSTICS', 'ANALYZE', true, 'Fetch order status from mockey live API'),\n(5, 'mock.order.async.trace', 'HTTP_API', 'ORDER_DIAGNOSTICS', 'ANALYZE', true, 'Fetch async callback trace from mockey live API'),\n(6, 'mock.customer.profile', 'HTTP_API', 'ORDER_DIAGNOSTICS', 'ANALYZE', true, 'Fetch customer profile from mockey live API');\n"})}),"\n",(0,r.jsx)(n.p,{children:"Then seed planner prompts (framework seed) if your environment uses scoped MCP planner rows:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Postgres: ",(0,r.jsx)(n.code,{children:"convengine/src/main/resources/sql/mcp_planner_seed.sql"})," (or ",(0,r.jsx)(n.code,{children:"mcp_planner_seed_postgres.sql"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:["SQLite: ",(0,r.jsx)(n.code,{children:"convengine/src/main/resources/sql/mcp_planner_seed_sqlite.sql"})]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"step-5-run-as-chat-style-walkthrough",children:"Step 5: Run as chat-style walkthrough"}),"\n",(0,r.jsxs)(l.A,{groupId:"example1-chat-flow",children:[(0,r.jsx)(i.A,{value:"chat",label:"Conversation",default:!0,children:(0,r.jsxs)(a.cW,{children:[(0,r.jsx)(a._b,{role:"user",name:"Turn 1 - User",message:"Order ORD-7017 was submitted by admin, callback is still null. Can you check status and trace?",info:["Intent resolves to diagnostics scope.","Planner mode starts."]}),(0,r.jsx)(a._b,{role:"assistant",name:"Turn 1 - Assistant (internal MCP)",message:"Calling tools: mock.order.status -> mock.order.async.trace",json:{mcp:{observations:[{toolCode:"mock.order.status",json:'{"mapped":{"orderId":"ORD-7017","status":"SUBMITTED"}}'},{toolCode:"mock.order.async.trace",json:'{"mapped":{"orderId":"ORD-7017","callbackAt":null}}'}]}},tables:["ce_mcp_tool (R)","ce_mcp_planner (R)","ce_audit (W)"],info:["MCP loop runs until planner returns ANSWER.","Observations are written in context.mcp.observations."]}),(0,r.jsx)(a._b,{role:"assistant",name:"Turn 1 - Final Assistant Output",message:"Order ORD-7017 is submitted. Async callback is pending/missing, so no callback timestamp is available yet.",json:{mcp:{finalAnswer:"Order submitted, callback pending."}},tables:["ce_rule (R)","ce_response (R)","ce_prompt_template (R)","ce_conversation (W)"],info:["POST_AGENT_MCP moves ANALYZE -> COMPLETED when context.mcp.finalAnswer exists.","ResponseResolutionStep uses context + derivation_hint."]})]})}),(0,r.jsx)(i.A,{value:"turn-table",label:"Turn Table",children:(0,r.jsx)(a.p,{title:"Turn-by-turn summary",columns:["Turn/Phase","What happens","Tables touched","Output"],rows:[["Turn 1 / Planner loop","Planner selects status then async-trace tool.","ce_mcp_tool(R), ce_mcp_planner(R), ce_audit(W)","context.mcp.observations[]"],["Turn 1 / Planner answer","Planner writes final MCP answer.","ce_audit(W)","context.mcp.finalAnswer"],["Turn 1 / Post-MCP rule","POST_AGENT_MCP checks context.mcp.finalAnswer and moves state to COMPLETED.","ce_rule(R), ce_audit(W)","state=COMPLETED"],["Turn 1 / Response resolution","DERIVED response rendered from context for COMPLETED state.","ce_response(R), ce_prompt_template(R), ce_audit(W)","assistant text"]]})}),(0,r.jsxs)(i.A,{value:"api",label:"Request Payloads",children:[(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "userInput": "Order ORD-7017 was submitted by admin, callback is still null. Can you check status and trace?",\n  "contextJson": "{}",\n  "inputParams": {}\n}\n'})}),(0,r.jsx)(n.p,{children:"Direct deterministic tool payload (optional):"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "userInput": "Check order status",\n  "contextJson": "{}",\n  "inputParams": {\n    "tool_request": {\n      "tool_code": "mock.order.status",\n      "tool_group": "HTTP_API",\n      "args": {\n        "orderId": "ORD-7017"\n      }\n    }\n  }\n}\n'})})]})]}),"\n",(0,r.jsx)(n.h2,{id:"step-6-validate-advanced-http-behavior",children:"Step 6: Validate advanced HTTP behavior"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"HttpApiRequestingToolHandler"})," calls are executed by framework ",(0,r.jsx)(n.code,{children:"HttpApiToolInvoker"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"Observation payload will include:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"status"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"attempt"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"latencyMs"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"mapped"})}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Expected shape:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "status": 200,\n  "attempt": 1,\n  "latencyMs": 40,\n  "mapped": {\n    "orderId": "ORD-7017",\n    "status": "SUBMITTED",\n    "api4AsyncStatus": null\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"step-7-verify-mcp-audit-stages",children:"Step 7: Verify MCP audit stages"}),"\n",(0,r.jsx)(n.p,{children:"Check audit timeline in audit APIs for:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"TOOL_ORCHESTRATION_REQUEST"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"TOOL_ORCHESTRATION_RESULT"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"MCP_TOOL_CALL"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"MCP_TOOL_RESULT"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"mcp-output-to-final-response-deep-dive",children:"MCP Output to Final Response (Deep Dive)"}),"\n",(0,r.jsx)(n.p,{children:"This is the exact handoff path from MCP tools to response text/json in the same request turn:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"McpToolStep"})," clears stale ",(0,r.jsx)(n.code,{children:"context.mcp.*"})," at start of turn."]}),"\n",(0,r.jsxs)(n.li,{children:["Planner (",(0,r.jsx)(n.code,{children:"McpPlanner"}),") receives ",(0,r.jsx)(n.code,{children:"user_input"}),", ",(0,r.jsx)(n.code,{children:"context"}),", ",(0,r.jsx)(n.code,{children:"mcp_tools"}),", and current ",(0,r.jsx)(n.code,{children:"mcp_observations"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Each ",(0,r.jsx)(n.code,{children:"CALL_TOOL"})," result is appended into ",(0,r.jsx)(n.code,{children:"context.mcp.observations[]"})," as ",(0,r.jsx)(n.code,{children:"{toolCode, json}"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["When planner returns ",(0,r.jsx)(n.code,{children:"ANSWER"}),", step writes:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"context.mcp.finalAnswer"})}),"\n",(0,r.jsxs)(n.li,{children:["input param ",(0,r.jsx)(n.code,{children:"mcp_final_answer"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"RulesStep"})," runs ",(0,r.jsx)(n.code,{children:"POST_AGENT_MCP"})," phase; when context.mcp.finalAnswer exists, rule transitions ANALYZE -> COMPLETED."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ResponseResolutionStep"})," selects ",(0,r.jsx)(n.code,{children:"ce_response"})," for current intent/state."]}),"\n",(0,r.jsxs)(n.li,{children:["If selected response is ",(0,r.jsx)(n.code,{children:"DERIVED"}),", resolver selects matching ",(0,r.jsx)(n.code,{children:"ce_prompt_template"})," and invokes LLM with:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"rendered prompt"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"derivation_hint"})," from ",(0,r.jsx)(n.code,{children:"ce_response"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"session.contextDict()"})," as context (includes the MCP block)"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Final assistant output is audited (",(0,r.jsx)(n.code,{children:"ASSISTANT_OUTPUT"}),") and persisted."]}),"\n"]}),"\n",(0,r.jsx)(a.f4,{type:"tip",title:"Why this works",children:(0,r.jsxs)(n.p,{children:["Even if your template does not explicitly reference ",(0,r.jsx)(n.code,{children:"mcp_final_answer"}),", it still receives full context JSON. If ",(0,r.jsx)(n.code,{children:"context.mcp.observations"})," and ",(0,r.jsx)(n.code,{children:"context.mcp.finalAnswer"})," exist, response derivation can use them."]})}),"\n",(0,r.jsx)(n.h2,{id:"turn-by-turn-e2e-tab-view",children:"Turn-by-Turn E2E (Tab View)"}),"\n",(0,r.jsxs)(l.A,{groupId:"mcp-live-e2e",children:[(0,r.jsx)(i.A,{value:"planner-path",label:"Planner Path",default:!0,children:(0,r.jsx)(a.p,{title:"Natural language planner path (single request turn)",columns:["Loop/Step","What LLM deduces","Tables touched","Artifact produced"],rows:[["Intent+state phase","Question is an order diagnostics request in tool-eligible scope.","ce_intent(R), ce_intent_classifier(R), ce_rule(R), ce_audit(W)","resolved intent/state"],["MCP loop #1","Need order status first.","ce_mcp_tool(R), ce_mcp_planner(R), ce_audit(W)","CALL_TOOL mock.order.status"],["Tool exec #1","HTTP mapped status payload available.","ce_audit(W)","context.mcp.observations[0]"],["MCP loop #2","Need callback trace to confirm async issue.","ce_mcp_tool(R), ce_mcp_planner(R), ce_audit(W)","CALL_TOOL mock.order.async.trace"],["Tool exec #2","Trace confirms callback missing/pending.","ce_audit(W)","context.mcp.observations[1]"],["MCP loop #3","Enough evidence; produce conclusion.","ce_mcp_planner(R), ce_audit(W)","context.mcp.finalAnswer + mcp_final_answer"],["Post-MCP rule","When context.mcp.finalAnswer exists, move ANALYZE to COMPLETED.","ce_rule(R), ce_audit(W)","state=COMPLETED"],["Response resolution","Render user-facing answer with MCP evidence.","ce_response(R), ce_prompt_template(R), ce_audit(W)","final payload"]]})}),(0,r.jsx)(i.A,{value:"direct-tool",label:"Direct tool_request",children:(0,r.jsx)(a.p,{title:"Deterministic direct tool path",columns:["Step","What happens","Tables touched","Output source"],rows:[["ToolOrchestrationStep","Executes exactly the requested tool without planner loop.","ce_mcp_tool(R), ce_audit(W)","inputParams.tool_request"],["HTTP execution","Handler + HttpApiToolInvoker returns mapped response.","ce_audit(W)","tool_result"],["Response resolution","Depending on response mapping, output may be EXACT or DERIVED.","ce_response(R), ce_prompt_template(R), ce_audit(W)","tool_result + context"]]})}),(0,r.jsx)(i.A,{value:"response-internals",label:"Response Internals",children:(0,r.jsx)(a.p,{title:"How response derivation consumes MCP data",columns:["Resolver input","Source","Example"],rows:[["context","session.contextJson (includes mcp.observations and mcp.finalAnswer)",'{"mcp":{"observations":[...],"finalAnswer":"..."}}'],["user_input","current request text","Order ORD-7017 was submitted by admin..."],["derivation_hint","ce_response.derivation_hint","Use MCP observations to explain status and callback condition."],["prompt template","ce_prompt_template by intent/state/output format","TEXT template for ORDER_DIAGNOSTICS + COMPLETED"],["LLM output","TextOutputFormatResolver / JsonOutputFormatResolver","final assistant payload"]]})})]}),"\n",(0,r.jsx)(n.h2,{id:"example-1-explicit-prompt-wiring-recommended",children:"Example 1: Explicit prompt wiring (recommended)"}),"\n",(0,r.jsx)(n.p,{children:"Keep it simple:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["direct ",(0,r.jsx)(n.code,{children:"tool_request"})," path uses ",(0,r.jsx)(n.code,{children:"inputParams.tool_result"})]}),"\n",(0,r.jsxs)(n.li,{children:["planner path uses ",(0,r.jsx)(n.code,{children:"context.mcp.observations"})," and ",(0,r.jsx)(n.code,{children:"context.mcp.finalAnswer"})]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Use these SQL updates so prompt behavior is explicit:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Direct tool_request path (ToolOrchestrationStep output)\nUPDATE ce_prompt_template\nSET user_prompt = 'User input: {{user_input}}\\nTool result: {{tool_result}}\\nContext: {{context}}\\nSummarize status and next action.'\nWHERE intent_code = 'FAQ' AND state_code = 'IDLE' AND response_type = 'JSON';\n\n-- Planner path (McpToolStep output)\nUPDATE ce_prompt_template\nSET user_prompt = 'Context JSON:\\n{{context}}\\n\\nRead context.mcp.observations and context.mcp.finalAnswer. Produce a concise diagnostic summary.'\nWHERE intent_code = 'ORDER_DIAGNOSTICS' AND state_code = 'COMPLETED' AND response_type = 'TEXT';\n"})}),"\n",(0,r.jsx)(n.p,{children:"ORDER_DIAGNOSTICS is now included in demo seed with POST_AGENT_MCP completion and DERIVED final response from context.mcp.finalAnswer."}),"\n",(0,r.jsx)(n.h2,{id:"reactflow-view",children:"ReactFlow View"}),"\n",(0,r.jsx)(a.il,{title:"MCP Live Request Execution",subtitle:"Planner loop, tool observations, and response resolution handoff.",nodes:p,edges:m,detailsById:h,defaultSelectedId:"m1"}),"\n",(0,r.jsx)(n.h2,{id:"optional-planner-driven-test",children:"Optional planner-driven test"}),"\n",(0,r.jsxs)(n.p,{children:["After deterministic ",(0,r.jsx)(n.code,{children:"tool_request"})," tests pass, ask natural prompts without ",(0,r.jsx)(n.code,{children:"tool_request"}),", for example:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"Order ORD-7017 was submitted by admin but async callback is null. Check status and trace."})}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Planner should choose one or more ",(0,r.jsx)(n.code,{children:"mock.*"})," tools based on descriptions and context."]}),"\n",(0,r.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"No HttpApiToolHandler..."}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["ensure ",(0,r.jsx)(n.code,{children:"convengine-demo"})," depends on ConvEngine ",(0,r.jsx)(n.code,{children:"2.0.7"})]}),"\n",(0,r.jsxs)(n.li,{children:["ensure handler ",(0,r.jsx)(n.code,{children:"toolCode()"})," matches DB ",(0,r.jsx)(n.code,{children:"ce_mcp_tool.tool_code"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["API not called:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["confirm ",(0,r.jsx)(n.a,{href:"https://github.com/salilvnair/mockey",children:"mockey"})," running on ",(0,r.jsx)(n.code,{children:"31333"})]}),"\n",(0,r.jsxs)(n.li,{children:["confirm ",(0,r.jsx)(n.code,{children:"convengine.demo.mockey.base-url"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["tool not found:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["re-run ",(0,r.jsx)(n.code,{children:"seed.sql"})]}),"\n",(0,r.jsxs)(n.li,{children:["verify ",(0,r.jsx)(n.code,{children:"ce_mcp_tool.enabled=true"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"related-pages",children:"Related pages"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/docs/v2/consumer/mcp/basics",children:"MCP Basics"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/docs/v2/consumer/mcp/advanced",children:"MCP Advanced Guide"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/docs/v2/consumer/mcp/example2",children:"MCP Example 2 - Loan Application"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/docs/v2/consumer/caching-and-persistence",children:"Caching & Persistence"})}),"\n"]})]})}function _(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(j,{...e})}):j(e)}},9365(e,n,s){s.d(n,{A:()=>l});s(6540);var t=s(4164);const r="tabItem_Ymn6";var o=s(4848);function l({children:e,hidden:n,className:s}){return(0,o.jsx)("div",{role:"tabpanel",className:(0,t.A)(r,s),hidden:n,children:e})}}}]);