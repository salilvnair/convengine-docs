"use strict";(globalThis.webpackChunkconvengine_docs=globalThis.webpackChunkconvengine_docs||[]).push([[4367],{9098(e,n,c){c.r(n),c.d(n,{assets:()=>r,contentTitle:()=>o,default:()=>a,frontMatter:()=>i,metadata:()=>l,toc:()=>t});const l=JSON.parse('{"id":"deep-dive/mcp-audit","title":"MCP and Audit","description":"Two tool paths","source":"@site/docs/v2/deep-dive/mcp-audit.mdx","sourceDirName":"deep-dive","slug":"/deep-dive/mcp-audit","permalink":"/docs/v2/deep-dive/mcp-audit","draft":false,"unlisted":false,"editUrl":"https://github.com/salilvnair/convengine-docs/tree/main/docs/v2/deep-dive/mcp-audit.mdx","tags":[],"version":"current","sidebarPosition":10,"frontMatter":{"title":"MCP and Audit","sidebar_position":10},"sidebar":"docSidebar","previous":{"title":"Rules & Responses","permalink":"/docs/v2/deep-dive/rules-responses"},"next":{"title":"Detailed Features","permalink":"/docs/v2/deep-dive/v2-features"}}');var s=c(4848),d=c(8453);const i={title:"MCP and Audit",sidebar_position:10},o="MCP, Tool Orchestration, and Audit (v2)",r={},t=[{value:"Two tool paths",id:"two-tool-paths",level:2},{value:"Guardrail blocked branch",id:"guardrail-blocked-branch",level:2},{value:"Rule-ready MCP metadata",id:"rule-ready-mcp-metadata",level:2},{value:"JSON_PATH examples for <code>ce_rule.match_pattern</code>",id:"json_path-examples-for-ce_rulematch_pattern",level:2},{value:"Audit stages to watch",id:"audit-stages-to-watch",level:2},{value:"Scope enforcement",id:"scope-enforcement",level:2}];function h(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,d.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"mcp-tool-orchestration-and-audit-v2",children:"MCP, Tool Orchestration, and Audit (v2)"})}),"\n",(0,s.jsx)(n.h2,{id:"two-tool-paths",children:"Two tool paths"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ToolOrchestrationStep"})," (direct tool mode)"]}),"\n"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["request-driven via ",(0,s.jsx)(n.code,{children:"tool_request"})]}),"\n",(0,s.jsx)(n.li,{children:"executes one tool"}),"\n",(0,s.jsxs)(n.li,{children:["runs ",(0,s.jsx)(n.code,{children:"POST_TOOL_EXECUTION"})," rules"]}),"\n",(0,s.jsxs)(n.li,{children:["writes ",(0,s.jsx)(n.code,{children:"context.mcp.toolExecution.*"})]}),"\n"]}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"McpToolStep"})," (planner loop mode)"]}),"\n"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["planner loop (",(0,s.jsx)(n.code,{children:"CALL_TOOL"}),"/",(0,s.jsx)(n.code,{children:"ANSWER"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:["writes ",(0,s.jsx)(n.code,{children:"context.mcp.observations[]"})," and ",(0,s.jsx)(n.code,{children:"context.mcp.finalAnswer"})]}),"\n",(0,s.jsxs)(n.li,{children:["runs ",(0,s.jsx)(n.code,{children:"POST_AGENT_MCP"})," rules"]}),"\n",(0,s.jsxs)(n.li,{children:["writes ",(0,s.jsx)(n.code,{children:"context.mcp.lifecycle.*"})]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"guardrail-blocked-branch",children:"Guardrail blocked branch"}),"\n",(0,s.jsx)(n.p,{children:"If planner proposes a blocked next tool:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"mcp_status=GUARDRAIL_BLOCKED_NEXT_TOOL"})}),"\n",(0,s.jsxs)(n.li,{children:["fallback final text is written to ",(0,s.jsx)(n.code,{children:"context.mcp.finalAnswer"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"POST_AGENT_MCP"})," rules still run"]}),"\n",(0,s.jsxs)(n.li,{children:["response is still finalized by ",(0,s.jsx)(n.code,{children:"ce_response"})," resolution"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"rule-ready-mcp-metadata",children:"Rule-ready MCP metadata"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"context.mcp.lifecycle"})," includes:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"phase"}),", ",(0,s.jsx)(n.code,{children:"status"}),", ",(0,s.jsx)(n.code,{children:"outcome"}),", ",(0,s.jsx)(n.code,{children:"finished"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"blocked"}),", ",(0,s.jsx)(n.code,{children:"error"}),", ",(0,s.jsx)(n.code,{children:"errorMessage"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"lastAction"}),", ",(0,s.jsx)(n.code,{children:"lastToolCode"}),", ",(0,s.jsx)(n.code,{children:"lastToolGroup"}),", ",(0,s.jsx)(n.code,{children:"lastToolArgs"})]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"toolExecuted"})}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"context.mcp.toolExecution"})," includes:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"phase"}),", ",(0,s.jsx)(n.code,{children:"status"}),", ",(0,s.jsx)(n.code,{children:"outcome"}),", ",(0,s.jsx)(n.code,{children:"finished"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"error"}),", ",(0,s.jsx)(n.code,{children:"scopeMismatch"}),", ",(0,s.jsx)(n.code,{children:"toolExecuted"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"toolCode"}),", ",(0,s.jsx)(n.code,{children:"toolGroup"}),", ",(0,s.jsx)(n.code,{children:"meta"}),", ",(0,s.jsx)(n.code,{children:"result"}),", ",(0,s.jsx)(n.code,{children:"errorMessage"})]}),"\n"]}),"\n",(0,s.jsxs)(n.h2,{id:"json_path-examples-for-ce_rulematch_pattern",children:["JSON_PATH examples for ",(0,s.jsx)(n.code,{children:"ce_rule.match_pattern"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"$[?(@.context.mcp.lifecycle.finished == true && @.context.mcp.lifecycle.outcome == 'BLOCKED')]\n$[?(@.context.mcp.lifecycle.error == true)]\n$[?(@.context.mcp.toolExecution.phase == 'POST_TOOL_EXECUTION' && @.context.mcp.toolExecution.status == 'SUCCESS')]\n$[?(@.context.mcp.toolExecution.scopeMismatch == true)]\n"})}),"\n",(0,s.jsx)(n.h2,{id:"audit-stages-to-watch",children:"Audit stages to watch"}),"\n",(0,s.jsx)(n.p,{children:"Tool orchestration path:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"TOOL_ORCHESTRATION_REQUEST"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"TOOL_ORCHESTRATION_RESULT"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"TOOL_ORCHESTRATION_ERROR"})}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Planner MCP path:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"MCP_PLAN_LLM_INPUT"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"MCP_PLAN_LLM_OUTPUT"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"MCP_TOOL_CALL"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"MCP_TOOL_RESULT"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"MCP_TOOL_ERROR"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"MCP_FINAL_ANSWER"})}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Rule phases around these paths:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"RULE_MATCH (McpToolStep)"})," / ",(0,s.jsx)(n.code,{children:"RULE_NO_MATCH (McpToolStep)"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"RULE_MATCH (ToolOrchestrationStep PostTool)"})," / ",(0,s.jsx)(n.code,{children:"RULE_NO_MATCH (ToolOrchestrationStep PostTool)"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"RULE_MATCH (AgentIntentResolver)"})," / ",(0,s.jsx)(n.code,{children:"RULE_NO_MATCH (AgentIntentResolver)"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"RULE_MATCH (RulesStep)"})," / ",(0,s.jsx)(n.code,{children:"RULE_NO_MATCH (RulesStep)"})]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"scope-enforcement",children:"Scope enforcement"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"ce_mcp_tool"})," and ",(0,s.jsx)(n.code,{children:"ce_mcp_planner"})," are scope-validated at startup:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"null/blank scope rows are rejected"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"intent_code"})," must be ",(0,s.jsx)(n.code,{children:"ANY"}),", ",(0,s.jsx)(n.code,{children:"UNKNOWN"}),", or defined in ",(0,s.jsx)(n.code,{children:"ce_intent"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"state_code"})," must be ",(0,s.jsx)(n.code,{children:"ANY"}),", ",(0,s.jsx)(n.code,{children:"UNKNOWN"}),", or present in ",(0,s.jsx)(n.code,{children:"ce_rule.state_code"})]}),"\n"]})]})}function a(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}}}]);