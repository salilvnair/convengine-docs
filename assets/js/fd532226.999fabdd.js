/*! For license information please see fd532226.999fabdd.js.LICENSE.txt */
"use strict";(globalThis.webpackChunkconvengine_docs=globalThis.webpackChunkconvengine_docs||[]).push([[230],{1523(e,n,s){s.d(n,{Fb:()=>d,vl:()=>x,sy:()=>o,p:()=>r,Fp:()=>l,f4:()=>p,Bn:()=>h,KJ:()=>c});var i=s(6540),t=s(4848);function l({type:e,children:n}){const s="deterministic"===e?"\ud83e\uddee":"llm"===e?"\ud83e\udd16":"\ud83d\uded1";return(0,t.jsxs)("div",{className:`ce-decision ce-${e}`,children:[(0,t.jsxs)("strong",{children:[s," ",e.toUpperCase()]}),(0,t.jsx)("div",{children:n})]})}function r({name:e,purpose:n,title:s,columns:i,rows:l,children:r}){const o=e||s;return(0,t.jsxs)("div",{className:"ce-db-table",children:[o&&(0,t.jsxs)("h4",{children:["\ud83d\uddc4\ufe0f ",o]}),n&&(0,t.jsx)("p",{children:(0,t.jsx)("em",{children:n})}),i&&l?(0,t.jsxs)("table",{className:"ce-db-table-grid",children:[(0,t.jsx)("thead",{children:(0,t.jsx)("tr",{children:i.map((e,n)=>(0,t.jsx)("th",{children:e},n))})}),(0,t.jsx)("tbody",{children:l.map((e,n)=>(0,t.jsx)("tr",{children:e.map((e,n)=>(0,t.jsx)("td",{children:e},n))},n))})]}):null,i||l||!r?null:(0,t.jsx)("ul",{children:r})]})}function o({engineStatus:e,engineDetails:n,children:s}){const[l,r]=(0,i.useState)(!1);return(0,t.jsxs)("div",{className:"ce-conversation",children:[e&&(0,t.jsxs)("div",{className:"ce-engine-header",onClick:()=>r(!l),children:[(0,t.jsxs)("span",{className:`ce-engine-badge ce-engine-${e.toLowerCase()}`,children:["\u2699 ENGINE \xb7 ",e]}),n&&(0,t.jsx)("span",{className:"ce-engine-toggle",children:l?"\u25be":"\u25b8"})]}),n&&l&&(0,t.jsx)("div",{className:"ce-engine-details",children:n}),(0,t.jsx)("div",{className:"ce-chat",children:s})]})}function c({children:e}){return(0,t.jsxs)("div",{className:"ce-chat-row ce-chat-end",children:[(0,t.jsx)("div",{className:"ce-chat-bubble ce-chat-bubble-user",children:e}),(0,t.jsx)("div",{className:"ce-avatar ce-avatar-user",children:"\ud83d\udc64"})]})}function d({children:e}){return(0,t.jsxs)("div",{className:"ce-chat-row ce-chat-start",children:[(0,t.jsx)("div",{className:"ce-avatar ce-avatar-assistant",children:"\ud83e\udd16"}),(0,t.jsx)("div",{className:"ce-chat-bubble ce-chat-bubble-assistant",children:e})]})}var a=s(3457);function h({title:e,children:n}){return(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{className:"ce-schema-header",children:["\ud83d\udcd0 ",e]}),(0,t.jsx)(a.A,{language:"json",children:"string"==typeof n?n.trim():""})]})}function p({type:e,children:n}){return(0,t.jsx)("div",{className:`ce-highlight ce-${e}`,children:n})}function x({language:e="text",title:n,defaultOpen:s=!1,children:l}){const[r,o]=(0,i.useState)(s);return(0,t.jsxs)("div",{className:"ce-codeblock-toggle",children:[(0,t.jsxs)("div",{className:"ce-codeblock-header",onClick:()=>o(!r),children:[(0,t.jsxs)("div",{className:"ce-codeblock-title",children:["\ud83e\udde9 ",n||`${e.toUpperCase()} code`]}),(0,t.jsx)("button",{className:"ce-codeblock-btn",children:r?"Hide \u25b2":"Show \u25bc"})]}),r&&(0,t.jsx)("div",{className:"ce-codeblock-body",children:(0,t.jsx)(a.A,{language:e,children:l})})]})}},4001(e,n,s){s.r(n),s.d(n,{assets:()=>I,contentTitle:()=>w,default:()=>N,frontMatter:()=>R,metadata:()=>i,toc:()=>A});const i=JSON.parse('{"id":"architecture","title":"Architecture","description":"End-to-end flow (the big picture)","source":"@site/docs/architecture.mdx","sourceDirName":".","slug":"/architecture","permalink":"/docs/architecture","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/architecture.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"docSidebar","next":{"title":"MCP","permalink":"/docs/mcp"}}');var t=s(4848),l=s(8453),r=s(1523),o=s(8991);const c=(0,o.A)("outline","arrow-right","ArrowRight",[["path",{d:"M5 12l14 0",key:"svg-0"}],["path",{d:"M13 18l6 -6",key:"svg-1"}],["path",{d:"M13 6l6 6",key:"svg-2"}]]),d=(0,o.A)("outline","cpu","Cpu",[["path",{d:"M5 6a1 1 0 0 1 1 -1h12a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-12a1 1 0 0 1 -1 -1l0 -12",key:"svg-0"}],["path",{d:"M9 9h6v6h-6l0 -6",key:"svg-1"}],["path",{d:"M3 10h2",key:"svg-2"}],["path",{d:"M3 14h2",key:"svg-3"}],["path",{d:"M10 3v2",key:"svg-4"}],["path",{d:"M14 3v2",key:"svg-5"}],["path",{d:"M21 10h-2",key:"svg-6"}],["path",{d:"M21 14h-2",key:"svg-7"}],["path",{d:"M14 21v-2",key:"svg-8"}],["path",{d:"M10 21v-2",key:"svg-9"}]]);var a=s(7606),h=s(1831);const p=(0,o.A)("outline","tool","Tool",[["path",{d:"M7 10h3v-3l-3.5 -3.5a6 6 0 0 1 8 8l6 6a2 2 0 0 1 -3 3l-6 -6a6 6 0 0 1 -8 -8l3.5 3.5",key:"svg-0"}]]),x=(0,o.A)("outline","git-branch","GitBranch",[["path",{d:"M5 18a2 2 0 1 0 4 0a2 2 0 1 0 -4 0",key:"svg-0"}],["path",{d:"M5 6a2 2 0 1 0 4 0a2 2 0 1 0 -4 0",key:"svg-1"}],["path",{d:"M15 6a2 2 0 1 0 4 0a2 2 0 1 0 -4 0",key:"svg-2"}],["path",{d:"M7 8l0 8",key:"svg-3"}],["path",{d:"M9 18h6a2 2 0 0 0 2 -2v-5",key:"svg-4"}],["path",{d:"M14 14l3 -3l3 3",key:"svg-5"}]]),u=(0,o.A)("outline","message","Message",[["path",{d:"M8 9h8",key:"svg-0"}],["path",{d:"M8 13h6",key:"svg-1"}],["path",{d:"M18 4a3 3 0 0 1 3 3v8a3 3 0 0 1 -3 3h-5l-5 3v-3h-2a3 3 0 0 1 -3 -3v-8a3 3 0 0 1 3 -3h12",key:"svg-2"}]]),j=(0,o.A)("outline","device-floppy","DeviceFloppy",[["path",{d:"M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2",key:"svg-0"}],["path",{d:"M10 14a2 2 0 1 0 4 0a2 2 0 1 0 -4 0",key:"svg-1"}],["path",{d:"M14 4l0 4l-6 0l0 -4",key:"svg-2"}]]);var v=s(1826),g=s(3692),m=s(9073),f=(s(6540),s(9396)),y=s(6344),_=s(6100),E=s(8644),b=s(1637),S=s(2412),C={root:"m_b183c0a2"};const P=(0,f.V)((e,{color:n})=>({root:{"--code-bg":n?(0,y.r)(n,e):void 0}})),T=(0,S.P9)((e,n)=>{const s=(0,_.Y)("Code",null,e),{classNames:i,className:l,style:r,styles:o,unstyled:c,vars:d,color:a,block:h,variant:p,mod:x,attributes:u,...j}=s,v=(0,E.I)({name:"Code",props:s,classes:C,className:l,style:r,classNames:i,styles:o,unstyled:c,attributes:u,vars:d,varsResolver:P});return(0,t.jsx)(b.a,{component:h?"pre":"code",variant:p,ref:n,mod:[{block:h},x],...v("root"),...j,dir:"ltr"})});T.classes=C,T.displayName="@mantine/core/Code";const R={},w="Architecture",I={},A=[{value:"End-to-end flow (the big picture)",id:"end-to-end-flow-the-big-picture",level:3},{value:"1) Request entry point - controller",id:"1-request-entry-point---controller",level:2},{value:"2) ConversationalEngine - session + pipeline",id:"2-conversationalengine---session--pipeline",level:2},{value:"3) EnginePipeline - the core loop (StepResult)",id:"3-enginepipeline---the-core-loop-stepresult",level:2},{value:"4) Pipeline composition - how steps are discovered and ordered",id:"4-pipeline-composition---how-steps-are-discovered-and-ordered",level:2},{value:"5) Database \u201cbrain\u201d - all configuration tables (don&#39;t skip any)",id:"5-database-brain---all-configuration-tables-dont-skip-any",level:2},{value:"6) Step-by-step pipeline walk-through (actual steps)",id:"6-step-by-step-pipeline-walk-through-actual-steps",level:2},{value:"Step 1 - PersistConversationBootstrapStep",id:"step-1---persistconversationbootstrapstep",level:3},{value:"Step 2 - LoadOrCreateConversationStep",id:"step-2---loadorcreateconversationstep",level:3},{value:"Step 3 - IntentResolutionStep",id:"step-3---intentresolutionstep",level:3},{value:"Step 4 - (Validation / schema / extraction steps)",id:"step-4---validation--schema--extraction-steps",level:3},{value:"Step 5 - McpToolStep (MCP loop)",id:"step-5---mcptoolstep-mcp-loop",level:3},{value:"Step 6 - RulesStep (DB-driven state machine + shortcuts)",id:"step-6---rulesstep-db-driven-state-machine--shortcuts",level:3},{value:"Step 7 - ResponseResolutionStep (ce_response driven)",id:"step-7---responseresolutionstep-ce_response-driven",level:3},{value:"Step 8 - PersistConversationStep + PipelineEndGuardStep",id:"step-8---persistconversationstep--pipelineendguardstep",level:3},{value:"7) Putting it together - example conversation + \u201cbehind the scenes\u201d",id:"7-putting-it-together---example-conversation--behind-the-scenes",level:2},{value:"\ud83d\udde3\ufe0f Example FAQ Conversation",id:"\ufe0f-example-faq-conversation",level:2},{value:"\ud83d\udd04 High-level Flow (FAQ)",id:"-high-level-flow-faq",level:2},{value:"1\ufe0f\u20e3 Controller receives the request",id:"1\ufe0f\u20e3-controller-receives-the-request",level:2},{value:"2\ufe0f\u20e3 Engine creates session and pipeline",id:"2\ufe0f\u20e3-engine-creates-session-and-pipeline",level:2},{value:"3\ufe0f\u20e3 Pipeline executes steps in order",id:"3\ufe0f\u20e3-pipeline-executes-steps-in-order",level:2},{value:"4\ufe0f\u20e3 IntentResolutionStep \u2192 FAQ",id:"4\ufe0f\u20e3-intentresolutionstep--faq",level:2},{value:"5\ufe0f\u20e3 MCP is SKIPPED (IMPORTANT)",id:"5\ufe0f\u20e3-mcp-is-skipped-important",level:2},{value:"6\ufe0f\u20e3 RulesStep (usually no-op for FAQ)",id:"6\ufe0f\u20e3-rulesstep-usually-no-op-for-faq",level:2},{value:"7\ufe0f\u20e3 ResponseResolutionStep",id:"7\ufe0f\u20e3-responseresolutionstep",level:2},{value:"Pattern A - EXACT (no LLM)",id:"pattern-a---exact-no-llm",level:3},{value:"Pattern B - DERIVED (LLM formatting)",id:"pattern-b---derived-llm-formatting",level:3},{value:"\ud83d\udd0d What you&#39;ll see in ce_audit for FAQ",id:"-what-youll-see-in-ce_audit-for-faq",level:2},{value:"\u2705 Final Takeaways (FAQ)",id:"-final-takeaways-faq",level:2},{value:"\ud83d\udde3\ufe0f Example Conversation",id:"\ufe0f-example-conversation",level:2},{value:"\ud83d\udd01 High-level Flow (One Turn)",id:"-high-level-flow-one-turn",level:2},{value:"1\ufe0f\u20e3 Request enters via REST controller",id:"1\ufe0f\u20e3-request-enters-via-rest-controller",level:2},{value:"2\ufe0f\u20e3 EngineSession + Pipeline orchestration",id:"2\ufe0f\u20e3-enginesession--pipeline-orchestration",level:2},{value:"3\ufe0f\u20e3 Pipeline execution model",id:"3\ufe0f\u20e3-pipeline-execution-model",level:2},{value:"4\ufe0f\u20e3 Core pipeline steps (order matters)",id:"4\ufe0f\u20e3-core-pipeline-steps-order-matters",level:2},{value:"5\ufe0f\u20e3 Intent resolution for MOVE_CONNECTIONS",id:"5\ufe0f\u20e3-intent-resolution-for-move_connections",level:2},{value:"Tables involved",id:"tables-involved",level:3},{value:"6\ufe0f\u20e3 MCP Tool Step (MOVE_CONNECTIONS only)",id:"6\ufe0f\u20e3-mcp-tool-step-move_connections-only",level:2},{value:"MCP execution loop",id:"mcp-execution-loop",level:3},{value:"7\ufe0f\u20e3 MCP database tools",id:"7\ufe0f\u20e3-mcp-database-tools",level:2},{value:"8\ufe0f\u20e3 MCP writes final answer to context",id:"8\ufe0f\u20e3-mcp-writes-final-answer-to-context",level:2},{value:"9\ufe0f\u20e3 RulesStep - optional short-circuit",id:"9\ufe0f\u20e3-rulesstep---optional-short-circuit",level:2},{value:"\ud83d\udd1f ResponseResolutionStep",id:"-responseresolutionstep",level:2},{value:"Two valid patterns",id:"two-valid-patterns",level:3},{value:"\ud83d\udc1e Debugging: stale move ID bug",id:"-debugging-stale-move-id-bug",level:2},{value:"\u2705 Final takeaway",id:"-final-takeaway",level:2}];function M(e){const n={blockquote:"blockquote",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return v.K||O("Timeline",!1),v.K.Item||O("Timeline.Item",!0),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"architecture",children:"Architecture"})}),"\n",(0,t.jsx)(n.h3,{id:"end-to-end-flow-the-big-picture",children:"End-to-end flow (the big picture)"}),"\n",(0,t.jsx)("br",{}),"\n",(0,t.jsxs)(v.K,{active:7,bulletSize:32,lineWidth:2,children:[(0,t.jsx)(v.K.Item,{bullet:(0,t.jsx)(c,{size:18}),title:"Request enters ConversationController",children:(0,t.jsxs)(g.B,{gap:"xs",children:[(0,t.jsx)(m.E,{fw:600,children:"HTTP request received"}),(0,t.jsx)(m.E,{size:"sm",c:"dimmed",children:(0,t.jsxs)(n.p,{children:["REST API receives ",(0,t.jsx)(T,{children:"{conversationId, text}"}),",\naudits ",(0,t.jsx)("b",{children:"USER_INPUT"}),", and forwards control to\n",(0,t.jsx)(T,{children:" DefaultConversationalEngine"}),"."]})})]})}),(0,t.jsx)(v.K.Item,{bullet:(0,t.jsx)(d,{size:18}),title:"EngineSession created + pipeline execution",children:(0,t.jsxs)(g.B,{gap:"xs",children:[(0,t.jsx)(m.E,{fw:600,children:"Engine initializes execution context"}),(0,t.jsx)(m.E,{size:"sm",c:"dimmed",children:(0,t.jsx)(n.p,{children:"EngineSession is a working POJO holding intent, state,\ncontext_json, payload, and history. The engine dynamically\nbuilds the pipeline from Spring-managed steps."})})]})}),(0,t.jsx)(v.K.Item,{bullet:(0,t.jsx)(a.A,{size:18}),title:"Conversation bootstrap + load",children:(0,t.jsxs)(g.B,{gap:"xs",children:[(0,t.jsx)(m.E,{fw:600,children:"Conversation row ensured and restored"}),(0,t.jsx)(m.E,{size:"sm",c:"dimmed",children:(0,t.jsxs)(n.p,{children:[(0,t.jsx)(T,{children:"ce_conversation"})," is created (if missing) and loaded.\nExisting ",(0,t.jsx)("b",{children:"state_code"}),", ",(0,t.jsx)("b",{children:"intent_code"}),", and\n",(0,t.jsx)("b",{children:"context_json"})," are restored into the session."]})})]})}),(0,t.jsx)(v.K.Item,{bullet:(0,t.jsx)(h.A,{size:18}),title:"Intent resolution",children:(0,t.jsxs)(g.B,{gap:"xs",children:[(0,t.jsx)(m.E,{fw:600,children:"Intent classified using DB + LLM"}),(0,t.jsx)(m.E,{size:"sm",c:"dimmed",children:(0,t.jsxs)(n.p,{children:["Intent resolution is driven by\n",(0,t.jsx)(T,{children:" ce_intent"}),",\n",(0,t.jsx)(T,{children:" ce_intent_classifier"}),", and\n",(0,t.jsx)(T,{children:" ce_prompt_template"}),".\nAGENT classifiers invoke the LLM under strict JSON contracts."]})})]})}),(0,t.jsx)(v.K.Item,{bullet:(0,t.jsx)(p,{size:18}),title:"MCP tool execution",children:(0,t.jsxs)(g.B,{gap:"xs",children:[(0,t.jsx)(m.E,{fw:600,children:"Planner selects and executes tools"}),(0,t.jsx)(m.E,{size:"sm",c:"dimmed",children:(0,t.jsxs)(n.p,{children:["MCP context is cleared first.\nPlanner selects tools from\n",(0,t.jsx)(T,{children:" ce_mcp_tool"})," +\n",(0,t.jsx)(T,{children:" ce_mcp_db_tool"}),",\nexecutes SQL safely, and stores observations and\n",(0,t.jsx)("b",{children:"finalAnswer"})," under ",(0,t.jsx)(T,{children:"context_json.mcp"}),"."]})})]})}),(0,t.jsx)(v.K.Item,{bullet:(0,t.jsx)(x,{size:18}),title:"Rules engine evaluation",children:(0,t.jsxs)(g.B,{gap:"xs",children:[(0,t.jsx)(m.E,{fw:600,children:"DB-driven state machine applied"}),(0,t.jsx)(m.E,{size:"sm",c:"dimmed",children:(0,t.jsxs)(n.p,{children:["Rules from ",(0,t.jsx)(T,{children:"ce_rule"})," run in priority order,\nmutating state, intent, or short-circuiting execution\nusing resolver factories."]})})]})}),(0,t.jsx)(v.K.Item,{bullet:(0,t.jsx)(u,{size:18}),title:"Response resolution",children:(0,t.jsxs)(g.B,{gap:"xs",children:[(0,t.jsx)(m.E,{fw:600,children:"Final payload generated"}),(0,t.jsx)(m.E,{size:"sm",c:"dimmed",children:(0,t.jsxs)(n.p,{children:[(0,t.jsx)(T,{children:"ce_response"})," selects EXACT vs DERIVED output.\nDERIVED responses may invoke LLM; EXACT responses are\ndeterministic and bypass generation."]})})]})}),(0,t.jsx)(v.K.Item,{bullet:(0,t.jsx)(j,{size:18}),title:"Conversation persisted + response returned",children:(0,t.jsxs)(g.B,{gap:"xs",children:[(0,t.jsx)(m.E,{fw:600,children:"Conversation saved and returned to client"}),(0,t.jsx)(m.E,{size:"sm",c:"dimmed",children:(0,t.jsxs)(n.p,{children:["Updated intent, state, context_json, and payload are\npersisted. The full execution trace is visible via\n",(0,t.jsx)(T,{children:"ce_audit"}),"."]})})]})})]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"1-request-entry-point---controller",children:"1) Request entry point - controller"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"api/controller/ConversationController.java"})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"What happens here"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Accepts ",(0,t.jsx)(n.code,{children:"ConversationMessageRequest"})," with ",(0,t.jsx)(n.code,{children:"conversationId"})," + ",(0,t.jsx)(n.code,{children:"text"})]}),"\n",(0,t.jsxs)(n.li,{children:["Writes a ",(0,t.jsx)(n.code,{children:"USER_INPUT"})," audit so UI can replay the chain"]}),"\n",(0,t.jsxs)(n.li,{children:["Delegates to ",(0,t.jsx)(n.code,{children:"ConversationalEngine.process(...)"})]}),"\n",(0,t.jsxs)(n.li,{children:["Returns ",(0,t.jsx)(n.code,{children:"OutputPayload"})," (TextPayload or JsonPayload)"]}),"\n"]}),"\n",(0,t.jsx)(r.vl,{title:"ConversationController.message(...)",language:"java",defaultOpen:!0,children:'@PostMapping("/message")\npublic OutputPayload message(@RequestBody ConversationMessageRequest request) {\n  UUID conversationId = request.getConversationId();\n\n  audit.audit(\n          "USER_INPUT",\n          conversationId,\n          "{\\"text\\":\\"" + JsonUtil.escape(request.getText()) + "\\"}"\n  );\n\n  EngineSession session = engine.process(conversationId, request.getText());\n\n  audit.audit(\n          "ENGINE_OUTPUT",\n          conversationId,\n          "{\\"payload\\":\\"" + JsonUtil.escape(String.valueOf(session.getPayload())) + "\\"}"\n  );\n\n  return session.getPayload();\n}'}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"2-conversationalengine---session--pipeline",children:"2) ConversationalEngine - session + pipeline"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"engine/provider/DefaultConversationalEngine.java"})]}),"\n",(0,t.jsxs)(n.p,{children:["This is the ",(0,t.jsx)(n.strong,{children:"single orchestration point"})," that:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["creates a new ",(0,t.jsx)(n.code,{children:"EngineSession"})]}),"\n",(0,t.jsx)(n.li,{children:"creates the pipeline (dynamic steps)"}),"\n",(0,t.jsx)(n.li,{children:"executes it"}),"\n",(0,t.jsx)(n.li,{children:"returns the session to the controller"}),"\n"]}),"\n",(0,t.jsx)(r.vl,{title:"DefaultConversationalEngine.process(...)",language:"java",children:"@Override\npublic EngineSession process(UUID conversationId, String userText) {\n\n  EngineSession session =\n          sessionFactory.create(conversationId, userText);\n\n  EnginePipeline pipeline =\n          pipelineFactory.createPipeline();\n\n  pipeline.execute(session);\n\n  return session;\n}"}),"\n",(0,t.jsx)(r.f4,{type:"success",children:(0,t.jsxs)(n.p,{children:["EngineSession is intentionally a ",(0,t.jsx)("b",{children:"POJO working state"}),".\n",(0,t.jsx)("br",{}),(0,t.jsx)("br",{}),"It should not \u201creach into DB\u201d.\n",(0,t.jsx)("br",{}),(0,t.jsx)("br",{}),"DB reads/writes are done inside steps/services (like ConversationService, AuditHistoryProvider)."]})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"3-enginepipeline---the-core-loop-stepresult",children:"3) EnginePipeline - the core loop (StepResult)"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"engine/pipeline/EnginePipeline.java"})]}),"\n",(0,t.jsxs)(n.p,{children:["Every step returns a ",(0,t.jsx)(n.code,{children:"StepResult"}),":"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Continue"})," \u2192 next step"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Stop"})," \u2192 pipeline terminates early and returns final OutputPayload"]}),"\n"]}),"\n",(0,t.jsx)(r.vl,{title:"EnginePipeline.execute(...)",language:"java",defaultOpen:!0,children:"public OutputPayload execute(EngineSession session) {\n\n  for (EngineStep step : steps) {\n\n      StepResult r = step.execute(session);\n\n      if (r instanceof StepResult.Stop stop) {\n          return stop.result();\n      }\n  }\n\n  return session.getPayload();\n}"}),"\n",(0,t.jsx)(r.f4,{type:"success",children:(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{children:["It's how the engine can ",(0,t.jsx)("b",{children:"hard-stop"})," when required preconditions fail (missing payload, invalid state, no response configured)."]}),(0,t.jsx)("br",{}),(0,t.jsx)("div",{children:"It keeps \u201cstop logic\u201d centralized and predictable."})]})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"4-pipeline-composition---how-steps-are-discovered-and-ordered",children:"4) Pipeline composition - how steps are discovered and ordered"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"engine/factory/EnginePipelineFactory.java"})]}),"\n",(0,t.jsx)(n.p,{children:"Steps are:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["discovered from Spring as beans of ",(0,t.jsx)(n.code,{children:"EngineStep"})]}),"\n",(0,t.jsx)(n.li,{children:"filtered (conversation persisted requirement, etc.)"}),"\n",(0,t.jsxs)(n.li,{children:["ordered using annotations:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"@MustRunAfter"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"@MustRunBefore"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"@RequiresConversationPersisted"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(r.vl,{title:"EnginePipelineFactory ordering strategy (concept)",language:"java",children:"// Pseudocode summary:\nList<EngineStep> beans = stepsFromSpring();\nList<EngineStep> ordered = orderResolver.sort(beans);\nreturn new EnginePipeline(ordered);"}),"\n",(0,t.jsxs)(r.f4,{type:"warning",children:[(0,t.jsx)("b",{children:"Tip: adding a new step"}),(0,t.jsx)("br",{}),(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Create a Spring component that implements EngineStep",(0,t.jsx)("br",{})]}),"\n",(0,t.jsxs)(n.li,{children:["Annotate with MustRunAfter / MustRunBefore relative to existing steps",(0,t.jsx)("br",{})]}),"\n",(0,t.jsxs)(n.li,{children:["If it requires a ce_conversation row, add @RequiresConversationPersisted",(0,t.jsx)("br",{})]}),"\n",(0,t.jsx)(n.li,{children:"Add audits inside the step so UI shows it"}),"\n"]})]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"5-database-brain---all-configuration-tables-dont-skip-any",children:"5) Database \u201cbrain\u201d - all configuration tables (don't skip any)"}),"\n",(0,t.jsxs)(n.p,{children:["Below is an overview of ",(0,t.jsx)(n.strong,{children:"every core table"})," that drives behavior."]}),"\n",(0,t.jsx)(r.p,{title:"Configuration tables",columns:["Table","What it controls","Used by (code)","Notes / key columns"],rows:[["ce_intent","Allowed intents, priority ordering, description + llmHint","AllowedIntentService, AgentIntentResolver","intent_code, enabled, priority, llm_hint"],["ce_intent_classifier","How intents are classified (AGENT/REGEX/EXACT etc) and which resolver to use","IntentResolutionStep","classifier_type, enabled, priority"],["ce_prompt_template","Prompt templates by purpose + optional intent scoping","AgentIntentResolver, MCP planner, Response resolvers","purpose, intent_code, system_prompt, user_prompt, enabled"],["ce_output_schema","Strict JSON schema control for LLM calls (by intent/state)","AgentIntentResolver, response format resolvers","intent_code, state_code, json_schema, enabled"],["ce_response","Which response to use for (state,intent) and how to generate it","ResponseResolutionStep + ResponseTypeResolverFactory","state_code, intent_code, response_type, output_format, priority"],["ce_rule","DB-driven state machine + short-circuit logic","RulesStep + RuleTypeResolverFactory + RuleActionResolverFactory","intent_code, rule_type, match_pattern, action, action_value, priority"],["ce_mcp_tool","Tool registry (code/group/enabled/description)","McpToolStep planner & tool loader","tool_code, tool_group, enabled"],["ce_mcp_db_tool","DB tool configuration (dialect, sql template, param schema, safe mode, max rows)","McpDbToolExecutor","tool_id (FK), sql_template, param_schema (jsonb), safe_mode, max_rows"]]}),"\n",(0,t.jsx)(r.p,{title:"Runtime tables",columns:["Table","What it stores","Written/Read by","Key columns"],rows:[["ce_conversation","One row per conversation with current state/intent + context_json + last response payload","PersistConversationBootstrapStep, LoadOrCreateConversationStep, PersistConversationStep","conversation_id, intent_code, state_code, context_json, last_assistant_json"],["ce_audit","Append-only timeline of everything that happened during processing","AuditService implementations; UI reads this for the chain","conversation_id, stage, payload_json (json), created_at"]]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"6-step-by-step-pipeline-walk-through-actual-steps",children:"6) Step-by-step pipeline walk-through (actual steps)"}),"\n",(0,t.jsxs)(n.p,{children:["Below is the ",(0,t.jsx)(n.strong,{children:"practical flow"})," you'll see in your engine.",(0,t.jsx)(n.br,{}),"\n","(Exact ordering can vary slightly based on annotations, but this is the intended lifecycle.)"]}),"\n",(0,t.jsx)(n.h3,{id:"step-1---persistconversationbootstrapstep",children:"Step 1 - PersistConversationBootstrapStep"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"engine/steps/PersistConversationBootstrapStep.java"})]}),"\n",(0,t.jsx)(n.p,{children:"Purpose:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Ensures the conversation exists in DB when needed (bootstrap)"}),"\n",(0,t.jsx)(n.li,{children:"Audits the bootstrap action so your UI can see it"}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"step-2---loadorcreateconversationstep",children:"Step 2 - LoadOrCreateConversationStep"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"engine/steps/LoadOrCreateConversationStep.java"})]}),"\n",(0,t.jsx)(n.p,{children:"Purpose:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Loads existing conversation row OR creates a new one"}),"\n",(0,t.jsxs)(n.li,{children:["Syncs conversation's ",(0,t.jsx)(n.code,{children:"intent_code"}),", ",(0,t.jsx)(n.code,{children:"state_code"}),", ",(0,t.jsx)(n.code,{children:"context_json"})," into EngineSession"]}),"\n"]}),"\n",(0,t.jsx)(r.f4,{type:"danger",children:(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{children:"This is the boundary between \u201cstateless HTTP call\u201d and \u201cstateful conversation engine\u201d."}),(0,t.jsx)("br",{}),(0,t.jsx)("div",{children:"If this step is wrong, you'll see bugs like \u201cold move id answer repeats\u201d because context wasn't updated/cleared correctly."})]})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"step-3---intentresolutionstep",children:"Step 3 - IntentResolutionStep"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"engine/steps/IntentResolutionStep.java"})]}),"\n",(0,t.jsx)(n.p,{children:"Purpose:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Picks which classifier to run (from ",(0,t.jsx)(n.code,{children:"ce_intent_classifier"}),")"]}),"\n",(0,t.jsx)(n.li,{children:"Classifiers can be AGENT / REGEX / EXACT"}),"\n",(0,t.jsxs)(n.li,{children:["Sets ",(0,t.jsx)(n.code,{children:"session.intent"})," and audits"]}),"\n"]}),"\n",(0,t.jsx)(r.vl,{title:"IntentResolutionStep (key idea)",language:"java",children:"// Simplified:\nCeIntentClassifier classifier = classifierRepo.findFirstEnabled(...);\nIntentResolver resolver = resolverFactory.get(classifier.getClassifierType());\nString intent = resolver.resolve(session);\nsession.setIntent(intent);"}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"step-4---validation--schema--extraction-steps",children:"Step 4 - (Validation / schema / extraction steps)"}),"\n",(0,t.jsx)(n.p,{children:"You have these steps in your engine to enrich session before MCP/Response:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"ValidationStep"}),"\n",(0,t.jsx)(n.li,{children:"SchemaExtractionStep"}),"\n",(0,t.jsx)(n.li,{children:"AutoAdvanceStep\n(Exact behavior depends on your table config and your program features.)"}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"step-5---mcptoolstep-mcp-loop",children:"Step 5 - McpToolStep (MCP loop)"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"engine/steps/McpToolStep.java"})]}),"\n",(0,t.jsx)(n.p,{children:"Purpose:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Clears old ",(0,t.jsx)(n.code,{children:"context_json.mcp"})," (audit: MCP_CONTEXT_CLEARED)"]}),"\n",(0,t.jsx)(n.li,{children:"Planner calls LLM to decide tool usage"}),"\n",(0,t.jsxs)(n.li,{children:["Executes tools from DB tables:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"ce_mcp_tool"}),"\n",(0,t.jsx)(n.li,{children:"ce_mcp_db_tool"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Writes:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"mcp.observations[]"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"mcp.finalAnswer"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(r.Bn,{title:"context_json.mcp shape",children:'{\n"mcp": {\n  "observations": [\n    {\n      "tool": "postgres.schema",\n      "result": { "tables": ["..."] }\n    },\n    {\n      "tool": "postgres.move_status",\n      "result": { "rows": [ { "connection_id": "...", "status": "MOVED" } ] }\n    }\n  ],\n  "finalAnswer": {\n    "answer": "The status of your move for connection ... is MOVED."\n  }\n}\n}'}),"\n",(0,t.jsx)(r.f4,{type:"success",children:(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{children:["Tools come from ",(0,t.jsx)("b",{children:"ce_mcp_tool"})," and ",(0,t.jsx)("b",{children:"ce_mcp_db_tool"}),", not from if/else in Java."]}),(0,t.jsx)("br",{}),(0,t.jsx)("div",{children:"SQL templates and param_schema are stored in DB and enforced via safe_mode + max_rows."}),(0,t.jsx)("br",{}),(0,t.jsx)("div",{children:"The planner's choice is audited so you can see exactly why it picked a tool."})]})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"step-6---rulesstep-db-driven-state-machine--shortcuts",children:"Step 6 - RulesStep (DB-driven state machine + shortcuts)"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"engine/steps/RulesStep.java"})]}),"\n",(0,t.jsx)(n.p,{children:"Purpose:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Iterates enabled rules ordered by priority"}),"\n",(0,t.jsxs)(n.li,{children:["Uses ",(0,t.jsx)(n.strong,{children:"factory pattern"}),":","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"RuleTypeResolverFactory \u2192 resolves whether rule matches (JSON_PATH / REGEX / \u2026)"}),"\n",(0,t.jsx)(n.li,{children:"RuleActionResolverFactory \u2192 applies mutation (SET_STATE / SET_INTENT / SHORT_CIRCUIT)"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:"Audits RULE_APPLIED / RULE_NOT_APPLIED etc"}),"\n"]}),"\n",(0,t.jsx)(r.f4,{type:"success",children:(0,t.jsxs)(n.p,{children:[(0,t.jsx)("b",{children:"This is where you build your state machine"}),(0,t.jsx)("br",{}),"\nExample: if MCP produced mcp.finalAnswer, you can SHORT_CIRCUIT deterministically (no LLM formatting required)."]})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"step-7---responseresolutionstep-ce_response-driven",children:"Step 7 - ResponseResolutionStep (ce_response driven)"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"engine/steps/ResponseResolutionStep.java"})]}),"\n",(0,t.jsx)(n.p,{children:"Purpose:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Finds the matching ",(0,t.jsx)(n.code,{children:"ce_response"})," row"]}),"\n",(0,t.jsxs)(n.li,{children:["Delegates to ",(0,t.jsx)(n.code,{children:"ResponseTypeResolverFactory"}),":","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"EXACT \u2192 return configured response content directly"}),"\n",(0,t.jsx)(n.li,{children:"DERIVED \u2192 uses templates + LLM (through OutputFormatResolverFactory)"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Writes audits including:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"RESOLVE_RESPONSE"}),"\n",(0,t.jsx)(n.li,{children:"RESOLVE_RESPONSE_LLM_INPUT"}),"\n",(0,t.jsx)(n.li,{children:"RESOLVE_RESPONSE_LLM_OUTPUT"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(r.f4,{type:"success",children:(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{children:"Different programs can change responses without a build."}),(0,t.jsx)("br",{}),(0,t.jsx)("div",{children:"State+Intent drives the output: same intent can respond differently based on state_code."}),(0,t.jsx)("br",{}),(0,t.jsx)("div",{children:"DERIVED responses still remain controlled via templates + output schema."})]})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"step-8---persistconversationstep--pipelineendguardstep",children:"Step 8 - PersistConversationStep + PipelineEndGuardStep"}),"\n",(0,t.jsx)(n.p,{children:"Purpose:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["PersistConversationStep syncs final ",(0,t.jsx)(n.code,{children:"intent/state/context/last_assistant_json"})," to ce_conversation"]}),"\n",(0,t.jsx)(n.li,{children:"PipelineEndGuardStep ensures payload exists; otherwise returns STOP with error payload"}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"7-putting-it-together---example-conversation--behind-the-scenes",children:"7) Putting it together - example conversation + \u201cbehind the scenes\u201d"}),"\n",(0,t.jsx)(n.h1,{id:"faq-example---how-convengine-answers-faqs-no-mcp",children:"FAQ Example - How ConvEngine Answers FAQs (No MCP)"}),"\n",(0,t.jsxs)(n.p,{children:["This document explains ",(0,t.jsx)(n.strong,{children:"exactly"})," how ConvEngine processes a ",(0,t.jsx)(n.strong,{children:"FAQ-style question"}),".\nUnlike MOVE or other operational intents, ",(0,t.jsx)(n.strong,{children:"FAQ does NOT use MCP tools"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["If MCP runs for FAQ, that is a ",(0,t.jsx)(n.strong,{children:"bug"})," - not a feature."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"\ufe0f-example-faq-conversation",children:"\ud83d\udde3\ufe0f Example FAQ Conversation"}),"\n",(0,t.jsxs)(r.sy,{children:[(0,t.jsx)(r.KJ,{children:(0,t.jsx)(n.p,{children:"Can I move my connections within zapper?"})}),(0,t.jsx)("br",{}),(0,t.jsx)(r.Fb,{children:(0,t.jsx)(n.p,{children:"Yes, internal account moves are supported."})})]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"-high-level-flow-faq",children:"\ud83d\udd04 High-level Flow (FAQ)"}),"\n",(0,t.jsx)(n.p,{children:"Controller \u2192 Engine \u2192 Pipeline \u2192 Intent \u2192 Response \u2192 Output"}),"\n",(0,t.jsx)(n.p,{children:"Key difference from MOVE:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u274c No MCP planner"}),"\n",(0,t.jsx)(n.li,{children:"\u274c No MCP tools"}),"\n",(0,t.jsx)(n.li,{children:"\u274c No DB queries via MCP"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Direct FAQ resolution"}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"1\ufe0f\u20e3-controller-receives-the-request",children:"1\ufe0f\u20e3 Controller receives the request"}),"\n",(0,t.jsx)(r.vl,{title:"ConversationController.message(...)",language:"java",children:'@PostMapping("/message")\npublic OutputPayload message(@RequestBody ConversationMessageRequest request) {\n  audit.audit(\n      "USER_INPUT",\n      request.getConversationId(),\n      "{\\"text\\":\\"" + JsonUtil.escape(request.getText()) + "\\"}"\n  );\n\n  EngineSession session =\n      engine.process(\n          request.getConversationId(),\n          request.getText()\n      );\n\n  return session.getPayload();\n}'}),"\n",(0,t.jsx)(r.f4,{type:"info",title:"Why audit USER_INPUT immediately?",children:(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{children:"So UI can replay the exact question later"}),(0,t.jsx)("br",{}),(0,t.jsx)("div",{children:"So intent mistakes can be traced precisely"})]})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"2\ufe0f\u20e3-engine-creates-session-and-pipeline",children:"2\ufe0f\u20e3 Engine creates session and pipeline"}),"\n",(0,t.jsx)(r.vl,{title:"DefaultConversationalEngine.process(...)",language:"java",children:"EngineSession session =\n  EngineSession.forConversation(conversationId, userText);\n\nsession.setHistory(historyProvider.load(conversationId));\n\nEnginePipeline pipeline = pipelineFactory.create(session);\npipeline.execute(session);"}),"\n",(0,t.jsx)(r.f4,{type:"info",children:(0,t.jsxs)(n.p,{children:["EngineSession is a POJO.",(0,t.jsx)(n.br,{}),"\n","It does NOT decide behavior - the pipeline + DB do."]})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"3\ufe0f\u20e3-pipeline-executes-steps-in-order",children:"3\ufe0f\u20e3 Pipeline executes steps in order"}),"\n",(0,t.jsx)(r.vl,{title:"EnginePipeline.execute(...)",language:"java",children:"for (EngineStep step : steps) {\n  StepResult r = step.execute(session);\n  if (r instanceof StepResult.Stop stop) {\n      return stop.result();\n  }\n}"}),"\n",(0,t.jsx)(r.Fp,{type:"info",title:"Why StepResult?",children:(0,t.jsxs)("ul",{children:[(0,t.jsx)("li",{children:"Allows SHORT_CIRCUIT"}),(0,t.jsx)("li",{children:"Allows rules to stop flow early"}),(0,t.jsx)("li",{children:"No hardcoded branching"})]})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"4\ufe0f\u20e3-intentresolutionstep--faq",children:"4\ufe0f\u20e3 IntentResolutionStep \u2192 FAQ"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Tables involved:"})}),"\n",(0,t.jsxs)(r.p,{name:"ce_intent",purpose:"Allowed intents",children:[(0,t.jsx)("li",{children:"intent_code = FAQ"}),(0,t.jsx)("li",{children:"priority"}),(0,t.jsx)("li",{children:"enabled"})]}),"\n",(0,t.jsxs)(r.p,{name:"ce_prompt_template",purpose:"Intent agent prompt",children:[(0,t.jsx)("li",{children:"purpose = INTENT_AGENT"}),(0,t.jsx)("li",{children:"intent_code = null"})]}),"\n",(0,t.jsx)(n.p,{children:"The AgentIntentResolver:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Sees allowed intents"}),"\n",(0,t.jsxs)(n.li,{children:["Uses LLM ",(0,t.jsx)(n.strong,{children:"only to classify"})]}),"\n",(0,t.jsxs)(n.li,{children:["Returns ",(0,t.jsx)(n.code,{children:"FAQ"})]}),"\n"]}),"\n",(0,t.jsx)(r.f4,{type:"success",children:(0,t.jsx)(n.p,{children:"FAQ intent is resolved BEFORE any MCP logic exists."})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"5\ufe0f\u20e3-mcp-is-skipped-important",children:"5\ufe0f\u20e3 MCP is SKIPPED (IMPORTANT)"}),"\n",(0,t.jsxs)(n.p,{children:["There is ",(0,t.jsx)(n.strong,{children:"no MCP planning"})," because:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["FAQ intent has ",(0,t.jsx)(n.strong,{children:"no MCP tools"})]}),"\n",(0,t.jsx)(n.li,{children:"No ce_mcp_tool applies"}),"\n",(0,t.jsx)(n.li,{children:"No ce_mcp_db_tool is loaded"}),"\n"]}),"\n",(0,t.jsx)(r.f4,{type:"danger",children:(0,t.jsx)(n.p,{children:"If MCP runs for FAQ, your configuration is wrong."})}),"\n",(0,t.jsxs)(n.p,{children:["You will ",(0,t.jsx)(n.strong,{children:"not"})," see:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"MCP_PLAN_LLM_INPUT"}),"\n",(0,t.jsx)(n.li,{children:"MCP_TOOL_CALL"}),"\n",(0,t.jsx)(n.li,{children:"MCP_FINAL_ANSWER"}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"6\ufe0f\u20e3-rulesstep-usually-no-op-for-faq",children:"6\ufe0f\u20e3 RulesStep (usually no-op for FAQ)"}),"\n",(0,t.jsx)(n.p,{children:"Typical FAQ rules:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"none"}),"\n",(0,t.jsx)(n.li,{children:"or cosmetic state changes"}),"\n"]}),"\n",(0,t.jsxs)(r.p,{name:"ce_rule",purpose:"Optional FAQ rules",children:[(0,t.jsx)("li",{children:"intent_code = FAQ"}),(0,t.jsx)("li",{children:"rule_type = REGEX / JSON_PATH"})]}),"\n",(0,t.jsx)(r.f4,{type:"info",children:(0,t.jsx)(n.p,{children:"FAQ usually has zero rules."})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"7\ufe0f\u20e3-responseresolutionstep",children:"7\ufe0f\u20e3 ResponseResolutionStep"}),"\n",(0,t.jsxs)(r.p,{name:"ce_response",purpose:"FAQ responses",children:[(0,t.jsx)("li",{children:"intent_code = FAQ"}),(0,t.jsx)("li",{children:"state_code = IDLE"}),(0,t.jsx)("li",{children:"response_type = EXACT or DERIVED"})]}),"\n",(0,t.jsx)(n.p,{children:"Two patterns:"}),"\n",(0,t.jsx)(n.h3,{id:"pattern-a---exact-no-llm",children:"Pattern A - EXACT (no LLM)"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"exact_text is returned"}),"\n",(0,t.jsx)(n.li,{children:"fastest path"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"pattern-b---derived-llm-formatting",children:"Pattern B - DERIVED (LLM formatting)"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"derivation_hint used"}),"\n",(0,t.jsx)(n.li,{children:"still no MCP"}),"\n"]}),"\n",(0,t.jsx)(r.f4,{type:"success",children:(0,t.jsx)(n.p,{children:"FAQ responses NEVER depend on MCP context."})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"-what-youll-see-in-ce_audit-for-faq",children:"\ud83d\udd0d What you'll see in ce_audit for FAQ"}),"\n",(0,t.jsx)(n.p,{children:"Typical stages:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"USER_INPUT"}),"\n",(0,t.jsx)(n.li,{children:"INTENT_AGENT_LLM_INPUT"}),"\n",(0,t.jsx)(n.li,{children:"INTENT_AGENT_LLM_OUTPUT"}),"\n",(0,t.jsx)(n.li,{children:"RESOLVE_RESPONSE"}),"\n",(0,t.jsx)(n.li,{children:"RESOLVE_RESPONSE_LLM_OUTPUT (only if DERIVED)"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"No MCP stages. Ever."}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"-final-takeaways-faq",children:"\u2705 Final Takeaways (FAQ)"}),"\n",(0,t.jsx)(r.Fp,{type:"success",title:"FAQ behavior summary",children:(0,t.jsxs)("ul",{children:[(0,t.jsx)("li",{children:"Intent = FAQ"}),(0,t.jsx)("li",{children:"No MCP planning"}),(0,t.jsx)("li",{children:"No DB tools"}),(0,t.jsx)("li",{children:"Response comes from ce_response"}),(0,t.jsx)("li",{children:"Fully deterministic unless DERIVED"})]})}),"\n",(0,t.jsx)(n.p,{children:"If FAQ ever:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"reuses previous answers"}),"\n",(0,t.jsx)(n.li,{children:"runs MCP"}),"\n",(0,t.jsx)(n.li,{children:"hits DB tools"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["\ud83d\udc49 the bug is in ",(0,t.jsx)(n.strong,{children:"configuration"}),", not engine code."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h1,{id:"move_connections---architecture-deep-dive",children:"MOVE_CONNECTIONS - Architecture Deep Dive"}),"\n",(0,t.jsxs)(n.p,{children:["This document explains ",(0,t.jsx)(n.strong,{children:"exactly"})," how ConvEngine processes a\n",(0,t.jsx)(n.code,{children:"MOVE_CONNECTIONS"})," request - from REST controller to MCP tools to final response."]}),"\n",(0,t.jsx)(n.p,{children:"If you read this once, you should be able to:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Debug any MOVE flow issue"}),"\n",(0,t.jsx)(n.li,{children:"Add new MCP tools safely"}),"\n",(0,t.jsx)(n.li,{children:"Understand where stale answers come from"}),"\n",(0,t.jsx)(n.li,{children:"Explain the engine to another engineer confidently"}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"\ufe0f-example-conversation",children:"\ud83d\udde3\ufe0f Example Conversation"}),"\n",(0,t.jsxs)(r.sy,{children:[(0,t.jsx)(r.KJ,{children:(0,t.jsx)(n.p,{children:"What is the status of my move for connection USPSC003BA100SA277CON1388"})}),(0,t.jsx)("br",{}),(0,t.jsx)(r.Fb,{children:(0,t.jsx)(n.p,{children:"The status of your move for connection USPSC003BA100SA277CON1388 is MOVED."})}),(0,t.jsx)("br",{}),(0,t.jsx)(r.KJ,{children:(0,t.jsx)(n.p,{children:"What is the status of my move for connection USPSC003BA100SA277CON1128"})}),(0,t.jsx)("br",{}),(0,t.jsx)(r.Fb,{children:(0,t.jsx)(n.p,{children:"The status of your move for connection USPSC003BA100SA277CON1128 is IN_PROGRESS."})})]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"-high-level-flow-one-turn",children:"\ud83d\udd01 High-level Flow (One Turn)"}),"\n",(0,t.jsx)(n.p,{children:"Controller \u2192 Engine \u2192 Pipeline \u2192 Intent \u2192 MCP \u2192 Rules \u2192 Response"}),"\n",(0,t.jsxs)(n.p,{children:["Every ",(0,t.jsx)(n.strong,{children:"User \u2192 Assistant"})," turn follows this exact lifecycle."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"1\ufe0f\u20e3-request-enters-via-rest-controller",children:"1\ufe0f\u20e3 Request enters via REST controller"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"ConversationController.java"})]}),"\n",(0,t.jsx)(r.vl,{language:"java",title:"ConversationController.message(...)",children:'@PostMapping("/message")\npublic OutputPayload message(@RequestBody ConversationMessageRequest request) {\n\n  audit.audit(\n      "USER_INPUT",\n      request.getConversationId(),\n      "{\\"text\\":\\"" + JsonUtil.escape(request.getText()) + "\\"}"\n  );\n\n  EngineSession session =\n      engine.process(\n          request.getConversationId(),\n          request.getText()\n      );\n\n  audit.audit(\n      "ENGINE_OUTPUT",\n      session.getConversationId(),\n      "{\\"payload\\":\\"" +\n          JsonUtil.escape(String.valueOf(session.getPayload())) +\n      "\\"}"\n  );\n\n  return session.getPayload();\n}'}),"\n",(0,t.jsx)(r.Fp,{type:"info",title:"Why audit at the controller?",children:(0,t.jsxs)("ul",{children:[(0,t.jsxs)("li",{children:[(0,t.jsx)("b",{children:"UI replay:"})," ce_audit becomes a full timeline"]}),(0,t.jsxs)("li",{children:[(0,t.jsx)("b",{children:"Debug truth:"})," broken JSON or stale state is visible immediately"]}),(0,t.jsxs)("li",{children:[(0,t.jsx)("b",{children:"No hidden behavior:"})," every request is auditable"]})]})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"2\ufe0f\u20e3-enginesession--pipeline-orchestration",children:"2\ufe0f\u20e3 EngineSession + Pipeline orchestration"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"DefaultConversationalEngine.java"})]}),"\n",(0,t.jsx)(r.vl,{language:"java",title:"DefaultConversationalEngine.process(...)",children:"public EngineSession process(UUID conversationId, String userText) {\n\n  EngineSession session =\n      EngineSession.forConversation(conversationId, userText);\n\n  session.setHistory(historyProvider.load(conversationId));\n\n  EnginePipeline pipeline =\n      pipelineFactory.create(session);\n\n  pipeline.execute(session);\n\n  return session;\n}"}),"\n",(0,t.jsx)(r.f4,{type:"success",children:(0,t.jsxs)(n.p,{children:["EngineSession is a POJO.",(0,t.jsx)(n.br,{}),"\n","All intelligence lives in pipeline steps + DB configuration."]})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"3\ufe0f\u20e3-pipeline-execution-model",children:"3\ufe0f\u20e3 Pipeline execution model"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"EnginePipeline.java"})]}),"\n",(0,t.jsx)(r.vl,{language:"java",title:"EnginePipeline.execute(...)",children:"for (EngineStep step : steps) {\n  StepResult r = step.execute(session);\n\n  if (r instanceof StepResult.Stop stop) {\n      return stop.result();\n  }\n}"}),"\n",(0,t.jsx)(r.Fp,{type:"info",title:"Why StepResult?",children:(0,t.jsxs)("ul",{children:[(0,t.jsx)("li",{children:"Allows SHORT_CIRCUIT responses"}),(0,t.jsx)("li",{children:"Allows rules to stop execution"}),(0,t.jsx)("li",{children:"Keeps pipeline generic & extensible"})]})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"4\ufe0f\u20e3-core-pipeline-steps-order-matters",children:"4\ufe0f\u20e3 Core pipeline steps (order matters)"}),"\n",(0,t.jsx)(n.p,{children:"Selects resolver (AGENT / REGEX / EXACT) from DB."}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"5\ufe0f\u20e3-intent-resolution-for-move_connections",children:"5\ufe0f\u20e3 Intent resolution for MOVE_CONNECTIONS"}),"\n",(0,t.jsx)(n.h3,{id:"tables-involved",children:"Tables involved"}),"\n",(0,t.jsxs)(r.p,{name:"ce_intent",purpose:"Allowed intents",children:[(0,t.jsx)("li",{children:"intent_code"}),(0,t.jsx)("li",{children:"priority"}),(0,t.jsx)("li",{children:"llm_hint"}),(0,t.jsx)("li",{children:"enabled"})]}),"\n",(0,t.jsxs)(r.p,{name:"ce_prompt_template",purpose:"Intent prompts",children:[(0,t.jsx)("li",{children:"purpose = INTENT_AGENT"}),(0,t.jsx)("li",{children:"system_prompt"}),(0,t.jsx)("li",{children:"user_prompt"})]}),"\n",(0,t.jsxs)(r.p,{name:"ce_output_schema",purpose:"Strict JSON control",children:[(0,t.jsx)("li",{children:"intent_code"}),(0,t.jsx)("li",{children:"state_code"}),(0,t.jsx)("li",{children:"json_schema"})]}),"\n",(0,t.jsx)(n.p,{children:"The LLM returns structured JSON like:"}),"\n",(0,t.jsx)(r.Bn,{title:"Intent agent output",children:'{\n"intent": "MOVE_CONNECTIONS",\n"confidence": 0.92,\n"needsClarification": false,\n"clarificationResolved": false,\n"clarificationQuestion": ""\n}'}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"6\ufe0f\u20e3-mcp-tool-step-move_connections-only",children:"6\ufe0f\u20e3 MCP Tool Step (MOVE_CONNECTIONS only)"}),"\n",(0,t.jsx)(r.f4,{type:"danger",children:(0,t.jsxs)(n.p,{children:["The FIRST thing MCP does is clear old context.",(0,t.jsx)(n.br,{}),"\n","If this does not happen, stale answers WILL appear."]})}),"\n",(0,t.jsx)(n.h3,{id:"mcp-execution-loop",children:"MCP execution loop"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"MCP_CONTEXT_CLEARED"}),"\n",(0,t.jsx)(n.li,{children:"MCP_PLAN_LLM_INPUT"}),"\n",(0,t.jsx)(n.li,{children:"MCP_PLAN_LLM_OUTPUT"}),"\n",(0,t.jsx)(n.li,{children:"MCP_TOOL_CALL"}),"\n",(0,t.jsx)(n.li,{children:"MCP_TOOL_RESULT"}),"\n",(0,t.jsx)(n.li,{children:"Repeat until MCP_FINAL_ANSWER"}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"7\ufe0f\u20e3-mcp-database-tools",children:"7\ufe0f\u20e3 MCP database tools"}),"\n",(0,t.jsxs)(r.p,{name:"ce_mcp_tool",purpose:"Tool registry",children:[(0,t.jsx)("li",{children:"tool_code"}),(0,t.jsx)("li",{children:"tool_group"}),(0,t.jsx)("li",{children:"enabled"})]}),"\n",(0,t.jsxs)(r.p,{name:"ce_mcp_db_tool",purpose:"SQL-backed tools",children:[(0,t.jsx)("li",{children:"tool_id (FK)"}),(0,t.jsx)("li",{children:"sql_template"}),(0,t.jsx)("li",{children:"param_schema"}),(0,t.jsx)("li",{children:"safe_mode"}),(0,t.jsx)("li",{children:"max_rows"})]}),"\n",(0,t.jsx)(n.p,{children:"Example SQL template:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"select status\nfrom move_request\nwhere connection_id = :connection_id\n\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"8\ufe0f\u20e3-mcp-writes-final-answer-to-context",children:"8\ufe0f\u20e3 MCP writes final answer to context"}),"\n",(0,t.jsx)(r.Bn,{title:"context_json.mcp",children:'{\n"mcp": {\n  "observations": [\n    {\n      "tool": "postgres.move_status",\n      "rowsJson": "[{ status: \'MOVED\' }]"\n    }\n  ],\n  "finalAnswer": {\n    "answer": "The status of your move is MOVED."\n  }\n}\n}'}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"9\ufe0f\u20e3-rulesstep---optional-short-circuit",children:"9\ufe0f\u20e3 RulesStep - optional short-circuit"}),"\n",(0,t.jsx)(n.p,{children:"Rules can:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"SET_STATE"}),"\n",(0,t.jsx)(n.li,{children:"SET_INTENT"}),"\n",(0,t.jsx)(n.li,{children:"SHORT_CIRCUIT"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Typical MOVE rule:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"rule_type = JSON_PATH"}),"\n",(0,t.jsxs)(n.li,{children:["match_pattern = ",(0,t.jsx)(n.code,{children:"$.mcp.finalAnswer"})]}),"\n",(0,t.jsx)(n.li,{children:"action = SHORT_CIRCUIT"}),"\n"]}),"\n",(0,t.jsx)(r.f4,{type:"info",children:(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{children:"Customer-specific behavior without code changes"}),(0,t.jsx)("br",{}),(0,t.jsx)("div",{children:"Configurable state machine"}),(0,t.jsx)("br",{}),(0,t.jsx)("div",{children:"Deterministic overrides"})]})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"-responseresolutionstep",children:"\ud83d\udd1f ResponseResolutionStep"}),"\n",(0,t.jsxs)(n.p,{children:["Uses ",(0,t.jsx)(n.code,{children:"ce_response"}),":"]}),"\n",(0,t.jsxs)(r.p,{name:"ce_response",purpose:"Final output configuration",children:[(0,t.jsx)("li",{children:"state_code"}),(0,t.jsx)("li",{children:"intent_code"}),(0,t.jsx)("li",{children:"response_type (EXACT / DERIVED)"}),(0,t.jsx)("li",{children:"output_format (TEXT / JSON)"})]}),"\n",(0,t.jsx)(n.h3,{id:"two-valid-patterns",children:"Two valid patterns"}),"\n",(0,t.jsx)(r.Fp,{type:"success",title:"Pattern A - Deterministic",children:(0,t.jsxs)("ul",{children:[(0,t.jsx)("li",{children:"Rules SHORT_CIRCUIT"}),(0,t.jsx)("li",{children:"No LLM call"}),(0,t.jsx)("li",{children:"Fast & safe"})]})}),"\n",(0,t.jsx)(r.Fp,{type:"info",title:"Pattern B - Derived",children:(0,t.jsxs)("ul",{children:[(0,t.jsx)("li",{children:"derivation_hint checks mcp.finalAnswer"}),(0,t.jsx)("li",{children:"LLM formats response"})]})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"-debugging-stale-move-id-bug",children:"\ud83d\udc1e Debugging: stale move ID bug"}),"\n",(0,t.jsx)(n.p,{children:"If you see:"}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"Second request returns previous move result"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"The cause is almost always one of:"}),"\n",(0,t.jsx)(r.Fp,{type:"danger",title:"Root causes",children:(0,t.jsxs)("ul",{children:[(0,t.jsx)("li",{children:"MCP context not cleared early enough"}),(0,t.jsx)("li",{children:"derivation_hint blindly reusing mcp.finalAnswer"}),(0,t.jsx)("li",{children:"Tool param extraction failed and reused old params"})]})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"-final-takeaway",children:"\u2705 Final takeaway"}),"\n",(0,t.jsx)(n.p,{children:"ConvEngine MOVE flow is:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Deterministic"}),"\n",(0,t.jsx)(n.li,{children:"Auditable"}),"\n",(0,t.jsx)(n.li,{children:"DB-driven"}),"\n",(0,t.jsx)(n.li,{children:"MCP-powered"}),"\n",(0,t.jsx)(n.li,{children:"Safe when configured correctly"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"If you understand this file,\nyou understand the MOVE engine end-to-end."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{})})]})}function N(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(M,{...e})}):M(e)}function O(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}}}]);