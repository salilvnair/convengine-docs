import { Conversation, User, Assistant, CodeBlockToggle} from "../../src/components/convengine";

# üß† DefaultConversationalEngine

This page documents **the core engine implementation** of ConvEngine: `DefaultConversationalEngine`.

You'll see:

- ‚úÖ The **complete Java file** (with inline comments)
- ‚úÖ A **line-by-line walkthrough** of what each section does
- ‚úÖ A few **mini conversation examples** using your chat components (engineStatus + engineDetails)

> The most important idea: **the engine is deterministic**.  
> The LLM is used only for **text/JSON generation**, never for state or intent control.

---

## üó∫Ô∏è What This Engine Owns

ConvEngine owns these responsibilities:

- **Conversation lifecycle** (create/load/save)
- **Policy enforcement** (hard stops)
- **Intent classification** (DB-driven, gated by state)
- **Rule processing** (deterministic transitions)
- **Schema-bound extraction** (LLM used as strict extractor, DB-driven)
- **Response resolution** (EXACT vs DERIVED, TEXT vs JSON)
- **Context memory** (`context_json` as the long-lived ‚Äúbrain‚Äù)

---

## ‚úÖ The Complete Java File (Annotated)

> This is your `DefaultConversationalEngine` rewritten **as a readable, commented reference**.
> Keep this in docs; your production source can stay clean.

<CodeBlockToggle
    language="java"
    title="DefaultConversationalEngine.java"
    defaultOpen={false}
>
    {`
    package com.github.salilvnair.convengine.engine.provider;

    import com.github.salilvnair.convengine.engine.model.EngineResult;
    import com.github.salilvnair.convengine.engine.type.RuleAction;
    import com.github.salilvnair.convengine.engine.core.ConversationalEngine;
    import com.github.salilvnair.convengine.entity.*;
    import com.github.salilvnair.convengine.llm.core.LlmClient;
    import com.github.salilvnair.convengine.llm.context.LlmInvocationContext;
    import com.github.salilvnair.convengine.model.*;
    import com.github.salilvnair.convengine.repo.*;
    import com.github.salilvnair.convengine.util.JsonMergeUtil;
    import lombok.RequiredArgsConstructor;
    import java.time.OffsetDateTime;
    import java.util.UUID;
    import java.util.regex.Pattern;

    @RequiredArgsConstructor
    public class DefaultConversationalEngine implements ConversationalEngine {

        private final ConversationRepository conversationRepo;
        private final RuleRepository ruleRepo;
        private final PolicyRepository policyRepo;
        private final ResponseRepository responseRepo;
        private final IntentClassifierRepository intentClassifierRepo;
        private final OutputSchemaRepository outputSchemaRepo;
        private final AuditRepository auditRepo; // ‚úÖ AUDIT
        private final LlmClient llm;

        @Override
        public EngineResult process(String conversationIdStr, String userText) {

            UUID conversationId = UUID.fromString(conversationIdStr);

            // ------------------------------------------------------------
            // 1. Load or create conversation
            // ------------------------------------------------------------
            CeConversation convo = conversationRepo
                    .findById(conversationId)
                    .orElseGet(() -> createNewConversation(conversationId));

            convo.setLastUserText(userText);
            convo.setUpdatedAt(OffsetDateTime.now());

            audit("USER_INPUT", conversationId,
                    "{\\"text\\":\\"" + escape(userText) + "\\"}");

            String intent = convo.getIntentCode();
            final String[] state = {convo.getStateCode()};
            String previousIntent = intent;

            // ------------------------------------------------------------
            // 2. Policy enforcement (hard stop)
            // ------------------------------------------------------------
            for (CePolicy policy : policyRepo.findByEnabledTrueOrderByPriorityAsc()) {
                if (matches(policy.getRuleType(), policy.getPattern(), userText)) {

                    audit("POLICY_BLOCK", conversationId,
                            "{\\"policyId\\":" + policy.getPolicyId() +
                                    ",\\"ruleType\\":\\"" + policy.getRuleType() +
                                    "\\",\\"pattern\\":\\"" + escape(policy.getPattern()) + "\\"}");

                    convo.setStatus("BLOCKED");
                    convo.setLastAssistantJson(jsonText(policy.getResponseText()));
                    convo.setUpdatedAt(OffsetDateTime.now());
                    conversationRepo.save(convo);

                    return new EngineResult(
                            intent,
                            state[0],
                            new TextPayload(policy.getResponseText()),
                            convo.getContextJson()
                    );
                }
            }

            // ------------------------------------------------------------
            // 3. Intent classification (IDLE only)
            // ------------------------------------------------------------
            if ("IDLE".equalsIgnoreCase(state[0])) {

                String classifiedIntent = null;

                for (CeIntentClassifier ic :
                        intentClassifierRepo.findByEnabledTrueOrderByPriorityAsc()) {

                    if (matches(ic.getRuleType(), ic.getPattern(), userText)) {
                        classifiedIntent = ic.getIntentCode();
                        break;
                    }
                }

                if (classifiedIntent != null &&
                        (!classifiedIntent.equals(previousIntent))) {

                    intent = classifiedIntent;
                    convo.setIntentCode(intent);

                    audit("INTENT_CLASSIFIED", conversationId,
                            "{\\"intent\\":\\"" + intent + "\\"}");
                }
            }

            // ------------------------------------------------------------
            // 4. Apply rules (override intent/state)
            // ------------------------------------------------------------
            for (CeRule rule : ruleRepo.findByEnabledTrueOrderByPriorityAsc()) {

                if (!matches(rule.getRuleType(), rule.getMatchPattern(), userText)) {
                    continue;
                }

                RuleAction action =
                        RuleAction.valueOf(rule.getAction().trim().toUpperCase());

                audit("RULE_MATCHED", conversationId,
                        "{\\"ruleId\\":" + rule.getRuleId() +
                                ",\\"action\\":\\"" + action + "\\"}");

                switch (action) {

                    case SET_INTENT -> {
                        intent = rule.getActionValue();
                        convo.setIntentCode(intent);

                        audit("SET_INTENT", conversationId,
                                "{\\"intent\\":\\"" + intent + "\\"}");
                    }

                    case SET_STATE -> {
                        state[0] = rule.getActionValue();
                        convo.setStateCode(state[0]);

                        audit("SET_STATE", conversationId,
                                "{\\"state\\":\\"" + state[0] + "\\"}");
                    }

                    case SHORT_CIRCUIT -> {
                        convo.setLastAssistantJson(jsonText(rule.getActionValue()));
                        convo.setUpdatedAt(OffsetDateTime.now());
                        conversationRepo.save(convo);

                        audit("SHORT_CIRCUIT", conversationId,
                                "{\\"message\\":\\"" + escape(rule.getActionValue()) + "\\"}");

                        return new EngineResult(
                                intent,
                                state[0],
                                new TextPayload(rule.getActionValue()),
                                convo.getContextJson()
                        );
                    }
                }
            }

            // ------------------------------------------------------------
            // 5. Final fallbacks
            // ------------------------------------------------------------
            if (intent == null) {
                intent = "UNKNOWN";
                convo.setIntentCode(intent);

                audit("INTENT_FALLBACK", conversationId, "{\\"intent\\":\\"UNKNOWN\\"}");
            }

            if (state[0] == null) {
                state[0] = "IDLE";
                convo.setStateCode(state[0]);

                audit("STATE_FALLBACK", conversationId, "{\\"state\\":\\"IDLE\\"}");
            }

            // ------------------------------------------------------------
            // 6. Extraction (intent + state bound schema)
            // ------------------------------------------------------------
            String finalIntent = intent;
            String finalState = state[0];

            outputSchemaRepo
                    .findFirstByEnabledTrueAndIntentCodeAndStateCodeOrderByPriorityAsc(
                            intent, state[0]
                    )
                    .ifPresent(schema -> {

                        audit("SCHEMA_EXTRACTION_START", conversationId, "{\\"schemaId\\":" + schema.getSchemaId() + "}");

                        LlmInvocationContext.set(conversationId, finalIntent, finalState);

                        String extractedJson = llm.generateJson(
                                """
                                Extract structured data from user input.
                                - Follow the JSON schema strictly
                                - Return ONLY valid JSON
                                - Omit fields not present in user input
                                """,
                                schema.getJsonSchema(),
                                convo.getContextJson() + "\\nUser input: " + userText
                        );

                        String merged = JsonMergeUtil.merge(convo.getContextJson(), extractedJson);
                        convo.setContextJson(merged);
                        audit("SCHEMA_EXTRACTED", conversationId, merged);

                        // üî• AUTO-ADVANCE LOGIC
                        boolean schemaComplete = JsonMergeUtil.isSchemaComplete(schema.getJsonSchema(), merged);

                        if (schemaComplete && "NEED_MORE_INFO".equalsIgnoreCase(state[0])) {
                            audit("SCHEMA_COMPLETE", conversationId, merged);
                            state[0] = "READY";
                            convo.setStateCode("READY");
                            audit("STATE_TRANSITION",conversationId,"{\\"from\\":\\"NEED_MORE_INFO\\",\\"to\\":\\"READY\\"}");
                        }
                        audit("SCHEMA_MERGED", conversationId, merged);
                    });

            // ------------------------------------------------------------
            // 7. Resolve response
            // ------------------------------------------------------------
            final String resolvedIntent = intent;
            final String resolvedState  = state[0];

            CeResponse resp =
                    responseRepo
                            .findFirstByEnabledTrueAndStateCodeAndIntentCodeOrderByPriorityAsc(
                                    resolvedState, resolvedIntent
                            )
                            .or(() ->
                                    responseRepo.findFirstByEnabledTrueAndStateCodeAndIntentCodeIsNullOrderByPriorityAsc(
                                            resolvedState
                                    )
                            )
                            .or(() ->
                                    responseRepo.findFirstByEnabledTrueAndStateCodeOrderByPriorityAsc("ANY")
                            )
                            .orElseThrow(() ->
                                    new IllegalStateException("No fallback response configured in ce_response")
                            );

            OutputPayload payload;

            if ("TEXT".equalsIgnoreCase(resp.getOutputFormat())
                    && "EXACT".equalsIgnoreCase(resp.getResponseType())) {

                payload = new TextPayload(resp.getExactText());
                convo.setLastAssistantJson(jsonText(resp.getExactText()));

                audit("RESPONSE_EXACT", conversationId, "{\\"text\\":\\"" + escape(resp.getExactText()) + "\\"}");

            }
            else if ("TEXT".equalsIgnoreCase(resp.getOutputFormat())) {

                LlmInvocationContext.set(conversationId, intent, state[0]);

                String text = llm.generateText(
                        resp.getDerivationHint(),
                        convo.getContextJson()
                );

                payload = new TextPayload(text);
                convo.setLastAssistantJson(jsonText(text));

                audit("RESPONSE_DERIVED_TEXT", conversationId, "{\\"text\\":\\"" + escape(text) + "\\"}");

            }
            else {

                LlmInvocationContext.set(conversationId, intent, state[0]);

                String json = llm.generateJson(
                        resp.getDerivationHint(),
                        resp.getJsonSchema(),
                        convo.getContextJson()
                );

                payload = new JsonPayload(json);
                convo.setLastAssistantJson(json);

                audit("RESPONSE_DERIVED_JSON", conversationId, json);
            }

            convo.setStatus("RUNNING");
            convo.setUpdatedAt(OffsetDateTime.now());
            conversationRepo.save(convo);

            audit("ENGINE_RETURN", conversationId, "{\\"intent\\":\\"" + intent + "\\",\\"state\\":\\"" + state[0] + "\\"}");

            return new EngineResult(
                    intent,
                    state[0],
                    payload,
                    convo.getContextJson()
            );
        }

        // ------------------------------------------------------------
        // Helpers
        // ------------------------------------------------------------

        private CeConversation createNewConversation(UUID id) {
            return conversationRepo.save(
                    CeConversation.builder()
                            .conversationId(id)
                            .status("RUNNING")
                            .stateCode("IDLE")
                            .contextJson("{}")
                            .createdAt(OffsetDateTime.now())
                            .updatedAt(OffsetDateTime.now())
                            .build()
            );
        }

        private boolean matches(String type, String pattern, String text) {
            if (type == null || pattern == null || text == null) {
                return false;
            }

            return switch (type.trim().toUpperCase()) {
                case "REGEX" ->
                        Pattern.compile(pattern, Pattern.CASE_INSENSITIVE)
                                .matcher(text)
                                .find();
                case "CONTAINS" ->
                        text.toLowerCase().contains(pattern.toLowerCase());
                case "STARTS_WITH" ->
                        text.toLowerCase().startsWith(pattern.toLowerCase());
                default -> false;
            };
        }

        private String jsonText(String text) {
            return "{\\"type\\":\\"TEXT\\",\\"value\\":\\"" +
                    escape(text) +
                    "\\"}";
        }

        private void audit(String stage, UUID conversationId, String payloadJson) {
            auditRepo.save(
                    CeAudit.builder()
                            .conversationId(conversationId)
                            .stage(stage)
                            .payloadJson(payloadJson)
                            .createdAt(OffsetDateTime.now())
                            .build()
            );
        }

        private String escape(String s) {
            return s == null ? "" : s.replace("\\"", "\\\\"");
        }
    }
`}
</CodeBlockToggle>


---

## üîç Detailed Walkthrough (Line-by-Line)

---

## Phase 0 ‚Äî Parse Conversation ID

### Code

```java
UUID conversationId = UUID.fromString(conversationIdStr);
```

### Meaning
- Converts the inbound request‚Äôs `conversationId` into a UUID.
- This is the stable primary key used by:
  - `ce_conversation`
  - `ce_llm_call_log`
  - any audit tables

---

## Phase 1 ‚Äî Load or Create Conversation

### Code

```java
CeConversation convo = conversationRepo
        .findById(conversationId)
        .orElseGet(() -> createNewConversation(conversationId));
```

### Meaning
- Looks up the conversation row by `conversation_id`.
- If missing, creates a fresh one (`IDLE` state, `{}` context).

### Why it matters
- Enables **multi-turn conversations**.
- User can send messages independently and engine continues from DB state.

---

### Phase 1.1 ‚Äî Update last_user_text + timestamp

```java
convo.setLastUserText(userText);
convo.setUpdatedAt(OffsetDateTime.now());
```

- `last_user_text`: helpful for debugging and dashboards.
- `updated_at`: allows sorting ‚Äúmost recently active conversations‚Äù.

---

### Phase 1.2 ‚Äî Load intent and state

```java
String intent = convo.getIntentCode();
String state  = convo.getStateCode();
String previousIntent = intent;
```

- `intent`: **what** the user wants (GREETING/ACTION/etc)
- `state`: **where** the conversation is (IDLE/NEED_MORE_INFO/READY/DONE)
- `previousIntent`: used so we don‚Äôt rewrite intent unnecessarily

---

## Phase 2 ‚Äî Policy Enforcement (Hard Stop)

### Key concept
Policies are **pre-rules** and are evaluated before anything else.

### Code

```java
for (CePolicy policy : policyRepo.findByEnabledTrueOrderByPriorityAsc()) {
    if (matches(policy.getRuleType(), policy.getPattern(), userText)) {
        convo.setStatus("BLOCKED");
        convo.setLastAssistantJson(jsonText(policy.getResponseText()));
        conversationRepo.save(convo);
        return new EngineResult(...);
    }
}
```

### Meaning
- Policies are stored in `ce_policy`.
- If a policy matches, engine immediately:
  - marks conversation as `BLOCKED`
  - returns a fixed response
  - stops processing

### Why this is enterprise-grade
- Deterministic safety guardrails.
- No LLM needed to decide whether a message is allowed.

---

## Phase 3 ‚Äî Intent Classification (IDLE only)

### Key rule
> **We only classify intent when state is IDLE**.

### Why?
If you‚Äôre already mid-flow (`NEED_MORE_INFO`, `READY`), the user might say ‚Äúyes‚Äù or ‚Äúok‚Äù.
That should not randomly change intent back to GREETING or UNKNOWN.

### Code (conceptual)
- iterate `ce_intent_classifier` in priority order
- if a matcher hits, set intent

---

## Phase 4 ‚Äî Rule Processing (Deterministic)

Rules are the **state machine controls**.

They can:
- set intent
- set state
- short-circuit and end immediately

### Code

```java
RuleAction action = RuleAction.valueOf(...);

switch(action) {
  case SET_INTENT -> ...
  case SET_STATE -> ...
  case SHORT_CIRCUIT -> return ...
}
```

### Meaning
- Rules are in `ce_rule` and evaluated in order.
- They override previous intent/state decisions.
- `SHORT_CIRCUIT` returns immediately (like ‚Äúcancel‚Äù, ‚Äústop‚Äù, etc.)

---

## Phase 5 ‚Äî Guarantee Non-Null Intent/State

```java
if (intent == null) intent = "UNKNOWN";
if (state == null)  state = "IDLE";
```

### Meaning
- Makes later DB queries safe.
- Ensures response resolution always has stable keys.

---

## Phase 6 ‚Äî Schema-Bound Extraction (Intent + State)

### The key sentence
> ‚ÄúIf DB defines a schema for `(intent,state)`, extract JSON and merge into context.‚Äù

### Code

```java
outputSchemaRepo.findFirstByEnabledTrueAndIntentCodeAndStateCodeOrderByPriorityAsc(intent, state);
```

- Reads `ce_output_schema`.
- If schema exists ‚Üí call LLM in strict JSON mode.

### Why it‚Äôs not ‚Äúhardcoded‚Äù
- No schema in DB = extraction won‚Äôt happen.
- Schema content is 100% DB-controlled.
- Binding to state makes it precise.

---

## Phase 7 ‚Äî Response Resolution

### 3-level deterministic fallback

1) `(intent,state)` exact match  
2) `(state, intent_code is null)` global-by-state  
3) `(state_code = ANY)` global fallback

This guarantees you always get a response template.

Then response generation depends on:

- output_format = TEXT | JSON
- response_type = EXACT | DERIVED

---

## Phase 8 ‚Äî Persist + Return

The engine always persists the latest conversation update before returning.

That‚Äôs what makes multi-turn work.

---

---
## Examples

The below examples assume you added/used these intents/states:

**Intents**
- `GREETING`
- `ACTION_MOVE`
- `ACTION_DISCONNECT`
- `CONFIRMATION`
- `HELP`
- `UNKNOWN`

**States**
- `IDLE`
- `NEED_MORE_INFO`
- `READY`
- `DONE`

> üß† Note: Your **DB tables** define how these actually behave.


---


### Example 1 ‚Äî Greeting (EXACT)

<Conversation
    engineStatus="RUNNING"
    engineDetails={
        <>
            <div className="ce-engine-item success">state = IDLE</div>
            <div className="ce-engine-item success">intent = GREETING</div>
            <div className="ce-engine-item ok">response = EXACT TEXT</div>
        </>
    }
>
    <User>Hi</User>
    <Assistant>Hi, I am Conv Assistant. How can I help you?</Assistant>
</Conversation>

---

### Example 2 ‚Äî Move request begins (extract partial ‚Üí NEED_MORE_INFO)

<Conversation
    engineStatus="RUNNING"
    engineDetails={
        <>
            <div className="ce-engine-item success">intent = ACTION_MOVE</div>
            <div className="ce-engine-item warn">schema-bound extract ran</div>
            <div className="ce-engine-item warn">context_json now has from.subAccount = A</div>
            <div className="ce-engine-item warn">missing: to.subAccount</div>
            <div className="ce-engine-item success">state = NEED_MORE_INFO</div>
        </>
    }
>
    <User>move from A</User>
    <Assistant>Where do you want to move the service to?</Assistant>
</Conversation>

---

### Example 3 ‚Äî Provide missing field (auto-advance to READY)

<Conversation
    engineStatus="RUNNING"
    engineDetails={
        <>
            <div className="ce-engine-item success">intent = ACTION_MOVE</div>
            <div className="ce-engine-item warn">schema-bound extract ran</div>
            <div className="ce-engine-item success">context_json merged</div>
            <div className="ce-engine-item success">schema complete ‚úÖ</div>
            <div className="ce-engine-item success">state = READY</div>
        </>
    }
>
    <User>to B</User>
    <Assistant>Please confirm your request.</Assistant>
</Conversation>

---

### Example 4 ‚Äî Confirmation (SHORT_CIRCUIT)

<Conversation
    engineStatus="RUNNING"
    engineDetails={
        <>
            <div className="ce-engine-item success">intent = CONFIRMATION</div>
            <div className="ce-engine-item success">rule matched: confirm|yes</div>
            <div className="ce-engine-item success">state = DONE</div>
            <div className="ce-engine-item ok">response = EXACT TEXT</div>
        </>
    }
>
    <User>Yes, confirm</User>
    <Assistant>Done. Your request has been successfully completed.</Assistant>
</Conversation>

---

### Example 5 ‚Äî Cancel (SHORT_CIRCUIT global)

<Conversation
    engineStatus="RUNNING"
    engineDetails={
        <>
            <div className="ce-engine-item warn">rule matched: cancel|abort|stop</div>
            <div className="ce-engine-item ok">SHORT_CIRCUIT</div>
        </>
    }
>
    <User>cancel</User>
    <Assistant>Okay, I have stopped the current request.</Assistant>
</Conversation>

---

### Example 6 ‚Äî Policy block üö´

<Conversation
    engineStatus="ERROR"
    engineDetails={
        <>
            <div className="ce-engine-item error">policy matched: contains "hack"</div>
            <div className="ce-engine-item error">status = BLOCKED</div>
        </>
    }
>
    <User>how to hack the meter</User>
    <Assistant>I cannot help with that. Please provide a valid structured request.</Assistant>
</Conversation>

---

### Example 7 ‚Äî Help intent (derived text)

<Conversation
    engineStatus="RUNNING"
    engineDetails={
        <>
            <div className="ce-engine-item success">intent = HELP</div>
            <div className="ce-engine-item warn">LLM called (TEXT DERIVED)</div>
            <div className="ce-engine-item ok">logged in ce_llm_call_log ‚úÖ</div>
        </>
    }
>
    <User>What can you do?</User>
    <Assistant>I can help you move, disconnect, or validate a service request. Tell me what you want to do.</Assistant>
</Conversation>

---

### Example 8 ‚Äî Disconnect flow begins (needs connectionId)

<Conversation
    engineStatus="RUNNING"
    engineDetails={
        <>
            <div className="ce-engine-item success">intent = ACTION_DISCONNECT</div>
            <div className="ce-engine-item warn">missing: connectionId</div>
            <div className="ce-engine-item success">state = NEED_MORE_INFO</div>
        </>
    }
>
    <User>disconnect my service</User>
    <Assistant>Sure ‚Äî which connection ID should I disconnect?</Assistant>
</Conversation>

---

### Example 9 ‚Äî Provide connectionId ‚Üí READY

<Conversation
    engineStatus="RUNNING"
    engineDetails={
        <>
            <div className="ce-engine-item warn">schema-bound extract ran</div>
            <div className="ce-engine-item success">context_json merged: connectionId = USPSCON200</div>
            <div className="ce-engine-item success">state = READY</div>
        </>
    }
>
    <User>USPSCON200</User>
    <Assistant>Please confirm you want to disconnect USPSCON200.</Assistant>
</Conversation>

---

### Example 10 ‚Äî Unknown fallback

<Conversation
    engineStatus="RUNNING"
    engineDetails={
        <>
            <div className="ce-engine-item warn">intent = UNKNOWN</div>
            <div className="ce-engine-item ok">response = global fallback (ANY)</div>
        </>
    }
>
    <User>tell me a joke about transformers and electricity billing</User>
    <Assistant>Sorry, I did not understand that. Can you rephrase?</Assistant>
</Conversation>

---

## ‚úÖ Final Mental Model

:::note The ConvEngine contract
- Rules and policies control **intent + state**
- Schemas control **structure**
- LLM generates **text/JSON**, never state transitions
- DB is the source of truth for ‚Äúwhat should happen‚Äù
:::

---

If you want, next we can create a companion page:

- `code/engine-code-walkthrough.mdx` that links to this doc
- a Mermaid sequence diagram for phases 1‚Üí8 (looks üî•)
