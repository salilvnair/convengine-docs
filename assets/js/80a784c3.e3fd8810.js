"use strict";(globalThis.webpackChunkconvengine_docs=globalThis.webpackChunkconvengine_docs||[]).push([[641],{9647(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"consumer/extensions","title":"Extensions","description":"1) EngineStepHook - intervene between any steps","source":"@site/docs/consumer/extensions.mdx","sourceDirName":"consumer","slug":"/consumer/extensions","permalink":"/docs/consumer/extensions","draft":false,"unlisted":false,"editUrl":"https://github.com/salilvnair/convengine-docs/tree/main/docs/consumer/extensions.mdx","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"Extensions","sidebar_position":3},"sidebar":"docSidebar","previous":{"title":"Configuration","permalink":"/docs/consumer/configuration"},"next":{"title":"Session, Reset, Continuity","permalink":"/docs/consumer/session-reset-and-continuity"}}');var o=t(4848),r=t(8453),i=t(4566);const a={title:"Extensions",sidebar_position:3},c="Extension Points and Intervention Scenarios",l={},d=[{value:"1) <code>EngineStepHook</code> - intervene between any steps",id:"1-enginestephook---intervene-between-any-steps",level:2},{value:"2) <code>ContainerDataTransformer</code> - reshape container response",id:"2-containerdatatransformer---reshape-container-response",level:2},{value:"3) <code>ResponseTransformer</code> - post-process final payload",id:"3-responsetransformer---post-process-final-payload",level:2},{value:"4) <code>ContainerDataInterceptor</code> - intercept request/response around CCF",id:"4-containerdatainterceptor---intercept-requestresponse-around-ccf",level:2},{value:"5) Rule Action Playbook (<code>SET_TASK</code>, <code>SET_JSON</code>, <code>GET_CONTEXT</code>, <code>GET_SESSION</code>)",id:"5-rule-action-playbook-set_task-set_json-get_context-get_session",level:2},{value:"5.1 <code>SET_TASK</code> - execute consumer Java methods from rule",id:"51-set_task---execute-consumer-java-methods-from-rule",level:3},{value:"5.2 <code>SET_JSON</code> - move JSONPath value into input params",id:"52-set_json---move-jsonpath-value-into-input-params",level:3},{value:"5.3 <code>GET_CONTEXT</code> - snapshot context into input params",id:"53-get_context---snapshot-context-into-input-params",level:3},{value:"5.4 <code>GET_SESSION</code> - snapshot session facts into input params",id:"54-get_session---snapshot-session-facts-into-input-params",level:3},{value:"5.5 Custom action resolver (<code>RuleActionResolver</code>)",id:"55-custom-action-resolver-ruleactionresolver",level:3}];function p(e){const n={admonition:"admonition",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"extension-points-and-intervention-scenarios",children:"Extension Points and Intervention Scenarios"})}),"\n",(0,o.jsxs)(n.h2,{id:"1-enginestephook---intervene-between-any-steps",children:["1) ",(0,o.jsx)(n.code,{children:"EngineStepHook"})," - intervene between any steps"]}),"\n",(0,o.jsxs)(n.p,{children:["Real scenario: For ",(0,o.jsx)(n.code,{children:"LOG_ANALYSIS"}),", inject additional retrieval hint before schema extraction."]}),"\n",(0,o.jsx)(i.vl,{title:"EngineStepHook example",language:"java",packagePath:"com.acme.convengine.hooks",children:'@Component\npublic class LogAnalysisHintHook implements EngineStepHook {\n  @Override\n  public boolean supports(EngineStep.Name stepName, EngineSession session) {\n      return EngineStep.Name.SchemaExtractionStep == stepName\n          && "LOG_ANALYSIS".equalsIgnoreCase(session.getIntent());\n  }\n\n  @Override\n  public void beforeStep(EngineStep.Name stepName, EngineSession session) {\n      session.putInputParam("log_source_priority", "APM_FIRST");\n  }\n}'}),"\n",(0,o.jsx)(n.admonition,{title:"Where to use this",type:"tip",children:(0,o.jsx)(n.p,{children:"Use hooks when you need low-friction runtime intervention without forking framework steps."})}),"\n",(0,o.jsxs)(n.h2,{id:"2-containerdatatransformer---reshape-container-response",children:["2) ",(0,o.jsx)(n.code,{children:"ContainerDataTransformer"})," - reshape container response"]}),"\n",(0,o.jsx)(n.p,{children:"Real scenario: CCF returns nested payload; you flatten to schema-friendly map."}),"\n",(0,o.jsx)(i.vl,{title:"ContainerDataTransformer example",language:"java",packagePath:"com.acme.convengine.transformers",children:'@Component\n@ContainerDataTransformer(intent = "REQUEST_TRACKER", state = "IDLE")\npublic class RequestTrackerContainerTransformer implements ContainerDataTransformerHandler {\n  @Override\n  public Map<String, Object> transform(ContainerComponentResponse response,\n                                       EngineSession session,\n                                       Map<String, Object> inputParams) {\n      Map<String, Object> out = new LinkedHashMap<>();\n      out.put("ticket_id", inputParams.get("ticketId"));\n      out.put("status", "IN_REVIEW");\n      return out;\n  }\n}'}),"\n",(0,o.jsxs)(n.h2,{id:"3-responsetransformer---post-process-final-payload",children:["3) ",(0,o.jsx)(n.code,{children:"ResponseTransformer"})," - post-process final payload"]}),"\n",(0,o.jsx)(n.p,{children:"Real scenario: Add support-team escalation footer for high-severity disconnect failures."}),"\n",(0,o.jsx)(i.vl,{title:"ResponseTransformer example",language:"java",packagePath:"com.acme.convengine.transformers",children:'@Component\n@ResponseTransformer(intent = "DISCONNECT_ELECTRICITY", state = "FAILED")\npublic class DisconnectFailureResponseTransformer implements ResponseTransformerHandler {\n  @Override\n  public OutputPayload transform(OutputPayload responsePayload,\n                                 EngineSession session,\n                                 Map<String, Object> inputParams) {\n      if (responsePayload instanceof TextPayload(String text)) {\n          return new TextPayload(text + "\\nIf this is urgent, call support at +1-800-000-0000.");\n      }\n      return responsePayload;\n  }\n}'}),"\n",(0,o.jsxs)(n.h2,{id:"4-containerdatainterceptor---intercept-requestresponse-around-ccf",children:["4) ",(0,o.jsx)(n.code,{children:"ContainerDataInterceptor"})," - intercept request/response around CCF"]}),"\n",(0,o.jsx)(n.p,{children:"Real scenario: add tenant metadata and redact a field before persistence."}),"\n",(0,o.jsx)(i.vl,{title:"Interceptor scenario (concept)",language:"text",children:"Before Execute:\n- inject tenantId/requestId\n- attach observability headers\n\nAfter Execute:\n- redact sensitive node from raw container payload\n- enrich session input params for downstream rule checks"}),"\n",(0,o.jsxs)(n.h2,{id:"5-rule-action-playbook-set_task-set_json-get_context-get_session",children:["5) Rule Action Playbook (",(0,o.jsx)(n.code,{children:"SET_TASK"}),", ",(0,o.jsx)(n.code,{children:"SET_JSON"}),", ",(0,o.jsx)(n.code,{children:"GET_CONTEXT"}),", ",(0,o.jsx)(n.code,{children:"GET_SESSION"}),")"]}),"\n",(0,o.jsxs)(n.p,{children:["These actions execute inside ",(0,o.jsx)(i.pu,{children:"RulesStep.execute(...)"})," and mutate the live ",(0,o.jsx)(i.pu,{children:"EngineSession"}),"."]}),"\n",(0,o.jsx)(i.p,{title:"Action value format (exact runtime behavior)",columns:["Action","action_value format","Engine behavior"],rows:[["SET_TASK","beanName:methodName or beanName:methodA,methodB","Invokes Spring bean methods via CeRuleTaskExecutor"],["SET_JSON","targetKey:jsonPath","Extracts JSONPath from session eject and stores into inputParams[targetKey]"],["GET_CONTEXT","targetKey (optional)","Stores session.contextDict() into inputParams[targetKey] (default key=context)"],["GET_SESSION","targetKey (optional)","Stores session.sessionDict() into inputParams[targetKey] (default key=session)"]]}),"\n",(0,o.jsxs)(n.h3,{id:"51-set_task---execute-consumer-java-methods-from-rule",children:["5.1 ",(0,o.jsx)(n.code,{children:"SET_TASK"})," - execute consumer Java methods from rule"]}),"\n",(0,o.jsx)(n.p,{children:"Use this when a rule match must trigger consumer-side business logic (incident raise, tracker lookup, eligibility fetch, etc)."}),"\n",(0,o.jsx)(i.zM,{step:"1",title:"Create ce_rule row",children:(0,o.jsxs)(n.p,{children:["Set ",(0,o.jsx)(i.pu,{children:"ce_rule.action"})," to ",(0,o.jsx)(i.pu,{children:"SET_TASK"})," and provide bean/method mapping in ",(0,o.jsx)(i.pu,{children:"action_value"}),"."]})}),"\n",(0,o.jsx)(i.vl,{title:"SET_TASK rule example (SQL)",language:"sql",children:"INSERT INTO ce_rule\n(intent_code, rule_type, match_pattern, action, action_value, priority, enabled, description)\nVALUES\n('REQUEST_TRACKER', 'REGEX', '(?i).*track.*request.*', 'SET_TASK', 'requestTrackerTask:loadStatus,attachEta', 10, true,\n 'Load tracker status + ETA from consumer service');"}),"\n",(0,o.jsx)(i.zM,{step:"2",title:"Implement task bean",children:(0,o.jsxs)(n.p,{children:["Bean must be a Spring bean with the configured bean name and implement ",(0,o.jsx)(i.pu,{children:"CeRuleTask"}),". Methods are invoked with ",(0,o.jsx)(i.pu,{children:"(EngineSession session, CeRule rule)"}),"."]})}),"\n",(0,o.jsx)(i.vl,{title:"Consumer task bean (Java)",language:"java",packagePath:"com.acme.convengine.tasks",filePath:"src/main/java/com/acme/convengine/tasks/RequestTrackerTask.java",children:'@Component("requestTrackerTask")\npublic class RequestTrackerTask implements CeRuleTask {\n\n  public void loadStatus(EngineSession session, CeRule rule) {\n      String requestId = String.valueOf(session.contextDict().getOrDefault("requestId", ""));\n      // fetch from your DB/service\n      session.putContext("requestStatus", "APPROVAL_PENDING");\n      session.putContext("lastUpdated", "2026-02-10T11:40:00Z");\n  }\n\n  public void attachEta(EngineSession session, CeRule rule) {\n      session.putInputParam("eta_hours", 12);\n  }\n}'}),"\n",(0,o.jsx)(i.zM,{step:"3",title:"Use in response generation",children:(0,o.jsxs)(n.p,{children:["Downstream prompt/response can read new context/inputParams (for example ",(0,o.jsx)(n.code,{children:"requestStatus"}),", ",(0,o.jsx)(n.code,{children:"lastUpdated"}),", ",(0,o.jsx)(n.code,{children:"eta_hours"}),")."]})}),"\n",(0,o.jsxs)(n.h3,{id:"52-set_json---move-jsonpath-value-into-input-params",children:["5.2 ",(0,o.jsx)(n.code,{children:"SET_JSON"})," - move JSONPath value into input params"]}),"\n",(0,o.jsx)(n.p,{children:"Use this to extract one value from runtime session JSON into a flat prompt var."}),"\n",(0,o.jsx)(i.vl,{title:"SET_JSON rule example (SQL)",language:"sql",children:"INSERT INTO ce_rule\n(intent_code, rule_type, match_pattern, action, action_value, priority, enabled, description)\nVALUES\n('LOG_ANALYSIS', 'JSON_PATH', '$.schemaJson.errorCode != null', 'SET_JSON', 'error_code:$.schemaJson.errorCode', 20, true,\n 'Expose extracted errorCode as prompt var');"}),"\n",(0,o.jsx)(i.f4,{type:"info",title:"What exactly gets updated",children:(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"SET_JSON"})," writes to ",(0,o.jsx)(i.pu,{children:'session.putInputParam("error_code", value)'}),".",(0,o.jsx)(n.br,{}),"\n","It does not change ",(0,o.jsx)(n.code,{children:"session.contextJson"})," unless your subsequent task/hook updates context explicitly."]})}),"\n",(0,o.jsxs)(n.h3,{id:"53-get_context---snapshot-context-into-input-params",children:["5.3 ",(0,o.jsx)(n.code,{children:"GET_CONTEXT"})," - snapshot context into input params"]}),"\n",(0,o.jsx)(n.p,{children:"Use this when prompt templates or tasks need full context as a single variable."}),"\n",(0,o.jsx)(i.vl,{title:"GET_CONTEXT rule example (SQL)",language:"sql",children:"INSERT INTO ce_rule\n(intent_code, rule_type, match_pattern, action, action_value, priority, enabled, description)\nVALUES\n('REQUEST_TRACKER', 'REGEX', '(?i).*status.*', 'GET_CONTEXT', 'ctx_snapshot', 30, true,\n 'Expose full context to prompt/task layer');"}),"\n",(0,o.jsxs)(n.p,{children:["If ",(0,o.jsx)(n.code,{children:"action_value"})," is blank, engine uses default key ",(0,o.jsx)(n.code,{children:"context"}),"."]}),"\n",(0,o.jsxs)(n.h3,{id:"54-get_session---snapshot-session-facts-into-input-params",children:["5.4 ",(0,o.jsx)(n.code,{children:"GET_SESSION"})," - snapshot session facts into input params"]}),"\n",(0,o.jsxs)(n.p,{children:["Use this for advanced derived responses that need runtime flags (",(0,o.jsx)(n.code,{children:"schemaComplete"}),", ",(0,o.jsx)(n.code,{children:"intentLocked"}),", ",(0,o.jsx)(n.code,{children:"missingRequiredFields"}),", etc)."]}),"\n",(0,o.jsx)(i.vl,{title:"GET_SESSION rule example (SQL)",language:"sql",children:"INSERT INTO ce_rule\n(intent_code, rule_type, match_pattern, action, action_value, priority, enabled, description)\nVALUES\n('DISCONNECT_ELECTRICITY', 'JSON_PATH', '$.schemaComplete == false', 'GET_SESSION', 'session_snapshot', 40, true,\n 'Expose full runtime session facts for follow-up prompt decisions');"}),"\n",(0,o.jsxs)(n.p,{children:["If ",(0,o.jsx)(n.code,{children:"action_value"})," is blank, engine uses default key ",(0,o.jsx)(n.code,{children:"session"}),"."]}),"\n",(0,o.jsx)(i.f4,{type:"warning",title:"Operational guardrails",children:(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"SET_TASK"})," methods run during rule execution. Keep methods deterministic and idempotent.",(0,o.jsx)(n.br,{}),"\n","For side-effecting calls (ticket creation, webhook dispatch), guard with strict rule conditions and add idempotency keys from ",(0,o.jsx)(i.pu,{children:"conversationId"}),"."]})}),"\n",(0,o.jsx)(i.f4,{type:"tip",title:"Where to trace this in code",children:(0,o.jsxs)(n.p,{children:["Resolvers: ",(0,o.jsx)(i.Mn,{children:"engine/rule/type/provider/SetTaskActionResolver.java"}),", ",(0,o.jsx)(i.Mn,{children:"engine/rule/type/provider/SetJsonActionResolver.java"}),", ",(0,o.jsx)(i.Mn,{children:"engine/rule/type/provider/GetContextActionResolver.java"}),", ",(0,o.jsx)(i.Mn,{children:"engine/rule/type/provider/GetSessionActionResolver.java"}),".",(0,o.jsx)(n.br,{}),"\n","Task invocation: ",(0,o.jsx)(i.Mn,{children:"engine/rule/task/CeRuleTaskExecutor.java"}),".",(0,o.jsx)(n.br,{}),"\n","Execution loop: ",(0,o.jsx)(i.Mn,{children:"engine/steps/RulesStep.java"}),"."]})}),"\n",(0,o.jsxs)(n.h3,{id:"55-custom-action-resolver-ruleactionresolver",children:["5.5 Custom action resolver (",(0,o.jsx)(n.code,{children:"RuleActionResolver"}),")"]}),"\n",(0,o.jsx)(n.p,{children:"Consumer can define a brand-new rule action without changing framework core."}),"\n",(0,o.jsx)(i.zM,{step:"1",title:"Create custom resolver bean",children:(0,o.jsxs)(n.p,{children:["Implement ",(0,o.jsx)(i.pu,{children:"RuleActionResolver"})," and return your action name from ",(0,o.jsx)(i.pu,{children:"action()"}),"."]})}),"\n",(0,o.jsx)(i.vl,{title:"Custom RuleActionResolver example",language:"java",packagePath:"com.acme.convengine.rules",filePath:"src/main/java/com/acme/convengine/rules/EnrichCustomerTierActionResolver.java",children:'@Component\npublic class EnrichCustomerTierActionResolver implements RuleActionResolver {\n\n  @Override\n  public String action() {\n      return "ENRICH_TIER";\n  }\n\n  @Override\n  public void resolve(EngineSession session, CeRule rule) {\n      // action_value example: customerTier:PREMIUM\n      String raw = rule.getActionValue() == null ? "" : rule.getActionValue();\n      String[] parts = raw.split(":", 2);\n      String key = parts.length > 0 && !parts[0].isBlank() ? parts[0] : "customerTier";\n      String value = parts.length > 1 ? parts[1] : "STANDARD";\n\n      session.putContext(key, value);\n      session.putInputParam(key, value);\n  }\n}'}),"\n",(0,o.jsx)(i.zM,{step:"2",title:"Use action in ce_rule",children:(0,o.jsxs)(n.p,{children:["Set ",(0,o.jsx)(i.pu,{children:"ce_rule.action"})," to your custom token (case-insensitive lookup), for example ",(0,o.jsx)(i.pu,{children:"ENRICH_TIER"}),"."]})}),"\n",(0,o.jsx)(i.vl,{title:"ce_rule row for custom action",language:"sql",children:"INSERT INTO ce_rule\n(intent_code, rule_type, match_pattern, action, action_value, priority, enabled, description)\nVALUES\n('REQUEST_TRACKER', 'REGEX', '(?i).*vip.*', 'ENRICH_TIER', 'customerTier:PREMIUM', 5, true,\n 'Mark VIP tier for downstream response logic');"}),"\n",(0,o.jsx)(i.f4,{type:"tip",title:"Auto-registration behavior",children:(0,o.jsxs)(n.p,{children:["No manual factory config is needed. ",(0,o.jsx)(i.pu,{children:"RuleActionResolverFactory"})," auto-discovers all Spring beans implementing ",(0,o.jsx)(i.pu,{children:"RuleActionResolver"})," and maps by ",(0,o.jsx)(i.pu,{children:"action().toUpperCase()"}),"."]})})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(p,{...e})}):p(e)}}}]);