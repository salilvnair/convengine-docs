# ğŸ§ªğŸ“œ LLM Observability & Audit

`ce_llm_call_log` records **every interaction with an LLM** made by ConvEngine.
This table is the foundation for **debugging, cost control, compliance, and trust**.

---

## ğŸ§  Why This Exists

> If an LLM influences user experience, it must be observable.

ConvEngine treats LLMs as **external, fallible services** â€” not as decision-makers.
Every call is logged with full context.

---

## ğŸ“¦ Table Definition

```sql
CREATE TABLE ce_llm_call_log (
  llm_call_id     BIGSERIAL PRIMARY KEY,

  conversation_id UUID        NOT NULL,
  intent_code     TEXT,
  state_code      TEXT,

  provider        TEXT        NOT NULL,   -- openai, azure-openai, etc
  model           TEXT        NOT NULL,
  temperature     NUMERIC(3,2),

  prompt_text     TEXT        NOT NULL,   -- full system + instruction prompt
  user_context    TEXT        NOT NULL,   -- context_json + user input
  response_text   TEXT,                   -- raw LLM output

  success         BOOLEAN     NOT NULL,
  error_message   TEXT,

  created_at      TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

---

## ğŸ” What Gets Logged

Each row captures:

- ğŸ”— **Conversation linkage**
- ğŸ§  Intent + state at time of call
- ğŸ¤– Provider + model used
- ğŸŒ¡ Temperature (and future params)
- ğŸ“ Exact prompt sent
- ğŸ“¦ Full user/context payload
- ğŸ“¤ Raw response (or error)

Nothing is inferred later â€” everything is stored **as-is**.

---

## ğŸ” When Logging Happens

LLM calls are logged when:

- A `DERIVED` response is generated
- A JSON schema extraction is attempted
- Follow-up questions are generated
- UI JSON is synthesized

Both **success and failure** are logged.

---

## âŒ What Is NOT Logged

- âŒ Business decisions
- âŒ Rule evaluations
- âŒ State transitions

Those belong to `ce_audit`.

---

## ğŸ§ª Example Log Entry

```sql
INSERT INTO ce_llm_call_log (
  conversation_id,
  intent_code,
  state_code,
  provider,
  model,
  temperature,
  prompt_text,
  user_context,
  response_text,
  success
)
VALUES (
  '4a6fe675-977f-4680-b211-a227bad72178',
  'ACTION',
  'NEED_MORE_INFO',
  'openai',
  'gpt-4o-mini',
  0.0,
  'Politely ask the user for missing fields.',
  '{ "lastUserText": "move from A" }',
  'Where do you want to move the service to?',
  true
);
```

---

## ğŸ›¡ï¸ Compliance & Safety

This table enables:

- ğŸ” Post-incident analysis
- ğŸ’° Cost attribution per conversation
- ğŸ§¾ Audit trails for regulated environments
- ğŸ§  Prompt evolution tracking

---

## âœ… Why This Is Critical

- Debugging becomes trivial
- LLM hallucinations are traceable
- Reproducibility is possible
- Trust increases across teams

If something went wrong â€” **this table tells you exactly why**.
