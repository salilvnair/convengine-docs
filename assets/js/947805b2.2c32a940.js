"use strict";(globalThis.webpackChunkconvengine_docs=globalThis.webpackChunkconvengine_docs||[]).push([[2644],{4063(e,n,s){s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>u,frontMatter:()=>o,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"consumer/extensions","title":"Extensions","description":"EngineStepHook - intervene between any steps","source":"@site/docs/v1/consumer/extensions.mdx","sourceDirName":"consumer","slug":"/consumer/extensions","permalink":"/docs/v1/consumer/extensions","draft":false,"unlisted":false,"editUrl":"https://github.com/salilvnair/convengine-docs/tree/main/docs/v1/consumer/extensions.mdx","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"Extensions","sidebar_position":3},"sidebar":"docSidebar","previous":{"title":"Annotations Reference","permalink":"/docs/v1/consumer/annotations-reference"},"next":{"title":"Session, Reset, Continuity","permalink":"/docs/v1/consumer/session-reset-and-continuity"}}');var i=s(4848),r=s(8453),a=s(9131);const o={title:"Extensions",sidebar_position:3},c="Extension Points and Intervention Scenarios",l={},d=[{value:"<code>EngineStepHook</code> - intervene between any steps",id:"1-enginestephook---intervene-between-any-steps",level:2},{value:"<code>ContainerDataTransformer</code> - reshape container response",id:"2-containerdatatransformer---reshape-container-response",level:2},{value:"<code>ResponseTransformer</code> - post-process final payload",id:"3-responsetransformer---post-process-final-payload",level:2},{value:"<code>ContainerDataInterceptor</code> - intercept request/response around CCF",id:"4-containerdatainterceptor---intercept-requestresponse-around-ccf",level:2},{value:"Rule Action Playbook (<code>SET_TASK</code>, <code>SET_JSON</code>, <code>GET_CONTEXT</code>, <code>GET_SESSION</code>)",id:"5-rule-action-playbook-set_task-set_json-get_context-get_session",level:2},{value:"<code>SET_TASK</code> - execute consumer Java methods from rule",id:"51-set_task---execute-consumer-java-methods-from-rule",level:3},{value:"<code>SET_JSON</code> - move JSONPath value into input params",id:"52-set_json---move-jsonpath-value-into-input-params",level:3},{value:"<code>GET_CONTEXT</code> - snapshot context into input params",id:"53-get_context---snapshot-context-into-input-params",level:3},{value:"<code>GET_SESSION</code> - snapshot session facts into input params",id:"54-get_session---snapshot-session-facts-into-input-params",level:3},{value:"Custom action resolver (<code>RuleActionResolver</code>)",id:"55-custom-action-resolver-ruleactionresolver",level:3}];function p(e){const n={admonition:"admonition",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"extension-points-and-intervention-scenarios",children:"Extension Points and Intervention Scenarios"})}),"\n",(0,i.jsxs)("div",{className:"ce-extensions-page",children:[(0,i.jsxs)(n.h2,{id:"1-enginestephook---intervene-between-any-steps",children:[(0,i.jsx)(n.code,{children:"EngineStepHook"})," - intervene between any steps"]}),(0,i.jsxs)(n.p,{children:["Real scenario: For ",(0,i.jsx)(n.code,{children:"LOG_ANALYSIS"}),", inject additional retrieval hint before schema extraction."]}),(0,i.jsx)(a.vl,{title:"EngineStepHook example",language:"java",packagePath:"com.zapper.convengine.hooks",children:'@Component\npublic class LogAnalysisHintHook implements EngineStepHook {\n  @Override\n  public boolean supports(EngineStep.Name stepName, EngineSession session) {\n      return EngineStep.Name.SchemaExtractionStep == stepName\n          && "LOG_ANALYSIS".equalsIgnoreCase(session.getIntent());\n  }\n\n  @Override\n  public void beforeStep(EngineStep.Name stepName, EngineSession session) {\n      session.putInputParam("log_source_priority", "APM_FIRST");\n  }\n}'}),(0,i.jsx)(n.admonition,{title:"Where to use this",type:"tip",children:(0,i.jsx)(n.p,{children:"Use hooks when you need low-friction runtime intervention without forking framework steps."})}),(0,i.jsxs)(n.h2,{id:"2-containerdatatransformer---reshape-container-response",children:[(0,i.jsx)(n.code,{children:"ContainerDataTransformer"})," - reshape container response"]}),(0,i.jsx)(n.p,{children:"Real scenario: CCF returns nested payload; you flatten to schema-friendly map."}),(0,i.jsx)(a.vl,{title:"ContainerDataTransformer example",language:"java",packagePath:"com.zapper.convengine.transformers",children:'@Component\n@ContainerDataTransformer(intent = "REQUEST_TRACKER", state = "IDLE")\npublic class RequestTrackerContainerTransformer implements ContainerDataTransformerHandler {\n  @Override\n  public Map<String, Object> transform(ContainerComponentResponse response,\n                                       EngineSession session,\n                                       Map<String, Object> inputParams) {\n      Map<String, Object> out = new LinkedHashMap<>();\n      out.put("ticket_id", inputParams.get("ticketId"));\n      out.put("status", "IN_REVIEW");\n      return out;\n  }\n}'}),(0,i.jsxs)(n.h2,{id:"3-responsetransformer---post-process-final-payload",children:[(0,i.jsx)(n.code,{children:"ResponseTransformer"})," - post-process final payload"]}),(0,i.jsx)(n.p,{children:"Real scenario: Add support-team escalation footer for high-severity disconnect failures."}),(0,i.jsx)(a.vl,{title:"ResponseTransformer example",language:"java",packagePath:"com.zapper.convengine.transformers",children:'@Component\n@ResponseTransformer(intent = "DISCONNECT_ELECTRICITY", state = "FAILED")\npublic class DisconnectFailureResponseTransformer implements ResponseTransformerHandler {\n  @Override\n  public OutputPayload transform(OutputPayload responsePayload,\n                                 EngineSession session,\n                                 Map<String, Object> inputParams) {\n      if (responsePayload instanceof TextPayload(String text)) {\n          return new TextPayload(text + "\\nIf this is urgent, call support at +1-800-000-0000.");\n      }\n      return responsePayload;\n  }\n}'}),(0,i.jsxs)(n.h2,{id:"4-containerdatainterceptor---intercept-requestresponse-around-ccf",children:[(0,i.jsx)(n.code,{children:"ContainerDataInterceptor"})," - intercept request/response around CCF"]}),(0,i.jsx)(n.p,{children:"Real scenario: add tenant metadata and redact a field before persistence."}),(0,i.jsx)(a.vl,{title:"Interceptor scenario (concept)",language:"text",children:"Before Execute:\n- inject tenantId/requestId\n- attach observability headers\n\nAfter Execute:\n- redact sensitive node from raw container payload\n- enrich session input params for downstream rule checks"}),(0,i.jsxs)(n.h2,{id:"5-rule-action-playbook-set_task-set_json-get_context-get_session",children:["Rule Action Playbook (",(0,i.jsx)(n.code,{children:"SET_TASK"}),", ",(0,i.jsx)(n.code,{children:"SET_JSON"}),", ",(0,i.jsx)(n.code,{children:"GET_CONTEXT"}),", ",(0,i.jsx)(n.code,{children:"GET_SESSION"}),")"]}),(0,i.jsxs)(n.p,{children:["These actions execute inside ",(0,i.jsx)(a.pu,{children:"RulesStep.execute(...)"})," and mutate the live ",(0,i.jsx)(a.pu,{children:"EngineSession"}),"."]}),(0,i.jsxs)(n.p,{children:["Set ",(0,i.jsx)(a.pu,{children:"ce_rule.phase"})," based on where you want the action to run:"]}),(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(a.pu,{children:"PIPELINE_RULES"}),": normal ",(0,i.jsx)(a.pu,{children:"RulesStep"})," pass."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(a.pu,{children:"AGENT_POST_INTENT"}),": post-intent pass inside ",(0,i.jsx)(a.pu,{children:"AgentIntentResolver"}),"."]}),"\n"]}),(0,i.jsx)(a.p,{title:"Action value format (exact runtime behavior)",columns:["Action","action_value format","Engine behavior"],rows:[["SET_TASK","beanName:methodName or beanName:methodA,methodB","Invokes Spring bean methods via CeRuleTaskExecutor"],["SET_JSON","targetKey:jsonPath","Extracts JSONPath from session eject and stores into inputParams[targetKey]"],["GET_CONTEXT","targetKey (optional)","Stores session.contextDict() into inputParams[targetKey] (default key=context)"],["GET_SESSION","targetKey (optional)","Stores session.sessionDict() into inputParams[targetKey] (default key=session)"]]}),(0,i.jsxs)(n.h3,{id:"51-set_task---execute-consumer-java-methods-from-rule",children:[(0,i.jsx)(n.code,{children:"SET_TASK"})," - execute consumer Java methods from rule"]}),(0,i.jsx)(n.p,{children:"Use this when a rule match must trigger consumer-side business logic (incident raise, tracker lookup, eligibility fetch, etc)."}),(0,i.jsx)(a.zM,{step:"1",title:"Create ce_rule row",children:(0,i.jsxs)(n.p,{children:["Set ",(0,i.jsx)(a.pu,{children:"ce_rule.action"})," to ",(0,i.jsx)(a.pu,{children:"SET_TASK"})," and provide bean/method mapping in ",(0,i.jsx)(a.pu,{children:"action_value"}),"."]})}),(0,i.jsx)(a.vl,{title:"SET_TASK rule example (SQL)",language:"sql",children:"INSERT INTO ce_rule\n(phase, intent_code, state_code, rule_type, match_pattern, action, action_value, priority, enabled, description)\nVALUES\n('PIPELINE_RULES', 'REQUEST_TRACKER', 'ANY', 'REGEX', '(?i).*track.*request.*', 'SET_TASK', 'requestTrackerTask:loadStatus,attachEta', 10, true,\n 'Load tracker status + ETA from consumer service');"}),(0,i.jsx)(a.zM,{step:"2",title:"Implement task bean",children:(0,i.jsxs)(n.p,{children:["Bean must be a Spring bean with the configured bean name and implement ",(0,i.jsx)(a.pu,{children:"CeRuleTask"}),". Methods are invoked with ",(0,i.jsx)(a.pu,{children:"(EngineSession session, CeRule rule)"}),"."]})}),(0,i.jsx)(a.vl,{title:"Consumer task bean (Java)",language:"java",packagePath:"com.zapper.convengine.tasks",filePath:"src/main/java/com/acme/convengine/tasks/RequestTrackerTask.java",children:'@Component("requestTrackerTask")\npublic class RequestTrackerTask implements CeRuleTask {\n\n  public void loadStatus(EngineSession session, CeRule rule) {\n      String requestId = String.valueOf(session.getInputParams().getOrDefault("requestId", ""));\n      // fetch from your DB/service\n      session.putInputParam("requestStatus", "APPROVAL_PENDING");\n      session.putInputParam("lastUpdated", "2026-02-10T11:40:00Z");\n  }\n\n  public void attachEta(EngineSession session, CeRule rule) {\n      session.putInputParam("eta_hours", 12);\n  }\n}'}),(0,i.jsx)(a.zM,{step:"3",title:"Use in response generation",children:(0,i.jsxs)(n.p,{children:["Downstream prompt/response can read new context/inputParams (for example ",(0,i.jsx)(n.code,{children:"requestStatus"}),", ",(0,i.jsx)(n.code,{children:"lastUpdated"}),", ",(0,i.jsx)(n.code,{children:"eta_hours"}),")."]})}),(0,i.jsxs)(n.h3,{id:"52-set_json---move-jsonpath-value-into-input-params",children:[(0,i.jsx)(n.code,{children:"SET_JSON"})," - move JSONPath value into input params"]}),(0,i.jsx)(n.p,{children:"Use this to extract one value from runtime session JSON into a flat prompt var."}),(0,i.jsx)(a.vl,{title:"SET_JSON rule example (SQL)",language:"sql",children:"INSERT INTO ce_rule\n(phase, intent_code, state_code, rule_type, match_pattern, action, action_value, priority, enabled, description)\nVALUES\n('PIPELINE_RULES', 'LOG_ANALYSIS', 'ANY', 'JSON_PATH', '$.schemaJson.errorCode != null', 'SET_JSON', 'error_code:$.schemaJson.errorCode', 20, true,\n 'Expose extracted errorCode as prompt var');"}),(0,i.jsx)(a.f4,{type:"info",title:"What exactly gets updated",children:(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"SET_JSON"})," writes to ",(0,i.jsx)(a.pu,{children:'session.putInputParam("error_code", value)'}),".",(0,i.jsx)(n.br,{}),"\n","It does not change ",(0,i.jsx)(n.code,{children:"session.contextJson"})," unless your subsequent task/hook updates context explicitly."]})}),(0,i.jsxs)(n.h3,{id:"53-get_context---snapshot-context-into-input-params",children:[(0,i.jsx)(n.code,{children:"GET_CONTEXT"})," - snapshot context into input params"]}),(0,i.jsx)(n.p,{children:"Use this when prompt templates or tasks need full context as a single variable."}),(0,i.jsx)(a.vl,{title:"GET_CONTEXT rule example (SQL)",language:"sql",children:"INSERT INTO ce_rule\n(phase, intent_code, state_code, rule_type, match_pattern, action, action_value, priority, enabled, description)\nVALUES\n('PIPELINE_RULES', 'REQUEST_TRACKER', 'ANY', 'REGEX', '(?i).*status.*', 'GET_CONTEXT', 'ctx_snapshot', 30, true,\n 'Expose full context to prompt/task layer');"}),(0,i.jsxs)(n.p,{children:["If ",(0,i.jsx)(n.code,{children:"action_value"})," is blank, engine uses default key ",(0,i.jsx)(n.code,{children:"context"}),"."]}),(0,i.jsxs)(n.h3,{id:"54-get_session---snapshot-session-facts-into-input-params",children:[(0,i.jsx)(n.code,{children:"GET_SESSION"})," - snapshot session facts into input params"]}),(0,i.jsxs)(n.p,{children:["Use this for advanced derived responses that need runtime flags (",(0,i.jsx)(n.code,{children:"schemaComplete"}),", ",(0,i.jsx)(n.code,{children:"intentLocked"}),", ",(0,i.jsx)(n.code,{children:"missingRequiredFields"}),", etc)."]}),(0,i.jsx)(a.vl,{title:"GET_SESSION rule example (SQL)",language:"sql",children:"INSERT INTO ce_rule\n(phase, intent_code, state_code, rule_type, match_pattern, action, action_value, priority, enabled, description)\nVALUES\n('PIPELINE_RULES', 'DISCONNECT_ELECTRICITY', 'ANY', 'JSON_PATH', '$.schemaComplete == false', 'GET_SESSION', 'session_snapshot', 40, true,\n 'Expose full runtime session facts for follow-up prompt decisions');"}),(0,i.jsxs)(n.p,{children:["If ",(0,i.jsx)(n.code,{children:"action_value"})," is blank, engine uses default key ",(0,i.jsx)(n.code,{children:"session"}),"."]}),(0,i.jsx)(a.f4,{type:"warning",title:"Operational guardrails",children:(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"SET_TASK"})," methods run during rule execution. Keep methods deterministic and idempotent.",(0,i.jsx)(n.br,{}),"\n","For side-effecting calls (ticket creation, webhook dispatch), guard with strict rule conditions and add idempotency keys from ",(0,i.jsx)(a.pu,{children:"conversationId"}),"."]})}),(0,i.jsx)(a.f4,{type:"tip",title:"Where to trace this in code",children:(0,i.jsxs)("div",{className:"ce-chip-groups",children:[(0,i.jsxs)("div",{className:"ce-chip-group",children:[(0,i.jsx)("span",{className:"ce-chip-group-label",children:"Resolvers"}),(0,i.jsxs)("div",{className:"ce-chip-list",children:[(0,i.jsx)("span",{className:"ce-chip-item",children:(0,i.jsx)(a.Mn,{children:"engine/rule/type/provider/SetTaskActionResolver.java"})}),(0,i.jsx)("span",{className:"ce-chip-item",children:(0,i.jsx)(a.Mn,{children:"engine/rule/type/provider/SetJsonActionResolver.java"})}),(0,i.jsx)("span",{className:"ce-chip-item",children:(0,i.jsx)(a.Mn,{children:"engine/rule/type/provider/GetContextActionResolver.java"})}),(0,i.jsx)("span",{className:"ce-chip-item",children:(0,i.jsx)(a.Mn,{children:"engine/rule/type/provider/GetSessionActionResolver.java"})})]})]}),(0,i.jsxs)("div",{className:"ce-chip-group",children:[(0,i.jsx)("span",{className:"ce-chip-group-label",children:"Task invocation"}),(0,i.jsx)("div",{className:"ce-chip-list",children:(0,i.jsx)("span",{className:"ce-chip-item",children:(0,i.jsx)(a.Mn,{children:"engine/rule/task/CeRuleTaskExecutor.java"})})})]}),(0,i.jsxs)("div",{className:"ce-chip-group",children:[(0,i.jsx)("span",{className:"ce-chip-group-label",children:"Execution loop"}),(0,i.jsx)("div",{className:"ce-chip-list",children:(0,i.jsx)("span",{className:"ce-chip-item",children:(0,i.jsx)(a.Mn,{children:"engine/steps/RulesStep.java"})})})]})]})}),(0,i.jsxs)(n.h3,{id:"55-custom-action-resolver-ruleactionresolver",children:["Custom action resolver (",(0,i.jsx)(n.code,{children:"RuleActionResolver"}),")"]}),(0,i.jsx)(n.p,{children:"Consumer can define a brand-new rule action without changing framework core."}),(0,i.jsx)(a.zM,{step:"1",title:"Create custom resolver bean",children:(0,i.jsxs)(n.p,{children:["Implement ",(0,i.jsx)(a.pu,{children:"RuleActionResolver"})," and return your action name from ",(0,i.jsx)(a.pu,{children:"action()"}),"."]})}),(0,i.jsx)(a.vl,{title:"Custom RuleActionResolver example",language:"java",packagePath:"com.zapper.convengine.rules",filePath:"src/main/java/com/acme/convengine/rules/EnrichCustomerTierActionResolver.java",children:'@Component\npublic class EnrichCustomerTierActionResolver implements RuleActionResolver {\n\n  @Override\n  public String action() {\n      return "ENRICH_TIER";\n  }\n\n  @Override\n  public void resolve(EngineSession session, CeRule rule) {\n      // action_value example: customerTier:PREMIUM\n      String raw = rule.getActionValue() == null ? "" : rule.getActionValue();\n      String[] parts = raw.split(":", 2);\n      String key = parts.length > 0 && !parts[0].isBlank() ? parts[0] : "customerTier";\n      String value = parts.length > 1 ? parts[1] : "STANDARD";\n\n      session.putInputParam(key, value);\n  }\n}'}),(0,i.jsx)(a.zM,{step:"2",title:"Use action in ce_rule",children:(0,i.jsxs)(n.p,{children:["Set ",(0,i.jsx)(a.pu,{children:"ce_rule.action"})," to your custom token (case-insensitive lookup), for example ",(0,i.jsx)(a.pu,{children:"ENRICH_TIER"}),"."]})}),(0,i.jsx)(a.vl,{title:"ce_rule row for custom action",language:"sql",children:"INSERT INTO ce_rule\n(phase, intent_code, rule_type, match_pattern, action, action_value, priority, enabled, description)\nVALUES\n('PIPELINE_RULES', 'REQUEST_TRACKER', 'REGEX', '(?i).*vip.*', 'ENRICH_TIER', 'customerTier:PREMIUM', 5, true,\n 'Mark VIP tier for downstream response logic');"}),(0,i.jsx)(a.f4,{type:"tip",title:"Auto-registration behavior",children:(0,i.jsxs)(n.p,{children:["No manual factory config is needed. ",(0,i.jsx)(a.n0,{term:"Auto-registration behavior",children:"RuleActionResolverFactory auto-registration behavior"})," auto-discovers all Spring beans implementing ",(0,i.jsx)(a.pu,{children:"RuleActionResolver"})," and maps by ",(0,i.jsx)(a.pu,{children:"action().toUpperCase()"}),"."]})})]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(p,{...e})}):p(e)}}}]);