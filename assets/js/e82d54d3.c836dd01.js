"use strict";(globalThis.webpackChunkconvengine_docs=globalThis.webpackChunkconvengine_docs||[]).push([[1298],{1628(e,i,n){n.r(i),n.d(i,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"deep-dive/mcp-audit","title":"MCP & Audit","description":"MCP flow","source":"@site/docs/v1/deep-dive/mcp-audit.mdx","sourceDirName":"deep-dive","slug":"/deep-dive/mcp-audit","permalink":"/docs/v1/deep-dive/mcp-audit","draft":false,"unlisted":false,"editUrl":"https://github.com/salilvnair/convengine-docs/tree/main/docs/v1/deep-dive/mcp-audit.mdx","tags":[],"version":"current","sidebarPosition":7,"frontMatter":{"title":"MCP & Audit","sidebar_position":7,"hide_table_of_contents":true},"sidebar":"docSidebar","previous":{"title":"Rules & Responses","permalink":"/docs/v1/deep-dive/rules-responses"},"next":{"title":"Data Correctness Gotchas","permalink":"/docs/v1/deep-dive/failure-gotchas"}}');var t=n(4848),l=n(8453),d=n(9131);const r={title:"MCP & Audit",sidebar_position:7,hide_table_of_contents:!0},o="MCP and Audit Internals",c={},a=[{value:"MCP flow",id:"mcp-flow",level:2},{value:"MCP-related tables",id:"mcp-related-tables",level:2},{value:"Audit stream model",id:"audit-stream-model",level:2},{value:"Trace API",id:"trace-api",level:2}];function p(e){const i={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",ul:"ul",...(0,l.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.header,{children:(0,t.jsx)(i.h1,{id:"mcp-and-audit-internals",children:"MCP and Audit Internals"})}),"\n",(0,t.jsx)(i.h2,{id:"mcp-flow",children:"MCP flow"}),"\n",(0,t.jsxs)(i.p,{children:[(0,t.jsx)(i.code,{children:"McpToolStep"})," does:"]}),"\n",(0,t.jsxs)(i.ol,{children:["\n",(0,t.jsx)(i.li,{children:"skip on pending clarification"}),"\n",(0,t.jsx)(i.li,{children:"list enabled tools"}),"\n",(0,t.jsxs)(i.li,{children:["clear stale ",(0,t.jsx)(i.code,{children:"context_json.mcp"})," branch"]}),"\n",(0,t.jsxs)(i.li,{children:["planner loop (",(0,t.jsx)(i.code,{children:"CALL_TOOL"})," or ",(0,t.jsx)(i.code,{children:"ANSWER"}),")"]}),"\n",(0,t.jsxs)(i.li,{children:["DB tool execution via ",(0,t.jsx)(i.code,{children:"McpDbExecutor"})]}),"\n",(0,t.jsx)(i.li,{children:"store observations and final answer in context"}),"\n"]}),"\n",(0,t.jsx)(i.h2,{id:"mcp-related-tables",children:"MCP-related tables"}),"\n",(0,t.jsx)(d.p,{title:"MCP table usage",columns:["Table","Role","Key fields"],rows:[["ce_mcp_tool","Tool registry","tool_code, tool_group, intent_code, state_code, enabled"],["ce_mcp_db_tool","DB tool SQL template config","sql_template, param_schema, max_rows, safe_mode"],["ce_config","Planner prompts","McpPlanner.SYSTEM_PROMPT, McpPlanner.USER_PROMPT"]]}),"\n",(0,t.jsx)(i.h2,{id:"audit-stream-model",children:"Audit stream model"}),"\n",(0,t.jsxs)(i.p,{children:[(0,t.jsx)(i.code,{children:"DbAuditService"})," writes normalized payload with ",(0,t.jsx)(i.code,{children:"_meta"})," block, then:"]}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:["applies ",(0,t.jsx)(i.code,{children:"AuditStageControl"})," (level/include/exclude/rate controls)"]}),"\n",(0,t.jsxs)(i.li,{children:["dispatches listeners through ",(0,t.jsx)(i.code,{children:"AuditEventDispatcher"})," (sync by default, async optional)"]}),"\n"]}),"\n",(0,t.jsx)(i.p,{children:"Transport outputs:"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:["SSE stream (",(0,t.jsx)(i.code,{children:"/api/v1/conversation/stream/{conversationId}"}),")"]}),"\n",(0,t.jsxs)(i.li,{children:["optional STOMP topic (",(0,t.jsx)(i.code,{children:"/topic/convengine/audit/{conversationId}"}),")"]}),"\n",(0,t.jsx)(i.li,{children:"STOMP broker mode: simple in-memory (default) or relay (RabbitMQ/other STOMP relay)"}),"\n"]}),"\n",(0,t.jsx)(i.h2,{id:"trace-api",children:"Trace API"}),"\n",(0,t.jsx)(i.p,{children:(0,t.jsx)(i.code,{children:"GET /api/v1/conversation/audit/{conversationId}/trace"})}),"\n",(0,t.jsx)(i.p,{children:"Returns:"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsx)(i.li,{children:"step timeline"}),"\n",(0,t.jsx)(i.li,{children:"ordered stage list"}),"\n",(0,t.jsx)(i.li,{children:"source class/file metadata"}),"\n"]}),"\n",(0,t.jsx)(d.vl,{title:"SSE subscribe example",language:"bash",children:"curl -N http://localhost:8080/api/v1/conversation/stream/9bf7540a-b129-4685-a120-730e8a0cb94b"}),"\n",(0,t.jsx)(d.f4,{type:"success",title:"Debug strategy",children:(0,t.jsx)(i.p,{children:"When output is wrong, compare raw audit stages with trace step boundaries. This isolates whether issue came from resolver logic, rule mutation, MCP plan, or response mapping."})})]})}function h(e={}){const{wrapper:i}={...(0,l.R)(),...e.components};return i?(0,t.jsx)(i,{...e,children:(0,t.jsx)(p,{...e})}):p(e)}}}]);