# ğŸ“ Schemaâ€‘Driven Extraction

`ce_output_schema` defines **what structured data ConvEngine expects**
for a given **intent + state** combination.

This is the backbone of **deterministic extraction**.

---

## ğŸ§  Core Principle

> ConvEngine never *guesses* structure.  
> It **declares structure first**, then asks the LLM to comply.

---

## ğŸ“¦ Table Definition

```sql
CREATE TABLE ce_output_schema (
  schema_id    BIGSERIAL PRIMARY KEY,
  intent_code  TEXT NOT NULL,
  state_code   TEXT NOT NULL,

  json_schema  JSONB NOT NULL,
  description  TEXT,

  enabled      BOOLEAN DEFAULT true,
  priority     INT NOT NULL
);
```

---

## ğŸ¯ When Is This Used?

The engine evaluates `ce_output_schema` when:

- Intent is known (`ACTION`, etc.)
- State is `READY` or transitioning to it
- Structured extraction is required

---

## ğŸ“œ Example Schema (Move Action)

```json
{
  "type": "object",
  "required": ["from", "to"],
  "properties": {
    "from": {
      "type": "object",
      "required": ["subAccount"],
      "properties": {
        "subAccount": { "type": "string" }
      }
    },
    "to": {
      "type": "object",
      "required": ["subAccount"],
      "properties": {
        "subAccount": { "type": "string" }
      }
    }
  }
}
```

---

## ğŸ” Resolution Order

Schemas are resolved by:

1. `intent_code`
2. `state_code`
3. `priority` (ascending)

First enabled match wins.

---

## ğŸ§© Schema Completeness

ConvEngine automatically checks:

- Are all `required` fields present?
- Are nested requirements satisfied?

### Outcomes:
- âŒ Incomplete â†’ `NEED_MORE_INFO`
- âœ… Complete â†’ autoâ€‘advance to `READY`

---

## ğŸš« What Schemas Must NOT Do

- âŒ Encode business rules
- âŒ Control UI behavior directly
- âŒ Change intent/state

Schemas describe **shape**, not **behavior**.

---

## âœ… Why This Matters

- Safe LLM usage
- Multiâ€‘turn extraction
- Replayable conversations
- Frontendâ€‘agnostic UIs

This is what turns ConvEngine into a **conversation compiler** instead of a chatbot.
