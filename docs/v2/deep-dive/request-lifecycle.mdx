---
title: Request Lifecycle
sidebar_position: 3
hide_table_of_contents: true
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import { EngineDebugFlow, CodeBlockToggle, Highlight, DbTable, FileRef, MethodRef, PipelineStepList } from "@site/src/components/convengine";

export const v2PipelineSteps = [
  { name: "LoadOrCreateConversationStep", description: "Hydrates existing conversation or creates new conversation shell." },
  { name: "CacheInspectAuditStep", description: "Conditionally audits cache snapshot when cache-inspector enabled." },
  { name: "ResetConversationStep", description: "Applies reset/start-over command handling." },
  { name: "PersistConversationBootstrapStep", description: "Persists conversation bootstrap row before persisted-required steps." },
  { name: "AuditUserInputStep", description: "Writes raw user input audit event." },
  { name: "PolicyEnforcementStep", description: "Applies pre-intent policy checks and safe short-circuit when required." },
  { name: "DialogueActStep", description: "Classifies turn as AFFIRM/NEGATE/ANSWER/EDIT/RESET/QUESTION/NEW_REQUEST and can derive standalone_query." },
  { name: "InteractionPolicyStep", description: "Decides EXECUTE_PENDING_ACTION / REJECT_PENDING_ACTION / FILL_PENDING_SLOT / RECLASSIFY_INTENT." },
  { name: "CorrectionStep", description: "Applies confirmation routing and in-place schema correction before intent/schema rework." },
  { name: "ActionLifecycleStep", description: "Maintains pending_action_runtime status with TTL semantics." },
  { name: "DisambiguationStep", description: "When multiple actions are eligible, asks targeted clarification and pauses execution." },
  { name: "GuardrailStep", description: "Sanitization + sensitive checks + approval gate hooks." },
  { name: "IntentResolutionStep", description: "Resolves intent unless policy says skip_intent_resolution." },
  { name: "ResetResolvedIntentStep", description: "Applies post-intent reset mapping." },
  { name: "FallbackIntentStateStep", description: "Assigns fallback UNKNOWN flow when intent/state unresolved." },
  { name: "AddContainerDataStep", description: "Merges configured container data into runtime context." },
  { name: "PendingActionStep", description: "Executes or rejects pending action task via CeTaskExecutor." },
  { name: "ToolOrchestrationStep", description: "Unified tool request->execute->result contract by tool_group." },
  { name: "McpToolStep", description: "Planner loop for CALL_TOOL/ANSWER with MCP observations." },
  { name: "SchemaExtractionStep", description: "Parses/extracts structured schema fields." },
  { name: "AutoAdvanceStep", description: "Advances state when schema/task facts satisfy conditions." },
  { name: "RulesStep", description: "Runs phase-scoped rules and actions with cascade passes." },
  { name: "StateGraphStep", description: "Validate-only transition check, no forced state mutation." },
  { name: "ResponseResolutionStep", description: "Resolves EXACT/DERIVED response output." },
  { name: "MemoryStep", description: "Writes session summary and optional recall memory." },
  { name: "PersistConversationStep", description: "Persists conversation/result/audit metadata." },
  { name: "PipelineEndGuardStep", description: "Final guard and timing closure." },
];

export const lifecycleNodes = [
  { id: "api", position: { x: 20, y: 40 }, data: { label: "API: ConversationController.message" } },
  { id: "engine", position: { x: 300, y: 40 }, data: { label: "DefaultConversationalEngine.process" } },
  { id: "session", position: { x: 580, y: 40 }, data: { label: "EngineSessionFactory.open" } },
  { id: "pipeline", position: { x: 860, y: 40 }, data: { label: "EnginePipelineFactory.create" } },

  { id: "s1", position: { x: 20, y: 190 }, data: { label: "LoadOrCreateConversationStep" } },
  { id: "s1a", position: { x: 140, y: 190 }, data: { label: "CacheInspectAuditStep" } },
  { id: "s2", position: { x: 260, y: 190 }, data: { label: "ResetConversationStep" } },
  { id: "s3", position: { x: 500, y: 190 }, data: { label: "AuditUserInputStep" } },
  { id: "s4", position: { x: 740, y: 190 }, data: { label: "IntentResolutionStep" } },
  { id: "s5", position: { x: 980, y: 190 }, data: { label: "SchemaExtractionStep" } },

  { id: "s6", position: { x: 20, y: 340 }, data: { label: "AutoAdvanceStep" } },
  { id: "s7", position: { x: 260, y: 340 }, data: { label: "RulesStep" } },
  { id: "s8", position: { x: 500, y: 340 }, data: { label: "ResponseResolutionStep" } },
  { id: "s9", position: { x: 740, y: 340 }, data: { label: "PersistConversationStep" } },
  { id: "s10", position: { x: 980, y: 340 }, data: { label: "PipelineEndGuardStep" } },

  { id: "out", position: { x: 500, y: 500 }, data: { label: "EngineResult -> HTTP Response" } },
];

export const lifecycleEdges = [
  { id: "e1", source: "api", target: "engine" },
  { id: "e2", source: "engine", target: "session" },
  { id: "e3", source: "session", target: "pipeline" },

  { id: "e4", source: "pipeline", target: "s1" },
  { id: "e4a", source: "s1", target: "s1a" },
  { id: "e4b", source: "s1a", target: "s2" },
  { id: "e5", source: "s2", target: "s3" },
  { id: "e7", source: "s3", target: "s4" },
  { id: "e8", source: "s4", target: "s5" },
  { id: "e9", source: "s5", target: "s6" },
  { id: "e10", source: "s6", target: "s7" },
  { id: "e11", source: "s7", target: "s8" },
  { id: "e12", source: "s8", target: "s9" },
  { id: "e13", source: "s9", target: "s10" },
  { id: "e14", source: "s10", target: "out" },
];

export const lifecycleDetails = {
  api: {
    title: "ConversationController.message",
    file: "api/controller/ConversationController.java",
    method: "message(...)",
    stage: "HTTP_ENTRY",
    summary: "Reads request body, normalizes inputParams, injects reset flag when needed, builds EngineContext and delegates to engine.process.",
    session: ["conversationId maybe provided or generated", "userText from request.message", "inputParams merged"],
    tables: ["none"],
  },
  engine: {
    title: "DefaultConversationalEngine.process",
    file: "engine/provider/DefaultConversationalEngine.java",
    method: "process(EngineContext)",
    stage: "ENGINE_ENTRY",
    summary: "Opens EngineSession, loads conversation history provider data, executes pipeline, returns EngineResult.",
    session: ["session created", "conversationHistory injected"],
    tables: ["ce_audit (indirect via steps)", "ce_conversation (indirect via steps)"],
  },
  session: {
    title: "EngineSessionFactory.open",
    file: "engine/factory/EngineSessionFactory.java",
    method: "open(EngineContext)",
    stage: "SESSION_BOOTSTRAP",
    summary: "Ensures conversation bootstrap row exists, attaches it into session, syncs state/intent/context/input params.",
    session: ["conversation object attached", "intent/state/context synced from DB"],
    tables: ["ce_conversation (R/W bootstrap)"],
  },
  pipeline: {
    title: "EnginePipelineFactory.create",
    file: "engine/factory/EnginePipelineFactory.java",
    method: "orderByDag(...) + wrapWithTiming(...)",
    stage: "PIPELINE_BUILD",
    summary: "Resolves step DAG by annotations, wraps each step in timing/audit/hook-aware wrapper.",
    session: ["none (topology build)"],
    tables: ["none"],
  },
  s1: {
    title: "LoadOrCreateConversationStep.execute",
    file: "engine/steps/LoadOrCreateConversationStep.java",
    method: "execute(EngineSession)",
    stage: "STEP",
    summary: "Loads/syncs conversation row into session and keeps runtime state consistent.",
    session: ["conversation synchronized", "state available for next steps"],
    tables: ["ce_conversation (R/W)"],
  },
  s2: {
    title: "ResetConversationStep.execute",
    file: "engine/steps/ResetConversationStep.java",
    method: "execute(EngineSession)",
    stage: "STEP",
    summary: "Checks reset controls (`reset`, `restart`, `conversation_reset`, command text). If triggered, wipes conversation runtime state.",
    session: ["intent/state/context reset conditionally", "input controls filtered"],
    tables: ["ce_conversation (W)", "ce_audit (CONVERSATION_RESET)"],
  },
  s3: {
    title: "AuditUserInputStep.execute",
    file: "engine/steps/AuditUserInputStep.java",
    method: "execute(EngineSession)",
    stage: "STEP",
    summary: "Writes compact user input audit record with session meta intent/state.",
    session: ["user input captured"],
    tables: ["ce_audit (W)"],
  },
  s4: {
    title: "IntentResolutionStep.execute",
    file: "engine/steps/IntentResolutionStep.java",
    method: "execute(EngineSession)",
    stage: "STEP",
    summary: "Resolves intent using classifier + agent flow, with schema lock checks and collision handling.",
    session: ["intent maybe changed", "state may become INTENT_COLLISION"],
    tables: ["ce_intent (R)", "ce_intent_classifier (R)", "ce_config (R)", "ce_audit (W)"],
  },
  s5: {
    title: "SchemaExtractionStep.execute",
    file: "engine/steps/SchemaExtractionStep.java",
    method: "execute(EngineSession)",
    stage: "STEP",
    summary: "Finds schema by intent/state, renders prompt template, calls LLM JSON extraction, merges context, computes missing fields, locks/unlocks intent.",
    session: ["contextJson merged", "schemaComplete/schemaHasAnyValue flags", "missing fields/options"],
    tables: ["ce_output_schema (R)", "ce_prompt_template (R)", "ce_audit (W)", "ce_config (R optional)"],
  },
  s6: {
    title: "AutoAdvanceStep.execute",
    file: "engine/steps/AutoAdvanceStep.java",
    method: "execute(EngineSession)",
    stage: "STEP",
    summary: "Applies deterministic state changes from schema facts before rules run.",
    session: ["state may auto-transition"],
    tables: ["ce_audit (W)"],
  },
  s7: {
    title: "RulesStep.execute",
    file: "engine/steps/RulesStep.java",
    method: "execute(EngineSession)",
    stage: "STEP",
    summary: "Runs enabled rules in priority order with multi-pass cascading when intent/state changes.",
    session: ["intent/state/context/inputParams may mutate via actions"],
    tables: ["ce_rule (R)", "ce_audit (W)"],
  },
  s8: {
    title: "ResponseResolutionStep.execute",
    file: "engine/steps/ResponseResolutionStep.java",
    method: "execute(EngineSession)",
    stage: "STEP",
    summary: "Selects response mapping, executes EXACT/DERIVED strategy, resolves templates for derived output, applies transformers, audits output.",
    session: ["payload set", "finalResult staged"],
    tables: ["ce_response (R)", "ce_prompt_template (R)", "ce_audit (W)"],
  },
  s9: {
    title: "PersistConversationStep.execute",
    file: "engine/steps/PersistConversationStep.java",
    method: "execute(EngineSession)",
    stage: "STEP",
    summary: "Persists final conversation state and last assistant payload to durable row.",
    session: ["conversation row synchronized with runtime"],
    tables: ["ce_conversation (W)", "ce_audit (W optional)"],
  },
  s10: {
    title: "PipelineEndGuardStep.execute",
    file: "engine/steps/PipelineEndGuardStep.java",
    method: "execute(EngineSession)",
    stage: "STEP",
    summary: "Final guard/timing stage, emits pipeline timing audit and closes execution envelope.",
    session: ["step timings finalized"],
    tables: ["ce_audit (W)"],
  },
  out: {
    title: "EngineResult return",
    file: "api/controller/ConversationController.java",
    method: "message(...) return",
    stage: "HTTP_RESPONSE",
    summary: "Controller maps EngineResult to API response payload type (TEXT/JSON) and returns to client.",
    session: ["final result exposed"],
    tables: ["none"],
  },
};

# Request Lifecycle (IDE Debug Mode)

This page is the runtime control-flow view for one turn. Think of it as stepping through breakpoints from API entry to final persistence.

## Canonical step inventory (latest)

<PipelineStepList ariaLabel="Canonical step inventory" steps={v2PipelineSteps} />

<Highlight type="tip" title="Graph below is the common path">
The visual flow highlights the common deterministic runtime path. Conditional/system steps from the list above still execute when their prerequisites are met.
</Highlight>

<EngineDebugFlow
  title="Request Turn Execution Graph"
  subtitle="Click any node in tree or graph to inspect method-level detail, session snapshots, and table touch points."
  nodes={lifecycleNodes}
  edges={lifecycleEdges}
  detailsById={lifecycleDetails}
  defaultSelectedId="s4"
/>

<Tabs groupId="lifecycle-code">
  <TabItem value="entry" label="Controller -> Engine" default>

<CodeBlockToggle
  title="ConversationController.message"
  language="java"
  packagePath="com.github.salilvnair.convengine.api.controller"
  filePath="src/main/java/com/github/salilvnair/convengine/api/controller/ConversationController.java"
>
{`EngineContext engineContext = EngineContext.builder()
    .conversationId(conversationId.toString())
    .userText(request.getMessage())
    .inputParams(inputParams)
    .build();

EngineResult result = engine.process(engineContext);`}
</CodeBlockToggle>

<CodeBlockToggle
  title="DefaultConversationalEngine.process"
  language="java"
  packagePath="com.github.salilvnair.convengine.engine.provider"
  filePath="src/main/java/com/github/salilvnair/convengine/engine/provider/DefaultConversationalEngine.java"
>
{`EngineSession session = sessionFactory.open(engineContext);
session.setConversationHistory(historyProvider.lastTurns(session.getConversationId(), 10));
EnginePipeline pipeline = pipelineFactory.create();
return pipeline.execute(session);`}
</CodeBlockToggle>

  </TabItem>

  <TabItem value="pipeline" label="DAG + Step Wrapper">

<CodeBlockToggle
  title="EnginePipelineFactory.orderByDag + wrapWithTiming"
  language="java"
  packagePath="com.github.salilvnair.convengine.engine.factory"
  filePath="src/main/java/com/github/salilvnair/convengine/engine/factory/EnginePipelineFactory.java"
>
{`@PostConstruct
public void init() {
  List<EngineStep> ordered = orderByDag(discoveredSteps);
  this.pipeline = new EnginePipeline(wrapWithTiming(ordered));
}

// orderByDag uses @MustRunAfter, @MustRunBefore, @RequiresConversationPersisted
// wrapWithTiming adds STEP_ENTER / STEP_EXIT / STEP_ERROR audits + hook callbacks`}
</CodeBlockToggle>

<CodeBlockToggle
  title="EnginePipeline.execute"
  language="java"
  packagePath="com.github.salilvnair.convengine.engine.pipeline"
  filePath="src/main/java/com/github/salilvnair/convengine/engine/pipeline/EnginePipeline.java"
>
{`for (EngineStep step : steps) {
  StepResult r = step.execute(session);
  if (r instanceof StepResult.Stop(EngineResult result)) {
    return result;
  }
}
return session.getFinalResult();`}
</CodeBlockToggle>

  </TabItem>

  <TabItem value="hooks" label="Step Hook Interception">

<CodeBlockToggle
  title="EngineStepHook typed step matching"
  language="java"
  packagePath="com.github.salilvnair.convengine.engine.hook"
  filePath="src/main/java/com/github/salilvnair/convengine/engine/hook/EngineStepHook.java"
>
{`public interface EngineStepHook {
    default boolean supports(EngineStep.Name stepName, EngineSession session) { return true; }
    default void beforeStep(EngineStep.Name stepName, EngineSession session) {}
    default void afterStep(EngineStep.Name stepName, EngineSession session, StepResult result) {}
    default void onStepError(EngineStep.Name stepName, EngineSession session, Throwable error) {}
}`}
</CodeBlockToggle>

<CodeBlockToggle
  title="Consumer hook example"
  language="java"
  packagePath="com.zapper.convengine.hooks"
>
{`@Component
public class MyHook implements EngineStepHook {
  @Override
  public boolean supports(EngineStep.Name stepName, EngineSession session) {
    return EngineStep.Name.SchemaExtractionStep == stepName;
  }

  @Override
  public void beforeStep(EngineStep.Name stepName, EngineSession session) {
    session.putInputParam("consumer_hint", "compact");
  }
}`}
</CodeBlockToggle>

  </TabItem>
</Tabs>

## Table Touch Matrix

<DbTable
  title="Per-turn table access"
  columns={["Table", "Read Path", "Write Path"]}
  rows={[
    ["ce_conversation", "LoadOrCreateConversationStep", "PersistConversationStep / reset steps"],
    ["ce_intent", "IntentResolutionStep", "-"],
    ["ce_intent_classifier", "IntentResolutionStep", "-"],
    ["ce_output_schema", "SchemaExtractionStep", "-"],
    ["ce_prompt_template", "SchemaExtractionStep / ResponseResolutionStep", "-"],
    ["ce_rule", "RulesStep", "-"],
    ["ce_response", "ResponseResolutionStep", "-"],
    ["ce_config", "intent/reset/sql-agent config lookup", "-"],
    ["ce_mcp_planner", "McpToolStep planner prompt lookup (with ce_config fallback)", "-"],
    ["ce_audit", "-", "all stage audits via DbAuditService"],
  ]}
/>

<Highlight type="info" title="How to read this page">
Start at `IntentResolutionStep`, then click `SchemaExtractionStep` and `RulesStep` in the tree. That path explains most multi-turn behavior differences.
</Highlight>
