"use strict";(globalThis.webpackChunkconvengine_docs=globalThis.webpackChunkconvengine_docs||[]).push([[3628],{1420(e,t,n){n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>c,default:()=>p,frontMatter:()=>a,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"deep-dive/verbose-and-conversation-runtime","title":"Verbose and Conversation Runtime","description":"This page documents two runtime tables that are often tuned together:","source":"@site/docs/v2/deep-dive/verbose-and-conversation-runtime.mdx","sourceDirName":"deep-dive","slug":"/deep-dive/verbose-and-conversation-runtime","permalink":"/docs/v2/deep-dive/verbose-and-conversation-runtime","draft":false,"unlisted":false,"editUrl":"https://github.com/salilvnair/convengine-docs/tree/main/docs/v2/deep-dive/verbose-and-conversation-runtime.mdx","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"title":"Verbose and Conversation Runtime","sidebar_position":5},"sidebar":"docSidebar","previous":{"title":"Data Model","permalink":"/docs/v2/deep-dive/data-model"},"next":{"title":"Developer Guide","permalink":"/docs/v2/deep-dive/developer-guide"}}');var r=n(4848),i=n(8453),o=n(7555);const a={title:"Verbose and Conversation Runtime",sidebar_position:5},c="Verbose and Conversation Runtime",d={},l=[{value:"<code>ce_conversation</code> runtime contract",id:"ce_conversation-runtime-contract",level:2},{value:"<code>ce_verbose</code> runtime contract",id:"ce_verbose-runtime-contract",level:2},{value:"Resolver behavior (from Java implementation)",id:"resolver-behavior-from-java-implementation",level:3},{value:"Determinants currently emitted by runtime",id:"determinants-currently-emitted-by-runtime",level:2},{value:"Stream envelope contract (<code>AUDIT</code> + <code>VERBOSE</code>)",id:"stream-envelope-contract-audit--verbose",level:2}];function h(e){const t={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"verbose-and-conversation-runtime",children:"Verbose and Conversation Runtime"})}),"\n",(0,r.jsx)(t.p,{children:"This page documents two runtime tables that are often tuned together:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"ce_conversation"})," (conversation state persistence)"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"ce_verbose"})," (runtime progress/error messaging)"]}),"\n"]}),"\n",(0,r.jsxs)(t.h2,{id:"ce_conversation-runtime-contract",children:[(0,r.jsx)(t.code,{children:"ce_conversation"})," runtime contract"]}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.code,{children:"ce_conversation"})," is the turn-to-turn state source used by ",(0,r.jsx)(t.code,{children:"EngineSessionFactory"})," and ",(0,r.jsx)(t.code,{children:"LoadOrCreateConversationStep"}),"."]}),"\n",(0,r.jsx)(o.p,{title:"ce_conversation fields used at runtime",columns:["Column","How engine uses it","Write path"],rows:[["conversation_id","Primary key for session bootstrap and resume","Created once in bootstrap/create step"],["intent_code","Restored into session intent at turn start","Updated through pipeline + persist"],["state_code","Restored into session state at turn start","Updated through pipeline + persist"],["context_json","Restored into `session.contextJson`","Mutated by steps, saved in persist"],["input_params_json","Restored into session input params baseline","Sanitized and saved in persist"],["last_user_text","Tracks most recent user text for diagnostics","Set in `LoadOrCreateConversationStep`"],["last_assistant_json","Stores last assistant payload","Set during response/persist flow"],["status","Conversation status marker (normally `RUNNING`)","Set in bootstrap/persist"],["created_at/updated_at","Turn recency and lifecycle timestamps","Created in bootstrap, updated each turn"]]}),"\n",(0,r.jsx)(o.f4,{type:"tip",title:"Bootstrap behavior",children:(0,r.jsxs)(t.p,{children:["If a conversation row does not exist, ",(0,r.jsx)(t.code,{children:"EngineSessionFactory"})," creates a minimal row with ",(0,r.jsx)(t.code,{children:"context_json={}"}),", ",(0,r.jsx)(t.code,{children:"input_params_json={}"}),", and status ",(0,r.jsx)(t.code,{children:"RUNNING"}),", then syncs session from it."]})}),"\n",(0,r.jsxs)(t.h2,{id:"ce_verbose-runtime-contract",children:[(0,r.jsx)(t.code,{children:"ce_verbose"})," runtime contract"]}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.code,{children:"ce_verbose"})," is resolved by ",(0,r.jsx)(t.code,{children:"DbVerboseMessageResolver"})," using the current runtime context from session and metadata."]}),"\n",(0,r.jsx)(o.p,{title:"ce_verbose matching inputs",columns:["Column","Meaning","Example"],rows:[["intent_code/state_code","Primary runtime scope","Exact value or `ANY`"],["determinant","Event emitted by runtime code","`STEP_ENTER`, `RULE_MATCH`, `MCP_TOOL_CALL`"],["step_match + step_value","Step matcher (`EXACT|REGEX|JSON_PATH`)","`RulesStep`, `.*Step$`, `$.stepInfo.error`"],["rule_id/tool_code","Optional strict narrowing","Specific rule or MCP tool"],["message/error_message","Text returned for info/error paths","Progress and failure variants"],["priority","Lower value wins after specificity scoring","10, 20, 100"],["enabled","Row eligibility switch","true/false"]]}),"\n",(0,r.jsx)(t.h3,{id:"resolver-behavior-from-java-implementation",children:"Resolver behavior (from Java implementation)"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["Load eligible rows from static cache (",(0,r.jsx)(t.code,{children:"ce_verbose"}),") by intent/state."]}),"\n",(0,r.jsx)(t.li,{children:"Filter by determinant, step match, rule/tool constraints."}),"\n",(0,r.jsxs)(t.li,{children:["Score candidates by specificity (",(0,r.jsx)(t.code,{children:"intent"}),", ",(0,r.jsx)(t.code,{children:"state"}),", ",(0,r.jsx)(t.code,{children:"determinant"}),", step match type, ",(0,r.jsx)(t.code,{children:"rule_id"}),", ",(0,r.jsx)(t.code,{children:"tool_code"}),") and priority."]}),"\n",(0,r.jsxs)(t.li,{children:["Build ",(0,r.jsx)(t.code,{children:"VerboseStreamPayload"})," with ",(0,r.jsx)(t.code,{children:"level=INFO|ERROR"}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["If no row matches and the event is error path, fallback publishes:\n",(0,r.jsx)(t.code,{children:"Something went wrong while processing <step>."})]}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"determinants-currently-emitted-by-runtime",children:"Determinants currently emitted by runtime"}),"\n",(0,r.jsx)(o.p,{title:"Common emitted determinants",columns:["Source","Determinants"],rows:[["Step hook","STEP_ENTER, STEP_EXIT, STEP_ERROR"],["Intent resolver","AGENT_INTENT_START, AGENT_INTENT_ACCEPTED, AGENT_INTENT_REJECTED, AGENT_INTENT_COLLISION, AGENT_INTENT_NEEDS_CLARIFICATION"],["Rules","RULE_MATCH, RULE_APPLIED"],["MCP/tool","MCP_TOOL_CALL, MCP_TOOL_RESULT, MCP_TOOL_ERROR, MCP_FINAL_ANSWER, TOOL_ORCHESTRATION_REQUEST, TOOL_ORCHESTRATION_RESULT, TOOL_ORCHESTRATION_ERROR"],["Resolver factories","RULE_ACTION_RESOLVER_SELECTED/NOT_FOUND, RESPONSE_TYPE_RESOLVER_SELECTED/NOT_FOUND, OUTPUT_FORMAT_RESOLVER_SELECTED/NOT_FOUND"],["Response step","RESOLVE_RESPONSE"],["Intent step","INTENT_RESOLVED"]]}),"\n",(0,r.jsxs)(t.h2,{id:"stream-envelope-contract-audit--verbose",children:["Stream envelope contract (",(0,r.jsx)(t.code,{children:"AUDIT"})," + ",(0,r.jsx)(t.code,{children:"VERBOSE"}),")"]}),"\n",(0,r.jsxs)(t.p,{children:["Both SSE and STOMP publish ",(0,r.jsx)(t.code,{children:"AuditStreamEventResponse"})," with:"]}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"eventType"}),": ",(0,r.jsx)(t.code,{children:"AUDIT"})," or ",(0,r.jsx)(t.code,{children:"VERBOSE"})]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"verbose"}),": populated for verbose events"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"payload.verbose"}),": verbose payload mirror for clients that read payload map"]}),"\n"]}),"\n",(0,r.jsx)(o.vl,{title:"Verbose rollout SQL (standalone assets)",language:"text",children:"src/main/resources/sql/verbose_ddl.sql\nsrc/main/resources/sql/verbose_seed.sql"}),"\n",(0,r.jsx)(o.f4,{type:"warning",title:"Startup safety",children:(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.code,{children:"ce_verbose"})," is validated at startup. Invalid ",(0,r.jsx)(t.code,{children:"step_match"})," or blank ",(0,r.jsx)(t.code,{children:"step_value"})," / ",(0,r.jsx)(t.code,{children:"determinant"})," rows can fail startup integrity checks."]})})]})}function p(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}}}]);