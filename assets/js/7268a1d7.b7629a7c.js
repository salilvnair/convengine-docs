"use strict";(globalThis.webpackChunkconvengine_docs=globalThis.webpackChunkconvengine_docs||[]).push([[6859],{1470(e,t,n){n.d(t,{A:()=>T});var s=n(6540),i=n(4164),a=n(7559),o=n(3104),r=n(6347),l=n(205),c=n(7485),u=n(1682),p=n(679);function d(e){return s.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,s.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function g(e){const{values:t,children:n}=e;return(0,s.useMemo)(()=>{const e=t??function(e){return d(e).map(({props:{value:e,label:t,attributes:n,default:s}})=>({value:e,label:t,attributes:n,default:s}))}(n);return function(e){const t=(0,u.XI)(e,(e,t)=>e.value===t.value);if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[t,n])}function m({value:e,tabValues:t}){return t.some(t=>t.value===e)}function h({queryString:e=!1,groupId:t}){const n=(0,r.W6)(),i=function({queryString:e=!1,groupId:t}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:e,groupId:t});return[(0,c.aZ)(i),(0,s.useCallback)(e=>{if(!i)return;const t=new URLSearchParams(n.location.search);t.set(i,e),n.replace({...n.location,search:t.toString()})},[i,n])]}function v(e){const{defaultValue:t,queryString:n=!1,groupId:i}=e,a=g(e),[o,r]=(0,s.useState)(()=>function({defaultValue:e,tabValues:t}){if(0===t.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!m({value:e,tabValues:t}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${t.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const n=t.find(e=>e.default)??t[0];if(!n)throw new Error("Unexpected error: 0 tabValues");return n.value}({defaultValue:t,tabValues:a})),[c,u]=h({queryString:n,groupId:i}),[d,v]=function({groupId:e}){const t=function(e){return e?`docusaurus.tab.${e}`:null}(e),[n,i]=(0,p.Dv)(t);return[n,(0,s.useCallback)(e=>{t&&i.set(e)},[t,i])]}({groupId:i}),f=(()=>{const e=c??d;return m({value:e,tabValues:a})?e:null})();(0,l.A)(()=>{f&&r(f)},[f]);return{selectedValue:o,selectValue:(0,s.useCallback)(e=>{if(!m({value:e,tabValues:a}))throw new Error(`Can't select invalid tab value=${e}`);r(e),u(e),v(e)},[u,v,a]),tabValues:a}}var f=n(2303);const S="tabList__CuJ",b="tabItem_LNqP";var E=n(4848);function y({className:e,block:t,selectedValue:n,selectValue:s,tabValues:a}){const r=[],{blockElementScrollPositionUntilNextRender:l}=(0,o.a_)(),c=e=>{const t=e.currentTarget,i=r.indexOf(t),o=a[i].value;o!==n&&(l(t),s(o))},u=e=>{let t=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const n=r.indexOf(e.currentTarget)+1;t=r[n]??r[0];break}case"ArrowLeft":{const n=r.indexOf(e.currentTarget)-1;t=r[n]??r[r.length-1];break}}t?.focus()};return(0,E.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.A)("tabs",{"tabs--block":t},e),children:a.map(({value:e,label:t,attributes:s})=>(0,E.jsx)("li",{role:"tab",tabIndex:n===e?0:-1,"aria-selected":n===e,ref:e=>{r.push(e)},onKeyDown:u,onClick:c,...s,className:(0,i.A)("tabs__item",b,s?.className,{"tabs__item--active":n===e}),children:t??e},e))})}function x({lazy:e,children:t,selectedValue:n}){const a=(Array.isArray(t)?t:[t]).filter(Boolean);if(e){const e=a.find(e=>e.props.value===n);return e?(0,s.cloneElement)(e,{className:(0,i.A)("margin-top--md",e.props.className)}):null}return(0,E.jsx)("div",{className:"margin-top--md",children:a.map((e,t)=>(0,s.cloneElement)(e,{key:t,hidden:e.props.value!==n}))})}function R(e){const t=v(e);return(0,E.jsxs)("div",{className:(0,i.A)(a.G.tabs.container,"tabs-container",S),children:[(0,E.jsx)(y,{...t,...e}),(0,E.jsx)(x,{...t,...e})]})}function T(e){const t=(0,f.A)();return(0,E.jsx)(R,{...e,children:d(e.children)},String(t))}},7974(e,t,n){n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>u,default:()=>S,frontMatter:()=>c,lifecycleDetails:()=>h,lifecycleEdges:()=>m,lifecycleNodes:()=>g,metadata:()=>s,toc:()=>v,v2PipelineSteps:()=>d});const s=JSON.parse('{"id":"deep-dive/request-lifecycle","title":"Request Lifecycle","description":"{ id { x 190 }, data \\"LoadOrCreateConversationStep\\" } },","source":"@site/docs/v2/deep-dive/request-lifecycle.mdx","sourceDirName":"deep-dive","slug":"/deep-dive/request-lifecycle","permalink":"/docs/v2/deep-dive/request-lifecycle","draft":false,"unlisted":false,"editUrl":"https://github.com/salilvnair/convengine-docs/tree/main/docs/v2/deep-dive/request-lifecycle.mdx","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"Request Lifecycle","sidebar_position":3,"hide_table_of_contents":true}}');var i=n(4848),a=n(8453),o=n(1470),r=n(9365),l=n(9131);const c={title:"Request Lifecycle",sidebar_position:3,hide_table_of_contents:!0},u="Request Lifecycle (IDE Debug Mode)",p={},d=[{name:"LoadOrCreateConversationStep",description:"Hydrates existing conversation or creates new conversation shell."},{name:"ResetConversationStep",description:"Applies reset/start-over command handling."},{name:"PersistConversationBootstrapStep",description:"Persists conversation bootstrap row before persisted-required steps."},{name:"AuditUserInputStep",description:"Writes raw user input audit event."},{name:"PolicyEnforcementStep",description:"Applies pre-intent policy checks and safe short-circuit when required."},{name:"DialogueActStep",description:"Classifies turn as AFFIRM/NEGATE/EDIT/RESET/QUESTION/NEW_REQUEST."},{name:"InteractionPolicyStep",description:"Decides EXECUTE_PENDING_ACTION / REJECT_PENDING_ACTION / FILL_PENDING_SLOT / RECLASSIFY_INTENT."},{name:"ActionLifecycleStep",description:"Maintains pending_action_runtime status with TTL semantics."},{name:"DisambiguationStep",description:"When multiple actions are eligible, asks targeted clarification and pauses execution."},{name:"GuardrailStep",description:"Sanitization + sensitive checks + approval gate hooks."},{name:"IntentResolutionStep",description:"Resolves intent unless policy says skip_intent_resolution."},{name:"ResetResolvedIntentStep",description:"Applies post-intent reset mapping."},{name:"FallbackIntentStateStep",description:"Assigns fallback UNKNOWN flow when intent/state unresolved."},{name:"AddContainerDataStep",description:"Merges configured container data into runtime context."},{name:"PendingActionStep",description:"Executes or rejects pending action task via CeTaskExecutor."},{name:"ToolOrchestrationStep",description:"Unified tool request->execute->result contract by tool_group."},{name:"McpToolStep",description:"Planner loop for CALL_TOOL/ANSWER with MCP observations."},{name:"SchemaExtractionStep",description:"Parses/extracts structured schema fields."},{name:"AutoAdvanceStep",description:"Advances state when schema/task facts satisfy conditions."},{name:"RulesStep",description:"Runs phase-scoped rules and actions with cascade passes."},{name:"StateGraphStep",description:"Validate-only transition check, no forced state mutation."},{name:"ResponseResolutionStep",description:"Resolves EXACT/DERIVED response output."},{name:"MemoryStep",description:"Writes session summary and optional recall memory."},{name:"PersistConversationStep",description:"Persists conversation/result/audit metadata."},{name:"PipelineEndGuardStep",description:"Final guard and timing closure."}],g=[{id:"api",position:{x:20,y:40},data:{label:"API: ConversationController.message"}},{id:"engine",position:{x:300,y:40},data:{label:"DefaultConversationalEngine.process"}},{id:"session",position:{x:580,y:40},data:{label:"EngineSessionFactory.open"}},{id:"pipeline",position:{x:860,y:40},data:{label:"EnginePipelineFactory.create"}},{id:"s1",position:{x:20,y:190},data:{label:"LoadOrCreateConversationStep"}},{id:"s2",position:{x:260,y:190},data:{label:"ResetConversationStep"}},{id:"s3",position:{x:500,y:190},data:{label:"AuditUserInputStep"}},{id:"s4",position:{x:740,y:190},data:{label:"IntentResolutionStep"}},{id:"s5",position:{x:980,y:190},data:{label:"SchemaExtractionStep"}},{id:"s6",position:{x:20,y:340},data:{label:"AutoAdvanceStep"}},{id:"s7",position:{x:260,y:340},data:{label:"RulesStep"}},{id:"s8",position:{x:500,y:340},data:{label:"ResponseResolutionStep"}},{id:"s9",position:{x:740,y:340},data:{label:"PersistConversationStep"}},{id:"s10",position:{x:980,y:340},data:{label:"PipelineEndGuardStep"}},{id:"out",position:{x:500,y:500},data:{label:"EngineResult -> HTTP Response"}}],m=[{id:"e1",source:"api",target:"engine"},{id:"e2",source:"engine",target:"session"},{id:"e3",source:"session",target:"pipeline"},{id:"e4",source:"pipeline",target:"s1"},{id:"e5",source:"s1",target:"s2"},{id:"e6",source:"s2",target:"s3"},{id:"e7",source:"s3",target:"s4"},{id:"e8",source:"s4",target:"s5"},{id:"e9",source:"s5",target:"s6"},{id:"e10",source:"s6",target:"s7"},{id:"e11",source:"s7",target:"s8"},{id:"e12",source:"s8",target:"s9"},{id:"e13",source:"s9",target:"s10"},{id:"e14",source:"s10",target:"out"}],h={api:{title:"ConversationController.message",file:"api/controller/ConversationController.java",method:"message(...)",stage:"HTTP_ENTRY",summary:"Reads request body, normalizes inputParams, injects reset flag when needed, builds EngineContext and delegates to engine.process.",session:["conversationId maybe provided or generated","userText from request.message","inputParams merged"],tables:["none"]},engine:{title:"DefaultConversationalEngine.process",file:"engine/provider/DefaultConversationalEngine.java",method:"process(EngineContext)",stage:"ENGINE_ENTRY",summary:"Opens EngineSession, loads conversation history provider data, executes pipeline, returns EngineResult.",session:["session created","conversationHistory injected"],tables:["ce_audit (indirect via steps)","ce_conversation (indirect via steps)"]},session:{title:"EngineSessionFactory.open",file:"engine/factory/EngineSessionFactory.java",method:"open(EngineContext)",stage:"SESSION_BOOTSTRAP",summary:"Ensures conversation bootstrap row exists, attaches it into session, syncs state/intent/context/input params.",session:["conversation object attached","intent/state/context synced from DB"],tables:["ce_conversation (R/W bootstrap)"]},pipeline:{title:"EnginePipelineFactory.create",file:"engine/factory/EnginePipelineFactory.java",method:"orderByDag(...) + wrapWithTiming(...)",stage:"PIPELINE_BUILD",summary:"Resolves step DAG by annotations, wraps each step in timing/audit/hook-aware wrapper.",session:["none (topology build)"],tables:["none"]},s1:{title:"LoadOrCreateConversationStep.execute",file:"engine/steps/LoadOrCreateConversationStep.java",method:"execute(EngineSession)",stage:"STEP",summary:"Loads/syncs conversation row into session and keeps runtime state consistent.",session:["conversation synchronized","state available for next steps"],tables:["ce_conversation (R/W)"]},s2:{title:"ResetConversationStep.execute",file:"engine/steps/ResetConversationStep.java",method:"execute(EngineSession)",stage:"STEP",summary:"Checks reset controls (`reset`, `restart`, `conversation_reset`, command text). If triggered, wipes conversation runtime state.",session:["intent/state/context reset conditionally","input controls filtered"],tables:["ce_conversation (W)","ce_audit (CONVERSATION_RESET)"]},s3:{title:"AuditUserInputStep.execute",file:"engine/steps/AuditUserInputStep.java",method:"execute(EngineSession)",stage:"STEP",summary:"Writes compact user input audit record with session meta intent/state.",session:["user input captured"],tables:["ce_audit (W)"]},s4:{title:"IntentResolutionStep.execute",file:"engine/steps/IntentResolutionStep.java",method:"execute(EngineSession)",stage:"STEP",summary:"Resolves intent using classifier + agent flow, with schema lock checks and collision handling.",session:["intent maybe changed","state may become INTENT_COLLISION"],tables:["ce_intent (R)","ce_intent_classifier (R)","ce_config (R)","ce_audit (W)"]},s5:{title:"SchemaExtractionStep.execute",file:"engine/steps/SchemaExtractionStep.java",method:"execute(EngineSession)",stage:"STEP",summary:"Finds schema by intent/state, renders prompt template, calls LLM JSON extraction, merges context, computes missing fields, locks/unlocks intent.",session:["contextJson merged","schemaComplete/schemaHasAnyValue flags","missing fields/options"],tables:["ce_output_schema (R)","ce_prompt_template (R)","ce_audit (W)","ce_config (R optional)"]},s6:{title:"AutoAdvanceStep.execute",file:"engine/steps/AutoAdvanceStep.java",method:"execute(EngineSession)",stage:"STEP",summary:"Applies deterministic state changes from schema facts before rules run.",session:["state may auto-transition"],tables:["ce_audit (W)"]},s7:{title:"RulesStep.execute",file:"engine/steps/RulesStep.java",method:"execute(EngineSession)",stage:"STEP",summary:"Runs enabled rules in priority order with multi-pass cascading when intent/state changes.",session:["intent/state/context/inputParams may mutate via actions"],tables:["ce_rule (R)","ce_audit (W)"]},s8:{title:"ResponseResolutionStep.execute",file:"engine/steps/ResponseResolutionStep.java",method:"execute(EngineSession)",stage:"STEP",summary:"Selects response mapping, executes EXACT/DERIVED strategy, resolves templates for derived output, applies transformers, audits output.",session:["payload set","finalResult staged"],tables:["ce_response (R)","ce_prompt_template (R)","ce_audit (W)"]},s9:{title:"PersistConversationStep.execute",file:"engine/steps/PersistConversationStep.java",method:"execute(EngineSession)",stage:"STEP",summary:"Persists final conversation state and last assistant payload to durable row.",session:["conversation row synchronized with runtime"],tables:["ce_conversation (W)","ce_audit (W optional)"]},s10:{title:"PipelineEndGuardStep.execute",file:"engine/steps/PipelineEndGuardStep.java",method:"execute(EngineSession)",stage:"STEP",summary:"Final guard/timing stage, emits pipeline timing audit and closes execution envelope.",session:["step timings finalized"],tables:["ce_audit (W)"]},out:{title:"EngineResult return",file:"api/controller/ConversationController.java",method:"message(...) return",stage:"HTTP_RESPONSE",summary:"Controller maps EngineResult to API response payload type (TEXT/JSON) and returns to client.",session:["final result exposed"],tables:["none"]}},v=[{value:"Canonical step inventory (latest)",id:"canonical-step-inventory-latest",level:2},{value:"Table Touch Matrix",id:"table-touch-matrix",level:2}];function f(e){const t={code:"code",h1:"h1",h2:"h2",header:"header",p:"p",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"request-lifecycle-ide-debug-mode",children:"Request Lifecycle (IDE Debug Mode)"})}),"\n",(0,i.jsx)(t.p,{children:"This page is the runtime control-flow view for one turn. Think of it as stepping through breakpoints from API entry to final persistence."}),"\n",(0,i.jsx)(t.h2,{id:"canonical-step-inventory-latest",children:"Canonical step inventory (latest)"}),"\n",(0,i.jsx)(l.Ve,{ariaLabel:"Canonical step inventory",steps:d}),"\n",(0,i.jsx)(l.f4,{type:"tip",title:"Graph below is the common path",children:(0,i.jsx)(t.p,{children:"The visual flow highlights the common deterministic runtime path. Conditional/system steps from the list above still execute when their prerequisites are met."})}),"\n",(0,i.jsx)(l.il,{title:"Request Turn Execution Graph",subtitle:"Click any node in tree or graph to inspect method-level detail, session snapshots, and table touch points.",nodes:g,edges:m,detailsById:h,defaultSelectedId:"s4"}),"\n",(0,i.jsxs)(o.A,{groupId:"lifecycle-code",children:[(0,i.jsxs)(r.A,{value:"entry",label:"Controller -> Engine",default:!0,children:[(0,i.jsx)(l.vl,{title:"ConversationController.message",language:"java",packagePath:"com.github.salilvnair.convengine.api.controller",filePath:"src/main/java/com/github/salilvnair/convengine/api/controller/ConversationController.java",children:"EngineContext engineContext = EngineContext.builder()\n  .conversationId(conversationId.toString())\n  .userText(request.getMessage())\n  .inputParams(inputParams)\n  .build();\n\nEngineResult result = engine.process(engineContext);"}),(0,i.jsx)(l.vl,{title:"DefaultConversationalEngine.process",language:"java",packagePath:"com.github.salilvnair.convengine.engine.provider",filePath:"src/main/java/com/github/salilvnair/convengine/engine/provider/DefaultConversationalEngine.java",children:"EngineSession session = sessionFactory.open(engineContext);\nsession.setConversationHistory(historyProvider.lastTurns(session.getConversationId(), 10));\nEnginePipeline pipeline = pipelineFactory.create();\nreturn pipeline.execute(session);"})]}),(0,i.jsxs)(r.A,{value:"pipeline",label:"DAG + Step Wrapper",children:[(0,i.jsx)(l.vl,{title:"EnginePipelineFactory.orderByDag + wrapWithTiming",language:"java",packagePath:"com.github.salilvnair.convengine.engine.factory",filePath:"src/main/java/com/github/salilvnair/convengine/engine/factory/EnginePipelineFactory.java",children:"@PostConstruct\npublic void init() {\nList<EngineStep> ordered = orderByDag(discoveredSteps);\nthis.pipeline = new EnginePipeline(wrapWithTiming(ordered));\n}\n\n// orderByDag uses @MustRunAfter, @MustRunBefore, @RequiresConversationPersisted\n// wrapWithTiming adds STEP_ENTER / STEP_EXIT / STEP_ERROR audits + hook callbacks"}),(0,i.jsx)(l.vl,{title:"EnginePipeline.execute",language:"java",packagePath:"com.github.salilvnair.convengine.engine.pipeline",filePath:"src/main/java/com/github/salilvnair/convengine/engine/pipeline/EnginePipeline.java",children:"for (EngineStep step : steps) {\nStepResult r = step.execute(session);\nif (r instanceof StepResult.Stop(EngineResult result)) {\n  return result;\n}\n}\nreturn session.getFinalResult();"})]}),(0,i.jsxs)(r.A,{value:"hooks",label:"Step Hook Interception",children:[(0,i.jsx)(l.vl,{title:"EngineStepHook typed step matching",language:"java",packagePath:"com.github.salilvnair.convengine.engine.hook",filePath:"src/main/java/com/github/salilvnair/convengine/engine/hook/EngineStepHook.java",children:"public interface EngineStepHook {\n  default boolean supports(EngineStep.Name stepName, EngineSession session) { return true; }\n  default void beforeStep(EngineStep.Name stepName, EngineSession session) {}\n  default void afterStep(EngineStep.Name stepName, EngineSession session, StepResult result) {}\n  default void onStepError(EngineStep.Name stepName, EngineSession session, Throwable error) {}\n}"}),(0,i.jsx)(l.vl,{title:"Consumer hook example",language:"java",packagePath:"com.zapper.convengine.hooks",children:'@Component\npublic class MyHook implements EngineStepHook {\n@Override\npublic boolean supports(EngineStep.Name stepName, EngineSession session) {\n  return EngineStep.Name.SchemaExtractionStep == stepName;\n}\n\n@Override\npublic void beforeStep(EngineStep.Name stepName, EngineSession session) {\n  session.putInputParam("consumer_hint", "compact");\n}\n}'})]})]}),"\n",(0,i.jsx)(t.h2,{id:"table-touch-matrix",children:"Table Touch Matrix"}),"\n",(0,i.jsx)(l.p,{title:"Per-turn table access",columns:["Table","Read Path","Write Path"],rows:[["ce_conversation","LoadOrCreateConversationStep","PersistConversationStep / reset steps"],["ce_intent","IntentResolutionStep","-"],["ce_intent_classifier","IntentResolutionStep","-"],["ce_output_schema","SchemaExtractionStep","-"],["ce_prompt_template","SchemaExtractionStep / ResponseResolutionStep","-"],["ce_rule","RulesStep","-"],["ce_response","ResponseResolutionStep","-"],["ce_config","intent/reset/mcp/sql-agent config lookup","-"],["ce_audit","-","all stage audits via DbAuditService"]]}),"\n",(0,i.jsx)(l.f4,{type:"info",title:"How to read this page",children:(0,i.jsxs)(t.p,{children:["Start at ",(0,i.jsx)(t.code,{children:"IntentResolutionStep"}),", then click ",(0,i.jsx)(t.code,{children:"SchemaExtractionStep"})," and ",(0,i.jsx)(t.code,{children:"RulesStep"})," in the tree. That path explains most multi-turn behavior differences."]})})]})}function S(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(f,{...e})}):f(e)}},9365(e,t,n){n.d(t,{A:()=>o});n(6540);var s=n(4164);const i="tabItem_Ymn6";var a=n(4848);function o({children:e,hidden:t,className:n}){return(0,a.jsx)("div",{role:"tabpanel",className:(0,s.A)(i,n),hidden:t,children:e})}}}]);