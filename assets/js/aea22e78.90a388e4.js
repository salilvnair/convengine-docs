/*! For license information please see aea22e78.90a388e4.js.LICENSE.txt */
"use strict";(globalThis.webpackChunkconvengine_docs=globalThis.webpackChunkconvengine_docs||[]).push([[478],{1523(e,n,s){s.d(n,{Fb:()=>a,vl:()=>p,sy:()=>c,p:()=>t,Fp:()=>r,f4:()=>x,Bn:()=>h,KJ:()=>o});var i=s(6540),l=s(4848);function r({type:e,children:n}){const s="deterministic"===e?"\ud83e\uddee":"llm"===e?"\ud83e\udd16":"\ud83d\uded1";return(0,l.jsxs)("div",{className:`ce-decision ce-${e}`,children:[(0,l.jsxs)("strong",{children:[s," ",e.toUpperCase()]}),(0,l.jsx)("div",{children:n})]})}function t({name:e,purpose:n,title:s,columns:i,rows:r,children:t}){const c=e||s;return(0,l.jsxs)("div",{className:"ce-db-table",children:[c&&(0,l.jsxs)("h4",{children:["\ud83d\uddc4\ufe0f ",c]}),n&&(0,l.jsx)("p",{children:(0,l.jsx)("em",{children:n})}),i&&r?(0,l.jsxs)("table",{className:"ce-db-table-grid",children:[(0,l.jsx)("thead",{children:(0,l.jsx)("tr",{children:i.map((e,n)=>(0,l.jsx)("th",{children:e},n))})}),(0,l.jsx)("tbody",{children:r.map((e,n)=>(0,l.jsx)("tr",{children:e.map((e,n)=>(0,l.jsx)("td",{children:e},n))},n))})]}):null,i||r||!t?null:(0,l.jsx)("ul",{children:t})]})}function c({engineStatus:e,engineDetails:n,children:s}){const[r,t]=(0,i.useState)(!1);return(0,l.jsxs)("div",{className:"ce-conversation",children:[e&&(0,l.jsxs)("div",{className:"ce-engine-header",onClick:()=>t(!r),children:[(0,l.jsxs)("span",{className:`ce-engine-badge ce-engine-${e.toLowerCase()}`,children:["\u2699 ENGINE \xb7 ",e]}),n&&(0,l.jsx)("span",{className:"ce-engine-toggle",children:r?"\u25be":"\u25b8"})]}),n&&r&&(0,l.jsx)("div",{className:"ce-engine-details",children:n}),(0,l.jsx)("div",{className:"ce-chat",children:s})]})}function o({children:e}){return(0,l.jsxs)("div",{className:"ce-chat-row ce-chat-end",children:[(0,l.jsx)("div",{className:"ce-chat-bubble ce-chat-bubble-user",children:e}),(0,l.jsx)("div",{className:"ce-avatar ce-avatar-user",children:"\ud83d\udc64"})]})}function a({children:e}){return(0,l.jsxs)("div",{className:"ce-chat-row ce-chat-start",children:[(0,l.jsx)("div",{className:"ce-avatar ce-avatar-assistant",children:"\ud83e\udd16"}),(0,l.jsx)("div",{className:"ce-chat-bubble ce-chat-bubble-assistant",children:e})]})}var d=s(3457);function h({title:e,children:n}){return(0,l.jsxs)("div",{children:[(0,l.jsxs)("div",{className:"ce-schema-header",children:["\ud83d\udcd0 ",e]}),(0,l.jsx)(d.A,{language:"json",children:"string"==typeof n?n.trim():""})]})}function x({type:e,children:n}){return(0,l.jsx)("div",{className:`ce-highlight ce-${e}`,children:n})}function p({language:e="text",title:n,defaultOpen:s=!1,children:r}){const[t,c]=(0,i.useState)(s);return(0,l.jsxs)("div",{className:"ce-codeblock-toggle",children:[(0,l.jsxs)("div",{className:"ce-codeblock-header",onClick:()=>c(!t),children:[(0,l.jsxs)("div",{className:"ce-codeblock-title",children:["\ud83e\udde9 ",n||`${e.toUpperCase()} code`]}),(0,l.jsx)("button",{className:"ce-codeblock-btn",children:t?"Hide \u25b2":"Show \u25bc"})]}),t&&(0,l.jsx)("div",{className:"ce-codeblock-body",children:(0,l.jsx)(d.A,{language:e,children:r})})]})}},2402(e,n,s){s.r(n),s.d(n,{assets:()=>u,contentTitle:()=>j,default:()=>v,frontMatter:()=>p,metadata:()=>i,toc:()=>m});const i=JSON.parse('{"id":"mcp","title":"MCP","description":"This document explains how MCP works internally in ConvEngine, based strictly on the real implementation of:","source":"@site/docs/mcp.mdx","sourceDirName":".","slug":"/mcp","permalink":"/convengine-docs/docs/mcp","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/mcp.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"docSidebar","previous":{"title":"Architecture","permalink":"/convengine-docs/docs/architecture"}}');var l=s(4848),r=s(8453),t=s(1826),c=s(9073),o=s(3692);const a=(0,s(8991).A)("outline","player-play","PlayerPlay",[["path",{d:"M7 4v16l13 -8l-13 -8",key:"svg-0"}]]);var d=s(1831),h=s(7606),x=s(1523);const p={},j="MCP",u={},m=[{value:"Example conversation",id:"example-conversation",level:2},{value:"MCP execution timeline",id:"mcp-execution-timeline",level:2},{value:"Core MCP loop (real code)",id:"core-mcp-loop-real-code",level:2},{value:"MCP context structure",id:"mcp-context-structure",level:2},{value:"How McpPlanner decides which tool to call",id:"how-mcpplanner-decides-which-tool-to-call",level:2},{value:"Why <code>postgres.move_status</code> is chosen",id:"why-postgresmove_status-is-chosen",level:3},{value:"Core MCP loop (real code)",id:"core-mcp-loop-real-code-1",level:2},{value:"What happens after MCP?",id:"what-happens-after-mcp",level:2},{value:"Why MCP is safe by design",id:"why-mcp-is-safe-by-design",level:2},{value:"Final takeaway",id:"final-takeaway",level:2},{value:"Debugging tip",id:"debugging-tip",level:2},{value:"Final takeaway",id:"final-takeaway-1",level:2}];function b(e){const n={blockquote:"blockquote",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return t.K||g("Timeline",!1),t.K.Item||g("Timeline.Item",!0),(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"mcp",children:"MCP"})}),"\n",(0,l.jsxs)(n.p,{children:["This document explains ",(0,l.jsx)(n.strong,{children:"how MCP works internally in ConvEngine"}),", based strictly on the real implementation of:"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.code,{children:"com.github.salilvnair.convengine.engine.steps.McpToolStep"})}),"\n",(0,l.jsx)(n.p,{children:"MCP is used when:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["An intent requires ",(0,l.jsx)(n.strong,{children:"external data"})]}),"\n",(0,l.jsxs)(n.li,{children:["That data must be fetched ",(0,l.jsx)(n.strong,{children:"safely"})]}),"\n",(0,l.jsxs)(n.li,{children:["The engine must reason in ",(0,l.jsx)(n.strong,{children:"multiple steps"})]}),"\n",(0,l.jsxs)(n.li,{children:["SQL or tools must be ",(0,l.jsx)(n.strong,{children:"DB-driven, not hardcoded"})]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"example-conversation",children:"Example conversation"}),"\n",(0,l.jsxs)(x.sy,{children:[(0,l.jsx)(x.KJ,{children:(0,l.jsx)(n.p,{children:"What is the status of my move for connection USPSC003BA100SA277CON1388"})}),(0,l.jsx)("br",{}),(0,l.jsx)(x.Fb,{children:(0,l.jsx)(n.p,{children:"The status of your move for connection USPSC003BA100SA277CON1388 is MOVED."})})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"mcp-execution-timeline",children:"MCP execution timeline"}),"\n",(0,l.jsxs)(t.K,{active:7,bulletSize:28,lineWidth:3,children:[(0,l.jsx)(t.K.Item,{bullet:(0,l.jsx)(a,{size:14}),title:"MCP step starts",children:(0,l.jsx)(c.E,{size:"sm",children:(0,l.jsx)(n.p,{children:"McpToolStep runs after intent resolution and before rules / response."})})}),(0,l.jsx)(t.K.Item,{bullet:(0,l.jsx)(d.A,{size:14}),title:"Enabled tools loaded",children:(0,l.jsx)(c.E,{size:"sm",children:(0,l.jsxs)(n.p,{children:["McpToolRegistry loads enabled tools from ",(0,l.jsx)("code",{children:"ce_mcp_tool"}),".\nIf no tools exist, MCP exits early."]})})}),(0,l.jsxs)(t.K.Item,{bullet:(0,l.jsx)(d.A,{size:14}),title:"MCP context cleared",children:[(0,l.jsx)(c.E,{size:"sm",children:(0,l.jsxs)(n.p,{children:["Any stale ",(0,l.jsx)("code",{children:"context_json.mcp.finalAnswer"})," or observations are removed."]})}),(0,l.jsx)(x.f4,{type:"danger",children:(0,l.jsx)(n.p,{children:"If this step is skipped, previous answers WILL leak into new requests."})})]}),(0,l.jsx)(t.K.Item,{bullet:(0,l.jsx)(d.A,{size:14}),title:"Planner loop begins (max 5 iterations)",children:(0,l.jsx)(c.E,{size:"sm",children:(0,l.jsx)(n.p,{children:"Planner decides whether to CALL_TOOL or ANSWER."})})}),(0,l.jsx)(t.K.Item,{bullet:(0,l.jsx)(h.A,{size:14}),title:"Planner calls DB tool",children:(0,l.jsx)(c.E,{size:"sm",children:(0,l.jsx)(n.p,{children:"Tool code + arguments are returned by the planner and audited."})})}),(0,l.jsx)(t.K.Item,{bullet:(0,l.jsx)(h.A,{size:14}),title:"DB tool executed safely",children:(0,l.jsx)(c.E,{size:"sm",children:(0,l.jsxs)(n.p,{children:["SQL template from ",(0,l.jsx)("code",{children:"ce_mcp_db_tool"})," is executed via\n",(0,l.jsx)("code",{children:"McpDbExecutor"}),"."]})})}),(0,l.jsx)(t.K.Item,{bullet:(0,l.jsx)(d.A,{size:14}),title:"Observation recorded",children:(0,l.jsx)(c.E,{size:"sm",children:(0,l.jsxs)(n.p,{children:["Tool result is appended to ",(0,l.jsx)("code",{children:"context_json.mcp.observations"}),"."]})})}),(0,l.jsx)(t.K.Item,{bullet:(0,l.jsx)(d.A,{size:14}),title:"Planner returns ANSWER",children:(0,l.jsx)(c.E,{size:"sm",children:(0,l.jsxs)(n.p,{children:["Final answer is written to ",(0,l.jsx)("code",{children:"context_json.mcp.finalAnswer"}),"."]})})})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"core-mcp-loop-real-code",children:"Core MCP loop (real code)"}),"\n",(0,l.jsx)(x.vl,{language:"java",title:"McpToolStep.execute(...)",children:'for (int i = 0; i < MAX_LOOPS; i++) {\n\n  McpPlan plan = planner.plan(session, tools, observations);\n\n  if ("ANSWER".equalsIgnoreCase(plan.action())) {\n      writeFinalAnswerToContext(session, plan.answer());\n      audit.audit("MCP_FINAL_ANSWER", session.getConversationId(), ...);\n      break;\n  }\n\n  if (!"CALL_TOOL".equalsIgnoreCase(plan.action())) {\n      writeFinalAnswerToContext(session, "I couldn\'t decide safely.");\n      break;\n  }\n\n  CeMcpDbTool dbTool = registry.requireDbTool(plan.tool_code());\n  String rowsJson = dbExecutor.execute(dbTool, plan.args());\n\n  observations.add(new McpObservation(plan.tool_code(), rowsJson));\n  writeObservationsToContext(session, observations);\n\n  audit.audit("MCP_TOOL_RESULT", session.getConversationId(), ...);\n}'}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"mcp-context-structure",children:"MCP context structure"}),"\n",(0,l.jsxs)(n.p,{children:["After execution, MCP writes into ",(0,l.jsx)(n.code,{children:"ce_conversation.context_json"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-json",children:'{\n  "mcp": {\n    "observations": [\n      {\n        "toolCode": "postgres.move_status",\n        "json": "[{ \\"status\\": \\"MOVED\\" }]"\n      }\n    ],\n    "finalAnswer": "The status of your move is MOVED."\n  }\n}\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(x.f4,{type:"success",children:(0,l.jsxs)(n.p,{children:[(0,l.jsx)("br",{})," MCP does NOT return the API response directly.",(0,l.jsx)(n.br,{}),"\n",(0,l.jsx)("br",{})," It prepares data for rules and response resolution."]})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"how-mcpplanner-decides-which-tool-to-call",children:"How McpPlanner decides which tool to call"}),"\n",(0,l.jsxs)(n.p,{children:["McpPlanner is the ",(0,l.jsx)(n.strong,{children:"only component"})," that decides:"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Whether MCP should continue"}),"\n",(0,l.jsx)(n.li,{children:"Whether to CALL_TOOL or ANSWER"}),"\n",(0,l.jsx)(n.li,{children:"Which tool to call"}),"\n",(0,l.jsx)(n.li,{children:"Which arguments to pass"}),"\n"]}),"\n",(0,l.jsx)(x.f4,{type:"info",children:(0,l.jsxs)(n.p,{children:["McpToolStep never chooses a tool.",(0,l.jsx)(n.br,{}),"\n","It blindly executes whatever McpPlanner returns."]})}),"\n",(0,l.jsxs)(n.h3,{id:"why-postgresmove_status-is-chosen",children:["Why ",(0,l.jsx)("code",{children:"postgres.move_status"})," is chosen"]}),"\n",(0,l.jsx)(n.p,{children:"Given:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Intent = MOVE_CONNECTIONS"}),"\n",(0,l.jsx)(n.li,{children:"Question contains a connection id"}),"\n",(0,l.jsx)(n.li,{children:"No existing answer in context"}),"\n",(0,l.jsx)(n.li,{children:"Tool metadata describing move-status lookup"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"The planner emits a CALL_TOOL plan."}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"core-mcp-loop-real-code-1",children:"Core MCP loop (real code)"}),"\n",(0,l.jsx)(x.vl,{language:"java",title:"McpToolStep.execute(...)",children:'for (int i = 0; i < MAX_LOOPS; i++) {\n  McpPlan plan = planner.plan(session, tools, observations);\n  if ("ANSWER".equalsIgnoreCase(plan.action())) {\n      writeFinalAnswerToContext(session, plan.answer());\n      break;\n  }\n  CeMcpDbTool dbTool = registry.requireDbTool(plan.tool_code());\n  String rowsJson = dbExecutor.execute(dbTool, plan.args());\n  observations.add(new McpObservation(plan.tool_code(), rowsJson));\n}'}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"what-happens-after-mcp",children:"What happens after MCP?"}),"\n",(0,l.jsxs)(o.B,{spacing:"xs",children:[(0,l.jsxs)(c.E,{children:["\u2022 RulesStep may short-circuit if ",(0,l.jsx)("code",{children:"$.mcp.finalAnswer"})," exists"]}),(0,l.jsxs)(c.E,{children:["\u2022 Or state may be updated via ",(0,l.jsx)("code",{children:"ce_rule"})]}),(0,l.jsxs)(c.E,{children:["\u2022 ResponseResolutionStep selects ",(0,l.jsx)("code",{children:"ce_response"})]}),(0,l.jsx)(c.E,{children:"\u2022 Response may be EXACT or DERIVED"})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"why-mcp-is-safe-by-design",children:"Why MCP is safe by design"}),"\n",(0,l.jsx)(x.f4,{type:"success",children:(0,l.jsxs)(n.p,{children:["No dynamic SQL from LLM",(0,l.jsx)(n.br,{}),"\n",(0,l.jsx)("br",{})," All tools are DB-configured",(0,l.jsx)(n.br,{}),"\n",(0,l.jsx)("br",{})," Param schema validated",(0,l.jsx)(n.br,{}),"\n",(0,l.jsx)("br",{})," Max rows enforced",(0,l.jsx)(n.br,{}),"\n",(0,l.jsx)("br",{})," Failures degrade gracefully",(0,l.jsx)(n.br,{}),"\n",(0,l.jsx)("br",{})," Every step is audited"]})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"final-takeaway",children:"Final takeaway"}),"\n",(0,l.jsx)(x.f4,{type:"success",children:(0,l.jsx)(n.p,{children:"MCP is controlled, deterministic, DB-driven, and safe."})}),"\n",(0,l.jsx)(n.h2,{id:"debugging-tip",children:"Debugging tip"}),"\n",(0,l.jsx)(n.p,{children:"If you ever see:"}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"Second request returns previous answer"}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["Check these ",(0,l.jsx)(n.strong,{children:"in order"}),":"]}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"MCP_CONTEXT_CLEARED audit exists"}),"\n",(0,l.jsx)(n.li,{children:"SQL tool params extracted correctly"}),"\n",(0,l.jsx)(n.li,{children:"derivation_hint does not blindly reuse old finalAnswer"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"final-takeaway-1",children:"Final takeaway"}),"\n",(0,l.jsxs)(x.f4,{type:"success",children:[(0,l.jsx)(n.p,{children:"MCP in ConvEngine is not \u201cagents doing magic\u201d."}),(0,l.jsxs)(n.p,{children:["It is:",(0,l.jsx)("br",{}),"\n\u2022 Controlled",(0,l.jsx)("br",{}),"\n\u2022 Deterministic",(0,l.jsx)("br",{}),"\n\u2022 Auditable",(0,l.jsx)("br",{}),"\n\u2022 DB-driven",(0,l.jsx)("br",{}),"\n\u2022 Safe ",(0,l.jsx)("br",{})]})]})]})}function v(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(b,{...e})}):b(e)}function g(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}}}]);