<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-architecture" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Architecture | ConvEngine</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://salilvnair.github.io/convengine-docs/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://salilvnair.github.io/convengine-docs/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://salilvnair.github.io/convengine-docs/docs/architecture"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Architecture | ConvEngine"><meta data-rh="true" name="description" content="End-to-end flow (the big picture)"><meta data-rh="true" property="og:description" content="End-to-end flow (the big picture)"><link data-rh="true" rel="icon" href="/convengine-docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://salilvnair.github.io/convengine-docs/docs/architecture"><link data-rh="true" rel="alternate" href="https://salilvnair.github.io/convengine-docs/docs/architecture" hreflang="en"><link data-rh="true" rel="alternate" href="https://salilvnair.github.io/convengine-docs/docs/architecture" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Architecture","item":"https://salilvnair.github.io/convengine-docs/docs/architecture"}]}</script><link rel="alternate" type="application/rss+xml" href="/convengine-docs/blog/rss.xml" title="ConvEngine RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/convengine-docs/blog/atom.xml" title="ConvEngine Atom Feed"><link rel="stylesheet" href="/convengine-docs/assets/css/styles.04e4c80c.css">
<script src="/convengine-docs/assets/js/runtime~main.ea61799a.js" defer="defer"></script>
<script src="/convengine-docs/assets/js/main.b4e160fa.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/convengine-docs/img/conv.svg"><style data-mantine-styles="true">



</style><style data-mantine-styles="classes">@media (max-width: 35.99375em) {.mantine-visible-from-xs {display: none !important;}}@media (min-width: 36em) {.mantine-hidden-from-xs {display: none !important;}}@media (max-width: 47.99375em) {.mantine-visible-from-sm {display: none !important;}}@media (min-width: 48em) {.mantine-hidden-from-sm {display: none !important;}}@media (max-width: 61.99375em) {.mantine-visible-from-md {display: none !important;}}@media (min-width: 62em) {.mantine-hidden-from-md {display: none !important;}}@media (max-width: 74.99375em) {.mantine-visible-from-lg {display: none !important;}}@media (min-width: 75em) {.mantine-hidden-from-lg {display: none !important;}}@media (max-width: 87.99375em) {.mantine-visible-from-xl {display: none !important;}}@media (min-width: 88em) {.mantine-hidden-from-xl {display: none !important;}}</style><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/convengine-docs/"><div class="navbar__logo"><img src="/convengine-docs/img/conv.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/convengine-docs/img/conv.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">ConvEngine</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/convengine-docs/docs/architecture">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/salilvnair/convengine-docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/convengine-docs/docs/architecture"><span title="Architecture" class="linkLabel_WmDU">Architecture</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/convengine-docs/docs/mcp"><span title="MCP" class="linkLabel_WmDU">MCP</span></a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/convengine-docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Architecture</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Architecture</h1></header>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="end-to-end-flow-the-big-picture">End-to-end flow (the big picture)<a href="#end-to-end-flow-the-big-picture" class="hash-link" aria-label="Direct link to End-to-end flow (the big picture)" title="Direct link to End-to-end flow (the big picture)" translate="no">‚Äã</a></h3>
<br>
<div style="--tl-bullet-size:calc(2rem * var(--mantine-scale));--tl-line-width:calc(0.125rem * var(--mantine-scale))" class="m_43657ece mantine-Timeline-root" data-align="left"><div class="m_436178ff mantine-Timeline-item" data-line-active="true" data-active="true"><div class="m_8affcee1 mantine-Timeline-itemBullet" data-with-child="true" data-align="left" data-active="true"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="tabler-icon tabler-icon-arrow-right"><path d="M5 12l14 0"></path><path d="M13 18l6 -6"></path><path d="M13 6l6 6"></path></svg></div><div class="m_540e8f41 mantine-Timeline-itemBody"><div class="m_2ebe8099 mantine-Timeline-itemTitle">Request enters ConversationController</div><div class="mantine-Timeline-itemContent"><div style="--stack-gap:var(--mantine-spacing-xs);--stack-align:stretch;--stack-justify:flex-start" class="m_6d731127 mantine-Stack-root"><p style="font-weight:600" class="mantine-focus-auto m_b6d8b162 mantine-Text-root">HTTP request received</p><p style="--text-fz:var(--mantine-font-size-sm);--text-lh:var(--mantine-line-height-sm);color:var(--mantine-color-dimmed)" class="mantine-focus-auto m_b6d8b162 mantine-Text-root" data-size="sm"></p><p>REST API receives <code class="m_b183c0a2 mantine-Code-root" dir="ltr">{conversationId, text}</code>,
audits <b>USER_INPUT</b>, and forwards control to
<code class="m_b183c0a2 mantine-Code-root" dir="ltr"> DefaultConversationalEngine</code>.</p><p></p></div></div></div></div><div class="m_436178ff mantine-Timeline-item" data-line-active="true" data-active="true"><div class="m_8affcee1 mantine-Timeline-itemBullet" data-with-child="true" data-align="left" data-active="true"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="tabler-icon tabler-icon-cpu"><path d="M5 6a1 1 0 0 1 1 -1h12a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-12a1 1 0 0 1 -1 -1l0 -12"></path><path d="M9 9h6v6h-6l0 -6"></path><path d="M3 10h2"></path><path d="M3 14h2"></path><path d="M10 3v2"></path><path d="M14 3v2"></path><path d="M21 10h-2"></path><path d="M21 14h-2"></path><path d="M14 21v-2"></path><path d="M10 21v-2"></path></svg></div><div class="m_540e8f41 mantine-Timeline-itemBody"><div class="m_2ebe8099 mantine-Timeline-itemTitle">EngineSession created + pipeline execution</div><div class="mantine-Timeline-itemContent"><div style="--stack-gap:var(--mantine-spacing-xs);--stack-align:stretch;--stack-justify:flex-start" class="m_6d731127 mantine-Stack-root"><p style="font-weight:600" class="mantine-focus-auto m_b6d8b162 mantine-Text-root">Engine initializes execution context</p><p style="--text-fz:var(--mantine-font-size-sm);--text-lh:var(--mantine-line-height-sm);color:var(--mantine-color-dimmed)" class="mantine-focus-auto m_b6d8b162 mantine-Text-root" data-size="sm"></p><p>EngineSession is a working POJO holding intent, state,
context_json, payload, and history. The engine dynamically
builds the pipeline from Spring-managed steps.</p><p></p></div></div></div></div><div class="m_436178ff mantine-Timeline-item" data-line-active="true" data-active="true"><div class="m_8affcee1 mantine-Timeline-itemBullet" data-with-child="true" data-align="left" data-active="true"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="tabler-icon tabler-icon-database"><path d="M4 6a8 3 0 1 0 16 0a8 3 0 1 0 -16 0"></path><path d="M4 6v6a8 3 0 0 0 16 0v-6"></path><path d="M4 12v6a8 3 0 0 0 16 0v-6"></path></svg></div><div class="m_540e8f41 mantine-Timeline-itemBody"><div class="m_2ebe8099 mantine-Timeline-itemTitle">Conversation bootstrap + load</div><div class="mantine-Timeline-itemContent"><div style="--stack-gap:var(--mantine-spacing-xs);--stack-align:stretch;--stack-justify:flex-start" class="m_6d731127 mantine-Stack-root"><p style="font-weight:600" class="mantine-focus-auto m_b6d8b162 mantine-Text-root">Conversation row ensured and restored</p><p style="--text-fz:var(--mantine-font-size-sm);--text-lh:var(--mantine-line-height-sm);color:var(--mantine-color-dimmed)" class="mantine-focus-auto m_b6d8b162 mantine-Text-root" data-size="sm"></p><p><code class="m_b183c0a2 mantine-Code-root" dir="ltr">ce_conversation</code> is created (if missing) and loaded.
Existing <b>state_code</b>, <b>intent_code</b>, and
<b>context_json</b> are restored into the session.</p><p></p></div></div></div></div><div class="m_436178ff mantine-Timeline-item" data-line-active="true" data-active="true"><div class="m_8affcee1 mantine-Timeline-itemBullet" data-with-child="true" data-align="left" data-active="true"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="tabler-icon tabler-icon-brain"><path d="M15.5 13a3.5 3.5 0 0 0 -3.5 3.5v1a3.5 3.5 0 0 0 7 0v-1.8"></path><path d="M8.5 13a3.5 3.5 0 0 1 3.5 3.5v1a3.5 3.5 0 0 1 -7 0v-1.8"></path><path d="M17.5 16a3.5 3.5 0 0 0 0 -7h-.5"></path><path d="M19 9.3v-2.8a3.5 3.5 0 0 0 -7 0"></path><path d="M6.5 16a3.5 3.5 0 0 1 0 -7h.5"></path><path d="M5 9.3v-2.8a3.5 3.5 0 0 1 7 0v10"></path></svg></div><div class="m_540e8f41 mantine-Timeline-itemBody"><div class="m_2ebe8099 mantine-Timeline-itemTitle">Intent resolution</div><div class="mantine-Timeline-itemContent"><div style="--stack-gap:var(--mantine-spacing-xs);--stack-align:stretch;--stack-justify:flex-start" class="m_6d731127 mantine-Stack-root"><p style="font-weight:600" class="mantine-focus-auto m_b6d8b162 mantine-Text-root">Intent classified using DB + LLM</p><p style="--text-fz:var(--mantine-font-size-sm);--text-lh:var(--mantine-line-height-sm);color:var(--mantine-color-dimmed)" class="mantine-focus-auto m_b6d8b162 mantine-Text-root" data-size="sm"></p><p>Intent resolution is driven by
<code class="m_b183c0a2 mantine-Code-root" dir="ltr"> ce_intent</code>,
<code class="m_b183c0a2 mantine-Code-root" dir="ltr"> ce_intent_classifier</code>, and
<code class="m_b183c0a2 mantine-Code-root" dir="ltr"> ce_prompt_template</code>.
AGENT classifiers invoke the LLM under strict JSON contracts.</p><p></p></div></div></div></div><div class="m_436178ff mantine-Timeline-item" data-line-active="true" data-active="true"><div class="m_8affcee1 mantine-Timeline-itemBullet" data-with-child="true" data-align="left" data-active="true"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="tabler-icon tabler-icon-tool"><path d="M7 10h3v-3l-3.5 -3.5a6 6 0 0 1 8 8l6 6a2 2 0 0 1 -3 3l-6 -6a6 6 0 0 1 -8 -8l3.5 3.5"></path></svg></div><div class="m_540e8f41 mantine-Timeline-itemBody"><div class="m_2ebe8099 mantine-Timeline-itemTitle">MCP tool execution</div><div class="mantine-Timeline-itemContent"><div style="--stack-gap:var(--mantine-spacing-xs);--stack-align:stretch;--stack-justify:flex-start" class="m_6d731127 mantine-Stack-root"><p style="font-weight:600" class="mantine-focus-auto m_b6d8b162 mantine-Text-root">Planner selects and executes tools</p><p style="--text-fz:var(--mantine-font-size-sm);--text-lh:var(--mantine-line-height-sm);color:var(--mantine-color-dimmed)" class="mantine-focus-auto m_b6d8b162 mantine-Text-root" data-size="sm"></p><p>MCP context is cleared first.
Planner selects tools from
<code class="m_b183c0a2 mantine-Code-root" dir="ltr"> ce_mcp_tool</code> +
<code class="m_b183c0a2 mantine-Code-root" dir="ltr"> ce_mcp_db_tool</code>,
executes SQL safely, and stores observations and
<b>finalAnswer</b> under <code class="m_b183c0a2 mantine-Code-root" dir="ltr">context_json.mcp</code>.</p><p></p></div></div></div></div><div class="m_436178ff mantine-Timeline-item" data-line-active="true" data-active="true"><div class="m_8affcee1 mantine-Timeline-itemBullet" data-with-child="true" data-align="left" data-active="true"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="tabler-icon tabler-icon-git-branch"><path d="M5 18a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path><path d="M5 6a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path><path d="M15 6a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path><path d="M7 8l0 8"></path><path d="M9 18h6a2 2 0 0 0 2 -2v-5"></path><path d="M14 14l3 -3l3 3"></path></svg></div><div class="m_540e8f41 mantine-Timeline-itemBody"><div class="m_2ebe8099 mantine-Timeline-itemTitle">Rules engine evaluation</div><div class="mantine-Timeline-itemContent"><div style="--stack-gap:var(--mantine-spacing-xs);--stack-align:stretch;--stack-justify:flex-start" class="m_6d731127 mantine-Stack-root"><p style="font-weight:600" class="mantine-focus-auto m_b6d8b162 mantine-Text-root">DB-driven state machine applied</p><p style="--text-fz:var(--mantine-font-size-sm);--text-lh:var(--mantine-line-height-sm);color:var(--mantine-color-dimmed)" class="mantine-focus-auto m_b6d8b162 mantine-Text-root" data-size="sm"></p><p>Rules from <code class="m_b183c0a2 mantine-Code-root" dir="ltr">ce_rule</code> run in priority order,
mutating state, intent, or short-circuiting execution
using resolver factories.</p><p></p></div></div></div></div><div class="m_436178ff mantine-Timeline-item" data-line-active="true" data-active="true"><div class="m_8affcee1 mantine-Timeline-itemBullet" data-with-child="true" data-align="left" data-active="true"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="tabler-icon tabler-icon-message"><path d="M8 9h8"></path><path d="M8 13h6"></path><path d="M18 4a3 3 0 0 1 3 3v8a3 3 0 0 1 -3 3h-5l-5 3v-3h-2a3 3 0 0 1 -3 -3v-8a3 3 0 0 1 3 -3h12"></path></svg></div><div class="m_540e8f41 mantine-Timeline-itemBody"><div class="m_2ebe8099 mantine-Timeline-itemTitle">Response resolution</div><div class="mantine-Timeline-itemContent"><div style="--stack-gap:var(--mantine-spacing-xs);--stack-align:stretch;--stack-justify:flex-start" class="m_6d731127 mantine-Stack-root"><p style="font-weight:600" class="mantine-focus-auto m_b6d8b162 mantine-Text-root">Final payload generated</p><p style="--text-fz:var(--mantine-font-size-sm);--text-lh:var(--mantine-line-height-sm);color:var(--mantine-color-dimmed)" class="mantine-focus-auto m_b6d8b162 mantine-Text-root" data-size="sm"></p><p><code class="m_b183c0a2 mantine-Code-root" dir="ltr">ce_response</code> selects EXACT vs DERIVED output.
DERIVED responses may invoke LLM; EXACT responses are
deterministic and bypass generation.</p><p></p></div></div></div></div><div class="m_436178ff mantine-Timeline-item" data-active="true"><div class="m_8affcee1 mantine-Timeline-itemBullet" data-with-child="true" data-align="left" data-active="true"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="tabler-icon tabler-icon-device-floppy"><path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2"></path><path d="M10 14a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path><path d="M14 4l0 4l-6 0l0 -4"></path></svg></div><div class="m_540e8f41 mantine-Timeline-itemBody"><div class="m_2ebe8099 mantine-Timeline-itemTitle">Conversation persisted + response returned</div><div class="mantine-Timeline-itemContent"><div style="--stack-gap:var(--mantine-spacing-xs);--stack-align:stretch;--stack-justify:flex-start" class="m_6d731127 mantine-Stack-root"><p style="font-weight:600" class="mantine-focus-auto m_b6d8b162 mantine-Text-root">Conversation saved and returned to client</p><p style="--text-fz:var(--mantine-font-size-sm);--text-lh:var(--mantine-line-height-sm);color:var(--mantine-color-dimmed)" class="mantine-focus-auto m_b6d8b162 mantine-Text-root" data-size="sm"></p><p>Updated intent, state, context_json, and payload are
persisted. The full execution trace is visible via
<code class="m_b183c0a2 mantine-Code-root" dir="ltr">ce_audit</code>.</p><p></p></div></div></div></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-request-entry-point---controller">1) Request entry point - controller<a href="#1-request-entry-point---controller" class="hash-link" aria-label="Direct link to 1) Request entry point - controller" title="Direct link to 1) Request entry point - controller" translate="no">‚Äã</a></h2>
<p><strong>File:</strong> <code>api/controller/ConversationController.java</code></p>
<p><strong>What happens here</strong></p>
<ul>
<li class="">Accepts <code>ConversationMessageRequest</code> with <code>conversationId</code> + <code>text</code></li>
<li class="">Writes a <code>USER_INPUT</code> audit so UI can replay the chain</li>
<li class="">Delegates to <code>ConversationalEngine.process(...)</code></li>
<li class="">Returns <code>OutputPayload</code> (TextPayload or JsonPayload)</li>
</ul>
<div class="ce-codeblock-toggle"><div class="ce-codeblock-header"><div class="ce-codeblock-title">üß© <!-- -->ConversationController.message(...)</div><button class="ce-codeblock-btn">Hide ‚ñ≤</button></div><div class="ce-codeblock-body"><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token annotation punctuation" style="color:rgb(248, 248, 242)">@PostMapping</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/message&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">public</span><span class="token plain"> </span><span class="token class-name">OutputPayload</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">message</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token annotation punctuation" style="color:rgb(248, 248, 242)">@RequestBody</span><span class="token plain"> </span><span class="token class-name">ConversationMessageRequest</span><span class="token plain"> request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token class-name">UUID</span><span class="token plain"> conversationId </span><span class="token operator">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">getConversationId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  audit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">audit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;USER_INPUT&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          conversationId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;{\&quot;text\&quot;:\&quot;&quot;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token class-name">JsonUtil</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">escape</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">getText</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;\&quot;}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token class-name">EngineSession</span><span class="token plain"> session </span><span class="token operator">=</span><span class="token plain"> engine</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">process</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">conversationId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">getText</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  audit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">audit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;ENGINE_OUTPUT&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          conversationId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;{\&quot;payload\&quot;:\&quot;&quot;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token class-name">JsonUtil</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">escape</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">valueOf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">session</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">getPayload</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;\&quot;}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> session</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">getPayload</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-conversationalengine---session--pipeline">2) ConversationalEngine - session + pipeline<a href="#2-conversationalengine---session--pipeline" class="hash-link" aria-label="Direct link to 2) ConversationalEngine - session + pipeline" title="Direct link to 2) ConversationalEngine - session + pipeline" translate="no">‚Äã</a></h2>
<p><strong>File:</strong> <code>engine/provider/DefaultConversationalEngine.java</code></p>
<p>This is the <strong>single orchestration point</strong> that:</p>
<ul>
<li class="">creates a new <code>EngineSession</code></li>
<li class="">creates the pipeline (dynamic steps)</li>
<li class="">executes it</li>
<li class="">returns the session to the controller</li>
</ul>
<div class="ce-codeblock-toggle"><div class="ce-codeblock-header"><div class="ce-codeblock-title">üß© <!-- -->DefaultConversationalEngine.process(...)</div><button class="ce-codeblock-btn">Show ‚ñº</button></div></div>
<div class="ce-highlight ce-success"><p>EngineSession is intentionally a <b>POJO working state</b>.
<br><br>It should not ‚Äúreach into DB‚Äù.
<br><br>DB reads/writes are done inside steps/services (like ConversationService, AuditHistoryProvider).</p></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-enginepipeline---the-core-loop-stepresult">3) EnginePipeline - the core loop (StepResult)<a href="#3-enginepipeline---the-core-loop-stepresult" class="hash-link" aria-label="Direct link to 3) EnginePipeline - the core loop (StepResult)" title="Direct link to 3) EnginePipeline - the core loop (StepResult)" translate="no">‚Äã</a></h2>
<p><strong>File:</strong> <code>engine/pipeline/EnginePipeline.java</code></p>
<p>Every step returns a <code>StepResult</code>:</p>
<ul>
<li class=""><code>Continue</code> ‚Üí next step</li>
<li class=""><code>Stop</code> ‚Üí pipeline terminates early and returns final OutputPayload</li>
</ul>
<div class="ce-codeblock-toggle"><div class="ce-codeblock-header"><div class="ce-codeblock-title">üß© <!-- -->EnginePipeline.execute(...)</div><button class="ce-codeblock-btn">Hide ‚ñ≤</button></div><div class="ce-codeblock-body"><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">public</span><span class="token plain"> </span><span class="token class-name">OutputPayload</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">execute</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token class-name">EngineSession</span><span class="token plain"> session</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token class-name">EngineStep</span><span class="token plain"> step </span><span class="token operator">:</span><span class="token plain"> steps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token class-name">StepResult</span><span class="token plain"> r </span><span class="token operator">=</span><span class="token plain"> step</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">execute</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">session</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">r </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">instanceof</span><span class="token plain"> </span><span class="token class-name">StepResult</span><span class="token class-name punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token class-name">Stop</span><span class="token plain"> stop</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> stop</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> session</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">getPayload</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div></div></div>
<div class="ce-highlight ce-success"><div><div>It&#x27;s how the engine can <b>hard-stop</b> when required preconditions fail (missing payload, invalid state, no response configured).</div><br><div>It keeps ‚Äústop logic‚Äù centralized and predictable.</div></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-pipeline-composition---how-steps-are-discovered-and-ordered">4) Pipeline composition - how steps are discovered and ordered<a href="#4-pipeline-composition---how-steps-are-discovered-and-ordered" class="hash-link" aria-label="Direct link to 4) Pipeline composition - how steps are discovered and ordered" title="Direct link to 4) Pipeline composition - how steps are discovered and ordered" translate="no">‚Äã</a></h2>
<p><strong>File:</strong> <code>engine/factory/EnginePipelineFactory.java</code></p>
<p>Steps are:</p>
<ul>
<li class="">discovered from Spring as beans of <code>EngineStep</code></li>
<li class="">filtered (conversation persisted requirement, etc.)</li>
<li class="">ordered using annotations:<!-- -->
<ul>
<li class=""><code>@MustRunAfter</code></li>
<li class=""><code>@MustRunBefore</code></li>
<li class=""><code>@RequiresConversationPersisted</code></li>
</ul>
</li>
</ul>
<div class="ce-codeblock-toggle"><div class="ce-codeblock-header"><div class="ce-codeblock-title">üß© <!-- -->EnginePipelineFactory ordering strategy (concept)</div><button class="ce-codeblock-btn">Show ‚ñº</button></div></div>
<div class="ce-highlight ce-warning"><b>Tip: adding a new step</b><br><ol>
<li class="">Create a Spring component that implements EngineStep<br></li>
<li class="">Annotate with MustRunAfter / MustRunBefore relative to existing steps<br></li>
<li class="">If it requires a ce_conversation row, add @RequiresConversationPersisted<br></li>
<li class="">Add audits inside the step so UI shows it</li>
</ol></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-database-brain---all-configuration-tables-dont-skip-any">5) Database ‚Äúbrain‚Äù - all configuration tables (don&#x27;t skip any)<a href="#5-database-brain---all-configuration-tables-dont-skip-any" class="hash-link" aria-label="Direct link to 5) Database ‚Äúbrain‚Äù - all configuration tables (don&#x27;t skip any)" title="Direct link to 5) Database ‚Äúbrain‚Äù - all configuration tables (don&#x27;t skip any)" translate="no">‚Äã</a></h2>
<p>Below is an overview of <strong>every core table</strong> that drives behavior.</p>
<div class="ce-db-table"><h4>üóÑÔ∏è <!-- -->Configuration tables</h4><table class="ce-db-table-grid"><thead><tr><th>Table</th><th>What it controls</th><th>Used by (code)</th><th>Notes / key columns</th></tr></thead><tbody><tr><td>ce_intent</td><td>Allowed intents, priority ordering, description + llmHint</td><td>AllowedIntentService, AgentIntentResolver</td><td>intent_code, enabled, priority, llm_hint</td></tr><tr><td>ce_intent_classifier</td><td>How intents are classified (AGENT/REGEX/EXACT etc) and which resolver to use</td><td>IntentResolutionStep</td><td>classifier_type, enabled, priority</td></tr><tr><td>ce_prompt_template</td><td>Prompt templates by purpose + optional intent scoping</td><td>AgentIntentResolver, MCP planner, Response resolvers</td><td>purpose, intent_code, system_prompt, user_prompt, enabled</td></tr><tr><td>ce_output_schema</td><td>Strict JSON schema control for LLM calls (by intent/state)</td><td>AgentIntentResolver, response format resolvers</td><td>intent_code, state_code, json_schema, enabled</td></tr><tr><td>ce_response</td><td>Which response to use for (state,intent) and how to generate it</td><td>ResponseResolutionStep + ResponseTypeResolverFactory</td><td>state_code, intent_code, response_type, output_format, priority</td></tr><tr><td>ce_rule</td><td>DB-driven state machine + short-circuit logic</td><td>RulesStep + RuleTypeResolverFactory + RuleActionResolverFactory</td><td>intent_code, rule_type, match_pattern, action, action_value, priority</td></tr><tr><td>ce_mcp_tool</td><td>Tool registry (code/group/enabled/description)</td><td>McpToolStep planner &amp; tool loader</td><td>tool_code, tool_group, enabled</td></tr><tr><td>ce_mcp_db_tool</td><td>DB tool configuration (dialect, sql template, param schema, safe mode, max rows)</td><td>McpDbToolExecutor</td><td>tool_id (FK), sql_template, param_schema (jsonb), safe_mode, max_rows</td></tr></tbody></table></div>
<div class="ce-db-table"><h4>üóÑÔ∏è <!-- -->Runtime tables</h4><table class="ce-db-table-grid"><thead><tr><th>Table</th><th>What it stores</th><th>Written/Read by</th><th>Key columns</th></tr></thead><tbody><tr><td>ce_conversation</td><td>One row per conversation with current state/intent + context_json + last response payload</td><td>PersistConversationBootstrapStep, LoadOrCreateConversationStep, PersistConversationStep</td><td>conversation_id, intent_code, state_code, context_json, last_assistant_json</td></tr><tr><td>ce_audit</td><td>Append-only timeline of everything that happened during processing</td><td>AuditService implementations; UI reads this for the chain</td><td>conversation_id, stage, payload_json (json), created_at</td></tr></tbody></table></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="6-step-by-step-pipeline-walk-through-actual-steps">6) Step-by-step pipeline walk-through (actual steps)<a href="#6-step-by-step-pipeline-walk-through-actual-steps" class="hash-link" aria-label="Direct link to 6) Step-by-step pipeline walk-through (actual steps)" title="Direct link to 6) Step-by-step pipeline walk-through (actual steps)" translate="no">‚Äã</a></h2>
<p>Below is the <strong>practical flow</strong> you&#x27;ll see in your engine.<br>
<!-- -->(Exact ordering can vary slightly based on annotations, but this is the intended lifecycle.)</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="step-1---persistconversationbootstrapstep">Step 1 - PersistConversationBootstrapStep<a href="#step-1---persistconversationbootstrapstep" class="hash-link" aria-label="Direct link to Step 1 - PersistConversationBootstrapStep" title="Direct link to Step 1 - PersistConversationBootstrapStep" translate="no">‚Äã</a></h3>
<p><strong>File:</strong> <code>engine/steps/PersistConversationBootstrapStep.java</code></p>
<p>Purpose:</p>
<ul>
<li class="">Ensures the conversation exists in DB when needed (bootstrap)</li>
<li class="">Audits the bootstrap action so your UI can see it</li>
</ul>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="step-2---loadorcreateconversationstep">Step 2 - LoadOrCreateConversationStep<a href="#step-2---loadorcreateconversationstep" class="hash-link" aria-label="Direct link to Step 2 - LoadOrCreateConversationStep" title="Direct link to Step 2 - LoadOrCreateConversationStep" translate="no">‚Äã</a></h3>
<p><strong>File:</strong> <code>engine/steps/LoadOrCreateConversationStep.java</code></p>
<p>Purpose:</p>
<ul>
<li class="">Loads existing conversation row OR creates a new one</li>
<li class="">Syncs conversation&#x27;s <code>intent_code</code>, <code>state_code</code>, <code>context_json</code> into EngineSession</li>
</ul>
<div class="ce-highlight ce-danger"><div><div>This is the boundary between ‚Äústateless HTTP call‚Äù and ‚Äústateful conversation engine‚Äù.</div><br><div>If this step is wrong, you&#x27;ll see bugs like ‚Äúold move id answer repeats‚Äù because context wasn&#x27;t updated/cleared correctly.</div></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="step-3---intentresolutionstep">Step 3 - IntentResolutionStep<a href="#step-3---intentresolutionstep" class="hash-link" aria-label="Direct link to Step 3 - IntentResolutionStep" title="Direct link to Step 3 - IntentResolutionStep" translate="no">‚Äã</a></h3>
<p><strong>File:</strong> <code>engine/steps/IntentResolutionStep.java</code></p>
<p>Purpose:</p>
<ul>
<li class="">Picks which classifier to run (from <code>ce_intent_classifier</code>)</li>
<li class="">Classifiers can be AGENT / REGEX / EXACT</li>
<li class="">Sets <code>session.intent</code> and audits</li>
</ul>
<div class="ce-codeblock-toggle"><div class="ce-codeblock-header"><div class="ce-codeblock-title">üß© <!-- -->IntentResolutionStep (key idea)</div><button class="ce-codeblock-btn">Show ‚ñº</button></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="step-4---validation--schema--extraction-steps">Step 4 - (Validation / schema / extraction steps)<a href="#step-4---validation--schema--extraction-steps" class="hash-link" aria-label="Direct link to Step 4 - (Validation / schema / extraction steps)" title="Direct link to Step 4 - (Validation / schema / extraction steps)" translate="no">‚Äã</a></h3>
<p>You have these steps in your engine to enrich session before MCP/Response:</p>
<ul>
<li class="">ValidationStep</li>
<li class="">SchemaExtractionStep</li>
<li class="">AutoAdvanceStep
(Exact behavior depends on your table config and your program features.)</li>
</ul>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="step-5---mcptoolstep-mcp-loop">Step 5 - McpToolStep (MCP loop)<a href="#step-5---mcptoolstep-mcp-loop" class="hash-link" aria-label="Direct link to Step 5 - McpToolStep (MCP loop)" title="Direct link to Step 5 - McpToolStep (MCP loop)" translate="no">‚Äã</a></h3>
<p><strong>File:</strong> <code>engine/steps/McpToolStep.java</code></p>
<p>Purpose:</p>
<ul>
<li class="">Clears old <code>context_json.mcp</code> (audit: MCP_CONTEXT_CLEARED)</li>
<li class="">Planner calls LLM to decide tool usage</li>
<li class="">Executes tools from DB tables:<!-- -->
<ul>
<li class="">ce_mcp_tool</li>
<li class="">ce_mcp_db_tool</li>
</ul>
</li>
<li class="">Writes:<!-- -->
<ul>
<li class=""><code>mcp.observations[]</code></li>
<li class=""><code>mcp.finalAnswer</code></li>
</ul>
</li>
</ul>
<div><div class="ce-schema-header">üìê <!-- -->context_json.mcp shape</div><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">&quot;mcp&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;observations&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">&quot;tool&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;postgres.schema&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">&quot;result&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">&quot;tables&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;...&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">&quot;tool&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;postgres.move_status&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">&quot;result&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">&quot;rows&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">&quot;connection_id&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;...&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">&quot;status&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;MOVED&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;finalAnswer&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;answer&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;The status of your move for connection ... is MOVED.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div></div>
<div class="ce-highlight ce-success"><div><div>Tools come from <b>ce_mcp_tool</b> and <b>ce_mcp_db_tool</b>, not from if/else in Java.</div><br><div>SQL templates and param_schema are stored in DB and enforced via safe_mode + max_rows.</div><br><div>The planner&#x27;s choice is audited so you can see exactly why it picked a tool.</div></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="step-6---rulesstep-db-driven-state-machine--shortcuts">Step 6 - RulesStep (DB-driven state machine + shortcuts)<a href="#step-6---rulesstep-db-driven-state-machine--shortcuts" class="hash-link" aria-label="Direct link to Step 6 - RulesStep (DB-driven state machine + shortcuts)" title="Direct link to Step 6 - RulesStep (DB-driven state machine + shortcuts)" translate="no">‚Äã</a></h3>
<p><strong>File:</strong> <code>engine/steps/RulesStep.java</code></p>
<p>Purpose:</p>
<ul>
<li class="">Iterates enabled rules ordered by priority</li>
<li class="">Uses <strong>factory pattern</strong>:<!-- -->
<ul>
<li class="">RuleTypeResolverFactory ‚Üí resolves whether rule matches (JSON_PATH / REGEX / ‚Ä¶)</li>
<li class="">RuleActionResolverFactory ‚Üí applies mutation (SET_STATE / SET_INTENT / SHORT_CIRCUIT)</li>
</ul>
</li>
<li class="">Audits RULE_APPLIED / RULE_NOT_APPLIED etc</li>
</ul>
<div class="ce-highlight ce-success"><p><b>This is where you build your state machine</b><br>
Example: if MCP produced mcp.finalAnswer, you can SHORT_CIRCUIT deterministically (no LLM formatting required).</p></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="step-7---responseresolutionstep-ce_response-driven">Step 7 - ResponseResolutionStep (ce_response driven)<a href="#step-7---responseresolutionstep-ce_response-driven" class="hash-link" aria-label="Direct link to Step 7 - ResponseResolutionStep (ce_response driven)" title="Direct link to Step 7 - ResponseResolutionStep (ce_response driven)" translate="no">‚Äã</a></h3>
<p><strong>File:</strong> <code>engine/steps/ResponseResolutionStep.java</code></p>
<p>Purpose:</p>
<ul>
<li class="">Finds the matching <code>ce_response</code> row</li>
<li class="">Delegates to <code>ResponseTypeResolverFactory</code>:<!-- -->
<ul>
<li class="">EXACT ‚Üí return configured response content directly</li>
<li class="">DERIVED ‚Üí uses templates + LLM (through OutputFormatResolverFactory)</li>
</ul>
</li>
<li class="">Writes audits including:<!-- -->
<ul>
<li class="">RESOLVE_RESPONSE</li>
<li class="">RESOLVE_RESPONSE_LLM_INPUT</li>
<li class="">RESOLVE_RESPONSE_LLM_OUTPUT</li>
</ul>
</li>
</ul>
<div class="ce-highlight ce-success"><div><div>Different programs can change responses without a build.</div><br><div>State+Intent drives the output: same intent can respond differently based on state_code.</div><br><div>DERIVED responses still remain controlled via templates + output schema.</div></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="step-8---persistconversationstep--pipelineendguardstep">Step 8 - PersistConversationStep + PipelineEndGuardStep<a href="#step-8---persistconversationstep--pipelineendguardstep" class="hash-link" aria-label="Direct link to Step 8 - PersistConversationStep + PipelineEndGuardStep" title="Direct link to Step 8 - PersistConversationStep + PipelineEndGuardStep" translate="no">‚Äã</a></h3>
<p>Purpose:</p>
<ul>
<li class="">PersistConversationStep syncs final <code>intent/state/context/last_assistant_json</code> to ce_conversation</li>
<li class="">PipelineEndGuardStep ensures payload exists; otherwise returns STOP with error payload</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="7-putting-it-together---example-conversation--behind-the-scenes">7) Putting it together - example conversation + ‚Äúbehind the scenes‚Äù<a href="#7-putting-it-together---example-conversation--behind-the-scenes" class="hash-link" aria-label="Direct link to 7) Putting it together - example conversation + ‚Äúbehind the scenes‚Äù" title="Direct link to 7) Putting it together - example conversation + ‚Äúbehind the scenes‚Äù" translate="no">‚Äã</a></h2>
<h1>FAQ Example - How ConvEngine Answers FAQs (No MCP)</h1>
<p>This document explains <strong>exactly</strong> how ConvEngine processes a <strong>FAQ-style question</strong>.
Unlike MOVE or other operational intents, <strong>FAQ does NOT use MCP tools</strong>.</p>
<p>If MCP runs for FAQ, that is a <strong>bug</strong> - not a feature.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="Ô∏è-example-faq-conversation">üó£Ô∏è Example FAQ Conversation<a href="#Ô∏è-example-faq-conversation" class="hash-link" aria-label="Direct link to üó£Ô∏è Example FAQ Conversation" title="Direct link to üó£Ô∏è Example FAQ Conversation" translate="no">‚Äã</a></h2>
<div class="ce-conversation"><div class="ce-chat"><div class="ce-chat-row ce-chat-end"><div class="ce-chat-bubble ce-chat-bubble-user"><p>Can I move my connections within zapper?</p></div><div class="ce-avatar ce-avatar-user">üë§</div></div><br><div class="ce-chat-row ce-chat-start"><div class="ce-avatar ce-avatar-assistant">ü§ñ</div><div class="ce-chat-bubble ce-chat-bubble-assistant"><p>Yes, internal account moves are supported.</p></div></div></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="-high-level-flow-faq">üîÑ High-level Flow (FAQ)<a href="#-high-level-flow-faq" class="hash-link" aria-label="Direct link to üîÑ High-level Flow (FAQ)" title="Direct link to üîÑ High-level Flow (FAQ)" translate="no">‚Äã</a></h2>
<p>Controller ‚Üí Engine ‚Üí Pipeline ‚Üí Intent ‚Üí Response ‚Üí Output</p>
<p>Key difference from MOVE:</p>
<ul>
<li class="">‚ùå No MCP planner</li>
<li class="">‚ùå No MCP tools</li>
<li class="">‚ùå No DB queries via MCP</li>
<li class="">‚úÖ Direct FAQ resolution</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="1Ô∏è‚É£-controller-receives-the-request">1Ô∏è‚É£ Controller receives the request<a href="#1Ô∏è‚É£-controller-receives-the-request" class="hash-link" aria-label="Direct link to 1Ô∏è‚É£ Controller receives the request" title="Direct link to 1Ô∏è‚É£ Controller receives the request" translate="no">‚Äã</a></h2>
<div class="ce-codeblock-toggle"><div class="ce-codeblock-header"><div class="ce-codeblock-title">üß© <!-- -->ConversationController.message(...)</div><button class="ce-codeblock-btn">Show ‚ñº</button></div></div>
<div class="ce-highlight ce-info"><div><div>So UI can replay the exact question later</div><br><div>So intent mistakes can be traced precisely</div></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="2Ô∏è‚É£-engine-creates-session-and-pipeline">2Ô∏è‚É£ Engine creates session and pipeline<a href="#2Ô∏è‚É£-engine-creates-session-and-pipeline" class="hash-link" aria-label="Direct link to 2Ô∏è‚É£ Engine creates session and pipeline" title="Direct link to 2Ô∏è‚É£ Engine creates session and pipeline" translate="no">‚Äã</a></h2>
<div class="ce-codeblock-toggle"><div class="ce-codeblock-header"><div class="ce-codeblock-title">üß© <!-- -->DefaultConversationalEngine.process(...)</div><button class="ce-codeblock-btn">Show ‚ñº</button></div></div>
<div class="ce-highlight ce-info"><p>EngineSession is a POJO.<br>
<!-- -->It does NOT decide behavior - the pipeline + DB do.</p></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="3Ô∏è‚É£-pipeline-executes-steps-in-order">3Ô∏è‚É£ Pipeline executes steps in order<a href="#3Ô∏è‚É£-pipeline-executes-steps-in-order" class="hash-link" aria-label="Direct link to 3Ô∏è‚É£ Pipeline executes steps in order" title="Direct link to 3Ô∏è‚É£ Pipeline executes steps in order" translate="no">‚Äã</a></h2>
<div class="ce-codeblock-toggle"><div class="ce-codeblock-header"><div class="ce-codeblock-title">üß© <!-- -->EnginePipeline.execute(...)</div><button class="ce-codeblock-btn">Show ‚ñº</button></div></div>
<div class="ce-decision ce-info"><strong>üõë<!-- --> <!-- -->INFO</strong><div><ul><li>Allows SHORT_CIRCUIT</li><li>Allows rules to stop flow early</li><li>No hardcoded branching</li></ul></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="4Ô∏è‚É£-intentresolutionstep--faq">4Ô∏è‚É£ IntentResolutionStep ‚Üí FAQ<a href="#4Ô∏è‚É£-intentresolutionstep--faq" class="hash-link" aria-label="Direct link to 4Ô∏è‚É£ IntentResolutionStep ‚Üí FAQ" title="Direct link to 4Ô∏è‚É£ IntentResolutionStep ‚Üí FAQ" translate="no">‚Äã</a></h2>
<p><strong>Tables involved:</strong></p>
<div class="ce-db-table"><h4>üóÑÔ∏è <!-- -->ce_intent</h4><p><em>Allowed intents</em></p><ul><li>intent_code = FAQ</li><li>priority</li><li>enabled</li></ul></div>
<div class="ce-db-table"><h4>üóÑÔ∏è <!-- -->ce_prompt_template</h4><p><em>Intent agent prompt</em></p><ul><li>purpose = INTENT_AGENT</li><li>intent_code = null</li></ul></div>
<p>The AgentIntentResolver:</p>
<ul>
<li class="">Sees allowed intents</li>
<li class="">Uses LLM <strong>only to classify</strong></li>
<li class="">Returns <code>FAQ</code></li>
</ul>
<div class="ce-highlight ce-success"><p>FAQ intent is resolved BEFORE any MCP logic exists.</p></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="5Ô∏è‚É£-mcp-is-skipped-important">5Ô∏è‚É£ MCP is SKIPPED (IMPORTANT)<a href="#5Ô∏è‚É£-mcp-is-skipped-important" class="hash-link" aria-label="Direct link to 5Ô∏è‚É£ MCP is SKIPPED (IMPORTANT)" title="Direct link to 5Ô∏è‚É£ MCP is SKIPPED (IMPORTANT)" translate="no">‚Äã</a></h2>
<p>There is <strong>no MCP planning</strong> because:</p>
<ul>
<li class="">FAQ intent has <strong>no MCP tools</strong></li>
<li class="">No ce_mcp_tool applies</li>
<li class="">No ce_mcp_db_tool is loaded</li>
</ul>
<div class="ce-highlight ce-danger"><p>If MCP runs for FAQ, your configuration is wrong.</p></div>
<p>You will <strong>not</strong> see:</p>
<ul>
<li class="">MCP_PLAN_LLM_INPUT</li>
<li class="">MCP_TOOL_CALL</li>
<li class="">MCP_FINAL_ANSWER</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="6Ô∏è‚É£-rulesstep-usually-no-op-for-faq">6Ô∏è‚É£ RulesStep (usually no-op for FAQ)<a href="#6Ô∏è‚É£-rulesstep-usually-no-op-for-faq" class="hash-link" aria-label="Direct link to 6Ô∏è‚É£ RulesStep (usually no-op for FAQ)" title="Direct link to 6Ô∏è‚É£ RulesStep (usually no-op for FAQ)" translate="no">‚Äã</a></h2>
<p>Typical FAQ rules:</p>
<ul>
<li class="">none</li>
<li class="">or cosmetic state changes</li>
</ul>
<div class="ce-db-table"><h4>üóÑÔ∏è <!-- -->ce_rule</h4><p><em>Optional FAQ rules</em></p><ul><li>intent_code = FAQ</li><li>rule_type = REGEX / JSON_PATH</li></ul></div>
<div class="ce-highlight ce-info"><p>FAQ usually has zero rules.</p></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="7Ô∏è‚É£-responseresolutionstep">7Ô∏è‚É£ ResponseResolutionStep<a href="#7Ô∏è‚É£-responseresolutionstep" class="hash-link" aria-label="Direct link to 7Ô∏è‚É£ ResponseResolutionStep" title="Direct link to 7Ô∏è‚É£ ResponseResolutionStep" translate="no">‚Äã</a></h2>
<div class="ce-db-table"><h4>üóÑÔ∏è <!-- -->ce_response</h4><p><em>FAQ responses</em></p><ul><li>intent_code = FAQ</li><li>state_code = IDLE</li><li>response_type = EXACT or DERIVED</li></ul></div>
<p>Two patterns:</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="pattern-a---exact-no-llm">Pattern A - EXACT (no LLM)<a href="#pattern-a---exact-no-llm" class="hash-link" aria-label="Direct link to Pattern A - EXACT (no LLM)" title="Direct link to Pattern A - EXACT (no LLM)" translate="no">‚Äã</a></h3>
<ul>
<li class="">exact_text is returned</li>
<li class="">fastest path</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="pattern-b---derived-llm-formatting">Pattern B - DERIVED (LLM formatting)<a href="#pattern-b---derived-llm-formatting" class="hash-link" aria-label="Direct link to Pattern B - DERIVED (LLM formatting)" title="Direct link to Pattern B - DERIVED (LLM formatting)" translate="no">‚Äã</a></h3>
<ul>
<li class="">derivation_hint used</li>
<li class="">still no MCP</li>
</ul>
<div class="ce-highlight ce-success"><p>FAQ responses NEVER depend on MCP context.</p></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="-what-youll-see-in-ce_audit-for-faq">üîç What you&#x27;ll see in ce_audit for FAQ<a href="#-what-youll-see-in-ce_audit-for-faq" class="hash-link" aria-label="Direct link to üîç What you&#x27;ll see in ce_audit for FAQ" title="Direct link to üîç What you&#x27;ll see in ce_audit for FAQ" translate="no">‚Äã</a></h2>
<p>Typical stages:</p>
<ul>
<li class="">USER_INPUT</li>
<li class="">INTENT_AGENT_LLM_INPUT</li>
<li class="">INTENT_AGENT_LLM_OUTPUT</li>
<li class="">RESOLVE_RESPONSE</li>
<li class="">RESOLVE_RESPONSE_LLM_OUTPUT (only if DERIVED)</li>
</ul>
<p>No MCP stages. Ever.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="-final-takeaways-faq">‚úÖ Final Takeaways (FAQ)<a href="#-final-takeaways-faq" class="hash-link" aria-label="Direct link to ‚úÖ Final Takeaways (FAQ)" title="Direct link to ‚úÖ Final Takeaways (FAQ)" translate="no">‚Äã</a></h2>
<div class="ce-decision ce-success"><strong>üõë<!-- --> <!-- -->SUCCESS</strong><div><ul><li>Intent = FAQ</li><li>No MCP planning</li><li>No DB tools</li><li>Response comes from ce_response</li><li>Fully deterministic unless DERIVED</li></ul></div></div>
<p>If FAQ ever:</p>
<ul>
<li class="">reuses previous answers</li>
<li class="">runs MCP</li>
<li class="">hits DB tools</li>
</ul>
<p>üëâ the bug is in <strong>configuration</strong>, not engine code.</p>
<hr>
<h1>MOVE_CONNECTIONS - Architecture Deep Dive</h1>
<p>This document explains <strong>exactly</strong> how ConvEngine processes a
<code>MOVE_CONNECTIONS</code> request - from REST controller to MCP tools to final response.</p>
<p>If you read this once, you should be able to:</p>
<ul>
<li class="">Debug any MOVE flow issue</li>
<li class="">Add new MCP tools safely</li>
<li class="">Understand where stale answers come from</li>
<li class="">Explain the engine to another engineer confidently</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="Ô∏è-example-conversation">üó£Ô∏è Example Conversation<a href="#Ô∏è-example-conversation" class="hash-link" aria-label="Direct link to üó£Ô∏è Example Conversation" title="Direct link to üó£Ô∏è Example Conversation" translate="no">‚Äã</a></h2>
<div class="ce-conversation"><div class="ce-chat"><div class="ce-chat-row ce-chat-end"><div class="ce-chat-bubble ce-chat-bubble-user"><p>What is the status of my move for connection USPSC003BA100SA277CON1388</p></div><div class="ce-avatar ce-avatar-user">üë§</div></div><br><div class="ce-chat-row ce-chat-start"><div class="ce-avatar ce-avatar-assistant">ü§ñ</div><div class="ce-chat-bubble ce-chat-bubble-assistant"><p>The status of your move for connection USPSC003BA100SA277CON1388 is MOVED.</p></div></div><br><div class="ce-chat-row ce-chat-end"><div class="ce-chat-bubble ce-chat-bubble-user"><p>What is the status of my move for connection USPSC003BA100SA277CON1128</p></div><div class="ce-avatar ce-avatar-user">üë§</div></div><br><div class="ce-chat-row ce-chat-start"><div class="ce-avatar ce-avatar-assistant">ü§ñ</div><div class="ce-chat-bubble ce-chat-bubble-assistant"><p>The status of your move for connection USPSC003BA100SA277CON1128 is IN_PROGRESS.</p></div></div></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="-high-level-flow-one-turn">üîÅ High-level Flow (One Turn)<a href="#-high-level-flow-one-turn" class="hash-link" aria-label="Direct link to üîÅ High-level Flow (One Turn)" title="Direct link to üîÅ High-level Flow (One Turn)" translate="no">‚Äã</a></h2>
<p>Controller ‚Üí Engine ‚Üí Pipeline ‚Üí Intent ‚Üí MCP ‚Üí Rules ‚Üí Response</p>
<p>Every <strong>User ‚Üí Assistant</strong> turn follows this exact lifecycle.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="1Ô∏è‚É£-request-enters-via-rest-controller">1Ô∏è‚É£ Request enters via REST controller<a href="#1Ô∏è‚É£-request-enters-via-rest-controller" class="hash-link" aria-label="Direct link to 1Ô∏è‚É£ Request enters via REST controller" title="Direct link to 1Ô∏è‚É£ Request enters via REST controller" translate="no">‚Äã</a></h2>
<p><strong>File:</strong> <code>ConversationController.java</code></p>
<div class="ce-codeblock-toggle"><div class="ce-codeblock-header"><div class="ce-codeblock-title">üß© <!-- -->ConversationController.message(...)</div><button class="ce-codeblock-btn">Show ‚ñº</button></div></div>
<div class="ce-decision ce-info"><strong>üõë<!-- --> <!-- -->INFO</strong><div><ul><li><b>UI replay:</b> ce_audit becomes a full timeline</li><li><b>Debug truth:</b> broken JSON or stale state is visible immediately</li><li><b>No hidden behavior:</b> every request is auditable</li></ul></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="2Ô∏è‚É£-enginesession--pipeline-orchestration">2Ô∏è‚É£ EngineSession + Pipeline orchestration<a href="#2Ô∏è‚É£-enginesession--pipeline-orchestration" class="hash-link" aria-label="Direct link to 2Ô∏è‚É£ EngineSession + Pipeline orchestration" title="Direct link to 2Ô∏è‚É£ EngineSession + Pipeline orchestration" translate="no">‚Äã</a></h2>
<p><strong>File:</strong> <code>DefaultConversationalEngine.java</code></p>
<div class="ce-codeblock-toggle"><div class="ce-codeblock-header"><div class="ce-codeblock-title">üß© <!-- -->DefaultConversationalEngine.process(...)</div><button class="ce-codeblock-btn">Show ‚ñº</button></div></div>
<div class="ce-highlight ce-success"><p>EngineSession is a POJO.<br>
<!-- -->All intelligence lives in pipeline steps + DB configuration.</p></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="3Ô∏è‚É£-pipeline-execution-model">3Ô∏è‚É£ Pipeline execution model<a href="#3Ô∏è‚É£-pipeline-execution-model" class="hash-link" aria-label="Direct link to 3Ô∏è‚É£ Pipeline execution model" title="Direct link to 3Ô∏è‚É£ Pipeline execution model" translate="no">‚Äã</a></h2>
<p><strong>File:</strong> <code>EnginePipeline.java</code></p>
<div class="ce-codeblock-toggle"><div class="ce-codeblock-header"><div class="ce-codeblock-title">üß© <!-- -->EnginePipeline.execute(...)</div><button class="ce-codeblock-btn">Show ‚ñº</button></div></div>
<div class="ce-decision ce-info"><strong>üõë<!-- --> <!-- -->INFO</strong><div><ul><li>Allows SHORT_CIRCUIT responses</li><li>Allows rules to stop execution</li><li>Keeps pipeline generic &amp; extensible</li></ul></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="4Ô∏è‚É£-core-pipeline-steps-order-matters">4Ô∏è‚É£ Core pipeline steps (order matters)<a href="#4Ô∏è‚É£-core-pipeline-steps-order-matters" class="hash-link" aria-label="Direct link to 4Ô∏è‚É£ Core pipeline steps (order matters)" title="Direct link to 4Ô∏è‚É£ Core pipeline steps (order matters)" translate="no">‚Äã</a></h2>
<p>Selects resolver (AGENT / REGEX / EXACT) from DB.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="5Ô∏è‚É£-intent-resolution-for-move_connections">5Ô∏è‚É£ Intent resolution for MOVE_CONNECTIONS<a href="#5Ô∏è‚É£-intent-resolution-for-move_connections" class="hash-link" aria-label="Direct link to 5Ô∏è‚É£ Intent resolution for MOVE_CONNECTIONS" title="Direct link to 5Ô∏è‚É£ Intent resolution for MOVE_CONNECTIONS" translate="no">‚Äã</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="tables-involved">Tables involved<a href="#tables-involved" class="hash-link" aria-label="Direct link to Tables involved" title="Direct link to Tables involved" translate="no">‚Äã</a></h3>
<div class="ce-db-table"><h4>üóÑÔ∏è <!-- -->ce_intent</h4><p><em>Allowed intents</em></p><ul><li>intent_code</li><li>priority</li><li>llm_hint</li><li>enabled</li></ul></div>
<div class="ce-db-table"><h4>üóÑÔ∏è <!-- -->ce_prompt_template</h4><p><em>Intent prompts</em></p><ul><li>purpose = INTENT_AGENT</li><li>system_prompt</li><li>user_prompt</li></ul></div>
<div class="ce-db-table"><h4>üóÑÔ∏è <!-- -->ce_output_schema</h4><p><em>Strict JSON control</em></p><ul><li>intent_code</li><li>state_code</li><li>json_schema</li></ul></div>
<p>The LLM returns structured JSON like:</p>
<div><div class="ce-schema-header">üìê <!-- -->Intent agent output</div><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">&quot;intent&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;MOVE_CONNECTIONS&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">&quot;confidence&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0.92</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">&quot;needsClarification&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">&quot;clarificationResolved&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">&quot;clarificationQuestion&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="6Ô∏è‚É£-mcp-tool-step-move_connections-only">6Ô∏è‚É£ MCP Tool Step (MOVE_CONNECTIONS only)<a href="#6Ô∏è‚É£-mcp-tool-step-move_connections-only" class="hash-link" aria-label="Direct link to 6Ô∏è‚É£ MCP Tool Step (MOVE_CONNECTIONS only)" title="Direct link to 6Ô∏è‚É£ MCP Tool Step (MOVE_CONNECTIONS only)" translate="no">‚Äã</a></h2>
<div class="ce-highlight ce-danger"><p>The FIRST thing MCP does is clear old context.<br>
<!-- -->If this does not happen, stale answers WILL appear.</p></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="mcp-execution-loop">MCP execution loop<a href="#mcp-execution-loop" class="hash-link" aria-label="Direct link to MCP execution loop" title="Direct link to MCP execution loop" translate="no">‚Äã</a></h3>
<ol>
<li class="">MCP_CONTEXT_CLEARED</li>
<li class="">MCP_PLAN_LLM_INPUT</li>
<li class="">MCP_PLAN_LLM_OUTPUT</li>
<li class="">MCP_TOOL_CALL</li>
<li class="">MCP_TOOL_RESULT</li>
<li class="">Repeat until MCP_FINAL_ANSWER</li>
</ol>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="7Ô∏è‚É£-mcp-database-tools">7Ô∏è‚É£ MCP database tools<a href="#7Ô∏è‚É£-mcp-database-tools" class="hash-link" aria-label="Direct link to 7Ô∏è‚É£ MCP database tools" title="Direct link to 7Ô∏è‚É£ MCP database tools" translate="no">‚Äã</a></h2>
<div class="ce-db-table"><h4>üóÑÔ∏è <!-- -->ce_mcp_tool</h4><p><em>Tool registry</em></p><ul><li>tool_code</li><li>tool_group</li><li>enabled</li></ul></div>
<div class="ce-db-table"><h4>üóÑÔ∏è <!-- -->ce_mcp_db_tool</h4><p><em>SQL-backed tools</em></p><ul><li>tool_id (FK)</li><li>sql_template</li><li>param_schema</li><li>safe_mode</li><li>max_rows</li></ul></div>
<p>Example SQL template:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">select</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">status</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> move_request</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">where</span><span class="token plain"> connection_id </span><span class="token operator">=</span><span class="token plain"> :connection_id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="8Ô∏è‚É£-mcp-writes-final-answer-to-context">8Ô∏è‚É£ MCP writes final answer to context<a href="#8Ô∏è‚É£-mcp-writes-final-answer-to-context" class="hash-link" aria-label="Direct link to 8Ô∏è‚É£ MCP writes final answer to context" title="Direct link to 8Ô∏è‚É£ MCP writes final answer to context" translate="no">‚Äã</a></h2>
<div><div class="ce-schema-header">üìê <!-- -->context_json.mcp</div><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token property">&quot;mcp&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;observations&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">&quot;tool&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;postgres.move_status&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">&quot;rowsJson&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;[{ status: &#x27;MOVED&#x27; }]&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;finalAnswer&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;answer&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;The status of your move is MOVED.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="9Ô∏è‚É£-rulesstep---optional-short-circuit">9Ô∏è‚É£ RulesStep - optional short-circuit<a href="#9Ô∏è‚É£-rulesstep---optional-short-circuit" class="hash-link" aria-label="Direct link to 9Ô∏è‚É£ RulesStep - optional short-circuit" title="Direct link to 9Ô∏è‚É£ RulesStep - optional short-circuit" translate="no">‚Äã</a></h2>
<p>Rules can:</p>
<ul>
<li class="">SET_STATE</li>
<li class="">SET_INTENT</li>
<li class="">SHORT_CIRCUIT</li>
</ul>
<p>Typical MOVE rule:</p>
<ul>
<li class="">rule_type = JSON_PATH</li>
<li class="">match_pattern = <code>$.mcp.finalAnswer</code></li>
<li class="">action = SHORT_CIRCUIT</li>
</ul>
<div class="ce-highlight ce-info"><div><div>Customer-specific behavior without code changes</div><br><div>Configurable state machine</div><br><div>Deterministic overrides</div></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="-responseresolutionstep">üîü ResponseResolutionStep<a href="#-responseresolutionstep" class="hash-link" aria-label="Direct link to üîü ResponseResolutionStep" title="Direct link to üîü ResponseResolutionStep" translate="no">‚Äã</a></h2>
<p>Uses <code>ce_response</code>:</p>
<div class="ce-db-table"><h4>üóÑÔ∏è <!-- -->ce_response</h4><p><em>Final output configuration</em></p><ul><li>state_code</li><li>intent_code</li><li>response_type (EXACT / DERIVED)</li><li>output_format (TEXT / JSON)</li></ul></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="two-valid-patterns">Two valid patterns<a href="#two-valid-patterns" class="hash-link" aria-label="Direct link to Two valid patterns" title="Direct link to Two valid patterns" translate="no">‚Äã</a></h3>
<div class="ce-decision ce-success"><strong>üõë<!-- --> <!-- -->SUCCESS</strong><div><ul><li>Rules SHORT_CIRCUIT</li><li>No LLM call</li><li>Fast &amp; safe</li></ul></div></div>
<div class="ce-decision ce-info"><strong>üõë<!-- --> <!-- -->INFO</strong><div><ul><li>derivation_hint checks mcp.finalAnswer</li><li>LLM formats response</li></ul></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="-debugging-stale-move-id-bug">üêû Debugging: stale move ID bug<a href="#-debugging-stale-move-id-bug" class="hash-link" aria-label="Direct link to üêû Debugging: stale move ID bug" title="Direct link to üêû Debugging: stale move ID bug" translate="no">‚Äã</a></h2>
<p>If you see:</p>
<blockquote>
<p>Second request returns previous move result</p>
</blockquote>
<p>The cause is almost always one of:</p>
<div class="ce-decision ce-danger"><strong>üõë<!-- --> <!-- -->DANGER</strong><div><ul><li>MCP context not cleared early enough</li><li>derivation_hint blindly reusing mcp.finalAnswer</li><li>Tool param extraction failed and reused old params</li></ul></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="-final-takeaway">‚úÖ Final takeaway<a href="#-final-takeaway" class="hash-link" aria-label="Direct link to ‚úÖ Final takeaway" title="Direct link to ‚úÖ Final takeaway" translate="no">‚Äã</a></h2>
<p>ConvEngine MOVE flow is:</p>
<ul>
<li class="">Deterministic</li>
<li class="">Auditable</li>
<li class="">DB-driven</li>
<li class="">MCP-powered</li>
<li class="">Safe when configured correctly</li>
</ul>
<p>If you understand this file,
you understand the MOVE engine end-to-end.</p>
<pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><code class="codeBlockLines_e6Vv"></code></pre></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/architecture.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--next" href="/convengine-docs/docs/mcp"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">MCP</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#end-to-end-flow-the-big-picture" class="table-of-contents__link toc-highlight">End-to-end flow (the big picture)</a></li><li><a href="#1-request-entry-point---controller" class="table-of-contents__link toc-highlight">1) Request entry point - controller</a></li><li><a href="#2-conversationalengine---session--pipeline" class="table-of-contents__link toc-highlight">2) ConversationalEngine - session + pipeline</a></li><li><a href="#3-enginepipeline---the-core-loop-stepresult" class="table-of-contents__link toc-highlight">3) EnginePipeline - the core loop (StepResult)</a></li><li><a href="#4-pipeline-composition---how-steps-are-discovered-and-ordered" class="table-of-contents__link toc-highlight">4) Pipeline composition - how steps are discovered and ordered</a></li><li><a href="#5-database-brain---all-configuration-tables-dont-skip-any" class="table-of-contents__link toc-highlight">5) Database ‚Äúbrain‚Äù - all configuration tables (don&#39;t skip any)</a></li><li><a href="#6-step-by-step-pipeline-walk-through-actual-steps" class="table-of-contents__link toc-highlight">6) Step-by-step pipeline walk-through (actual steps)</a><ul><li><a href="#step-1---persistconversationbootstrapstep" class="table-of-contents__link toc-highlight">Step 1 - PersistConversationBootstrapStep</a></li><li><a href="#step-2---loadorcreateconversationstep" class="table-of-contents__link toc-highlight">Step 2 - LoadOrCreateConversationStep</a></li><li><a href="#step-3---intentresolutionstep" class="table-of-contents__link toc-highlight">Step 3 - IntentResolutionStep</a></li><li><a href="#step-4---validation--schema--extraction-steps" class="table-of-contents__link toc-highlight">Step 4 - (Validation / schema / extraction steps)</a></li><li><a href="#step-5---mcptoolstep-mcp-loop" class="table-of-contents__link toc-highlight">Step 5 - McpToolStep (MCP loop)</a></li><li><a href="#step-6---rulesstep-db-driven-state-machine--shortcuts" class="table-of-contents__link toc-highlight">Step 6 - RulesStep (DB-driven state machine + shortcuts)</a></li><li><a href="#step-7---responseresolutionstep-ce_response-driven" class="table-of-contents__link toc-highlight">Step 7 - ResponseResolutionStep (ce_response driven)</a></li><li><a href="#step-8---persistconversationstep--pipelineendguardstep" class="table-of-contents__link toc-highlight">Step 8 - PersistConversationStep + PipelineEndGuardStep</a></li></ul></li><li><a href="#7-putting-it-together---example-conversation--behind-the-scenes" class="table-of-contents__link toc-highlight">7) Putting it together - example conversation + ‚Äúbehind the scenes‚Äù</a></li><li><a href="#Ô∏è-example-faq-conversation" class="table-of-contents__link toc-highlight">üó£Ô∏è Example FAQ Conversation</a></li><li><a href="#-high-level-flow-faq" class="table-of-contents__link toc-highlight">üîÑ High-level Flow (FAQ)</a></li><li><a href="#1Ô∏è‚É£-controller-receives-the-request" class="table-of-contents__link toc-highlight">1Ô∏è‚É£ Controller receives the request</a></li><li><a href="#2Ô∏è‚É£-engine-creates-session-and-pipeline" class="table-of-contents__link toc-highlight">2Ô∏è‚É£ Engine creates session and pipeline</a></li><li><a href="#3Ô∏è‚É£-pipeline-executes-steps-in-order" class="table-of-contents__link toc-highlight">3Ô∏è‚É£ Pipeline executes steps in order</a></li><li><a href="#4Ô∏è‚É£-intentresolutionstep--faq" class="table-of-contents__link toc-highlight">4Ô∏è‚É£ IntentResolutionStep ‚Üí FAQ</a></li><li><a href="#5Ô∏è‚É£-mcp-is-skipped-important" class="table-of-contents__link toc-highlight">5Ô∏è‚É£ MCP is SKIPPED (IMPORTANT)</a></li><li><a href="#6Ô∏è‚É£-rulesstep-usually-no-op-for-faq" class="table-of-contents__link toc-highlight">6Ô∏è‚É£ RulesStep (usually no-op for FAQ)</a></li><li><a href="#7Ô∏è‚É£-responseresolutionstep" class="table-of-contents__link toc-highlight">7Ô∏è‚É£ ResponseResolutionStep</a><ul><li><a href="#pattern-a---exact-no-llm" class="table-of-contents__link toc-highlight">Pattern A - EXACT (no LLM)</a></li><li><a href="#pattern-b---derived-llm-formatting" class="table-of-contents__link toc-highlight">Pattern B - DERIVED (LLM formatting)</a></li></ul></li><li><a href="#-what-youll-see-in-ce_audit-for-faq" class="table-of-contents__link toc-highlight">üîç What you&#39;ll see in ce_audit for FAQ</a></li><li><a href="#-final-takeaways-faq" class="table-of-contents__link toc-highlight">‚úÖ Final Takeaways (FAQ)</a></li><li><a href="#Ô∏è-example-conversation" class="table-of-contents__link toc-highlight">üó£Ô∏è Example Conversation</a></li><li><a href="#-high-level-flow-one-turn" class="table-of-contents__link toc-highlight">üîÅ High-level Flow (One Turn)</a></li><li><a href="#1Ô∏è‚É£-request-enters-via-rest-controller" class="table-of-contents__link toc-highlight">1Ô∏è‚É£ Request enters via REST controller</a></li><li><a href="#2Ô∏è‚É£-enginesession--pipeline-orchestration" class="table-of-contents__link toc-highlight">2Ô∏è‚É£ EngineSession + Pipeline orchestration</a></li><li><a href="#3Ô∏è‚É£-pipeline-execution-model" class="table-of-contents__link toc-highlight">3Ô∏è‚É£ Pipeline execution model</a></li><li><a href="#4Ô∏è‚É£-core-pipeline-steps-order-matters" class="table-of-contents__link toc-highlight">4Ô∏è‚É£ Core pipeline steps (order matters)</a></li><li><a href="#5Ô∏è‚É£-intent-resolution-for-move_connections" class="table-of-contents__link toc-highlight">5Ô∏è‚É£ Intent resolution for MOVE_CONNECTIONS</a><ul><li><a href="#tables-involved" class="table-of-contents__link toc-highlight">Tables involved</a></li></ul></li><li><a href="#6Ô∏è‚É£-mcp-tool-step-move_connections-only" class="table-of-contents__link toc-highlight">6Ô∏è‚É£ MCP Tool Step (MOVE_CONNECTIONS only)</a><ul><li><a href="#mcp-execution-loop" class="table-of-contents__link toc-highlight">MCP execution loop</a></li></ul></li><li><a href="#7Ô∏è‚É£-mcp-database-tools" class="table-of-contents__link toc-highlight">7Ô∏è‚É£ MCP database tools</a></li><li><a href="#8Ô∏è‚É£-mcp-writes-final-answer-to-context" class="table-of-contents__link toc-highlight">8Ô∏è‚É£ MCP writes final answer to context</a></li><li><a href="#9Ô∏è‚É£-rulesstep---optional-short-circuit" class="table-of-contents__link toc-highlight">9Ô∏è‚É£ RulesStep - optional short-circuit</a></li><li><a href="#-responseresolutionstep" class="table-of-contents__link toc-highlight">üîü ResponseResolutionStep</a><ul><li><a href="#two-valid-patterns" class="table-of-contents__link toc-highlight">Two valid patterns</a></li></ul></li><li><a href="#-debugging-stale-move-id-bug" class="table-of-contents__link toc-highlight">üêû Debugging: stale move ID bug</a></li><li><a href="#-final-takeaway" class="table-of-contents__link toc-highlight">‚úÖ Final takeaway</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/convengine-docs/docs/architecture">Tutorial</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2026 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>