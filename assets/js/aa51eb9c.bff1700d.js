"use strict";(globalThis.webpackChunkconvengine_docs=globalThis.webpackChunkconvengine_docs||[]).push([[9182],{1470(e,n,t){t.d(n,{A:()=>L});var s=t(6540),a=t(4164),i=t(7559),l=t(3104),r=t(6347),o=t(205),c=t(7485),d=t(1682),u=t(679);function p(e){return s.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,s.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function h(e){const{values:n,children:t}=e;return(0,s.useMemo)(()=>{const e=n??function(e){return p(e).map(({props:{value:e,label:n,attributes:t,default:s}})=>({value:e,label:n,attributes:t,default:s}))}(t);return function(e){const n=(0,d.XI)(e,(e,n)=>e.value===n.value);if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[n,t])}function m({value:e,tabValues:n}){return n.some(n=>n.value===e)}function x({queryString:e=!1,groupId:n}){const t=(0,r.W6)(),a=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,c.aZ)(a),(0,s.useCallback)(e=>{if(!a)return;const n=new URLSearchParams(t.location.search);n.set(a,e),t.replace({...t.location,search:n.toString()})},[a,t])]}function _(e){const{defaultValue:n,queryString:t=!1,groupId:a}=e,i=h(e),[l,r]=(0,s.useState)(()=>function({defaultValue:e,tabValues:n}){if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!m({value:e,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const t=n.find(e=>e.default)??n[0];if(!t)throw new Error("Unexpected error: 0 tabValues");return t.value}({defaultValue:n,tabValues:i})),[c,d]=x({queryString:t,groupId:a}),[p,_]=function({groupId:e}){const n=function(e){return e?`docusaurus.tab.${e}`:null}(e),[t,a]=(0,u.Dv)(n);return[t,(0,s.useCallback)(e=>{n&&a.set(e)},[n,a])]}({groupId:a}),j=(()=>{const e=c??p;return m({value:e,tabValues:i})?e:null})();(0,o.A)(()=>{j&&r(j)},[j]);return{selectedValue:l,selectValue:(0,s.useCallback)(e=>{if(!m({value:e,tabValues:i}))throw new Error(`Can't select invalid tab value=${e}`);r(e),d(e),_(e)},[d,_,i]),tabValues:i}}var j=t(2303);const f="tabList__CuJ",T="tabItem_LNqP";var b=t(4848);function v({className:e,block:n,selectedValue:t,selectValue:s,tabValues:i}){const r=[],{blockElementScrollPositionUntilNextRender:o}=(0,l.a_)(),c=e=>{const n=e.currentTarget,a=r.indexOf(n),l=i[a].value;l!==t&&(o(n),s(l))},d=e=>{let n=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const t=r.indexOf(e.currentTarget)+1;n=r[t]??r[0];break}case"ArrowLeft":{const t=r.indexOf(e.currentTarget)-1;n=r[t]??r[r.length-1];break}}n?.focus()};return(0,b.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,a.A)("tabs",{"tabs--block":n},e),children:i.map(({value:e,label:n,attributes:s})=>(0,b.jsx)("li",{role:"tab",tabIndex:t===e?0:-1,"aria-selected":t===e,ref:e=>{r.push(e)},onKeyDown:d,onClick:c,...s,className:(0,a.A)("tabs__item",T,s?.className,{"tabs__item--active":t===e}),children:n??e},e))})}function g({lazy:e,children:n,selectedValue:t}){const i=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){const e=i.find(e=>e.props.value===t);return e?(0,s.cloneElement)(e,{className:(0,a.A)("margin-top--md",e.props.className)}):null}return(0,b.jsx)("div",{className:"margin-top--md",children:i.map((e,n)=>(0,s.cloneElement)(e,{key:n,hidden:e.props.value!==t}))})}function P(e){const n=_(e);return(0,b.jsxs)("div",{className:(0,a.A)(i.G.tabs.container,"tabs-container",f),children:[(0,b.jsx)(v,{...n,...e}),(0,b.jsx)(g,{...n,...e})]})}function L(e){const n=(0,j.A)();return(0,b.jsx)(P,{...e,children:p(e.children)},String(n))}},8176(e,n,t){t.r(n),t.d(n,{assets:()=>u,contentTitle:()=>d,default:()=>j,frontMatter:()=>c,loanExampleDetails:()=>m,loanExampleEdges:()=>h,loanExampleNodes:()=>p,metadata:()=>s,toc:()=>x});const s=JSON.parse('{"id":"consumer/mcp/example2","title":"MCP Example 2 - Loan Application","description":"This example demonstrates a real-world conditional MCP chain:","source":"@site/docs/v2/consumer/mcp/example2.mdx","sourceDirName":"consumer/mcp","slug":"/consumer/mcp/example2","permalink":"/docs/v2/consumer/mcp/example2","draft":false,"unlisted":false,"editUrl":"https://github.com/salilvnair/convengine-docs/tree/main/docs/v2/consumer/mcp/example2.mdx","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"title":"MCP Example 2 - Loan Application","sidebar_position":4},"sidebar":"docSidebar","previous":{"title":"MCP Example 1 (Mockey + Demo)","permalink":"/docs/v2/consumer/mcp/example1"},"next":{"title":"REST API","permalink":"/docs/v2/api/rest-api"}}');var a=t(4848),i=t(8453),l=t(1470),r=t(9365),o=t(7555);const c={title:"MCP Example 2 - Loan Application",sidebar_position:4},d="MCP Example 2 - Loan Application (Conditional API Chain)",u={},p=[{id:"u1",data:{label:"User Input: apply loan"}},{id:"s1",data:{label:"SchemaExtractionStep"}},{id:"r1",data:{label:"Rule: UNKNOWN/IDLE -> ELIGIBILITY_GATE"}},{id:"m1",data:{label:"MCP plan #1"}},{id:"t1",data:{label:"loan.credit.rating.check"}},{id:"m2",data:{label:"MCP plan #2"}},{id:"t2",data:{label:"loan.credit.fraud.check"}},{id:"m3",data:{label:"MCP plan #3"}},{id:"t3",data:{label:"loan.debt.credit.summary"}},{id:"m4",data:{label:"MCP plan #4"}},{id:"t4",data:{label:"loan.application.submit"}},{id:"m5",data:{label:"MCP ANSWER"}},{id:"r2",data:{label:"Rule: ELIGIBILITY_GATE -> COMPLETED (POST_AGENT_MCP)"}},{id:"resp",data:{label:"ResponseResolutionStep (DERIVED TEXT)"}},{id:"out",data:{label:"Assistant Output"}}],h=[{id:"e1",source:"u1",target:"s1"},{id:"e2",source:"s1",target:"r1"},{id:"e3",source:"r1",target:"m1"},{id:"e4",source:"m1",target:"t1"},{id:"e5",source:"t1",target:"m2"},{id:"e6",source:"m2",target:"t2"},{id:"e7",source:"t2",target:"m3"},{id:"e8",source:"m3",target:"t3"},{id:"e9",source:"t3",target:"m4"},{id:"e10",source:"m4",target:"t4"},{id:"e11",source:"t4",target:"m5"},{id:"e12",source:"m5",target:"r2"},{id:"e13",source:"r2",target:"resp"},{id:"e14",source:"resp",target:"out"}],m={u1:{title:"User Input",stage:"REQUEST",summary:"User asks to apply for loan with customer and amount details.",session:["userText set","inputParams initialized"],tables:["ce_audit (W)"]},s1:{title:"SchemaExtractionStep",stage:"SCHEMA",summary:"Extracts customerId, requestedAmount, tenureMonths from user text.",session:["context updated with extracted schema fields"],tables:["ce_output_schema (R)","ce_prompt_template (R)","ce_audit (W)"]},r1:{title:"Rule transition",stage:"POST_AGENT_INTENT",summary:"Rule moves LOAN_APPLICATION from UNKNOWN or IDLE into ELIGIBILITY_GATE.",session:["state=ELIGIBILITY_GATE -> COMPLETED"],tables:["ce_rule (R)","ce_audit (W)"]},r2:{title:"Post-MCP transition",stage:"POST_AGENT_MCP",summary:"After planner ANSWER, POST_AGENT_MCP rule checks context.mcp.finalAnswer and moves state from ELIGIBILITY_GATE to COMPLETED.",session:["state=COMPLETED"],tables:["ce_rule (R)","ce_audit (W)"]},m1:{title:"MCP plan #1",stage:"MCP_PLAN_LLM_OUTPUT",summary:"Planner decides first check must be credit rating.",session:["CALL_TOOL loan.credit.rating.check"],tables:["ce_mcp_tool (R)","ce_mcp_planner (R)","ce_audit (W)"]},t1:{title:"loan.credit.rating.check",stage:"MCP_TOOL_RESULT",summary:"Mapped rating response appended to context.mcp.observations.",session:["observation[0]=rating"],tables:["ce_audit (W)"]},m2:{title:"MCP plan #2",stage:"MCP_PLAN_LLM_OUTPUT",summary:"If rating > 750 planner proceeds to fraud check.",session:["CALL_TOOL loan.credit.fraud.check"],tables:["ce_mcp_planner (R)","ce_audit (W)"]},t2:{title:"loan.credit.fraud.check",stage:"MCP_TOOL_RESULT",summary:"Fraud result stored as second observation.",session:["observation[1]=fraud"],tables:["ce_audit (W)"]},m3:{title:"MCP plan #3",stage:"MCP_PLAN_LLM_OUTPUT",summary:"If fraud false planner asks debt/credit summary.",session:["CALL_TOOL loan.debt.credit.summary"],tables:["ce_mcp_planner (R)","ce_audit (W)"]},t3:{title:"loan.debt.credit.summary",stage:"MCP_TOOL_RESULT",summary:"Debt metrics (dti, availableCredit) added to observations.",session:["observation[2]=debt"],tables:["ce_audit (W)"]},m4:{title:"MCP plan #4",stage:"MCP_PLAN_LLM_OUTPUT",summary:"If affordability passes, planner triggers submit API.",session:["CALL_TOOL loan.application.submit"],tables:["ce_mcp_planner (R)","ce_audit (W)"]},t4:{title:"loan.application.submit",stage:"MCP_TOOL_RESULT",summary:"Submission response includes applicationId and status.",session:["observation[3]=submit result"],tables:["ce_audit (W)"]},m5:{title:"MCP ANSWER",stage:"MCP_FINAL_ANSWER",summary:"Planner synthesizes final decision and stores context.mcp.finalAnswer.",session:["mcp_final_answer set","mcp_status=ANSWER"],tables:["ce_audit (W)"]},resp:{title:"ResponseResolutionStep",stage:"RESOLVE_RESPONSE",summary:"Selects LOAN_APPLICATION+COMPLETED DERIVED response and renders final text from MCP-enriched context.",session:["payload generated via TextOutputFormatResolver"],tables:["ce_response (R)","ce_prompt_template (R)","ce_audit (W)"]},out:{title:"Assistant Output",stage:"ASSISTANT_OUTPUT",summary:"Final decision text returned and persisted.",session:["final payload returned"],tables:["ce_conversation (W)","ce_conversation_history (W async)","ce_audit (W)"]}},x=[{value:"Repos and files used",id:"repos-and-files-used",level:2},{value:"Mock APIs (mockey)",id:"mock-apis-mockey",level:2},{value:"Demo MCP handlers (<code>convengine-demo</code>)",id:"demo-mcp-handlers-convengine-demo",level:2},{value:"Seed packs",id:"seed-packs",level:2},{value:"Required rule/response rows for this flow",id:"required-ruleresponse-rows-for-this-flow",level:2},{value:"Step-by-step test",id:"step-by-step-test",level:2},{value:"1) Start mockey",id:"1-start-mockey",level:2},{value:"2) Optional quick mock checks",id:"2-optional-quick-mock-checks",level:2},{value:"3) Start convengine-demo",id:"3-start-convengine-demo",level:2},{value:"4) Seed Example 2 DML",id:"4-seed-example-2-dml",level:2},{value:"5) Run as chat-style walkthrough",id:"5-run-as-chat-style-walkthrough",level:2},{value:"6) Verify audit stages",id:"6-verify-audit-stages",level:2},{value:"7) Verify advanced HTTP execution metadata",id:"7-verify-advanced-http-execution-metadata",level:2},{value:"How MCP Tool Output Is Used in Response Resolution (Step-by-Step)",id:"how-mcp-tool-output-is-used-in-response-resolution-step-by-step",level:2},{value:"E2E Turn-by-Turn (Tab View)",id:"e2e-turn-by-turn-tab-view",level:2},{value:"ReactFlow Execution Map",id:"reactflow-execution-map",level:2},{value:"Response Field Provenance",id:"response-field-provenance",level:2},{value:"Notes on state and scope",id:"notes-on-state-and-scope",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Related docs",id:"related-docs",level:2}];function _(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"mcp-example-2---loan-application-conditional-api-chain",children:"MCP Example 2 - Loan Application (Conditional API Chain)"})}),"\n",(0,a.jsx)(n.p,{children:"This example demonstrates a real-world conditional MCP chain:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"call Credit Union Rating API"}),"\n",(0,a.jsxs)(n.li,{children:["if ",(0,a.jsx)(n.code,{children:"creditRating > 750"}),", call Credit Card Fraud API"]}),"\n",(0,a.jsx)(n.li,{children:"if not flagged, call Debt/Credit Summary API"}),"\n",(0,a.jsx)(n.li,{children:"if debt profile is acceptable, call Loan Submit API"}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["All APIs are mocked through ",(0,a.jsx)(n.a,{href:"https://github.com/salilvnair/mockey",children:"mockey"})," with response delays to simulate real external systems."]}),"\n",(0,a.jsx)(n.h2,{id:"repos-and-files-used",children:"Repos and files used"}),"\n",(0,a.jsxs)(n.h2,{id:"mock-apis-mockey",children:["Mock APIs (",(0,a.jsx)(n.a,{href:"https://github.com/salilvnair/mockey",children:"mockey"}),")"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"GET /api/mock/loan/credit-union/rating"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"GET /api/mock/loan/credit-card/fraud-check"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"GET /api/mock/loan/debt-credit/summary"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"POST /api/mock/loan/application/submit"})}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Key files:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"mockey/src/resolver/provider/live-api.resolver.js"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"mockey/src/resolver/core/resolver.registry.js"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"mockey/src/route/mockey-route.json"})}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"mockey/src/response/loan/*.json"})," (includes delay via ",(0,a.jsx)(n.code,{children:"responseDelayInMillis"}),")"]}),"\n"]}),"\n",(0,a.jsxs)(n.h2,{id:"demo-mcp-handlers-convengine-demo",children:["Demo MCP handlers (",(0,a.jsx)(n.code,{children:"convengine-demo"}),")"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"loan.credit.rating.check"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"loan.credit.fraud.check"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"loan.debt.credit.summary"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"loan.application.submit"})}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Handler files:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"convengine-demo/.../LoanCreditRatingToolHandler.java"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"convengine-demo/.../LoanFraudCheckToolHandler.java"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"convengine-demo/.../LoanDebtSummaryToolHandler.java"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"convengine-demo/.../LoanApplicationSubmitToolHandler.java"})}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"seed-packs",children:"Seed packs"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Postgres: ",(0,a.jsx)(n.code,{children:"convengine-demo/src/main/resources/sql/example2_seed.sql"})]}),"\n",(0,a.jsxs)(n.li,{children:["SQLite: ",(0,a.jsx)(n.code,{children:"convengine-demo/src/main/resources/sql/example2_sqlite_seed.sql"})]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"These seed files include all required DML:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"ce_intent"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"ce_intent_classifier"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"ce_output_schema"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"ce_prompt_template"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"ce_response"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"ce_rule"})}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"ce_mcp_tool"})," (with ",(0,a.jsx)(n.code,{children:"intent_code"})," + ",(0,a.jsx)(n.code,{children:"state_code"}),")"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"ce_mcp_planner"})," scoped prompt rows (default + LOAN_APPLICATION/ELIGIBILITY_GATE)"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"required-ruleresponse-rows-for-this-flow",children:"Required rule/response rows for this flow"}),"\n",(0,a.jsx)(n.p,{children:"Use these key rows so classifier + MCP + response resolution line up correctly:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"-- 1) Bootstrap state after classifier picks LOAN_APPLICATION\nINSERT INTO ce_rule (intent_code, state_code, rule_type, match_pattern, action, action_value, phase, priority, enabled, description)\nVALUES\n('LOAN_APPLICATION', 'UNKNOWN', 'REGEX', '.*', 'SET_STATE', 'ELIGIBILITY_GATE', 'POST_AGENT_INTENT', 20, true,\n 'Move LOAN_APPLICATION from UNKNOWN into ELIGIBILITY_GATE.');\n\n-- 2) After MCP planner returns ANSWER, close state for final response mapping\nINSERT INTO ce_rule (intent_code, state_code, rule_type, match_pattern, action, action_value, phase, priority, enabled, description)\nVALUES\n('LOAN_APPLICATION', 'ELIGIBILITY_GATE', 'JSON_PATH', '$[?(@.context.mcp.finalAnswer != null && @.context.mcp.finalAnswer != '''')]', 'SET_STATE', 'COMPLETED', 'POST_AGENT_MCP', 30, true,\n 'Move loan flow to COMPLETED only when context.mcp.finalAnswer exists.');\n\n-- 3) Final response row should target COMPLETED and derive from MCP context\nINSERT INTO ce_response (intent_code, state_code, output_format, response_type, derivation_hint, priority, enabled, description)\nVALUES\n('LOAN_APPLICATION', 'COMPLETED', 'TEXT', 'DERIVED',\n 'Use context.mcp.finalAnswer as primary summary. Validate with context.mcp.observations (rating/fraud/debt/submit). Do not invent values.',\n 20, true, 'Loan decision derived from MCP outputs.');\n\n-- 4) Prompt template should explicitly read context.mcp.*\nINSERT INTO ce_prompt_template (intent_code, state_code, response_type, system_prompt, user_prompt, enabled)\nVALUES\n('LOAN_APPLICATION', 'COMPLETED', 'TEXT',\n 'You are a precise loan workflow summarizer. Use only MCP evidence from context JSON.',\n 'Context JSON:\\n{{context}}\\n\\nRead context.mcp.observations and context.mcp.finalAnswer. Return a concise final loan decision.',\n true);\n"})}),"\n",(0,a.jsx)(n.h2,{id:"step-by-step-test",children:"Step-by-step test"}),"\n",(0,a.jsxs)(n.h2,{id:"1-start-mockey",children:["1) Start ",(0,a.jsx)(n.a,{href:"https://github.com/salilvnair/mockey",children:"mockey"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"cd /Users/salilvnair/workspace/git/salilvnair/mockey\nnpm install\nnpm start\n"})}),"\n",(0,a.jsx)(n.p,{children:"Expected:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-text",children:"listening to 31333\n"})}),"\n",(0,a.jsx)(n.h2,{id:"2-optional-quick-mock-checks",children:"2) Optional quick mock checks"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'curl -s "http://localhost:31333/api/mock/loan/credit-union/rating?customerId=CUST-1001"\ncurl -s "http://localhost:31333/api/mock/loan/credit-card/fraud-check?customerId=CUST-1001"\ncurl -s "http://localhost:31333/api/mock/loan/debt-credit/summary?customerId=CUST-1001"\ncurl -s -X POST "http://localhost:31333/api/mock/loan/application/submit" -H "Content-Type: application/json" -d \'{"customerId":"CUST-1001","requestedAmount":350000,"tenureMonths":36}\'\n'})}),"\n",(0,a.jsx)(n.h2,{id:"3-start-convengine-demo",children:"3) Start convengine-demo"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"cd /Users/salilvnair/workspace/git/salilvnair/convengine-demo\n./mvnw spring-boot:run\n"})}),"\n",(0,a.jsx)(n.h2,{id:"4-seed-example-2-dml",children:"4) Seed Example 2 DML"}),"\n",(0,a.jsx)(n.p,{children:"For Postgres run:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"convengine-demo/src/main/resources/sql/example2_seed.sql"})}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"For SQLite run:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"convengine-demo/src/main/resources/sql/example2_sqlite_seed.sql"})}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"5-run-as-chat-style-walkthrough",children:"5) Run as chat-style walkthrough"}),"\n",(0,a.jsxs)(l.A,{groupId:"example2-chat-flow",children:[(0,a.jsx)(r.A,{value:"chat",label:"Conversation",default:!0,children:(0,a.jsxs)(o.cW,{children:[(0,a.jsx)(o._b,{role:"user",name:"Turn 1 - User",message:"Apply loan for customer CUST-1001, amount 350000 for 36 months.",info:["SchemaExtractionStep pulls customerId, amount, tenure.","Rule moves state to ELIGIBILITY_GATE."]}),(0,a.jsx)(o._b,{role:"assistant",name:"Turn 1 - Assistant (internal MCP)",message:"Running eligibility chain: rating -> fraud -> debt summary -> submit.",json:{mcp:{observations:[{toolCode:"loan.credit.rating.check",json:'{"mapped":{"customerId":"CUST-1001","creditRating":782}}'},{toolCode:"loan.credit.fraud.check",json:'{"mapped":{"customerId":"CUST-1001","flagged":false}}'},{toolCode:"loan.debt.credit.summary",json:'{"mapped":{"dti":0.31,"availableCredit":220000}}'},{toolCode:"loan.application.submit",json:'{"mapped":{"applicationId":"LA-90311","status":"SUBMITTED"}}'}]}},tables:["ce_mcp_tool (R)","ce_mcp_planner (R)","ce_audit (W)"],info:["Planner decides each next tool from previous observation.","Observations are persisted in context.mcp.observations."]}),(0,a.jsx)(o._b,{role:"assistant",name:"Turn 1 - Final Assistant Output",message:"Loan application submitted successfully. Application ID: LA-90311. Credit and fraud checks passed; debt profile is within threshold.",json:{mcp:{finalAnswer:"Approved and submitted with applicationId LA-90311."}},tables:["ce_response (R)","ce_prompt_template (R)","ce_conversation (W)"],info:["Response is DERIVED TEXT for LOAN_APPLICATION + COMPLETED.","TextOutputFormatResolver uses context + derivation_hint."]})]})}),(0,a.jsx)(r.A,{value:"turn-table",label:"Turn Table",children:(0,a.jsx)(o.p,{title:"Loan flow summary",columns:["Phase","What happens","Tables touched","Output"],rows:[["Schema + state","Extract fields and switch to ELIGIBILITY_GATE.","ce_output_schema(R), ce_rule(R), ce_audit(W)","context fields + state"],["Post-MCP transition","POST_AGENT_MCP rule moves state to COMPLETED only when context.mcp.finalAnswer is present.","ce_rule(R), ce_audit(W)","state=COMPLETED"],["MCP tool chain","Rating, fraud, debt, submit executed conditionally.","ce_mcp_tool(R), ce_mcp_planner(R), ce_audit(W)","context.mcp.observations[]"],["MCP final answer","Planner writes final decision text.","ce_audit(W)","context.mcp.finalAnswer"],["Response resolution","DERIVED TEXT generated for user.","ce_response(R), ce_prompt_template(R), ce_audit(W)","assistant payload"]]})}),(0,a.jsxs)(r.A,{value:"api",label:"Request Payloads",children:[(0,a.jsx)(n.p,{children:"Planner mode payload:"}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'{\n  "userInput": "Apply loan for customer CUST-1001, amount 350000 for 36 months",\n  "contextJson": "{}",\n  "inputParams": {}\n}\n'})}),(0,a.jsx)(n.p,{children:"Direct branch payload (low rating):"}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'{\n  "userInput": "Apply loan",\n  "contextJson": "{}",\n  "inputParams": {\n    "tool_request": {\n      "tool_code": "loan.credit.rating.check",\n      "tool_group": "HTTP_API",\n      "args": { "customerId": "CUST-LOW" }\n    }\n  }\n}\n'})}),(0,a.jsx)(n.p,{children:"Direct branch payload (fraud):"}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'{\n  "userInput": "Apply loan",\n  "contextJson": "{}",\n  "inputParams": {\n    "tool_request": {\n      "tool_code": "loan.credit.fraud.check",\n      "tool_group": "HTTP_API",\n      "args": { "customerId": "CUST-FRAUD" }\n    }\n  }\n}\n'})})]})]}),"\n",(0,a.jsx)(n.h2,{id:"6-verify-audit-stages",children:"6) Verify audit stages"}),"\n",(0,a.jsx)(n.p,{children:"Look for:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"MCP_PLAN_LLM_INPUT"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"MCP_PLAN_LLM_OUTPUT"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"MCP_TOOL_CALL"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"MCP_TOOL_RESULT"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"MCP_FINAL_ANSWER"})}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Also for direct tool requests:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"TOOL_ORCHESTRATION_REQUEST"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"TOOL_ORCHESTRATION_RESULT"})}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"7-verify-advanced-http-execution-metadata",children:"7) Verify advanced HTTP execution metadata"}),"\n",(0,a.jsx)(n.p,{children:"Mapped output includes framework execution details:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'{\n  "status": 200,\n  "attempt": 1,\n  "latencyMs": 1205,\n  "mapped": {\n    "customerId": "CUST-1001",\n    "creditRating": 782\n  }\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["The latency reflects mock delays (",(0,a.jsx)(n.code,{children:"responseDelayInMillis"}),") configured in ",(0,a.jsx)(n.a,{href:"https://github.com/salilvnair/mockey",children:"mockey"})," responses."]}),"\n",(0,a.jsx)(n.h2,{id:"how-mcp-tool-output-is-used-in-response-resolution-step-by-step",children:"How MCP Tool Output Is Used in Response Resolution (Step-by-Step)"}),"\n",(0,a.jsx)(n.p,{children:"For this example, the final assistant text is not hardcoded. It is derived from MCP evidence in runtime context:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"McpToolStep"})," starts and clears stale ",(0,a.jsx)(n.code,{children:"context.mcp.finalAnswer"})," and ",(0,a.jsx)(n.code,{children:"context.mcp.observations"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["Every successful tool call appends one entry into ",(0,a.jsx)(n.code,{children:"context.mcp.observations"}),":","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"toolCode"})}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"json"})," (stringified mapped payload)"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["When planner returns ",(0,a.jsx)(n.code,{children:"ANSWER"}),", ",(0,a.jsx)(n.code,{children:"McpToolStep"})," writes:","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"context.mcp.finalAnswer"})}),"\n",(0,a.jsxs)(n.li,{children:["input param ",(0,a.jsx)(n.code,{children:"mcp_final_answer"})]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"RulesStep"})," runs ",(0,a.jsx)(n.code,{children:"POST_AGENT_MCP"})," phase and matches rule only when ",(0,a.jsx)(n.code,{children:"context.mcp.finalAnswer"})," is present, then sets state to ",(0,a.jsx)(n.code,{children:"COMPLETED"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"ResponseResolutionStep"})," selects ",(0,a.jsx)(n.code,{children:"ce_response"})," for:","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"intent_code=LOAN_APPLICATION"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"state_code=COMPLETED"})}),"\n",(0,a.jsxs)(n.li,{children:["response type ",(0,a.jsx)(n.code,{children:"DERIVED"}),", output format ",(0,a.jsx)(n.code,{children:"TEXT"})]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["It then selects matching ",(0,a.jsx)(n.code,{children:"ce_prompt_template"})," (",(0,a.jsx)(n.code,{children:"TEXT"}),") for the same intent/state."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"TextOutputFormatResolver"})," invokes LLM with:","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"rendered system/user prompt"}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"ce_response.derivation_hint"})}),"\n",(0,a.jsxs)(n.li,{children:["context payload (",(0,a.jsx)(n.code,{children:"session.contextDict()"}),"), which includes MCP observations/finalAnswer"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["LLM produces final summary text. Engine audits ",(0,a.jsx)(n.code,{children:"RESOLVE_RESPONSE_LLM_OUTPUT"})," and ",(0,a.jsx)(n.code,{children:"ASSISTANT_OUTPUT"}),", then persists conversation."]}),"\n"]}),"\n",(0,a.jsx)(o.f4,{type:"info",title:"Practical implication",children:(0,a.jsxs)(n.p,{children:["In this setup, the response LLM is grounded by two things together: ",(0,a.jsx)(n.code,{children:"derivation_hint"})," policy from ",(0,a.jsx)(n.code,{children:"ce_response"})," and MCP evidence from ",(0,a.jsx)(n.code,{children:"context.mcp.*"}),". That is why the final answer reflects rating/fraud/debt/applicationId consistently."]})}),"\n",(0,a.jsx)(n.p,{children:"The provided Example 2 seed now makes this explicit in SQL as well:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"ce_prompt_template.user_prompt"})," explicitly instructs reading ",(0,a.jsx)(n.code,{children:"context.mcp.observations"})," and ",(0,a.jsx)(n.code,{children:"context.mcp.finalAnswer"})]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"ce_response.derivation_hint"})," explicitly references ",(0,a.jsx)(n.code,{children:"context.mcp.*"})]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"e2e-turn-by-turn-tab-view",children:"E2E Turn-by-Turn (Tab View)"}),"\n",(0,a.jsxs)(l.A,{groupId:"loan-example-e2e",children:[(0,a.jsx)(r.A,{value:"approved",label:"Approved Path",default:!0,children:(0,a.jsx)(o.p,{title:"Single request turn (approved branch)",columns:["Loop/Step","LLM deduction","Tables touched","Produced state/data"],rows:[["Schema extraction","customerId/requestedAmount/tenure extracted.","ce_output_schema(R), ce_prompt_template(R), ce_audit(W)","context fields set"],["State rule","loan flow evaluates in ELIGIBILITY_GATE (pre-MCP), then POST_AGENT_MCP moves to COMPLETED only when finalAnswer exists.","ce_rule(R), ce_audit(W)","state=ELIGIBILITY_GATE"],["MCP #1","Need credit rating first.","ce_mcp_tool(R), ce_mcp_planner(R), ce_audit(W)","CALL_TOOL rating"],["Tool #1","Rating available and > 750.","ce_audit(W)","obs[0]=creditRating"],["MCP #2","Proceed to fraud check.","ce_mcp_planner(R), ce_audit(W)","CALL_TOOL fraud"],["Tool #2","Fraud clear.","ce_audit(W)","obs[1]=flagged:false"],["MCP #3","Need affordability metrics.","ce_mcp_planner(R), ce_audit(W)","CALL_TOOL debt summary"],["Tool #3","DTI acceptable and credit sufficient.","ce_audit(W)","obs[2]=dti/availableCredit"],["MCP #4","Submit application now.","ce_mcp_planner(R), ce_audit(W)","CALL_TOOL submit"],["Tool #4","Submission succeeded.","ce_audit(W)","obs[3]=applicationId/status"],["MCP ANSWER","Enough evidence for final decision.","ce_audit(W)","context.mcp.finalAnswer"],["ResponseResolutionStep","Generate final user-facing summary.","ce_response(R), ce_prompt_template(R), ce_audit(W)","assistant text payload"]]})}),(0,a.jsx)(r.A,{value:"low-rating",label:"Low Rating",children:(0,a.jsx)(o.p,{title:"Early-stop branch: low credit score",columns:["Loop/Step","LLM deduction","Tables touched","Produced state/data"],rows:[["MCP #1","Call rating check.","ce_mcp_tool(R), ce_mcp_planner(R), ce_audit(W)","CALL_TOOL rating"],["Tool #1","creditRating <= 750.","ce_audit(W)","obs[0]=low rating"],["MCP ANSWER","Stop chain; reject without fraud/debt/submit.","ce_mcp_planner(R), ce_audit(W)","context.mcp.finalAnswer (rejection)"],["ResponseResolutionStep","Render low-score rejection summary.","ce_response(R), ce_prompt_template(R), ce_audit(W)","assistant text payload"]]})}),(0,a.jsx)(r.A,{value:"fraud",label:"Fraud Flagged",children:(0,a.jsx)(o.p,{title:"Branch: fraud hit after good rating",columns:["Loop/Step","LLM deduction","Tables touched","Produced state/data"],rows:[["MCP #1 + Tool #1","Rating is high enough to continue.","ce_mcp_tool(R), ce_mcp_planner(R), ce_audit(W)","obs[0]=rating"],["MCP #2 + Tool #2","Fraud flagged=true.","ce_mcp_planner(R), ce_audit(W)","obs[1]=fraud flagged"],["MCP ANSWER","Stop chain immediately; reject.","ce_mcp_planner(R), ce_audit(W)","context.mcp.finalAnswer (fraud rejection)"],["ResponseResolutionStep","Produce fraud-specific final text.","ce_response(R), ce_prompt_template(R), ce_audit(W)","assistant text payload"]]})}),(0,a.jsx)(r.A,{value:"high-debt",label:"High Debt",children:(0,a.jsx)(o.p,{title:"Branch: affordability fails after fraud clears",columns:["Loop/Step","LLM deduction","Tables touched","Produced state/data"],rows:[["MCP #1 + Tool #1","Rating allows continuation.","ce_mcp_tool(R), ce_mcp_planner(R), ce_audit(W)","obs[0]=rating"],["MCP #2 + Tool #2","Fraud clear.","ce_mcp_planner(R), ce_audit(W)","obs[1]=fraud false"],["MCP #3 + Tool #3","DTI too high or available credit too low.","ce_mcp_planner(R), ce_audit(W)","obs[2]=poor affordability"],["MCP ANSWER","Reject or mark manual review; skip submit.","ce_mcp_planner(R), ce_audit(W)","context.mcp.finalAnswer"],["ResponseResolutionStep","Generate debt/affordability explanation.","ce_response(R), ce_prompt_template(R), ce_audit(W)","assistant text payload"]]})})]}),"\n",(0,a.jsx)(n.h2,{id:"reactflow-execution-map",children:"ReactFlow Execution Map"}),"\n",(0,a.jsx)(o.il,{title:"Example 2 End-to-End Execution",subtitle:"Conditional MCP chain from eligibility checks to final response resolution.",nodes:p,edges:h,detailsById:m,defaultSelectedId:"m1"}),"\n",(0,a.jsx)(n.h2,{id:"response-field-provenance",children:"Response Field Provenance"}),"\n",(0,a.jsx)(o.p,{title:"Where final response facts come from",columns:["Response fact","Primary source","Stage where it enters context"],rows:[["creditRating","loan.credit.rating.check mapped payload","MCP_TOOL_RESULT #1"],["fraudFlag","loan.credit.fraud.check mapped payload","MCP_TOOL_RESULT #2"],["dti / availableCredit","loan.debt.credit.summary mapped payload","MCP_TOOL_RESULT #3"],["applicationId / submitStatus","loan.application.submit mapped payload","MCP_TOOL_RESULT #4 (approved path)"],["Final decision sentence","planner answer + response derivation","MCP_FINAL_ANSWER + RESOLVE_RESPONSE_LLM_OUTPUT"]]}),"\n",(0,a.jsx)(n.h2,{id:"notes-on-state-and-scope",children:"Notes on state and scope"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"ce_mcp_tool"})," rows in example2 are scoped as:"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"intent_code = LOAN_APPLICATION"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"state_code = ELIGIBILITY_GATE"})}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"This ensures tools are visible only in the loan decision state."}),"\n",(0,a.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Tool not resolved:","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["verify ",(0,a.jsx)(n.code,{children:"tool_code"})," in DB matches handler ",(0,a.jsx)(n.code,{children:"toolCode()"})," exactly"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["No tool call in planner path:","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["check ",(0,a.jsx)(n.code,{children:"McpPlanner"})," prompt rows in ",(0,a.jsx)(n.code,{children:"ce_mcp_planner"})]}),"\n",(0,a.jsxs)(n.li,{children:["confirm active intent is ",(0,a.jsx)(n.code,{children:"LOAN_APPLICATION"})]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["Timeouts/retries unexpected:","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["inspect handler-specific ",(0,a.jsx)(n.code,{children:"HttpApiExecutionPolicy"})]}),"\n",(0,a.jsxs)(n.li,{children:["inspect mock delay values in ",(0,a.jsx)(n.code,{children:"mockey/src/response/loan/*.json"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"related-docs",children:"Related docs"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/docs/v2/consumer/mcp/basics",children:"MCP Basics"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/docs/v2/consumer/mcp/advanced",children:"MCP Advanced Guide"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/docs/v2/consumer/mcp/example1",children:"MCP Example 1 (Mockey + Demo)"})}),"\n"]})]})}function j(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(_,{...e})}):_(e)}},9365(e,n,t){t.d(n,{A:()=>l});t(6540);var s=t(4164);const a="tabItem_Ymn6";var i=t(4848);function l({children:e,hidden:n,className:t}){return(0,i.jsx)("div",{role:"tabpanel",className:(0,s.A)(a,t),hidden:n,children:e})}}}]);