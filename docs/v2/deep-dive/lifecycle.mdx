---
title: Request Lifecycle
sidebar_position: 2
hide_table_of_contents: true
---

import { CodeBlockToggle, Highlight, FileRef, PipelineStepList } from "@site/src/components/convengine";

export const v2PipelineSteps = [
  { name: "LoadOrCreateConversationStep", description: "Hydrates existing conversation or creates new conversation shell." },
  { name: "CacheInspectAuditStep", description: "Conditionally audits cache snapshot when cache-inspector enabled." },
  { name: "ResetConversationStep", description: "Applies reset/start-over command handling." },
  { name: "PersistConversationBootstrapStep", description: "Persists conversation bootstrap row before persisted-required steps." },
  { name: "AuditUserInputStep", description: "Writes raw user input audit event." },
  { name: "PolicyEnforcementStep", description: "Applies pre-intent policy checks and safe short-circuit when required." },
  { name: "DialogueActStep", description: "Classifies turn as AFFIRM/NEGATE/EDIT/RESET/QUESTION/NEW_REQUEST." },
  { name: "InteractionPolicyStep", description: "Decides EXECUTE_PENDING_ACTION / REJECT_PENDING_ACTION / FILL_PENDING_SLOT / RECLASSIFY_INTENT." },
  { name: "ActionLifecycleStep", description: "Maintains pending_action_runtime status with TTL semantics." },
  { name: "DisambiguationStep", description: "When multiple actions are eligible, asks targeted clarification and pauses execution." },
  { name: "GuardrailStep", description: "Sanitization + sensitive checks + approval gate hooks." },
  { name: "IntentResolutionStep", description: "Resolves intent unless policy says skip_intent_resolution." },
  { name: "ResetResolvedIntentStep", description: "Applies post-intent reset mapping." },
  { name: "FallbackIntentStateStep", description: "Assigns fallback UNKNOWN flow when intent/state unresolved." },
  { name: "AddContainerDataStep", description: "Merges configured container data into runtime context." },
  { name: "PendingActionStep", description: "Executes or rejects pending action task via CeTaskExecutor." },
  { name: "ToolOrchestrationStep", description: "Unified tool request->execute->result contract by tool_group." },
  { name: "McpToolStep", description: "Planner loop for CALL_TOOL/ANSWER with MCP observations." },
  { name: "SchemaExtractionStep", description: "Parses/extracts structured schema fields." },
  { name: "AutoAdvanceStep", description: "Advances state when schema/task facts satisfy conditions." },
  { name: "RulesStep", description: "Runs phase-scoped rules and actions with cascade passes." },
  { name: "StateGraphStep", description: "Validate-only transition check, no forced state mutation." },
  { name: "ResponseResolutionStep", description: "Resolves EXACT/DERIVED response output." },
  { name: "MemoryStep", description: "Writes session summary and optional recall memory." },
  { name: "PersistConversationStep", description: "Persists conversation/result/audit metadata." },
  { name: "PipelineEndGuardStep", description: "Final guard and timing closure." },
];

# Request Lifecycle

This page is the quick lifecycle view. For the full interactive debug tree, open <FileRef>/docs/v2/deep-dive/request-lifecycle</FileRef>.

## 1. API Entry Point

The journey begins when a client sends a POST request to `/api/v1/conversation/message`.

<CodeBlockToggle
  title="ConversationController.message"
  language="java"
  packagePath="com.github.salilvnair.convengine.api.controller"
  filePath="src/main/java/com/github/salilvnair/convengine/api/controller/ConversationController.java"
>
{`@PostMapping("/message")
public ConversationResponse message(@RequestBody ConversationRequest request) {
  EngineContext engineContext = EngineContext.builder()
      .conversationId(request.getConversationId())
      .userText(request.getMessage())
      .inputParams(request.getInputParams())
      .build();

  EngineResult result = engine.process(engineContext);

  return mapToResponse(result);
}`}
</CodeBlockToggle>

## 2. Engine Processing

<CodeBlockToggle
  title="DefaultConversationalEngine.process"
  language="java"
  packagePath="com.github.salilvnair.convengine.engine.provider"
  filePath="src/main/java/com/github/salilvnair/convengine/engine/provider/DefaultConversationalEngine.java"
>
{`@Override
public EngineResult process(EngineContext engineContext) {
  EngineSession session = sessionFactory.open(engineContext);
  session.setConversationHistory(historyProvider.lastTurns(session.getConversationId(), 10));
  EnginePipeline pipeline = pipelineFactory.create();
  return pipeline.execute(session);
}`}
</CodeBlockToggle>

## 3. The Pipeline (Step-by-Step)

<PipelineStepList ariaLabel="Pipeline step-by-step (v2)" steps={v2PipelineSteps} />

<Highlight type="info" title="Core path vs conditional steps">
`DialogueActStep`, `InteractionPolicyStep`, `ActionLifecycleStep`, `DisambiguationStep`, `PendingActionStep`, `ToolOrchestrationStep`, `McpToolStep`, `StateGraphStep`, and `MemoryStep` are route-conditional and execute only when their prerequisites are met.
</Highlight>

<Highlight type="success" title="Audit Trail + Real-world trace">
Every step emits audit events. Use `/audit/{id}/trace`, then open <FileRef>/docs/v2/deep-dive/request-lifecycle</FileRef> and <FileRef>/docs/v2/deep-dive/examples</FileRef> to compare turn-by-turn real-world traces.
</Highlight>
