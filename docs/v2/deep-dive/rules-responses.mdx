---
title: Rules & Responses
sidebar_position: 6
---

# Rules and Response Resolution

## Rule phases

`ce_rule.phase` supports:

- `PRE_RESPONSE_RESOLUTION`
- `POST_AGENT_INTENT`
- `POST_AGENT_MCP`
- `POST_TOOL_EXECUTION`

`RulesStep` writes phase/source/origin metadata into input params and audit payload for every pass.

## Rule matching behavior

For each pass:

1. fetch by phase + session state
2. check intent (`ANY`/blank/null supported)
3. check state (`ANY`/blank/null supported)
4. evaluate type resolver (`EXACT`, `REGEX`, `JSON_PATH`)
5. execute action resolver
6. rerun pass if intent/state changed (max pass cap)

Audit emitted for both outcomes:

- `RULE_MATCH (AgentIntentResolver)`
- `RULE_NO_MATCH (AgentIntentResolver)`
- `RULE_MATCH (RulesStep)`
- `RULE_NO_MATCH (RulesStep)`
- `RULE_MATCH (McpToolStep)`
- `RULE_NO_MATCH (McpToolStep)`

`RULE_APPLIED (...)` is additionally emitted when action execution mutates/executes the matched rule.

## Response resolution behavior

`ResponseResolutionStep`:

1. selects response template by intent/state/priority
2. resolves output format
3. emits `RESOLVE_RESPONSE*` audit stages
4. writes final payload (`EXACT` or `DERIVED`)

## Operational guidance

- Keep fallback state responses (`ANY`/`UNKNOWN`) for safety paths.
- Keep at least one response for each terminal state.
- Use phase-scoped rules instead of overloading one monolithic `PRE_RESPONSE_RESOLUTION` pass.
